# $Id: Portfile,v 1.4 2005/07/01 23:37:47 pguyot Exp $
PortSystem		1.0

name			aquaterm
version			1.0.b2
revision		1
categories		aqua math science
maintainers		rshaw@opendarwin.org
description		AquaTerm is a viewer that displays vector graphics on Mac OS X
long_description	AquaTerm is a viewer app that displays vector \
					graphics.  Other apps connect to AquaTerm using a \
					simple remote object messaging protocol.  By adding \
					"adapters" to legacy code very little coding is \
					needed to bring it to OS X.
platforms		darwin
homepage		http://aquaterm.sourceforge.net/
master_sites	sourceforge
distname		${name}_src.${version}
checksums		md5 18208162ad73de4b69ff5e884240eb2e
worksrcdir		${name}_src

patch {
	# gcc 4 cannot find aquaterm/AQTAdapter.h in ObjC source files.
	# adding a -I would be the right thing to do, but I'm not sure about
	# how to patch the ProjectBuilder project.
	reinplace "s|#import <aquaterm/AQTAdapter.h>|#import \"AQTAdapter.h\"|g" \
		${worksrcpath}/aquaterm/Demo.m
	reinplace "s|#import <aquaterm/AQTAdapter.h>|#import \"AQTAdapter.h\"|g" \
		${worksrcpath}/aquaterm/Bugs.m
	reinplace "s|#import <aquaterm/AQTAdapter.h>|#import \"AQTAdapter.h\"|g" \
		${worksrcpath}/aquaterm/Timing.m
}

configure {
	cd ${worksrcpath}/${name}
	reinplace "s|/Users/per/Documents/Source/aquaterm/||" \
		AquaTerm.pbproj/project.pbxproj
	reinplace "s|/tmp/AquaTerm.dst||" \
		AquaTerm.pbproj/project.pbxproj
	reinplace "s|/usr/local/lib|${prefix}/lib|" \
		AquaTerm.pbproj/project.pbxproj
	file mkdir build/include
	system "ln -s ../.. build/include/aquaterm"

	cd ${worksrcpath}/adapters
	reinplace "s|/usr/local|${prefix}|g" \
		pgplot/ChangeLog pgplot/g77_gcc_AQT.conf pgplot/xlf_gcc_AQT.conf
	reinplace "s|\$(HOME)|${prefix}|g" \
		c/Makefile fortran/Makefile
	reinplace "s|/*<PREFIX>|${prefix}|g" \
		pgplot/g77_cc_AQT.conf pgplot/g77_gcc_AQT.conf pgplot/xlf_gcc_AQT.conf
	reinplace "s|/sw|${prefix}|g" \
		pgplot/ReadMe
}

set xcodebuilddir		build
platform darwin 8 {
	set xcodebuilddir	build/Deployment
}
build.type		pbx
build.dir		${worksrcpath}/${name}
build.target	-buildstyle Deployment -target AquaTerm
post-build {
	system "install_name_tool -id ${prefix}/lib/libaquaterm.1.dylib \
		${worksrcpath}/${name}/${xcodebuilddir}/libaquaterm.1.0.0.dylib"
	system "install_name_tool -change ${prefix}/lib/libaquaterm.1.0.0.dylib ${prefix}/lib/libaquaterm.1.dylib \
		${worksrcpath}/${name}/${xcodebuilddir}/AquaTerm.app/Contents/MacOS/AquaTerm"
}

destroot {
	cd ${worksrcpath}/${name}
	xinstall -d -m 0755 ${destroot}${prefix}/include/${name}
	xinstall -m 0644 AQTAdapter.h aquaterm.h \
		${destroot}${prefix}/include/${name}

	cd ${worksrcpath}/${name}/${xcodebuilddir}
	xinstall -m 0755 libaquaterm.1.0.0.dylib ${destroot}${prefix}/lib
	system "ln -s libaquaterm.1.0.0.dylib \
		${destroot}${prefix}/lib/libaquaterm.dylib"
	system "ln -s libaquaterm.1.0.0.dylib \
		${destroot}${prefix}/lib/libaquaterm.1.dylib"
	xinstall -d -m 0755 ${destroot}/Applications/DarwinPorts
	system "cp -R AquaTerm.app ${destroot}/Applications/DarwinPorts"

	cd ${worksrcpath}/adapters
	xinstall -d -m 0755 ${destroot}${prefix}/share/${name}
	system "cp -R c fortran gnuplot pgplot plplot \
		${destroot}${prefix}/share/${name}"
}

