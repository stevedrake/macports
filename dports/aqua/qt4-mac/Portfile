# $Id$
PortSystem      1.0

name            qt4-mac
version         4.3.1
categories      aqua
homepage        http://www.trolltech.com/
platforms       macosx
maintainers     nomaintainer

description     Qt Tool Kit (Native Aqua Version)
long_description \
    This is Qt, TrollTech's C++ toolkit for writing \
    cross-platform GUI applications.

master_sites \
    ftp://ftp.trolltech.com/qt/source/ \
    http://ftp.iasi.roedu.net/mirrors/ftp.trolltech.com/qt/source/ \
    http://ftp.ntua.gr/pub/X11/Qt/qt/source/ \
    http://wftp.tu-chemnitz.de/pub/Qt/qt/source/

distname    qt-mac-opensource-src-${version}
checksums   md5 adfb4196ee569d6ff5f7c7e539a76cd2 \
            sha1 efdeb87a81f5e3f7303d4a92fbb0267f196419ac \
            rmd160 b9e83a4cb42b4eec9e60da3a415499b2325f2e1a

depends_lib port:libmng port:libpng port:tiff

# have to build with Apple gcc because of -fconstant-cfstrings
configure.compiler  gcc-4.0
configure.cmd       "echo yes | ./configure"
configure.env       QMAKESPEC='' QTDIR='' DYLD_LIBRARY_PATH=''
configure.pre_args
configure.args \
    -v         \
    -prefix         '${prefix}'                            \
    -docdir         '${prefix}/share/doc/${portname}/html' \
    -datadir        '${prefix}/share/qt4'                  \
    -headerdir      '${prefix}/include/qt4'                \
    -plugindir      '${prefix}/lib/qt4-plugins'            \
    -translationdir '${prefix}/share/qt4/translations'     \
    -release                -shared         -fast           -stl                \
    -qt-gif                 -qt-libpng      -qt-libjpeg     -qt-libmng          \
    -qt-libtiff             -optimized-qmake                                    \
    -no-sql-ibase           -no-sql-mysql   -no-sql-odbc    -no-sql-psql        \
    -no-sql-sqlite          -no-nis         -no-cups        -nomake examples    \
    -system-zlib            -largefile      -no-framework   -nomake demos       \
    -I${prefix}/include     -L${prefix}/lib

build.env           QMAKESPEC='' QTDIR='' DYLD_LIBRARY_PATH="${worksrcpath}/lib"
#build.target       symlinks src-qmake src-moc sub-src sub-tools
build.target        first

destroot.destdir    INSTALL_ROOT="${destroot}"
set appPath         ${destroot}/Applications/MacPorts/Qt

post-destroot {
    xinstall -d -m 0755 ${appPath}
    foreach app {assistant Designer Linguist pixeltool qdbusviewer} {
        move ${destroot}${prefix}/bin/${app}.app \
            ${appPath}
    }
    foreach doc {INSTALL LICENSE.GPL OPENSOURCE-NOTICE.TXT README} {
        xinstall -c -m 644 ${worksrcpath}/$doc \
            ${destroot}${prefix}/share/doc/qt4-mac
    }
    if {![file exists ${destroot}${prefix}/lib/libqt.dylib]} {
        set majorver [strsed ${version} {s/\.[0-9]*\.[0-9]*$//}]
        set minorver [strsed ${version} {s/\.[0-9]*$//}]
        system "cd ${destroot}${prefix}/lib &&
            ln -s libqt-mt.${version}.dylib libqt.dylib &&
            ln -s libqt-mt.${version}.dylib libqt.${majorver}.dylib &&
            ln -s libqt-mt.${version}.dylib libqt.${minorver}.dylib"
   }
}

variant mysql {
    depends_lib-append  lib:libmysqlclient.12:mysql4
    configure.args-delete   -no-sql-mysql
    configure.args-append   -qt-sql-mysql \
                            -L${prefix}/lib/mysql \
                            -I${prefix}/include/mysql \
                            -plugin-sql-mysql
}
variant ipv6 {
    configure.args-delete   -no-ipv6
    configure.args-append   -ipv6
}
variant framework {
    configure.args-delete   -no-framework
    configure.args-append   -framework
    post-destroot {
        # move the stuff that doesn't belong into /Library/Frameworks into ${prefix}/lib
        foreach f {libQtUiTools.a libQtUiTools.prl libQtUiTools_debug.a libQtUiTools_debug.prl pkgconfig Qt3Support.la QtCore.la QtDBus.la QtGui.la QtNetwork.la QtOpenGL.la QtScript.la QtSql.la QtSvg.la QtTest.la QtXml.la} {
            move ${destroot}/Library/Frameworks/$f ${destroot}${prefix}/lib
        }
    }
}
variant examples {
    configure.args-delete   -nomake examples
    configure.args-append   -make examples
}
variant demos {
    configure.args-delete  -nomake demos
    configure.args-append  -make demos
    post-destroot {
        move ${destroot}${prefix}/demos ${appPath}
        move ${destroot}${prefix}/bin/qtdemo.app ${appPath}
    }
}
