# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

name                qt4-mac
version             4.3.4
categories          aqua
platforms           macosx
maintainers         openmaintainer jochen

homepage            http://www.trolltech.com/
description         Qt Tool Kit (Native Aqua Version)
long_description    This is Qt, TrollTech's C++ toolkit for writing cross-platform GUI applications. \
                    This version uses the native Aqua UI. For a X11 version, see qt4-x11.
master_sites        ftp://ftp.trolltech.com/qt/source/ \
                    http://ftp.iasi.roedu.net/mirrors/ftp.trolltech.com/qt/source/ \
                    http://ftp.ntua.gr/pub/X11/Qt/qt/source/ \
                    http://wftp.tu-chemnitz.de/pub/Qt/qt/source/
distname            qt-mac-opensource-src-${version}
checksums           md5 e3997f7c7620bcf03c635676c3b01fef \
                    sha1 bdba9cd2a5ad79724d536f8a4a3010c3a223108b

depends_lib         port:libmng port:libpng port:jpeg port:tiff

# have to build with Apple gcc because of -fconstant-cfstrings
configure.compiler  gcc-4.0
configure.cmd       "echo yes | ./configure"
configure.env       QMAKESPEC='' QTDIR='' DYLD_LIBRARY_PATH=''
configure.pre_args
# See
#   http://doc.trolltech.com/qtopia4.3/buildsystem/over-configure-options-qt-1.html
# for options
configure.args \
    -v         \
    -prefix         '${prefix}'                            \
    -docdir         '${prefix}/share/doc/${portname}/html' \
    -datadir        '${prefix}/share/qt4'                  \
    -headerdir      '${prefix}/include/qt4'                \
    -plugindir      '${prefix}/lib/qt4-plugins'            \
    -translationdir '${prefix}/share/qt4/translations'     \
    -optimized-qmake    -release        -shared         -stl                \
    -no-openssl         -largefile                                          \
    -system-libpng      -system-libjpeg -system-libmng  -system-libtiff     \
    -system-zlib        -qt-gif                                             \
    -no-sql-ibase       -no-sql-mysql   -no-sql-odbc    -no-sql-psql        \
    -no-sql-sqlite      -no-nis         -no-cups        -no-framework       \
    -make libs          -make tools                                         \
    -I${worksrcpath}/include -I${prefix}/include \
    -L${worksrcpath}/lib -L${prefix}/lib

    # not made by default, anyway: -nomake demos -nomake examples

build.env           QMAKESPEC='' QTDIR='' DYLD_LIBRARY_PATH="${worksrcpath}/lib"
build.target        first

destroot.destdir    INSTALL_ROOT="${destroot}"

set appPath         ${destroot}/Applications/MacPorts/Qt
set docPath         ${destroot}${prefix}/share/doc/qt4-mac

post-destroot {
    xinstall -d -m 0755 ${appPath}
    foreach app {assistant Designer Linguist pixeltool} {
        move ${destroot}${prefix}/bin/${app}.app ${appPath}
    }
    foreach doc {INSTALL LICENSE.GPL2 LICENSE.GPL3 OPENSOURCE-NOTICE.TXT README \
                 GPL_EXCEPTION_ADDENDUM.TXT GPL_EXCEPTION.TXT} {
        xinstall -c -m 644 ${worksrcpath}/$doc ${docPath}
    }
    if {![file exists ${destroot}${prefix}/lib/libqt.dylib]} {
        set majorver [strsed ${version} {s/\.[0-9]*\.[0-9]*$//}]
        set minorver [strsed ${version} {s/\.[0-9]*$//}]
        system "cd ${destroot}${prefix}/lib &&
            ln -s libqt-mt.${version}.dylib libqt.dylib &&
            ln -s libqt-mt.${version}.dylib libqt.${majorver}.dylib &&
            ln -s libqt-mt.${version}.dylib libqt.${minorver}.dylib"
   }
}

variant dbus description "Include DBus support" {
    depends_lib-append      port:dbus
    configure.args-append   -qdbus
}

variant framework description "Build frameworks" {
    configure.args-delete   -no-framework
    configure.args-append   -framework
}

variant ipv6 description "Include IPv6 support" {
    configure.args-delete   -no-ipv6
    configure.args-append   -ipv6
}

variant mysql description "Include support for SQL via mysql driver" {
    depends_lib-append      lib:libmysqlclient.12:mysql4
    configure.args-delete   -no-sql-mysql
    configure.args-append   -qt-sql-mysql -plugin-sql-mysql \
                            -I${prefix}/include/mysql -L${prefix}/lib/mysql
}

variant sqlite description "Include support for SQL via sqlite driver" {
	# depends_lib-append      port:sqlite3
	configure.args-delete	-no-sql-sqlite
	configure.args-append	-qt-sql-sqlite -plugin-sql-sqlite
    # -system-sqlite
    post-destroot {
        # fix install-name of plugin
        system "install_name_tool -id ${prefix}/lib/qt4-plugins/sqldrivers/libqsqlite.dylib \
            ${destroot}${prefix}/lib/qt4-plugins/sqldrivers/libqsqlite.dylib"
    }
}

variant ssl description "Include OpenSSL support" {
    depends_lib             port:openssl
    configure.args-delete   -no-openssl
    configure.args-append   -openssl
}

variant examples description "Build Qt examples" {
    # configure.args-delete   "-nomake examples"
    configure.args-append   -make examples
}

variant demos description "Build Qt demos" {
    # configure.args-delete   "-nomake demos"
    configure.args-append   -make demos
    post-destroot {
        move ${destroot}${prefix}/demos ${appPath}
        move ${destroot}${prefix}/bin/qtdemo.app ${appPath}
    }
}
