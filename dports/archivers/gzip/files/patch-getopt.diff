See http://old.nabble.com/Re%3A-getopt-compilation-failure-on-Darwin-%28gzip-1.3.13%29-p25779891.html

--- lib/getopt.in.h
+++ lib/getopt.in.h
@@ -22,9 +22,13 @@
 @PRAGMA_SYSTEM_HEADER@
 #endif
 
-/* The include_next requires a split double-inclusion guard.  */
+/* The include_next requires a split double-inclusion guard.  We must
+   also inform the replacement unistd.h to not recursively use
+   <getopt.h>; our definitions will be present soon enough.  */
 #if @HAVE_GETOPT_H@
+# define _GL_SYSTEM_GETOPT
 # @INCLUDE_NEXT@ @NEXT_GETOPT_H@
+# undef _GL_SYSTEM_GETOPT
 #endif
 
 #ifndef _GL_GETOPT_H
diff --git lib/unistd.in.h lib/unistd.in.h
index 38e2e13..b6ea889 100644
--- lib/unistd.in.h
+++ lib/unistd.in.h
@@ -49,7 +49,7 @@
 #endif
 
 /* Get getopt(), optarg, optind, opterr, optopt.  */
-#if @GNULIB_UNISTD_H_GETOPT@
+#if @GNULIB_UNISTD_H_GETOPT@ && !defined _GL_SYSTEM_GETOPT
 # include <getopt.h>
 #endif
 