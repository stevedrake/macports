# $Id$

PortSystem 1.0

name                zlib
version             1.2.3
categories          archivers
maintainers         ryandesign@macports.org landonf@macports.org \
                    openmaintainer@macports.org
description         zlib lossless data-compression library
long_description    zlib is designed to be a free, general-purpose, \
                    legally unencumbered, lossless data-compression \
                    library for use on virtually any computer hardware \
                    and operating system.

homepage            http://www.zlib.net/
platforms           darwin

master_sites        ${homepage} \
                    http://www.gzip.org/zlib/ \
                    sourceforge:libpng

use_bzip2           yes
checksums           md5 dee233bf288ee795ac96a98cc2e369b6

configure.args      --shared

test.run            yes

destroot.destdir    prefix=${destroot}${prefix}

post-destroot {
    ui_msg "$UI_PREFIX Configuring libz.a"
    configure.args-delete --shared
    run_command configure
    modify_ldshared
    ui_msg "$UI_PREFIX Building libz.a"
    run_command build
    ui_msg "$UI_PREFIX Staging libz.a into destroot"
    xinstall ${worksrcpath}/libz.a ${destroot}${prefix}/lib/
}

post-configure {
    modify_ldshared
}

variant universal {
    configure.env-append CFLAGS="-isysroot /Developer/SDKs/MacOSX10.4u.sdk -arch i386 -arch ppc" \
                         LDFLAGS="-Wl,-syslibroot,/Developer/SDKs/MacOSX10.4u.sdk -arch i386 -arch ppc"
}

proc modify_ldshared {} {
    global worksrcpath
    if {[variant_isset universal]} {
        reinplace "s|^\\(LDSHARED *=.*\\)$|\\1 -Wl,-syslibroot,/Developer/SDKs/MacOSX10.4u.sdk -arch i386 -arch ppc|" \
                  "${worksrcpath}/Makefile"
    }
}

proc run_command {cmd} {
    if {[catch {system "[command $cmd]"} result]} {
        return -code error "[format [msgcat::mc "%s failure: %s"] $cmd $result]"
    }
}