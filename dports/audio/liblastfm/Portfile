# -*- coding: utf-8; mode: tcl; c-basic-offset: 4; indent-tabs-mode: nil; tab-width: 4; truncate-lines: t -*- vim:fenc=utf-8:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0
PortGroup           qt4 1.0

name                liblastfm
version             0.3.0
revision            5
categories          audio
maintainers         michaelld openmaintainer
description         A set of libraries allowing use of the Last.fm site services.
long_description    liblastfm is a collection of libraries to help you \
integrate Last.fm services into your rich desktop software. It is \
officially supported software developed by Last.fm staff.
platforms           darwin
homepage            http://www.last.fm
master_sites        http://cdn.last.fm/src/
use_bzip2           yes
checksums           md5     3f73222ebc31635941832b01e7a494b6 \
                    sha1    1dabd8d67f4a36aebad29608c6f89b895472c25a \
                    rmd160  39098fe55f88c3831ab5b1380c1e978c2ef55aac

depends_build-append port:ruby

depends_lib-append  port:libsamplerate port:fftw-3-single

universal_variant   yes

use_parallel_build  no

# fix build failure on Snow Leopard
patchfiles          patch-src-core-misc-cpp.diff

post-patch {
    # fix library install directory
    reinplace "/target\\.path/s@\\/lib@\\\$\\\$QMAKE_LIBDIR_QT@" \
        ${worksrcpath}/src/lastfm.pro
    reinplace "/target\\.path/s@\\/lib@\\\$\\\$QMAKE_LIBDIR_QT@" \
        ${worksrcpath}/src/fingerprint/fingerprint.pro

    # fix destroot location for subdirs
    reinplace "/make install/s@#{\\\$install_prefix}@@g" \
        ${worksrcpath}/admin/Makefile.rb

    # swap -l -L ordering (to be -L -l)
    reinplace "/LIBS/s@+= \\(-l\[^ \]*\\) \\(-L\[^ \]*\\)@+= \\2 \\1@" \
        ${worksrcpath}/demos/demos.pro
    reinplace "/LIBS/s@+= \\(-l\[^ \]*\\) \\(-L\[^ \]*\\)@+= \\2 \\1@" \
        ${worksrcpath}/tests/tests.pro
}

# QMake does not handle this flag.
configure.universal_args-delete --disable-dependency-tracking
configure.args-delete  --disable-dependency-tracking

configure.pre_args  --prefix ${prefix}
configure.args      --release
