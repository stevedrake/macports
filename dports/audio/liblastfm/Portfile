# -*- coding: utf-8; mode: tcl; c-basic-offset: 4; indent-tabs-mode: nil; tab-width: 4; truncate-lines: t -*- vim:fenc=utf-8:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

name                liblastfm
version             0.3.0
revision            3
categories          audio
maintainers         nomaintainer
description         A set of libraries allowing use of the Last.fm site services.
long_description    liblastfm is a collection of libraries to help you \
integrate Last.fm services into your rich desktop software. It is \
officially supported software developed by Last.fm staff.
platforms           darwin
homepage            http://www.last.fm
master_sites        http://cdn.last.fm/src/
use_bzip2           yes
checksums           md5     3f73222ebc31635941832b01e7a494b6 \
                    sha1    1dabd8d67f4a36aebad29608c6f89b895472c25a \
                    rmd160  39098fe55f88c3831ab5b1380c1e978c2ef55aac

depends_build       port:ruby

depends_lib         port:libsamplerate port:fftw-3-single port:qt4-mac

set qtdir           ${prefix}/libexec/qt4-mac

universal_variant no

configure.env       PATH=${qtdir}/bin:$env(PATH)

configure.pre_args  --prefix ${prefix}
configure.args      --release

post-configure {
    # create Makefile's, then patch them to remove a flaw made by qmake.
    # (1) find subdir Makefile names from top-level Makefile, and have
    # 'make' create each in turn.
    foreach tMf [exec grep -e "Makefile\[\^ \]\*:" ${worksrcpath}/Makefile | \
                     sed -e "s@\\(\[^ \]*/Makefile\[^ \]*\\):\[^ \]*@\\1@g"] {
        system "cd ${worksrcpath} && PATH=${qtdir}/bin:$env(PATH) make ${tMf}"
    }

    # (2) find all created Makefile*'s, and reinplace the offending flaw
    foreach tMf [exec find ${worksrcpath} -name "Makefile*"] {
        reinplace "s@\\(-arch \[^ \]*\\) -arch@\\1@" ${tMf}
    }
}

use_parallel_build  no

build.env           PATH=${qtdir}/bin:$env(PATH)

# fix build failure on Snow Leopard
patchfiles          patch-src-core-misc-cpp.patch

# liblastfm libraries are not referencing their proper location.
# Until we learn how to fix this properly, we fix it manually.
post-destroot {
    set fixlibs [exec find ${destroot} -name "*.dylib" -type f | \
                     sed -e "s@${destroot}@@g" | \
                     sed -e "s@\\(\\.\[0-9\]*\\.\\)\[^ \]*@\\1dylib@g"]
    foreach t_fixlib ${fixlibs} {
        foreach t_lib ${fixlibs} {
            if {${t_fixlib} == ${t_lib}} {
                system "install_name_tool -id ${t_lib} ${destroot}${t_fixlib}"
            } else {
                set lib_name [exec echo ${t_lib} | \
                                  sed -e "s@/\[^ \]*/\\(\[^ \]*\\)@\\1@g"]
                system "install_name_tool -change ${lib_name} ${t_lib} ${destroot}${t_fixlib}"
            }
        }
    }
}
