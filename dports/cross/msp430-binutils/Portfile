# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=portfile:et:sw=4:ts=4:sts=4
# $Id$

PortSystem              1.0

name                    msp430-binutils
version                 2.21.1

# Parameters for this port.
set crossgcc_target     msp430
set version_date        20110716
set lts_date            ${version_date}

description             FSF Binutils for msp cross development
long_description        Free Software Foundation development toolchain ("binutils") for \
                        msp cross development.
license                 GPL-3+
platforms               darwin
categories              cross devel
maintainers             gmail.com:a2piratesoft openmantainer

distname                binutils-${version}
homepage                http://www.gnu.org/software/binutils/binutils.html
master_sites            gnu:binutils \
                        ftp://ftp.kernel.org/pub/linux/devel/binutils/ \
                        http://ftp.kernel.org/pub/linux/devel/binutils/

patch_sites             http://downloads.sourceforge.net/project/mspgcc/Patches/${distname}/ \
                        http://downloads.sourceforge.net/project/mspgcc/Patches/LTS/${lts_date}/ \

patchfiles              ${name}-${version}-${version_date}.patch \
                        ${name}-${version}-${version_date}-sf3143071.patch \
                        ${name}-${version}-${version_date}-sf3379341.patch \
                        ${name}-${version}-${version_date}-sf3386145.patch \
                        ${name}-${version}-${version_date}-sf3400711.patch \
                        ${name}-${version}-${version_date}-sf3400750.patch

use_bzip2               yes

checksums               ${name}-${version}-${version_date}.patch \
                        rmd160  1e20d21da72265e5f83a0417d3588a69478aadeb \
                        sha256  28698e96d99524b3f359591ef82703dd9a9b581596a7a6106cf7e11f38671246 \
                        ${distname}${extract.suffix} \
                        rmd160  de5ce1d7cb0d44e3ec18c557beefb2a292d59a60 \
                        sha256  cdecfa69f02aa7b05fbcdf678e33137151f361313b2f3e48aba925f64eabf654 \
                        ${name}-${version}-${version_date}-sf3143071.patch \
                        rmd160  a8e624bc381d72b87ac8ae3835fa2f3319b1a989 \
                        sha256  1df8c88e34c5742f56dfb78708d1dacd523c4b1e6a8436bfb737f04b557ab1a5 \
                        ${name}-${version}-${version_date}-sf3379341.patch \
                        rmd160  1e76515502f062c7c95ae0cb8feab3662d542934 \
                        sha256  a7555ec75f631e46ad12e70743e5a540792283820edf02dbe68f3c823772fd6d \
                        ${name}-${version}-${version_date}-sf3386145.patch \
                        rmd160  537a9dc6219a2d891037c52779910893ea2b6f3e \
                        sha256  15c349440b5fa2582422a659801a2f96d66eff230f924d7e4bb57b30df2bcd0a \
                        ${name}-${version}-${version_date}-sf3400711.patch \
                        rmd160  8fd78e0db39ab5ff76e12bc5bf97e9d597c39308 \
                        sha256  bfb2517411ee118ec12b17841fc2cb81c7dde3a5943f485e1542654806381a94 \
                        ${name}-${version}-${version_date}-sf3400750.patch \
                        rmd160  a6a630c85327c7d96e813ab08acb1a2415c563a4 \
                        sha256  40665a04dd2dce44058ede8ee88192c8ff9a3574f2ccb95285f4ad044333c4aa \

depends_build           port:gettext

worksrcdir              binutils-[string trimright ${version} a-zA-Z]

# All cross ports violate the mtree layout.
destroot.violate_mtree  yes

patch.args              -p1

# We don't want the etc module.
post-extract {
    system "rm -rf ${worksrcpath}/etc"
}

# Build in a different directory, as advised in the README file.
pre-configure {
    system "cd ${workpath} && mkdir -p build"
}

configure.dir           ${workpath}/build
configure.cmd           ${worksrcpath}/configure
#configure.env-append    CFLAGS="-I${prefix}/include"

configure.args-append   --target=${crossgcc_target} \
                        --program-prefix="${crossgcc_target}-" \
                        --with-mpfr-include=${prefix}/include \
                        -with-mpfr-lib=${prefix}/lib \
                        --with-gmp-include=${prefix}/include \
                        -with-gmp-lib=${prefix}/lib \
                        --with-mpc-include=${prefix}/include \
                        -with-mpc-lib=${prefix}/lib \
                        --disable-nls \
                        --disable-werror

build.dir               ${workpath}/build
#build.env-append        CFLAGS="-I${prefix}/include" # TODO deleteme

post-destroot {
    file delete "${destroot}/${prefix}/lib/x86_64/libiberty.a"
    file delete "${destroot}/${prefix}/lib/libiberty.a"
    file delete -force "${destroot}/${prefix}/share/info"
}

livecheck.type          regex
livecheck.url           http://mirrors.ibiblio.org/gnu/ftp/gnu/binutils/
livecheck.regex         "binutils-((?!.*binutils.*|\\${extract.suffix}).*)\\${extract.suffix}"
