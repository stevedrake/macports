# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem              1.0

name                    cassandra
version                 0.5.1
revision                1
categories              databases
maintainers             singingwolfboy openmaintainer
homepage                http://cassandra.apache.org/
platforms               darwin
master_sites            apache
master_sites.mirror_subdir  ${name}/${version}
distname                apache-${name}-${version}-src

description             A highly scalable, eventually consistent, \
                        distributed, structured key-value store.
long_description        \
    The Apache Cassandra Project develops a highly scalable second-generation \
    distributed database, bringing together Dynamo's fully distributed design \
    and Bigtable's ColumnFamily-based data model. Cassandra was open sourced \
    by Facebook in 2008, and is now developed by Apache committers and \
    contributors from many companies.

checksums               md5     1e0bf06f57e50348c2bc38d9d4b6a383 \
                        sha1    66ad387acc330b40f4ac980724b6899987bdc110 \
                        rmd160  259ecf4de5c3293b307662db0bd9cdb5bd8fb3e4

depends_build           bin:ant:apache-ant

use_configure           no

build.cmd               ${prefix}/bin/ant
build.target            jar

proc touch name {close [open $name a]}

destroot {
    # create directories
    set cas_home ${destroot}${prefix}/share/java/${name}
    set doc_dir ${destroot}${prefix}/share/doc/${name}
    xinstall -m 755 -d ${cas_home}/lib ${doc_dir}
    
    # move in docs
    eval move [glob ${worksrcpath}/*.txt] ${doc_dir}/
    
    # fix cassandra include file
    move ${worksrcpath}/bin/cassandra.in.sh ${cas_home}/
    reinplace "s|cassandra_home=.*|cassandra_home=${prefix}/share/java/${name}|" ${cas_home}/cassandra.in.sh
    reinplace "s|cassandra_bin=.*|cassandra_bin=\$cassandra_home/cassandra.jar|" ${cas_home}/cassandra.in.sh
    
    # install bin scripts
    eval delete [glob ${worksrcpath}/bin/*.bat]
    eval reinplace "s|/opt/cassandra/cassandra.in.sh|${prefix}/share/java/${name}/cassandra.in.sh|" [glob ${worksrcpath}/bin/*]
    eval xinstall -m 755 [glob ${worksrcpath}/bin/*] ${destroot}${prefix}/bin

    # install jars
    xinstall -m 755 ${worksrcpath}/build/apache-${name}-${version}.jar ${cas_home}/${name}.jar
    eval xinstall -m 755 [glob ${worksrcpath}/lib/*.jar] ${cas_home}/lib/
    
    # install conf, contrib, interface
    move ${worksrcpath}/conf ${worksrcpath}/contrib ${worksrcpath}/interface ${cas_home}
    
    # update file storage location to be within Macports hierarchy
    eval reinplace "s|/var|${prefix}/var|" [glob ${cas_home}/conf/*]
    
    # create these files
    xinstall -m 755 -d ${destroot}${prefix}/var/log/cassandra/ ${destroot}${prefix}/var/lib/cassandra/data/
    touch ${destroot}${prefix}/var/log/cassandra/system.log
}
destroot.keepdirs   ${destroot}${prefix}/var/log/cassandra/ \
                    ${destroot}${prefix}/var/lib/cassandra/
