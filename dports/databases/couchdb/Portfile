# $Id$

PortSystem 1.0

name		couchdb
version		0.7.2
revision	1

categories	databases
platforms	darwin

description	couchdb is a document database server
maintainers	jwa
long_description	${description}

homepage	http://couchdb.org/
master_sites	http://couchdb.googlecode.com/files/
checksums	md5 0366a6566d934790ed0e5bf5a834ebe5 \
    sha1 9ddd69fbebe45260600c0ef224d83e928e58b80b \
    rmd160 e3e1f46788816583675745efb2a3d513fa970e2c

depends_lib	port:automake \
    port:autoconf \
    port:libtool \
    port:help2man \
    port:icu \
    port:erlang

set dbgroup couchdb
set dbuser couchdb
set logdir ${prefix}/var/log/couchdb
set dbdir ${prefix}/var/lib/couchdb
set piddir ${prefix}/var/run/
set plistloc ${prefix}/etc/LaunchDaemons/org.macports.CouchDB

platform darwin 8 {
    configure.compiler	gcc-4.0
}

variant server description {adds a startup item} {
    addgroup ${dbgroup}
    adduser ${dbuser} gid=[existsgroup ${dbgroup}]

    startupitem.create	yes
    startupitem.type	launchd
    startupitem.name	CouchDB
#    startupitem.start	"\$\(${prefix}/bin/icu-config --invoke\) ${prefix}/bin/couchdb -b -o ${logdir}/couchdb.stdout -e ${logdir}/couchdb.stderr"
    startupitem.start	"${prefix}/bin/couchdb -b -o ${logdir}/couchdb.stdout -e ${logdir}/couchdb.stderr"
    startupitem.stop	"${prefix}/bin/couchdb -d"
}

pre-destroot {
    if { [variant_isset server] } {
	xinstall -m 755 -o ${dbuser} -g ${dbgroup} -d \
	    ${destroot}${dbdir} \
	    ${destroot}${logdir} \
	    ${destroot}${piddir}
	destroot.keepdirs-append \
	    ${destroot}${dbdir} \
	    ${destroot}${logdir} \
	    ${destroot}${piddir}
    }
}

pre-install {
    if { [variant_isset server] } {
	system "touch ${destroot}${piddir}/couchdb.pid"
	system "chown -R ${dbuser}:${dbgroup} ${destroot}${dbdir} ${destroot}${logdir} ${destroot}${piddir}/couchdb.pid"
	system "cd ${destroot}${plistloc}; patch <${filespath}/patch-org.macports.CouchDB.plist.diff"
    }
}

livecheck.check	regex
livecheck.url	http://code.google.com/p/couchdb/downloads/list
livecheck.regex	CouchDB (0.\[0-9\].\[0-9\])
