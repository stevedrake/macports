# $Id: Portfile,v 1.10 2004/10/04 22:42:35 rshaw Exp $

PortSystem 1.0
name		mysql4
version	 	4.0.21
categories	databases
maintainers 	benoitc@opendarwin.org	
description	Multithreaded SQL database server
long_description	MySQL is an open-source, multi-threaded SQL database \
			with a command syntax very similar to mSQL.
homepage		http://www.mysql.com/
platforms		darwin
master_sites	ftp://planetmirror.com/pub/mysql/Downloads/MySQL-4.0/ \
                http://www.softagency.co.jp/MySQL/Downloads/MySQL-4.0/ \
                ftp://sunsite.dk/mirrors/mysql/Downloads/MySQL-4.0/ \
                http://mysql.mediatraffic.fi/Downloads/MySQL-4.0/ \
                ftp://filepile.tiscali.de/mirror/mysql/Downloads/MySQL-4.0/ \
                http://mirrors.tilian.co.uk/mysql.com/Downloads/MySQL-4.0/ \
                ftp://ftp.rtfm.no/pub/mysql/Downloads/MySQL-4.0/ \
                http://www.mysql.cz/Downloads/MySQL-4.0/ \
                ftp://ftp.u-paris10.fr/mysql.com/Downloads/MySQL-4.0/ \
                http://mysql.oms-net.nl/Downloads/MySQL-4.0/ \
                ftp://ftp.free.fr/pub/MySQL/Downloads/MySQL-4.0/
				

set filename	mysql-${version}${extract.suffix}
distfiles	${filename}
distname	mysql-${version}
extract.only	${filename}
checksums	md5 0a3dae16519afa5e59d8b9e252181243

post-patch {
	cd ${worksrcpath}
	reinplace "s%/etc/my.cnf%${prefix}/etc/${name}/my.cnf%g" \
		scripts/mysqlaccess.sh \
		scripts/mysqld_multi.sh \
		scripts/mysqldumpslow.sh \
		scripts/mysqlhotcopy.sh \
		sql-bench/bench-init.pl.sh \
		support-files/my-huge.cnf.sh \
		support-files/my-innodb-heavy-4G.cnf.sh \
		support-files/my-large.cnf.sh \
		support-files/my-medium.cnf.sh \
		support-files/my-small.cnf.sh \
		support-files/mysql.server.sh
	reinplace "s%/etc/%${prefix}/etc/${name}/%g" \
		mysys/default.c
}

platform darwin 6 {
	depends_lib-append		lib:libdl:dlcompat
	
	configure.env	LDFLAGS="-L${prefix}/lib -lncurses" \
				CPPFLAGS=-I${prefix}/include \
				CFLAGS="-O3 -fno-omit-frame-pointer" \
				CXX=gcc \
				CXXFLAGS="-O3 -fno-omit-frame-pointer -felide-constructors -fno-exceptions -fno-rtti"

}

platform darwin 7 {
	configure.env	LDFLAGS="-lncurses" \
					CFLAGS="-O3 -fno-omit-frame-pointer" \
					CXX=gcc \
					CXXFLAGS="-O3 -fno-omit-frame-pointer -felide-constructors -fno-exceptions -fno-rtti" \
					LIBS=-ldl

}
set dbdir	${prefix}/var/db/mysql

				


configure.args 	--sysconfdir=${prefix}/etc/${name} --without-debug --without-bench \
				--mandir=${prefix}/share/man --infodir=${prefix}/share/info \
				--enable-thread-safe-client --with-extra-charsets=complex

pre-configure {
	if { ![variant_isset server] } {
		configure.args-append --without-server
	}
	
}

variant ssl {
	configure.args-append	--with-openssl
}

variant innodb {
	configure.args-append --with-innodb
}


variant server	{
 	depends_run path:/Library/StartupItems/DarwinPortsStartup:DarwinPortsStartup
 	configure.args-append --localstatedir=${dbdir} \
						--with-unix-socket-path=${prefix}/var/run/mysqld/mysqld.sock \
						--with-mysqld-user=mysql
	
}

pre-destroot	{ 
	if { [variant_isset server] } {
		addgroup mysql
		set gid [existsgroup mysql]
		adduser mysql gid=${gid} realname=MySQL\ Server
		
		xinstall -o mysql -g mysql -m 755 -d ${destroot}${prefix}/var/log/mysql
		system "touch ${destroot}${prefix}/var/log/mysql/.turd"  
        system "chown mysql:mysql ${destroot}${prefix}/var/log/mysql"
	}
        
}

post-destroot {
		
		system "rm -rf ${destroot}${prefix}/mysql-test"
		
		xinstall -o root -m 755 -d ${destroot}${prefix}/etc/${name}
		xinstall -o root -m 644 -c ${filespath}/my.cnf ${destroot}${prefix}/etc/${name}/my.cnf.sample
		reinplace "s|__PREFIX|${prefix}|g" ${destroot}${prefix}/etc/${name}/my.cnf.sample
			
		if { [variant_isset server] } {
			
			xinstall -o root -m 755 -d ${destroot}${prefix}/etc/rc.d
			xinstall -o root -m 755 -c ${filespath}/${name}.sh ${destroot}${prefix}/etc/rc.d/
			reinplace "s|__PREFIX|${prefix}|g" ${destroot}${prefix}/etc/rc.d/${name}.sh
			
			xinstall -o mysql -g mysql -m 775 -d ${destroot}${dbdir}
			system "touch ${destroot}${dbdir}/.turd"
			system "chown -R mysql:mysql ${destroot}${dbdir}"
			
			xinstall -o mysql -g mysql -m 755 -d ${destroot}${prefix}/var/run/mysqld
			system "touch ${destroot}${prefix}/var/run/mysqld/.turd"
			system "chown -R mysql:mysql ${destroot}${prefix}/var/run/mysqld"
			
		}
		
}

post-install {
	if { [variant_isset server] } {
		ui_msg "******************************************************"
		ui_msg "* You might want to run                              *"
		ui_msg "* sudo -u mysql mysql_install_db                     *"
		ui_msg "* if this is a new install                           *"	
		ui_msg "******************************************************"
	}
}
