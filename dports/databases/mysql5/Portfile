# $Id$

PortSystem          1.0

name                mysql5
version             5.0.45
revision            2
homepage            http://www.mysql.com/
categories          databases
platforms           darwin
maintainers         ryandesign
distname            mysql-${version}

description \
	Multithreaded SQL database server

long_description \
	MySQL is an open-source, multi-threaded SQL database \
	with a command syntax very similar to mSQL.

master_sites \
	http://mysql.mirrors.pair.com/Downloads/MySQL-5.0/ \
	http://mysql.he.net/Downloads/MySQL-5.0/ \
	http://mysql.orst.edu/Downloads/MySQL-5.0 \
	http://mysql.oss.eznetsols.org/Downloads/MySQL-5.0/ \
	http://mirrors.sunsite.dk/mysql/Downloads/MySQL-5.0/ \
	http://sunsite.informatik.rwth-aachen.de/mysql/Downloads/MySQL-5.0/ \
	http://ftp.plusline.de/mysql/Downloads/MySQL-5.0/

checksums \
	md5 a2a1c5a82bb22b45ab76a8ecab94e10d \
	sha1 a5fba8e004acc43ac1a576d728f10215f54ebe20 \
	rmd160 ee6717c65dc7bb6b5b596b90ef6c47c7fdebf5fb

depends_lib \
	port:zlib \
	port:openssl

patchfiles \
	patch-mysys-base64.c.diff

set major_version   [strsed ${version} {s/\..*$//}]
set mysql           mysql${major_version}
set dbdir           ${prefix}/var/db/${mysql}
set sysconfdir      ${prefix}/etc/${mysql}
set mysqluser       mysql

configure.args \
	--mandir=${prefix}/share/man \
	--infodir=${prefix}/share/info \
	--localstatedir=${dbdir} \
	--libdir=${prefix}/lib/${mysql} \
	--bindir=${prefix}/lib/${mysql}/bin \
	--includedir=${prefix}/include/${mysql} \
	--datadir=${prefix}/share/${mysql} \
	--sysconfdir=${sysconfdir} \
	--with-zlib-dir=${prefix} \
	--with-openssl=${prefix} \
	--with-extra-charsets=complex \
	--with-federated-storage-engine \
	--with-unix-socket-path=${prefix}/var/run/${mysql}/mysqld.sock \
	--with-mysqld-user=${mysqluser} \
	--without-bench \
	--enable-thread-safe-client

platform darwin 8 {
	configure.compiler	gcc-4.0
}

variant server {
	# Create a startupitem to start/stop the server
	startupitem.create	yes
	startupitem.start	"${prefix}/share/${mysql}/mysql/mysql.server start"
	startupitem.stop	"${prefix}/share/${mysql}/mysql/mysql.server stop"
}

pre-destroot {
	# Some directories we must have in all cases
	xinstall -m 755 -d ${destroot}${sysconfdir}
	destroot.keepdirs-append ${destroot}${sysconfdir}
	
	# Setup only for server
	if { [variant_isset server] } {
		addgroup ${mysqluser}
		set gid [existsgroup ${mysqluser}]
		adduser ${mysqluser} gid=${gid} realname=MySQL\ Server
		
		# Some directories we must have only if we're running as a server
		xinstall -m 755 -o root -d ${destroot}${prefix}/var/run
		
		xinstall -m 755 -o ${mysqluser} -g ${mysqluser} -d \
			${destroot}${dbdir} \
			${destroot}${prefix}/var/run/${mysql}
		destroot.keepdirs-append  \
			${destroot}${dbdir} \
			${destroot}${prefix}/var/run/${mysql}
	}
}

post-destroot {
	delete ${destroot}${prefix}/mysql-test
	
	# Fix paths in manpages and sample configuration files
	foreach manpage [glob -type f ${destroot}${prefix}/share/man/man\[1-9\]/*] {
		reinplace "s|/etc/my.cnf|${sysconfdir}/my.cnf|g" ${manpage}
	}
	foreach samp_conffile [glob -type f ${destroot}${prefix}/share/${mysql}/mysql/my-*.cnf] {
		reinplace "s|/etc/my.cnf|${sysconfdir}/my.cnf|g" ${samp_conffile}
	}
	
	# Symlink mysql binaries into bin directory, with ${major_version} appended to the name
	cd ${destroot}${prefix}/bin
	foreach f [glob -tails -directory ${destroot}${prefix}/lib/${mysql}/bin my*] {
		ln -sf ../lib/${mysql}/bin/${f} ${f}${major_version}
	}
}

post-install {
	if { [variant_isset server] } {
		ui_msg "******************************************************"
		ui_msg "* In order to setup the database, you might want to run"
		ui_msg "* sudo -u ${mysqluser} mysql_install_db5"
		ui_msg "* if this is a new install" 
		ui_msg "******************************************************"
	}
}

livecheck.check     regex
livecheck.url       http://dev.mysql.com/
livecheck.regex     "Generally Available (${major_version}\\.\[0-9.\]+)"
