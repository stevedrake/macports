# $Id$

PortSystem              1.0

name                    oracle-instantclient
version                 10.1.0.3
categories              databases
platforms               macosx
maintainers             ryandesign
homepage                http://www.oracle.com/technology/tech/oci/instantclient/
use_zip                 yes
worksrcdir              instantclient[join [lrange [split ${version} .] 0 1] _]

description \
    Oracle database connection libraries

long_description \
    Oracle Instant Client allows you to run your applications without installing the standard Oracle client or having an ORACLE_HOME.

master_sites \
    http://download.oracle.com/otn/mac/instantclient/

distfiles \
    instantclient-basic-macosx-${version}${extract.suffix} \
    instantclient-sdk-macosx-${version}${extract.suffix}

checksums \
    instantclient-basic-macosx-${version}${extract.suffix} \
        md5 5b38ab0565d6189d2069a4abe0bf2ab2 \
        sha1 2f3aa35e99228fd08b686b19eba84ec34db8277b \
        rmd160 d1f056f8f1b308c5493f4938b29b55fcb32452cf \
    instantclient-sdk-macosx-${version}${extract.suffix} \
        md5 79c7cb3f8afaff076fb20bad75b37cc9 \
        sha1 486fe1c9a6c5cfc32401e72728ff821a50a22cf9 \
        rmd160 c819db7f739b8ca468c8059dfbac31a6a6965938

pre-fetch {
    if { [string compare ${os.endian} "big"] != 0 } {
        return -code error "${name} is only available for PowerPC-based Macs at this time. Oracle says they will release a version for Intel-based Macs in Q1 CY2008."
    }
}

use_configure           no
universal_variant       no

set lib_dir ${prefix}/lib/oracle

build {
    # The pre-built libraries use weird prefixes like /b/729/rdbms and Oracle
    # recommends setting DYLD_LIBRARY_PATH to deal with this. I find that ill-
    # advised and would rather fix the paths in the libraries at install time.
    
    # For each dylib in the distribution, change the directory of its own
    # "soname" to our ${lib_dir}.
    foreach lib [glob -directory ${worksrcpath} *.dylib*] {
        system "install_name_tool -id ${lib_dir}/[strsed ${lib} /^.*\\///] ${lib}"
        
        # Then for each dependent dylib with a weird path that this dylib
        # references, fix the reference to use our ${lib_dir}.
        foreach dep [exec otool -L ${lib}] {
            if [string match "/b/729/*" ${dep}] {
                system "install_name_tool -change ${dep} ${lib_dir}/[strsed ${dep} /^.*\\///] ${lib}"
            }
        }
    }
}

destroot {
    xinstall -d ${destroot}${lib_dir}
    eval xinstall \
        [glob -directory ${worksrcpath} *.dylib*] \
        [glob -directory ${worksrcpath} *.jar] \
        ${destroot}${lib_dir}
    
    # php5 +oracle complains without this symlink.
    ln -s libclntsh.dylib.10.1 ${destroot}${lib_dir}/libclntsh.dylib
    
    # You would think the includes should go in ${prefix}/include/oracle, but
    # the instantclient layout wants it in ${prefix}/lib/oracle/sdk/include
    xinstall -d ${destroot}${lib_dir}/sdk
    copy ${worksrcpath}/sdk/include ${destroot}${lib_dir}/sdk
}
