# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

name                redis
version             2.0.4
revision            0
categories          databases
platforms           darwin

maintainers         gmail.com:brianjlandau openmaintainer

description         Redis is an open source, advanced key-value store.
long_description    ${description}

homepage            http://redis.io/
master_sites        googlecode:redis

checksums           md5     60656113efb6759ab644d7495629d90b \
                    sha1    fee2f1960eda22385503517a9a6dcae610df84d5 \
                    rmd160  e8ae60e9c5cf79b2f81233bfa6516659fea3983f

patchfiles          redis.c.diff

use_configure       no

build.env-append    CC=${configure.cc}

post-build {
    copy ${filespath}/redis.conf.sample.in ${workpath}/redis.conf.sample
    copy ${filespath}/redis-daemon.conf.sample.in ${workpath}/redis-daemon.conf.sample
    reinplace "s|@PREFIX@|${prefix}|g" \
        ${workpath}/redis.conf.sample \
        ${workpath}/redis-daemon.conf.sample
}

destroot.keepdirs   ${destroot}${prefix}/var/db/redis

destroot {
    xinstall -d ${destroot}${prefix}/var/db/redis
    xinstall -m 0755 -W ${worksrcpath} \
        redis-benchmark \
        redis-cli \
        redis-server \
        ${destroot}${prefix}/bin
    xinstall -m 0644 -W ${workpath} \
        redis.conf.sample \
        redis-daemon.conf.sample \
        ${destroot}${prefix}/etc
}

post-activate {
    if {![file exists ${prefix}/etc/redis-daemon.conf]} {
        file copy ${prefix}/etc/redis-daemon.conf.sample \
            ${prefix}/etc/redis-daemon.conf
    }
    if {![file exists ${prefix}/etc/redis.conf]} {
        file copy ${prefix}/etc/redis.conf.sample \
            ${prefix}/etc/redis.conf
    }
    xinstall -d ${prefix}/var/log
    touch ${prefix}/var/log/redis.log
}

startupitem.create  yes
startupitem.start   "${prefix}/bin/redis-server ${prefix}/etc/redis-daemon.conf"
startupitem.stop    "echo \"SHUTDOWN\" | nc localhost 6379"

notes "
To start up a redis server instance use this command:

    redis-server ${prefix}/etc/redis.conf
"
