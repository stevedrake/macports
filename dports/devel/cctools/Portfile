# $Id$

PortSystem              1.0
name                    cctools
version                 822
categories              devel
platforms               darwin
maintainers             mfeiri openmaintainer
license                 {APSL-2.0 GPL-2+}
description             Compiler Tools for Mac OS X and Darwin
long_description        A set of essential tools to support development \
                        on Mac OS X and Darwin. Conceptually similar \
                        similar to binutils on other platforms.

homepage                http://opensource.apple.com/source/${name}/
master_sites            http://opensource.apple.com/tarballs/${name}/

checksums               rmd160  1caf207acbf421cdc975926a392fc75dc1d2594c \
                        sha256  dfaa9bdbd023524d47429674f64d2d5ea393123dabf90868be0aa17f61f45289

depends_lib             port:cctools-headers
depends_build           path:lib/libprunetrie.a:ld64
patchfiles              patch-misc_libtool.c.diff patch-misc_Makefile.diff patch-libmacho_Makefile.diff

use_configure           no
destroot.args           DSTROOT=${destroot}${prefix} RC_ProjectSourceVersion=${version}


if {${os.major} < 9} {
    pre-fetch {
        ui_error "${name} requires Mac OS X 10.5 or later."
        return -code error "incompatible Mac OS X version"
    }
}

platform darwin 9 {
    version             698.1
    distname            cctools-${version}
    checksums           rmd160  898c7b46869d4989c115420912fdd8d96ae923d3 \
                        sha256  383f1c0c78a2b3efdfdf7ce01adb7e2f8ee9985164dba6ab1c0fae800a211cec
    patchfiles          patch-misc_libtool.c.diff patch-ld_ld.c.diff

    build {}

    post-destroot {

        foreach x "bin include lib libexec" {
            file delete -force ${destroot}${prefix}/${x}
            file rename -force ${destroot}${prefix}/usr/local/${x} ${destroot}${prefix}/
        }

        file delete -force ${destroot}${prefix}/share
        file rename -force ${destroot}${prefix}/usr/share ${destroot}${prefix}/

        file rename -force ${destroot}${prefix}/usr/local/efi/bin/mtoc ${destroot}${prefix}/bin/
        file rename -force ${destroot}${prefix}/usr/local/efi/share/man/man1/mtoc.1 ${destroot}${prefix}/share/man/man1/

        foreach x [glob ${destroot}${prefix}/usr/bin/*] {
            file rename -force ${x} ${destroot}${prefix}/bin/
        }
        foreach x [glob ${destroot}${prefix}/usr/local/man/man1/*] {
            file rename -force ${x} ${destroot}${prefix}/share/man/man1/
        }
        foreach x [glob ${destroot}${prefix}/usr/local/man/man3/*] {
            file rename -force ${x} ${destroot}${prefix}/share/man/man3/
        }
        foreach x [glob ${destroot}${prefix}/usr/libexec/gcc/darwin/*] {
            file rename -force ${x} ${destroot}${prefix}/libexec/gcc/darwin/
        }

        file delete -force ${destroot}${prefix}/usr
        file delete -force ${destroot}${prefix}/Developer
    }
}

platform darwin 10 {
    version             809
    distname            cctools-${version}
    checksums           rmd160  f433124035ac0ef403bdc6edec087bdedd0b4375 \
                        sha256  03ba62749b843b131c7304a044a98c6ffacd65b1399b921d69add0375f79d8ad

    post-destroot {
        
        foreach x "bin include lib libexec" {
            file delete -force ${destroot}${prefix}/${x}
            file rename -force ${destroot}${prefix}/usr/local/${x} ${destroot}${prefix}/
        }
        
        file delete -force ${destroot}${prefix}/share
        file rename -force ${destroot}${prefix}/usr/share ${destroot}${prefix}/
        
        file rename -force ${destroot}${prefix}/usr/local/efi/bin/mtoc ${destroot}${prefix}/bin/
        file rename -force ${destroot}${prefix}/usr/local/efi/share/man/man1/mtoc.1 ${destroot}${prefix}/share/man/man1/
        
        foreach x [glob ${destroot}${prefix}/usr/bin/*] {
            file rename -force ${x} ${destroot}${prefix}/bin/
        }
        foreach x [glob ${destroot}${prefix}/usr/local/man/man1/*] {
            file rename -force ${x} ${destroot}${prefix}/share/man/man1/
        }
        foreach x [glob ${destroot}${prefix}/usr/local/man/man3/*] {
            file rename -force ${x} ${destroot}${prefix}/share/man/man3/
        }
        foreach x [glob ${destroot}${prefix}/usr/lib/system/*] {
            file rename -force ${x} ${destroot}${prefix}/lib/system/
        }
        foreach x [glob ${destroot}${prefix}/usr/libexec/as/*] {
            file rename -force ${x} ${destroot}${prefix}/libexec/as/
        }
    
        file delete -force ${destroot}${prefix}/usr
    }
}

platform darwin 11 {
    post-destroot {
        
        foreach x "bin include lib libexec" {
            file delete -force ${destroot}${prefix}/${x}
            file rename -force ${destroot}${prefix}/usr/local/${x} ${destroot}${prefix}/
        }
        
        file delete -force ${destroot}${prefix}/share
        file rename -force ${destroot}${prefix}/usr/share ${destroot}${prefix}/
        
        file rename -force ${destroot}${prefix}/usr/local/efi/bin/mtoc ${destroot}${prefix}/bin/
        file rename -force ${destroot}${prefix}/usr/local/efi/share/man/man1/mtoc.1 ${destroot}${prefix}/share/man/man1/
        
        foreach x [glob ${destroot}${prefix}/usr/bin/*] {
            file rename -force ${x} ${destroot}${prefix}/bin/
        }
        foreach x [glob ${destroot}${prefix}/usr/local/man/man1/*] {
            file rename -force ${x} ${destroot}${prefix}/share/man/man1/
        }
        foreach x [glob ${destroot}${prefix}/usr/local/man/man3/*] {
            file rename -force ${x} ${destroot}${prefix}/share/man/man3/
        }
        foreach x [glob ${destroot}${prefix}/usr/lib/system/*] {
            file rename -force ${x} ${destroot}${prefix}/lib/system/
        }
        foreach x [glob ${destroot}${prefix}/usr/libexec/as/*] {
            file rename -force ${x} ${destroot}${prefix}/libexec/as/
        }
    
        file delete -force ${destroot}${prefix}/usr
    }
}

livecheck.type          regex
livecheck.regex         "${name}-(\[\\d.\]+)"
