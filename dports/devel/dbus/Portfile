# $Id$

PortSystem      1.0

name            dbus
version         1.1.20
revision        2
maintainers     nomaintainer
categories      devel
platforms       darwin
description     A message bus system, a simple way for applications to talk to one another.

long_description \
    ${description}

homepage        http://www.freedesktop.org/Software/dbus
master_sites    http://dbus.freedesktop.org/releases/dbus

checksums       md5 c552b9bc4b69e4c602644abc21b7661e \
                sha1 fff5db438483e6b4a3c40d430b20baa49ad2d58a \
                rmd160 da06f0fca2e83e9ea3af6fa14045a69b97435221

depends_build   port:pkgconfig

depends_lib     port:expat

patchfiles      patch-tools-dbus-launch.c.diff

pre-patch {
    file mkdir ${worksrcpath}/m4
    system "touch ${worksrcpath}/m4/acx_pthread.m4"
}

# Fixes to be removed post 1.1.20
patchfiles-append   patch-dbus-dbus-sysdeps.c.diff
post-patch {
    reinplace "s|-Wl,-z,relro||g" ${worksrcpath}/configure
    reinplace "s|ucred.h|sys/ucred.h|g" ${worksrcpath}/dbus/dbus-sysdeps-unix.c
}

configure.args  --mandir=${prefix}/share/man \
                --disable-tests \
                --disable-doxygen-docs \
                --disable-xml-docs \
                --enable-kqueue \
                --without-x \
                --with-dbus-daemondir=${prefix}/bin
    
configure.cflags-append -no-cpp-precomp
configure.cflags-append -flat_namespace

use_parallel_build  yes

test.run        yes
test.target     check

pre-test {
    if {![variant_isset test]} {
        ui_error "test variant must be activated to enable test support."
        error "Please enable test variant."
    }
}

post-destroot {
    file mkdir ${destroot}${prefix}/share/dbus-1/services
    file mkdir ${destroot}${prefix}/var/run/dbus
    file mkdir ${destroot}${prefix}/var/lib/dbus
    file mkdir ${destroot}${prefix}/etc/dbus-1/system.d
    file mkdir ${destroot}${prefix}/etc/dbus-1/session.d
}

destroot.keepdirs \
    ${destroot}${prefix}/share/dbus-1/services \
    ${destroot}${prefix}/var/run/dbus \
    ${destroot}${prefix}/var/lib/dbus \
    ${destroot}${prefix}/etc/dbus-1/system.d \
    ${destroot}${prefix}/etc/dbus-1/session.d

startupitem.create  yes
startupitem.name    dbus
startupitem.init    XDG_DATA_DIRS=${prefix}/share
startupitem.start   "${prefix}/bin/dbus-daemon --system"
startupitem.stop    "kill `cat ${prefix}/var/run/dbus/pid`"
startupitem.restart "kill `cat ${prefix}/var/run/dbus/pid` ; ${prefix}/bin/dbus-daemon --system"

pre-activate {
    addgroup messagebus
    adduser messagebus gid=[existsgroup messagebus] realname=Message\ Bus
}

post-activate {
    file attributes ${prefix}/var/run/dbus -group messagebus -owner messagebus
    file attributes ${prefix}/libexec/dbus-daemon-launch-helper -group messagebus
    system "${prefix}/bin/dbus-uuidgen --ensure"
}

variant test {
    configure.args-delete   --disable-tests
    configure.args-append   --enable-tests
}

platform darwin 7 {
    configure.args-delete   --enable-kqueue
}

livecheck.check regex
livecheck.regex {D-Bus (\d+(?:\.\d+)*)</a>}
