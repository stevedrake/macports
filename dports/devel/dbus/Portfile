# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:filetype=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem      1.0

name            dbus
version         1.2.4
revision        2
maintainers     nomaintainer
categories      devel
platforms       darwin
description     A message bus system, a simple way for applications to talk to one another.

long_description \
    ${description}

homepage        http://www.freedesktop.org/Software/dbus
master_sites    http://dbus.freedesktop.org/releases/dbus

checksums       md5     2e643910a09f44b000a0d76038637999 \
                sha1    913d796b79802b6ee6ca2b0ef59c670f3fd79774 \
                rmd160  0441eb8b668ed70250e484b02fe6a83c05c9a088
                
patchfiles      patch-dbus-launch-x11.c.diff

depends_build   port:pkgconfig

depends_lib     port:expat \
                lib:libX11:XFree86

configure.args  --disable-doxygen-docs \
                --disable-xml-docs \
                --with-x \
                --x-includes=${x11prefix}/include \
                --x-libraries=${x11prefix}/lib
    
configure.cflags-append -no-cpp-precomp -flat_namespace

use_parallel_build  yes

test.run        yes
test.target     check

pre-test {
    if {![variant_isset test]} {
        ui_error "test variant must be activated to enable test support."
        error "Please enable test variant."
    }
}

post-destroot {
    foreach dir ${destroot.keepdirs} {
        file mkdir $dir
    }
}

destroot.keepdirs \
    ${destroot}${prefix}/share/dbus-1/services \
    ${destroot}${prefix}/var/run/dbus \
    ${destroot}${prefix}/var/lib/dbus \
    ${destroot}${prefix}/etc/dbus-1/system.d \
    ${destroot}${prefix}/etc/dbus-1/session.d

startupitem.create  yes
startupitem.name    dbus
startupitem.init    XDG_DATA_DIRS=${prefix}/share
startupitem.start   "${prefix}/bin/dbus-daemon --system"
startupitem.stop    "kill `cat ${prefix}/var/run/dbus/pid`"
startupitem.restart "kill `cat ${prefix}/var/run/dbus/pid` ; ${prefix}/bin/dbus-daemon --system"

pre-activate {
    addgroup messagebus
    adduser messagebus gid=[existsgroup messagebus] realname=Message\ Bus
}

post-activate {
    file attributes ${prefix}/var/run/dbus -group messagebus -owner messagebus
    file attributes ${prefix}/libexec/dbus-daemon-launch-helper -group messagebus
    system "dbus-uuidgen --ensure"
}

variant test description {enable tests} {
    configure.args-append   --enable-tests
}

variant no_x11 description {disable X11 support} {
    configure.args-delete --with-x
    configure.args-append --without-x
    depends_lib-delete    lib:libX11:XFree86
}

livecheck.check regex
livecheck.regex {D-Bus (\d+(?:\.\d+)*)}
