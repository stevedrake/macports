# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

name                fossil
version             20110528185122
categories          devel
platforms           darwin
license             BSD
maintainers         ciserlohn

description         Simple, high-reliability, distributed software configuration management

long_description    Fossil is a distributed software configuration management which supports \
                    distributed version control, distributed bug tracking, distributed wiki, \
                    and a distributed blog mechanism all in single integrated package. It provides \
                    an easy-to-use web interface to access and administrate projects over the \
                    built-in webserver or CGI.

homepage            http://www.fossil-scm.org/

master_sites        ${homepage}download/
distname            ${name}-src-${version}

checksums           sha1    3225080b4e9a8542fced48d8797a8eaef26ef17d \
                    rmd160  3301f3e962c9b9a3304b135de03342ad0ba0da79

test.run            yes

depends_build       port:tcl

depends_lib         port:zlib \
                    port:openssl

patchfiles          patch-Makefile.diff \
                    patch-src-makemake.tcl.diff

post-extract {
    reinplace s|\$\(INSTALLDIR\)|\$(DESTDIR)/${prefix}/bin|g ${worksrcpath}/src/makemake.tcl
}

configure {
    system "cd ${worksrcpath}/src && tclsh ${worksrcpath}/src/makemake.tcl"
}

if {[variant_isset universal]} {
    set archflags ${configure.universal_cflags}
} else {
    set archflags ${configure.cc_archflags}
}

build.args-append   CC="${configure.cc} ${archflags}" \
                    CFLAGS=${configure.cflags} \
                    LDFLAGS=${configure.ldflags}

post-destroot {
    set docdir ${destroot}${prefix}/share/doc/${name}
    xinstall -d ${docdir}
    xinstall -m 644 -W ${worksrcpath} \
        COPYRIGHT-BSD2.txt \
        ci_cvs.txt \
        ci_fossil.txt \
        cvs2fossil.txt \
        rse-notes.txt \
        ${docdir}
}

post-activate {

    ui_msg "* Trying to rebuild known repositories:" 

    set exec_cmd exec
    set fossil_list {fossil all list}
    set fossil_rebuild {fossil rebuild}

    if [catch {eval $exec_cmd $fossil_list} repositories] {
        ui_error "failed to execute $fossil_list"
    }

    if [llength $repositories] {
        foreach repo $repositories {
            if {![catch {eval $exec_cmd $fossil_rebuild $repo} result]} {
                ui_msg "* successfully rebuild $repo"
            } else {
                ui_msg "* failed to rebuild $repo"
            }
        }
    } else {
        ui_msg "* No repositories found"
    }

    ui_msg "* Finished rebuilding repositories"

}

notes {
    ************************************************
    * It is recommended to rebuild repositories    *
    * created with earlier versions of fossil.     *
    * To rebuild a repository run:                 *
    * fossil rebuild /<path>/<to>/<repository>     *
    * Rebuilding a repository is a safe operation, *
    * executing it more then once will not harm    *
    * the integrity of a repository.               *
    ************************************************
}

livecheck.type      regex
livecheck.url       ${homepage}/download.html
livecheck.regex     ${name}-src-(\\d{14})${extract.suffix}
