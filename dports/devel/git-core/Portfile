# $Id$

PortSystem        1.0
name              git-core
version           1.5.2.4
revision          1
description       The stupid content tracker.
long_description  A stupid (but extremely fast) directory content manager. \
                  It doesn't do a whole lot, but what it _does_ do is track \
                  directory contents efficiently.
maintainers       bryan@larsen.st mgrimes
categories        devel
platforms         darwin
homepage          http://git.or.cz/
use_bzip2         yes
master_sites      http://www.kernel.org/pub/software/scm/git/
distname          git-${version}
distfiles         git-${version}${extract.suffix} \
                  git-manpages-${version}${extract.suffix}
 
checksums    git-${version}${extract.suffix} sha1 54842b00bf66de555ce82b3abfd2eb5f0aeb0bea \
             git-manpages-${version}${extract.suffix} sha1 cc52c3dd5550f357d42d23fd3240335254d2a245

depends_run  port:curl port:openssh port:rsync
depends_lib  port:curl port:zlib port:openssl port:expat port:libiconv

patchfiles   patch-Documentation_Makefile patch-Makefile patch-http.h

extract.only   git-${version}${extract.suffix} \
               git-manpages-${version}${extract.suffix}

use_configure  no

build.env      CFLAGS="-Wall -O2 -I${prefix}/include" LDFLAGS="-L${prefix}/lib"
build.args     prefix=${prefix} CURLDIR=${prefix} OPENSSLDIR=${prefix} ICONVDIR=${prefix} \
               PERL_PATH="/usr/bin/env perl" NO_FINK=1 NO_DARWIN_PORTS=1

test.run       yes
test.cmd       make
test.target    test
test.dir       ${worksrcpath}
test.args      prefix=${prefix} CURLDIR=${prefix} OPENSSLDIR=${prefix} ICONVDIR=${prefix} \
               PERL_PATH="/usr/bin/env perl" NO_FINK=1 NO_DARWIN_PORTS=1

destroot.destdir  DESTDIR=${destroot} prefix=${prefix}
destroot.target   install
destroot.args     prefix=${prefix} CURLDIR=${prefix} OPENSSLDIR=${prefix} ICONVDIR=${prefix} \
                  PERL_PATH="/usr/bin/env perl" NO_FINK=1 NO_DARWIN_PORTS=1

post-destroot {
    cd ${workpath}
    foreach f {1 5 7} {
        xinstall -d ${destroot}${prefix}/share/man/man${f}
        foreach m [glob man${f}/*.${f}] {
            xinstall ${m} ${destroot}${prefix}/share/man/man${f}
        }
    }
    if {![variant_isset svn]} {
        system "rm ${destroot}${prefix}/bin/git-svn*"
    }
    if {[variant_isset doc]} {
        set docdestroot ${destroot}${prefix}/share/doc/${name}
        xinstall -d ${docdestroot}
        cd ${docdestroot}
        system "${extract.cmd} ${extract.pre_args} \
            ${distpath}/git-htmldocs-${version}${extract.suffix} \
            ${extract.post_args}"
    }
}

variant doc description (Install HTML and plaintext documentation} {
    distfiles-append    git-htmldocs-${version}${extract.suffix}
    checksums-append    git-htmldocs-${version}${extract.suffix} sha1 14bf076457a7cd94ffb5c46f50c923d38d77fc17
}

variant svn {
    depends_run     port:subversion port:perl \
                    port:p5-error port:p5-libwww-perl port:p5-svn-simple port:p5-term-readkey
}

platform darwin 9 {
    # Provision until Ticket #12245 is resolved. Built-in openssh will suffice.
    depends_run-delete     port:openssh
}
