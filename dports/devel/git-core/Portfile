# -*- coding: utf-8; mode: tcl; tab-width: 4; truncate-lines: t; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:et:sw=4:ts=4:sts=4
# $Id$

PortSystem        1.0

name              git-core
version           1.7.3
description       A fast version control system
long_description  Git is a fast, scalable, distributed open source version \
                  control system focusing on speed and efficiency.
maintainers       gmail.com:maccheck openmaintainer
categories        devel
platforms         darwin
homepage          http://git-scm.com
use_bzip2         yes
master_sites      http://www.kernel.org/pub/software/scm/git/
distname          git-${version}
distfiles         git-${version}${extract.suffix} \
                  git-manpages-${version}${extract.suffix}

checksums    git-${version}${extract.suffix} \
                    md5     c18eb252ce63a688071f10c3f7bc28e1 \
                    sha1    32e231fd10b85265487f0c2cc50d6d889b71de78 \
                    rmd160  4b0f95b4d114f5b7a4eb61c0f73b2f9a533637a0 \
             git-manpages-${version}${extract.suffix} \
                    md5     d18d8f686fde24d1262ccbe61ad00ae0 \
                    sha1    725ff48e7de80fe56556af3f5162be4e0648db61 \
                    rmd160  97a8ae1ef8297e12ece2a3307547d0e73237920c

depends_run  port:rsync port:p5-error
depends_lib  path:bin/perl:perl5 port:curl port:zlib port:openssl port:expat port:libiconv port:python26

patchfiles   patch-Makefile.diff

extract.only   git-${version}${extract.suffix} \
               git-manpages-${version}${extract.suffix}

use_configure  no

set CFLAGS     "-Wall -O2 -I${prefix}/include ${configure.cc_archflags}"
set LDFLAGS    "-L${prefix}/lib"

build.args     CFLAGS="${CFLAGS}" LDFLAGS="${LDFLAGS}" \
               CC=${configure.cc} \
               prefix=${prefix} CURLDIR=${prefix} OPENSSLDIR=${prefix} ICONVDIR=${prefix} \
               PERL_PATH="${prefix}/bin/perl" PYTHON_PATH="${prefix}/bin/python2.6" NO_FINK=1 NO_DARWIN_PORTS=1 \
               NO_R_TO_GCC_LINKER=1

test.run       yes
test.cmd       make
test.target    test
test.dir       ${worksrcpath}
test.args      prefix=${prefix} CURLDIR=${prefix} OPENSSLDIR=${prefix} ICONVDIR=${prefix} \
               PERL_PATH="${prefix}/bin/perl" NO_FINK=1 NO_DARWIN_PORTS=1

destroot.destdir  DESTDIR=${destroot} prefix=${prefix}
destroot.target   install
destroot.args     CFLAGS="${CFLAGS}" LDFLAGS="${LDFLAGS}" \
                  prefix=${prefix} CURLDIR=${prefix} OPENSSLDIR=${prefix} ICONVDIR=${prefix} \
                  PERL_PATH="${prefix}/bin/perl" NO_FINK=1 NO_DARWIN_PORTS=1 \
                  NO_R_TO_GCC_LINKER=1

post-destroot {
    foreach f {1 5 7} {
        xinstall -d ${destroot}${prefix}/share/man/man${f}
        foreach m [glob -directory ${workpath} man${f}/*.${f}] {
            xinstall ${m} ${destroot}${prefix}/share/man/man${f}
        }
    }
    if {![variant_isset svn]} {
        system "rm ${destroot}${prefix}/libexec/git-core/git-svn*"
    }
    set docdestroot ${destroot}${prefix}/share/doc/${name}
    xinstall -d ${docdestroot}
    if {[variant_isset doc]} {
        system "cd ${docdestroot} && ${extract.cmd} ${extract.pre_args} \
            ${distpath}/git-htmldocs-${version}${extract.suffix} \
            ${extract.post_args}"
    }

    file copy ${worksrcpath}/contrib ${docdestroot}

    foreach badfile [exec find ${destroot} -name perllocal.pod] {
        ui_info "Removing ${badfile}"
        file delete ${badfile}
    }
}

variant doc description {Install HTML and plaintext documentation} {
    distfiles-append    git-htmldocs-${version}${extract.suffix}
    checksums-append    git-htmldocs-${version}${extract.suffix} \
                    md5     0a90e969db9a4e6b73b395cf19255b0b \
                    sha1    3dcfe85ad9f711404c3989bb3280f92635c75946 \
                    rmd160  cf391a7a6afcf249e7254d2f2aad8ea1be722bab
}

variant gitweb description {Install gitweb.cgi} {
    build.target-append        gitweb/gitweb.cgi

    post-destroot {
        xinstall -d ${destroot}${prefix}/share/${name}/gitweb
        xinstall -W ${worksrcpath}/gitweb \
            gitweb.cgi \
            ${destroot}${prefix}/share/${name}/gitweb
        xinstall -m 444 -W ${worksrcpath}/gitweb/static \
            gitweb.css \
            gitweb.js \
            git-favicon.png \
            git-logo.png \
            ${destroot}${prefix}/share/${name}/gitweb
        xinstall -d ${destroot}${prefix}/share/doc/${name}/gitweb
        xinstall -m 444 -W ${worksrcpath}/gitweb README INSTALL \
            ${destroot}${prefix}/share/doc/${name}/gitweb
    }
}

variant svn description {Bi-directional subversion repository support} {
    depends_run-append  port:subversion port:p5-libwww-perl port:p5-svn-simple port:p5-term-readkey
}

variant bash_completion {
    depends_run-append  port:bash-completion

    post-destroot {
        xinstall -d ${destroot}${prefix}/etc/bash_completion.d
        xinstall -m 644 ${worksrcpath}/contrib/completion/git-completion.bash \
            ${destroot}${prefix}/etc/bash_completion.d/git
    }
}

default_variants    +doc

livecheck.type          regex
livecheck.regex         {<div id="ver">v([0-9.]+)}
