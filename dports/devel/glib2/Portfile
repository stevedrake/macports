# $Id$

PortSystem              1.0

name                    glib2
set my_name             glib
version                 2.16.4
revision                1
set branch              [join [lrange [split ${version} .] 0 1] .]
categories              devel
maintainers             ryandesign
homepage                http://www.gtk.org/
platforms               darwin
distname                ${my_name}-${version}
use_bzip2               yes
use_parallel_build      yes

description \
    Library with data structure functions and other constructs

long_description \
    Glib is a library which includes support routines for \
    C, such as lists, trees, hashes, memory allocation, and \
    many other things.

master_sites \
    ftp://ftp.gtk.org/pub/${my_name}/${branch}/ \
    gnome:sources/${my_name}/${branch}/

checksums \
    md5 2ab79b3c93258827cc6ea8ee50128e49 \
    sha1 8d0d71a863f9db18b0c581b6382d37719ae3df50 \
    rmd160 d154f778cde25cc6ae1418c6d296e1b2ec71be62

patchfiles \
    patch-glib-2.0.pc.in.diff \
    patch-gutils.c.diff \
    patch-gi18n.h.diff

depends_build \
    port:pkgconfig

depends_lib \
    port:gettext \
    port:libiconv

configure.ldflags-append \
    -bind_at_load

configure.cflags-append \
    -funroll-loops \
    -fstrict-aliasing

configure.args \
    --enable-static \
    --mandir=${prefix}/share/man

platform puredarwin {
    depends_run bin:perl:perl5.8
}

post-patch {
    reinplace "s|data_dirs = \"/usr|data_dirs = \"${prefix}/share:/usr|g" ${worksrcpath}/glib/gutils.c
    reinplace "s|path = \"/bin|path = \"${prefix}/bin:/bin|g" ${worksrcpath}/glib/gutils.c ${worksrcpath}/glib/gspawn.c
}

platform darwin {
    patchfiles-append patch-configure.diff
}

platform powerpc {
    if {[variant_isset universal]} {
        post-configure {
            reinplace {s|^#define G_ATOMIC_POWERPC 1$|#undef G_ATOMIC_POWERPC|} ${worksrcpath}/config.h
        }
    }
}

post-destroot {
    file delete ${destroot}${prefix}/lib/charset.alias
}

platform darwin 6 {
    depends_lib-append lib:libdl:dlcompat
    post-configure {
        reinplace "s|#define HAVE_WCHAR_T 1|#undef HAVE_WCHAR_T|" \
            ${worksrcpath}/config.h
    }
}

platform darwin 9 {
    patchfiles-append patch-glib_gutils.h.diff
}

livecheck.check         regex
livecheck.url           http://ftp.gnome.org/pub/GNOME/sources/${my_name}/${branch}/?C=M&O=D
livecheck.regex         ${my_name}-(\[0-9.\]+)\\.tar
