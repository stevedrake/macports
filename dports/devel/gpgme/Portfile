# $Id$

PortSystem          1.0

name                gpgme
version             1.2.0
categories          devel security crypto
maintainers         boeyms openmaintainer
description         A library for easy acces to GnuPG.
long_description \
    GnuPG Made Easy (GPGME) is a library designed to make access \
    to GnuPG easier for applications. It provides a High-Level \
    Crypto API for encryption, decryption, signing, signature \
    verification and key management. Currently it uses GnuPG \
    as its backend but the API isn't restricted to this engine \
    in fact we have already developed a backend for CMS (S/MIME).

platforms           darwin

homepage            http://www.gnupg.org/related_software/gpgme/
master_sites        gnupg
use_bzip2           yes

checksums           md5     508ee686bd275d908d1dc1938810e045 \
                    sha1    2f4f6c4b85f2b5a2c4dcf2167342ed6c41efcd1c \
                    rmd160  1bc3e7b432cf8ff1c22cdbc8fbe3d1dc36a3c447

#patchfiles          patch-assuan_assuan.h.diff

depends_lib         port:gnupg port:pth port:libgpg-error

use_parallel_build  no

post-patch {
    reinplace "s|thread_modules=\"\"|thread_modules=\"pthread\"|" ${worksrcpath}/src/gpgme-config.in
}

configure.args      --with-gpg=${prefix}/bin/gpg --enable-static

post-configure {
    if {[variant_isset universal]} {
        reinplace "s|CC -dynamiclib|CC -dynamiclib ${configure.universal_ldflags}|g" ${worksrcpath}/libtool
    }
}

test.run    yes
test.target check

post-destroot {
    xinstall -m 755 -d ${destroot}${prefix}/share/doc/${name}
    xinstall -m 644 -W ${worksrcpath} AUTHORS COPYING COPYING.LESSER \
        ChangeLog INSTALL NEWS README THANKS TODO \
        ${destroot}${prefix}/share/doc/${name}
}

platform darwin 7 {
    configure.env-append    LIBS="-lpth"
}

# S/MIME needs gpgsm which comes with gnupg2 only; so use all gnupg2 here
variant smime description {Enable S/MIME support} {
    depends_lib-append      port:gnupg2
    depends_lib-delete      port:gnupg
    configure.args-append   --with-gpg=${prefix}/bin/gpg2
}

livecheck.type  regex
livecheck.url   ftp://ftp.gnupg.org/gcrypt/gpgme/
livecheck.regex "${name}-(\\d+(?:\\.\\d+)*)${extract.suffix}"
