# $Id$

PortSystem 1.0

name		ice-python25
version		3.3.0
revision	1
categories	devel python
maintainers	blair
description	Fast, object-oriented RPC for C++, Java, Python, Ruby, PHP

long_description \
	The Internet Communications Engine (Ice) is a modern alternative to \
	object middleware such as CORBA or COM/DCOM/COM+, with support for \
	C++, C#, Java, PHP, Python, Ruby and Visual Basic. \
	Ice consists of the following packages. \
	Slice: The Specification Language for Ice.  Slice establishes a \
	contract between clients and servers, and is also used to describe \
	persistent data. \
	Slice Compilers: Slice specifications are compiled into various \
	programming languages. Ice supports C++, Java, C#, Visual Basic, PHP, \
	Python and Ruby.  Ice clients and servers work together, regardless \
	of the programming language. \
	Ice: The Ice core library manages all the communication tasks using a \
	highly efficient protocol (including protocol compression and support \
	for both TCP and UDP), provides a flexible thread pool for \
	multi-threaded servers. \
	This Port provides the Python bindings that sit on top of the C++ \
	Ice C++ runtime libraries.

homepage	http://www.zeroc.com/
master_sites	http://www.zeroc.com/download/Ice/3.3/:ice \
		http://www.zeroc.com/download/Protobuf/0.1/:ice-protobuf
dist_subdir	ice-cpp
distname	Ice-${version}
distfiles	${distname}${extract.suffix}:ice
patchfiles	patch-py.config.Make.rules.Darwin.diff \
		patch-config.TestUtil.py.diff \
		protobuf-patch-0.1.0.gz:ice-protobuf
checksums	Ice-${version}.tar.gz \
			md5 0500306d9cdbc0fbb553fbb529de557a \
			sha1 b599c3a4d1d3006b868bf2cbcd8e2a2d4575fb22 \
			rmd160 e85b37c93f12d9ae97c6b7b2f64f506fa051e4f8 \
		protobuf-patch-0.1.0.gz \
			md5 d5ac6485fd89c540fc9e3912f9595d58 \
			sha1sum 0f9d2e2c1c1601695339b4f621e18f40563e3fa0 \
			rmd160 9494f3f763c473b1ed0742eda49ae9dde18bea01
platforms	darwin

depends_lib	port:python25 \
		port:ice-cpp

post-patch {
	reinplace "s/-O2/-g -O2/" \
		${workpath}/Ice-${version}/py/config/Make.rules.Darwin

	reinplace "s#python Client.py#${prefix}/bin/python2.5 Client.py#" \
		${worksrcpath}/py/test/Slice/keyword/run.py
}

use_configure	no

build.dir	${worksrcpath}/py
build.target	prefix="${prefix}" \
		CC="${configure.cc}" \
		CXX="${configure.cxx}" \
		ICE_HOME="${prefix}" \
		PYTHON_HOME="${prefix}/Library/Frameworks/Python.framework/Versions/2.5" \
		PYTHON_VERSION=python2.5 \
		OPTIMIZE="yes" \
		all

test.run	yes
test.dir	${worksrcpath}/py
test.env	ICE_HOME=${prefix}
test.cmd	${prefix}/bin/python2.5
test.target	allTests.py

destroot.dir	${worksrcpath}/py
destroot.target	prefix="${destroot}${prefix}" \
		CC="${configure.cc}" \
		CXX="${configure.cxx}" \
		ICE_HOME="${prefix}" \
		PYTHON_HOME="${prefix}/Library/Frameworks/Python.framework/Versions/2.5" \
		PYTHON_VERSION=python2.5 \
		OPTIMIZE="yes" \
		install

post-destroot {
	set sharedir ${destroot}${prefix}/share
	set docdir ${sharedir}/doc/${name}

	delete ${destroot}${prefix}/slice

	xinstall -m 755 -d ${docdir}

	file mkdir ${destroot}${prefix}/lib/python2.5
	file rename ${destroot}${prefix}/python ${destroot}${prefix}/lib/python2.5/site-packages

	set cmd "${prefix}/bin/python2.5 \
		${prefix}/Library/Frameworks/Python.framework/Versions/2.5/lib/python2.5/compileall.py \
		${destroot}${prefix}/lib/python2.5/site-packages"
	ui_debug ${cmd}
	system ${cmd}

	set cmd "${prefix}/bin/python2.5 -O \
		${prefix}/Library/Frameworks/Python.framework/Versions/2.5/lib/python2.5/compileall.py \
		${destroot}${prefix}/lib/python2.5/site-packages"
	ui_debug ${cmd}
	system ${cmd}

	file rename ${destroot}${prefix}/ICE_LICENSE ${docdir}
	file rename ${destroot}${prefix}/LICENSE ${docdir}
	foreach f {CHANGES RELEASE_NOTES} {
		file copy ${worksrcpath}/${f} ${docdir}
	}
	file copy ${worksrcpath}/py/INSTALL ${docdir}

	if {[variant_isset demo_source_code]} {
		file copy ${worksrcpath}/py/demo ${docdir}
	}
}

variant demo_source_code description {Install demonstration Python code} {
}
