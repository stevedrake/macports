# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:filetype=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem      1.0
PortGroup       muniversal 1.0

name            icu
set my_name     icu4c
version         4.4.2
categories      devel textproc
platforms       darwin freebsd
maintainers     nox openmaintainer
description     International Components for Unicode

long_description \
    The International Components for Unicode (ICU) libraries provide robust \
    and full-featured Unicode services on a wide variety of platforms. ICU \
    supports the most current version of the Unicode standard, and they provide \
    support for supplementary Unicode characters (needed for GB 18030 repertoire support).

homepage        http://www.icu-project.org/
master_sites    http://download.icu-project.org/files/${my_name}/${version}/

distname        ${my_name}-[join [split ${version} .] _]
extract.suffix  .tgz
distfiles       ${distname}-src${extract.suffix}
patchfiles      patch-configure.diff \
                patch-config-mh-darwin.diff \
                patch-Makefile.in.diff
checksums       ${distname}-src${extract.suffix} \
                md5     314e582264c36b3735466c522899aa07 \
                sha1    adc19231810eff2836a08b0e1f1a31a128d7a834 \
                rmd160  eb228e6fa9606855bbd881d98da738a61d72b74b

worksrcdir      ${name}/source
set docdir      ${prefix}/share/doc/${name}

pre-fetch {
    if {[variant_isset universal]} {
        if {${os.platform} != "darwin"} {
            return -code error "Sorry, building universal ICU library is not supported on your platform."
        }
        if {${build_arch} != "x86_64"} {
            return -code error "Sorry, building universal ICU library is now supported on x86_64 Macs only."
        }
    }
}

post-patch {
    reinplace "s|__PREFIX__|${prefix}|g" ${worksrcpath}/config/mh-darwin
    reinplace "s|__DATE__|[exec date]|g" ${worksrcpath}/Makefile.in
}

set platform [switch ${os.platform} {darwin {format MacOSX} freebsd {format FreeBSD}}]
configure.cmd   ./runConfigureICU ${platform}

configure.args  --mandir=${prefix}/share/man \
                --enable-static \
                --disable-samples

configure.universal_args-delete --disable-dependency-tracking

# Fix bug #11981 that prevents ICU from building when upgrading.
# The default configure flags causes utilisation of outdated ICU
# headers/libs instead of the right ones.
configure.cppflags
configure.ldflags

# Disable ccache, #23931
configure.ccache no

build.type      gnu

use_parallel_build  yes

test.run        yes
test.target     check

post-build {
    if {[variant_isset universal]} {
        set dirs {}
        foreach arch ${universal_archs_to_use} {
            lappend dirs ${worksrcpath}-${arch}
        }
    } else {
        set dirs ${worksrcpath}
    }
    foreach dir ${dirs} {
        reinplace -E {s|-arch [a-z0-9_]+||g} \
            ${dir}/config/icu-config \
            ${dir}/config/Makefile.inc \
            ${dir}/config/pkgdata.inc
    }
}

post-destroot {
    xinstall -d ${destroot}${docdir}
    eval xinstall -m 0644 [glob ${worksrcpath}/../*.{css,html,txt}] ${destroot}${docdir}
}

# The official doc archive seems to be a bit incomplete.
# (For examples, it doesn't contain any files in 'search/' directory.)
variant doc conflicts with_doxygen description {Install extra documentation} {
    depends_extract-append bin:unzip:unzip
    extract.only        ${distname}-src${extract.suffix}
    distfiles-append    ${distname}-docs.zip
    checksums-append    ${distname}-docs.zip \
                        md5     2312c2f5292c39dd01836d95e018efa6 \
                        sha1    fc913f674366f9f36000f6e01f305f3cfc146695 \
                        rmd160  5f354d9dfded256e28d66e6b8c189d15028eeab6

    post-extract {
        xinstall -m 0755 -d ${worksrcpath}/doc/html
        system "unzip -q ${distpath}/${distname}-docs.zip -d ${worksrcpath}/doc/html"
    }

    post-destroot {
        xinstall -m 0755 -d ${destroot}${docdir}/html/search
        eval xinstall -m 0644 [glob ${worksrcpath}/doc/html/*] ${destroot}${docdir}/html
        #eval xinstall -m 0644 [glob ${worksrcpath}/doc/html/search/*] ${destroot}${docdir}/html/search
    }
}

variant with_doxygen conflicts doc universal description {Build and install API documentation} {
    depends_build port:doxygen
    post-build {
        system "cd ${worksrcpath} && ${build.cmd} doc"
    }
    post-destroot {
        system "cd ${worksrcpath} && ${build.cmd} install-doc DESTDIR=${destroot}"
    }
}

platform freebsd {
    build.env       MAKE=/usr/local/bin/gmake
    destroot.env    MAKE=/usr/local/bin/gmake
}

livecheck.url   http://site.icu-project.org/download
livecheck.regex {>ICU4C \((\d+(?:\.\d+)*)\)<}
