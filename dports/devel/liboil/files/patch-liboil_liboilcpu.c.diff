--- /Users/rhwood/Developer/MacPorts/Repository/dports/devel/liboil/liboilcpu.c.unpatched	2007-02-06 06:28:37.000000000 -0500
+++ liboil/liboilcpu.c	2007-02-07 06:45:02.000000000 -0500
@@ -42,7 +42,7 @@
 #include <sys/time.h>
 #include <time.h>
 
-#if defined(__FreeBSD__)
+#if defined(__FreeBSD__) || defined(__APPLE__)
 #include <sys/types.h>
 #include <sys/sysctl.h>
 #endif
@@ -531,7 +531,7 @@
 static void
 oil_cpu_detect_kernel_support (void)
 {
-#ifdef __FreeBSD__
+#if defined(__FreeBSD__) || defined(__APPLE__)
   int ret, enabled;
   size_t len;
 
@@ -542,7 +542,7 @@
 		       OIL_IMPL_FLAG_MMXEXT | OIL_IMPL_FLAG_SSE3);
   }
 #endif
-#if !defined(__linux__) && !defined(__FreeBSD__) && !defined(__NetBSD__)
+#if !defined(__linux__) && !defined(__FreeBSD__) && !defined(__NetBSD__) && !defined(__APPLE__)
   /* If we don't know that the operating system supports SSE, don't trust that
    * it will properly support it.
    */
@@ -587,25 +587,17 @@
 }
 
 static void
-test_altivec (void * ignored)
-{
-  char x[16] = { 0, };
-
-  asm volatile (
-      "  lvx %%v0, %0, %%r0  \n"
-      :: "r" (x));
-}
-
-static void
 oil_cpu_detect_powerpc(void)
 {
-
-  oil_cpu_fault_check_enable ();
-  if (oil_cpu_fault_check_try(test_altivec, NULL)) {
+  int sels[2] = { CTL_HW, HW_VECTORUNIT };
+  int vType = 0; //0 == scalar only
+  size_t length = sizeof(vType);
+  int error = sysctl(sels, 2, &vType, &length, NULL, 0);
+ 
+  if ( 0 == error ) {
     OIL_DEBUG ("cpu flag altivec");
     oil_cpu_flags |= OIL_IMPL_FLAG_ALTIVEC;
   }
-  oil_cpu_fault_check_disable ();
 
   _oil_profile_stamp = oil_profile_stamp_tb;
 }
