# $Id$

PortSystem          1.0
name                ocaml-bin-prot
version             2.0.3
categories          devel ml
maintainers         erickt openmaintainer
license             {BSD LGPL-2}
description         A binary protocol generator
long_description    This library contains functionality for reading and writing OCaml-values \
                    in a type-safe binary protocol. These functions are extremely efficient and \
                    provide users with a convenient and safe way of performing I/O on any \
                    extensionally defined data type. This means that functions, objects, and \
                    values whose type is bound through a polymorphic record field are not \
                    supported, but everything else is.

homepage            http://ocaml.janestreet.com/?q=node/13
platforms           darwin
master_sites        http://www.janestreet.com/ocaml

distname            bin-prot-${version}

checksums           md5     950ab4bdca7f5b7570e4d6216eff235d \
                    sha1    5744736b5eb9367633c5fc124d531f6d9d66ee5e \
                    rmd160  fe02221b20f2bb176a2a5e6f293c906470f945ce

# remove me if http://caml.inria.fr/mantis/view.php?id=5516 is fixed
patchfiles          patch-myocamlbuild.ml.diff
post-patch {
    # deal with C99 semantics of inline
    if {${configure.compiler} == "clang"} {
        reinplace "s|inline||g" ${worksrcpath}/lib/common_stubs.c \
            ${worksrcpath}/lib/read_stubs.c ${worksrcpath}/lib/write_stubs.c
    }
}

depends_lib         port:ocaml port:ocaml-findlib port:ocaml-ounit port:ocaml-type-conv

use_configure       no
use_parallel_build  no

build.env           PREFIX=${prefix}

test.run            yes

set ocamlfind_destdir ${destroot}${prefix}/lib/ocaml/site-lib

destroot.env        OCAMLFIND_LDCONF="ignore" \
                    OCAMLFIND_DESTDIR="$ocamlfind_destdir"

pre-destroot {
    file mkdir ${ocamlfind_destdir}/stublibs
}

livecheck.type      regex
livecheck.regex     "bin-prot-(.*?).tar.gz"
