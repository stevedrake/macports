# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:filetype=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem 1.0

name            odcctools
set my_name     cctools
epoch           1
version         822
revision        2
set llvm_version 3.0
categories      devel
maintainers     jeremyhu openmaintainer
homepage        http://opensource.apple.com/
master_sites    http://opensource.apple.com/tarballs/${my_name}/
platforms       darwin
license         apsl-2.0

distname        ${my_name}-${version}

description     Darwin cctools build system.
long_description \
    The odcctools project is geared towards improving the \
    Darwin cctools build system and code base to support \
    Darwin development. Darwin cctools has several \
    components, including the assembler odas(1), the \
    static linker odld(1), various tools for manipulating \
    and analyzing Mach-O and fat files, and support \
    libraries.

checksums           md5     7a5e044c34b0d2745dddbdf3a5d3061d \
                    sha1    bd04447522aa69c1f71ab01811ac46dca23b92b7 \
                    rmd160  1caf207acbf421cdc975926a392fc75dc1d2594c

depends_build   port:ld64
depends_run     port:llvm-${llvm_version}

post-patch {
    reinplace "/^int subsections_via_symbols/s/^int/extern int/" ${worksrcpath}/as/as.h 
    reinplace "/^bfd_boolean dwarf2_loc_mark_labels/s/^bfd_boolean/extern bfd_boolean/" ${worksrcpath}/as/dwarf2dbg.h

    reinplace "s:\"llvm-mc\":\"llvm-mc-mp-${llvm_version}\":" ${worksrcpath}/as/driver.c

    foreach file [glob ${worksrcpath}/{*/,}Makefile] {
        reinplace "s:/usr/local:${prefix}:g" ${file}
        reinplace "s:/usr:${prefix}:g" ${file}
        reinplace "s:${prefix}/efi:${prefix}:g" ${file}
        reinplace "s:${prefix}/man:${prefix}/share/man:g" ${file}
    }
}

use_configure   no
use_parallel_build  yes

build.target    all
build.args-append \
    TRIE=-DTRIE_SUPPORT \
    USE_DEPENDENCY_FILE=NO \
    BUILD_DYLIBS=NO \
    LTO=-DLTO_SUPPORT \
    CC="${configure.cc}" \
    CXX="${configure.cxx}" \
    RC_CFLAGS="[get_canonical_archflags] `llvm-config-mp-${llvm_version} --cflags`" \
    LLVM_MC="llvm-mc-mp-${llvm_version}"

destroot.args-append \
    TRIE=-DTRIE_SUPPORT \
    USE_DEPENDENCY_FILE=NO \
    BUILD_DYLIBS=NO \
    LTO=-DLTO_SUPPORT \
    CC="${configure.cc}" \
    CXX="${configure.cxx}" \
    RC_CFLAGS="[get_canonical_archflags]" \
    LLVM_MC="llvm-mc-mp-${llvm_version}"

platform macosx {
    # DON'T DO THIS!  I'm leaving it here as a warning to curious minds.
    # build.args-append RC_OS="macos"

    if {${os.major} < 10} {
        build.args-append \
            OLD_LIBKLD=YES

        destroot.args-append \
            OLD_LIBKLD=YES
    }
}

destroot.args-append DSTROOT=${destroot}
post-destroot {
    file delete -force ${destroot}${prefix}/OpenSourceLicenses
    file delete -force ${destroot}${prefix}/OpenSourceVersions
    file delete -force ${destroot}${prefix}/RelNotes
}
