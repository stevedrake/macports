# $Id$

PortSystem 1.0
name			openssl
version			0.9.8e
platforms		darwin freebsd
categories		devel security
maintainers		mww@macports.org
homepage		http://www.openssl.org/
description		OpenSSL SSL/TLS cryptography library

long_description \
	The OpenSSL Project is a collaborative effort to develop a robust, \
	commercial-grade, full-featured, and Open Source toolkit implementing \
	the Secure Sockets Layer (SSL v2/v3) and Transport Layer Security \
	(TLS v1) protocols as well as a full-strength general purpose \
	cryptography library.

master_sites	http://www.openssl.org/source/
checksums		md5 3a7ff24f6ea5cd711984722ad654b927 \
				sha1 b429872d2a287714ab37e42296e6a5fbe23d32ff \
				rmd160 c1a498606dc0fc7219376b950fab6b53687466db

depends_lib		port:zlib

variant darwin {
	patchfiles	patch-Makefile.org patch-crypto-Makefile
}

configure.cmd	./config
configure.args	-L${prefix}/lib --openssldir=${prefix}/etc/openssl zlib no-asm no-krb5 shared

platform darwin 6 {
	depends_lib-append	port:dlcompat
}

platform darwin 8 {
	build.args	CC=/usr/bin/gcc-4.0
}

destroot.destdir	INSTALL_PREFIX=${destroot}
destroot.args		MANDIR=${prefix}/share/man

test.run		yes

livecheck.check	regex
livecheck.url	${master_sites}
livecheck.regex	${name}-(0.9.8\[a-z\])

variant universal {

    post-configure {
        cd ${worksrcpath}

        # prepare building for ppc
        if [variant_isset darwin_i386] {
            reinplace "s|darwin-i386-cc|darwin-ppc-cc|g" Makefile
            reinplace "s| 386||g" Makefile
            reinplace "s|DL_ENDIAN|DB_ENDIAN|g" Makefile
            reinplace "s|-O3 -fomit-frame-pointer -fno-common|-O3 -DB_ENDIAN|g" Makefile
        }
        reinplace "s|-O3 -DB_ENDIAN$|-O3 -DB_ENDIAN -arch ppc -isysroot /Developer/SDKs/MacOSX10.4u.sdk|" Makefile
        reinplace "s|^LDFLAGS=.*|LDFLAGS=-arch ppc|g" Makefile.shared
    }

    build {
        cd ${worksrcpath}

        # build for ppc
        system [command build]

        # determine which files will need to be lipo'ed together
        set lList {}
        foreach s {0.9.8.dylib a} {
            foreach n {crypto ssl} {
                lappend lList lib${n}.${s}
            }
        }
        set eList {}
        foreach f [glob engines/*.so] {
            lappend eList ${f}
        }
        set bList apps/openssl
        set tList {}
        foreach f [glob test/*test] {
            lappend tList ${f}
        }
        lappend tList test/sha256t
        lappend tList test/sha512t

        # define a backup procedure to a temporary location
        proc backup {bakPath} {
            xinstall -d ${bakPath}    
            foreach a {l e b t} b {. engines apps test} {
                upvar 1 [set a]List [set a]List 
                xinstall -d ${bakPath}/$b
                foreach n [set [set a]List] {
                    xinstall ${n} ${bakPath}/${b}
                }
            }
        }
        # backup the output of the first run (ppc)
        set ppcPath ${workpath}/ppc
        backup ${ppcPath}

        # cleanup the worksrcdir
        system "make clean"
        foreach f [glob lib*.0.9.8.dylib] {
            delete ${f}
        }

        # prepare building for i386
        reinplace "s|darwin-ppc-cc|darwin-i386-cc|g" ${worksrcpath}/Makefile
        reinplace "s|DB_ENDIAN|DL_ENDIAN|g" ${worksrcpath}/Makefile
        reinplace "s|-arch ppc|-arch i386|g" ${worksrcpath}/Makefile
        reinplace "s|-arch ppc|-arch i386|g" Makefile.shared

        # build for i386
        system [command build]

        # backup the output of the second run (i386)
        set i386Path ${workpath}/i386
        backup ${i386Path}

        # run lipo on the output of both runs
        foreach n {l e b t} {
            foreach m [set [set n]List] {
                delete ${m}
                system "lipo \
                -arch i386 ${i386Path}/${m} \
                -arch  ppc  ${ppcPath}/${m} \
                -create -output ${m}"
            }
        }

        # make sure installing won't rebuild
        reinplace "s|install: all |install: |g" Makefile
    }

    # make sure we don't build a third time
    post-build {}
}

platform darwin i386 {}
