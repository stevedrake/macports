# $Id$

PortSystem 1.0
name		perforce
version		06.1
categories	devel
maintainers	nomaintainer@macports.org
description	Fast source code management system
long_description	Perforce is a commercial revision control system that can be used gratis for developing free software. (see the WWW page for details). 
homepage    http://www.perforce.com/
platforms	darwin freebsd
master_sites    ftp://www.perforce.com/pub/perforce/r${portversion}/bin.darwin80ppc/ \
                http://www.perforce.com/perforce/doc.052/man/
dist_subdir	${portname}
worksrcdir	${portname}
distfiles	p4 p4.1 p4d p4d.1
checksums	p4 md5 c93999fe1fe3f87ea1dfec1aad3e883d \
		p4.1 md5 e5cada2f402e1e016be7999fdc49035d \
		p4d md5 95608c2f44fe378a03bc9a48fc10a36e \
		p4d.1 md5 1aa86f28ba0698266bf1dcaded3e4106
extract		{ system "mkdir -p ${portpath}/${workdir}/${worksrcdir}"
	 	  system "cp ${distpath}/* \
		  ${portpath}/${workdir}/${worksrcdir}/" }
configure	{}
build		{}
destroot	{ cd ${worksrcpath}
		  system "install -o root -m 755 -d ${destroot}${prefix}/bin"
		  system "install -o root -m 755 -d ${destroot}${prefix}/sbin"
		  system "install -o root -m 755 -d ${destroot}${prefix}/share/man/man1"
		  system "install -o root -m 755 -d ${destroot}${prefix}/share/man/man8"
		  system "install -o root -m 755 -c p4 ${destroot}${prefix}/bin"
		  system "install -o root -m 755 -c p4d ${destroot}${prefix}/sbin"
		  system "install -o root -m 644 -c p4.1 \
		    ${destroot}${prefix}/share/man/man1"
		  system "install -o root -m 644 -c p4d.1 \
		    ${destroot}${prefix}/share/man/man8" }

variant server {
depends_run path:/Library/StartupItems/DarwinPortsStartup:DarwinPortsStartup

	post-destroot {
		addgroup perforce
		set gid [existsgroup perforce]
		adduser perforce realname=Perforce\ Server gid=${gid} \
			home=${prefix}/share/perforce shell=/bin/sh
		system "install -o perforce -m 755 -d \
			${destroot}${prefix}/share/perforce/depot"
		system "install -o root -m 755 -d ${destroot}${prefix}/etc/rc.d"
		system "install -o perforce -m 644 -c /dev/null \
			${destroot}${prefix}/share/perforce/log"
		set script [open "${destroot}${prefix}/etc/rc.d/perforce.sh" w 0755]
		puts $script "#!/bin/sh"
		puts $script "su perforce -c \"${prefix}/sbin/p4d -d -r \
			${prefix}/share/perforce/depot -L \
			${prefix}/share/perforce/log\""
		close $script
	}
}

