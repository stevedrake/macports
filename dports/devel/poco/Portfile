# $Id$

PortSystem      1.0

name            poco
version         1.3.0
categories      devel
maintainers     n.oxyde@gmail.com
description     POCO C++ Libraries

long_description \
                POCO aims to be for network-centric, cross-platform C++ software development \
                what Apple's Cocoa is for Mac development, or Ruby on Rails is for Web \
                development â€” a powerful, yet easy to use platform to build your applications upon.

homepage        http://pocoproject.org/
master_sites    sourceforge
use_bzip2       yes

checksums       [suffix ${distname}] \
                    md5 798e3e99f3ed97fe4d2151acec12024e \
                    sha1 8630341bd54af3ef4176a41e4d90ca3e8e91e5ad \
                    rmd160 da58302df5fed9f111ee08a2f8ecdf1d9e0cbf15 \
                [suffix ${distname}-ssl] \
                    md5 c5169f92f2787a609f9611346d221e78 \
                    sha1 1429b7fb925e61e88df8d19648ef87c29144b6b4 \
                    rmd160 aeb24c2382a13e21d14bba4160bc7d144bb2780b \
                ${name}-${version}-doc.tar.gz \
                    md5 6107295904c6203a58377b2e7f97ed33 \
                    sha1 1374f44a3f82477c6587037e0d990cd26d0eb61e \
                    rmd160 433a7ff6f5db661fb799f09c4bfbf439f4cbc841

platforms       darwin

configure.args  --no-tests \
                --no-samples

build.target    poco

set docdir      ${prefix}/share/doc/${name}-${version}

post-destroot {
    xinstall -m 0755 -d ${destroot}${docdir}
    xinstall -m 0644 -W ${worksrcpath} CHANGELOG CONTRIBUTORS LICENSE NEWS README VERSION \
        ${destroot}${docdir}

    if {! [variant_isset doc]} {
        xinstall -m 0755 -d ${destroot}${docdir}/html
        xinstall -m 0644 -W ${worksrcpath}/doc Acknowledgements.html ${destroot}${docdir}/html
    }
}

variant ipv6 requires darwin_8 {}

variant ssl {
    distname                ${distname}-ssl
    depends_lib-append      port:openssl
}

variant doc {
    extract.only            ${distfiles}
    distfiles-append        ${name}-${version}-doc.tar.gz

    post-extract {
        system "tar xzf ${distpath}/${name}-${version}-doc.tar.gz -C ${workpath}"
    }

    post-destroot {
        set workdocpath ${workpath}/${name}-${version}-doc

        xinstall -m 0755 -d ${destroot}${docdir}/html
        eval xinstall -m 0644 [glob ${workdocpath}/*.html] ${destroot}${docdir}/html

        foreach {dir} {images css} {
            xinstall -m 0755 -d ${destroot}${docdir}/html/${dir}
            eval xinstall -m 0644 [glob ${workdocpath}/${dir}/*] ${destroot}${docdir}/html/${dir}
        }
    }
}

platform darwin {
    post-destroot {
        set libdir ${prefix}/lib
        cd ${destroot}${libdir}

        foreach {dylib} [glob -type f *.dylib] {
           system "install_name_tool -id ${libdir}/${dylib} ${dylib}"

           set otool [lrange [split [exec otool -L ${dylib}] \n] 2 end]

           foreach {otoolentry} ${otool} {
               set lib     [lindex ${otoolentry} 0]

               if {! [string match ${worksrcpath}/* ${lib}]} {
                   continue
               }

               system "install_name_tool -change ${lib} ${libdir}/[file tail ${lib}] ${dylib}"
           }
        }
    }
}

platform darwin 7 {
    configure.args-append   --config=Darwin7
}

platform darwin 8 {
    post-patch {
        if {! [variant_isset ipv6]} {
            reinplace "s/-DPOCO_HAVE_IPv6//" ${worksrcpath}/build/config/Darwin
        }
    }
}
