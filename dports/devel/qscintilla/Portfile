# -*- coding: utf-8; mode: tcl; c-basic-offset: 4; indent-tabs-mode: nil; tab-width: 4; truncate-lines: t -*- vim:fenc=utf-8:et:sw=4:ts=4:sts=4
# $Id$

PortSystem 1.0
PortGroup           qt4 1.0

name                qscintilla
version             2.4.5
revision            3
categories          devel
maintainers         adfernandes openmaintainer
description         QScintilla is a port to Qt of Neil Hodgson's Scintilla C++ editor control.
homepage            http://www.riverbankcomputing.com/software/qscintilla/
platforms           darwin

long_description    QScintilla is a port to Qt of Neil Hodgson's Scintilla C++ editor control. \
                	As well as features found in standard text editing components,		\
                	QScintilla includes features especially useful when editing and		\
                	debugging source code. These include support for syntax styling,	\
                	error indicators, code completion and call tips. The selection		\
                	margin can contain markers like those used in debuggers to indicate	\
                	breakpoints and the current line. Styling choices are more open		\
                	than with many editors, allowing the use of proportional fonts,		\
                	bold and italics, multiple foreground and background colours and	\
                	multiple fonts. See the py*-qscintilla port to install python bindings.

#
# NOTE: the version of this port must be kept in sync with the 'py*-qscintilla' port(s),
#       since they contain the python bindings!
#

distname            QScintilla-gpl-${version}
master_sites        http://www.riverbankcomputing.com/static/Downloads/QScintilla2/ \
                    http://gentoo.mirrors.easynews.com/linux/gentoo/distfiles/ \
                    http://www.gtlib.gatech.edu/pub/gentoo/distfiles/ \
                    http://gentoo.osuosl.org/distfiles/

checksums           md5     8063f8f933513959432c27c5ffecf56b \
                    sha1    2401c2214ba0377ad61855c0fac6f6c7c95801d6 \
                    rmd160  d96cf05c879f314ee828ec6a1609bd1864692bd6

universal_variant   yes

post-patch {
    # allow for universal building, if desired,
    # by fixing up the QMake .pro files.
    if {[variant_exists universal] && [variant_isset universal]} {
        # set universal arch types, depending on what the user has specified
        array set macports_to_qt_build_arch {
            ppc     ppc
            i386    x86
            ppc64   ppc64
            x86_64  x86_64
        }
        set arch_types ""
        foreach arch ${universal_archs} {
            lappend arch_types $macports_to_qt_build_arch($arch)
        }
        set ARCHES [join ${arch_types} " "]
        reinplace "s@CONFIG += @CONFIG += ${ARCHES} @" \
            ${worksrcpath}/Qt4/qscintilla.pro
        reinplace "s@CONFIG += @CONFIG += ${ARCHES} @" \
            ${worksrcpath}/designer-Qt4/designer.pro
    }

    # fix up 'Platform.h's, to avoid a conflict with the port 'tidy's
    # 'platform.h'.
    reinplace "/INCLUDEPATH/s@ \\. @ . .. @" \
        ${worksrcpath}/Qt4/qscintilla.pro
    foreach fixfile [exec grep -lr \"Platform\.h\" ${worksrcpath}] {
        reinplace "s@\"Platform\.h\"@\"include/Platform\.h\"@g" ${fixfile}
    }
}

configure.cmd       "cd ${worksrcpath}/Qt4; ${qt_qmake_cmd} qscintilla.pro; \
                     cd ${worksrcpath}/designer-Qt4; ${qt_qmake_cmd} designer.pro; \
                     echo"

post-configure {
    # make sure the designer plugin finds the correct Qsci library, by
    # putting its search path first of all -L paths
    if {[variant_isset debug]} {
        reinplace "/LIBS/s@\-L${prefix}/lib@\-L../Qt4@1" \
            ${worksrcpath}/designer-Qt4/Makefile.Release
        reinplace "/LIBS/s@\-L${prefix}/lib@\-L../Qt4@1" \
            ${worksrcpath}/designer-Qt4/Makefile.Debug
        reinplace "/INCPATH/s@\-I@\-I../Qt4 \-I@1" \
            ${worksrcpath}/designer-Qt4/Makefile.Release
        reinplace "/INCPATH/s@\-I@\-I../Qt4 \-I@1" \
            ${worksrcpath}/designer-Qt4/Makefile.Debug
    } else {
        reinplace "/LIBS/s@\-L${prefix}/lib@\-L../Qt4@1" \
            ${worksrcpath}/designer-Qt4/Makefile
        reinplace "/INCPATH/s@\-I@\-I../Qt4 \-I@1" \
            ${worksrcpath}/designer-Qt4/Makefile
    }
}

build.cmd           "cd ${worksrcpath}/Qt4; make; cd ${worksrcpath}/designer-Qt4; make; echo"

destroot.cmd        "cd ${worksrcpath}/Qt4; make install; cd ${worksrcpath}/designer-Qt4; make install; echo"

post-build {
    # Fix import and plugin library names
    system "install_name_tool -id \
                ${qt_dir}/lib/libqscintilla2.5.dylib \
                ${worksrcpath}/Qt4/libqscintilla2.5.dylib" 
    system "install_name_tool -id \
                ${qt_plugins_dir}/designer/libqscintillaplugin.dylib \
                ${worksrcpath}/designer-Qt4/libqscintillaplugin.dylib" 
    system "install_name_tool -change \
                libqscintilla2.5.dylib \
                ${qt_dir}/lib/libqscintilla2.5.dylib \
                ${worksrcpath}/designer-Qt4/libqscintillaplugin.dylib"
    if {[variant_isset debug]} {
        system "install_name_tool -id \
                ${qt_dir}/lib/libqscintilla2_debug.5.dylib \
                ${worksrcpath}/Qt4/libqscintilla2_debug.5.dylib" 
        system "install_name_tool -id \
                ${qt_plugins_dir}/designer/libqscintillaplugin_debug.dylib \
                ${worksrcpath}/designer-Qt4/libqscintillaplugin_debug.dylib" 
        system "install_name_tool -change \
                libqscintilla2.5.dylib \
                ${qt_dir}/lib/libqscintilla2_debug.5.dylib \
                ${worksrcpath}/designer-Qt4/libqscintillaplugin_debug.dylib"
    }
}

variant debug \
description {Produce both release and debug library and plugin} {
    # fix up QMake .pro files for +debug, if selected
    patchfiles-append patch-add_debug.diff
}

livecheck.type      regex
livecheck.url       ${master_sites}
livecheck.regex     QScintilla-gpl-\(\\d+.\\d+.\\d+\).tar.gz
