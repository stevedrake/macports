# $Id$

PortSystem              1.0

name                    redo
version                 0.05
revision                1
categories              devel
maintainers             singingwolfboy
supported_archs         noarch

homepage                http://apenwarr.ca/log/?m=201012#14
platforms               darwin openbsd
license                 LGPL-2
fetch.type              git
git.url                 https://github.com/apenwarr/${name}.git
git.branch              ${name}-${version}
description             Smaller, easier, more powerful, and more reliable than make.
long_description        \
    redo is literally the most amazingly groundbreaking build system since \
    the original invention of 'make'. Claims: \
        it can do everything make can do\; \
        with no baked-in assumptions about what you're building\; \
        with much less code\; \
        with much greater parallelism\; \
        with finer-grained dependencies\; \
        with much less syntax (actually nothing but /bin/sh)\; \
        while supporting recursion and full dependency information simultaneously \
            (no Recursive Make Considered Harmful crap)\; \
        yet build scripts are highly modular and readable\; \
        and you can checksum your targets instead of using timestamps\; \
        and your build scripts run linearly instead of an orderless \"ruleset\"\; \
        with no implicit rules required\; \
        and implementing C header autodependencies is completely sane\; \
        and dependency checks involve no forking or parsing so it's crazy fast\; \
        and you can incrementally convert parts of your project\; \
        because it can play well with other build systems\; \
        including jobserver compatibility with make -j\; \
        oh, and you can write a plug-compatible toy implementation in 100 lines of shell.

configure {
    eval reinplace "s|#!/usr/|#!${prefix}/|" [glob ${worksrcpath}/*]
}
build.cmd               ${worksrcpath}/${name}
test.run                yes
destroot.destdir        ""
destroot.env-append     DESTDIR=${destroot} PREFIX=${prefix}
depends_lib             bin:python:python_select
variant doc description {Build and install man pages} {
    # The documentation requires pandoc to build...    
    #depends_build       bin:pandoc:pandoc
    # ... but if we don't have pandoc already installed, we can just grab
    # the pregenerated documentation.
    post-fetch {
        if {[file isfile "${prefix}/bin/pandoc"] == 0} {
            system "cd ${worksrcpath} && ${build.cmd} Documentation/git-import"
        }
    }
}
variant bash_completion {
    depends_run         port:bash-completion
    post-destroot {
        xinstall -d ${destroot}${prefix}/etc/bash_completion.d/
        xinstall -m 644 ${worksrcpath}/contrib/bash_completion.d/redo \
            ${destroot}${prefix}/etc/bash_completion.d/
    }
}
default_variants        +doc +bash_completion
