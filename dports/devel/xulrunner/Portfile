# $Id$

PortSystem	1.0

name		xulrunner
version		1.9.0.7
categories	devel
maintainers	jeremyhu openmaintainer
platforms	darwin
description	Mozilla runtime package that can be used to bootstrap XUL+XPCOM applications

long_description ${description}

homepage	http://developer.mozilla.org/en/docs/XULRunner
master_sites	http://mozilla.isc.org/pub/mozilla.org/xulrunner/releases/${version}/source

distname	${name}-${version}-source
use_bzip2	yes

checksums           md5     9875c9237b532009df8e91c3785539a3 \
                    sha1    03c078d9c2d047d7cdc25f7823c6e647cb8d8f8b \
                    rmd160  da4319a3cbbb2deaab5dc80e1e18f042d98e4859

# nspr and nss aren't universal
universal_variant no

worksrcdir	mozilla

depends_lib \
	port:findutils \
	port:nss \
	port:nspr \
	port:gtk2

# Bug #485863 - enable-image-decoders=...
configure.args \
	--disable-static \
	--enable-shared \
	--disable-official-branding \
	--with-distribution-id=org.macports \
	--enable-default-toolkit=cairo-gtk2 \
	--x-includes=${prefix}/include \
	--x-libraries=${prefix}/lib \
	--with-system-nspr \
	--with-nspr-prefix=${prefix} \
	--with-system-nss \
	--with-nss-prefix=${prefix} \
	--with-system-bzip2=${prefix} \
	--with-system-jpeg=${prefix} \
	--with-system-zlib=${prefix} \
	--enable-system-cairo \
	--with-system-cairo=${prefix} \
	--enable-system-sqlite \
	--with-default-mozilla-five-home=${prefix}/lib/xulrunner \
	--disable-oji \
	--enable-plugins \
	--enable-mathml \
	--enable-extensions="default,spellcheck" \
	--enable-permissions \
	--enable-cookie \
	--enable-image-decoders="png,gif,jpeg,bmp,xbm" \
	--enable-image-encoder=all \
	--enable-canvas \
	--enable-jsd \
	--enable-xpctools \
	--enable-crypto \
        --enable-pango \
	--enable-svg \
	--enable-svg-renderer=cairo \
	--enable-xinerama \
	--with-pthreads \
	--enable-gnomevfs \
	--enable-postscript \
	--enable-help-viewer \
	--enable-safe-browsing \
	--enable-xft \
	--disable-freetype2 \
	--disable-crashreporter \
	--enable-optimize=-O2 \
	--disable-prebinding \
	--enable-strip \
	--disable-debug \
	--disable-installer \
	--disable-updater \
	--disable-pedantic \
	--disable-tests \
	--disable-mochitest

variant debug description "build with debugging symbols" {
    configure.args-delete   --disable-debug \
                            --disable-mochitest \
                            --enable-optimize='-O2' \
                            --enable-strip

    configure.args-append   --enable-debug \
                            --enable-mochitest \
                            --disable-optimize \
                            --disable-strip
}

post-extract {
    # https://bugzilla.mozilla.org/show_bug.cgi?id=484353
    move ${worksrcpath}/modules/libjar/nsWildCard.cpp ${worksrcpath}/modules/libjar/nsWildCard_jar.cpp
}

# Upstream bugs (http://bugzilla.mozilla.org)
# #485827 (xpcom-Makefile)
# #485856 (configure)
# #485862 (system-nss)
# #486036 (make-install)
# Previous firefox-x11 port (patch-dylib_file.diff patch-pthread.diff)
patchfiles configure.patch xpcom-Makefile.patch system-nss.patch make-install.patch patch-dylib_file.diff  patch-pthread.diff 

post-patch {
    # https://bugzilla.mozilla.org/show_bug.cgi?id=485857
    reinplace "s:XP_MACOSX:__APPLE__:g" ${worksrcpath}/xpcom/base/nsStackWalk.cpp 

    # https://bugzilla.mozilla.org/show_bug.cgi?id=484353
    reinplace "s:nsWildCard.cpp:nsWildCard_jar.cpp:g" ${worksrcpath}/modules/libjar/objs.mk

    # https://bugzilla.mozilla.org/show_bug.cgi?id=486034
    # find -xtype -> gfind -xtype
    reinplace "s:find:gfind:g" ${worksrcpath}/toolkit/mozapps/installer/packager.mk

    # Set the right install_name on the libs
    reinplace "s:@executable_path:${prefix}/lib/${name}:g" ${worksrcpath}/config/rules.mk

    reinplace "s:/etc/gre\.:${prefix}/etc/gre.:g" \
	${worksrcpath}/xpcom/build/nsXPCOMPrivate.h \
	${worksrcpath}/xulrunner/app/nsRegisterGREUnix.cpp \
	${worksrcpath}/xulrunner/installer/Makefile.in
}

configure.env \
	MOZCONFIG="${worksrcpath}/xulrunner/config/mozconfig" \
	MOZILLA_FIVE_HOME="${prefix}/lib/${name}"

build.args-append \
	includedir="${prefix}/include/${name}" \
	idldir="${prefix}/share/idl/${name}" \
	installdir="${prefix}/lib/${name}" \
	sdkdir="${prefix}/lib/${name}"

destroot.args-append \
	includedir="${prefix}/include/${name}" \
	idldir="${prefix}/share/idl/${name}" \
	installdir="${prefix}/lib/${name}" \
	sdkdir="${prefix}/lib/${name}"

# AC_X_PATH blindly asks xmkmf where X11 is, and it always uses /usr/X11R6.
# This block helps us link correctly when we are +system_x11 and x11prefix
# is somewhere non-standard and should cause AC_X_PATH to let us setup our
# CPPFLAGS and LDFLAGS without interference
pre-configure {
    if { ![file exists ${prefix}/lib/pkgconfig/x11.pc] } {
        configure.cppflags-append -I${x11prefix}/include
        configure.ldflags-append  -L${x11prefix}/lib
    }
}
