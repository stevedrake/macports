# $Id$
PortSystem          1.0

name                vim-app
set realname        vim
set vim_version     7.0
set vim_patchlevel  224
version             ${vim_version}.${vim_patchlevel}
revision            0
categories          editors
maintainers         raimue@codingfarm.de
description         Vim.app is a GUI version of the famous editor vim.
long_description    This port provides Vim.app, a GUI version of the famous editor vim. \
                        Vim is a highly configurable text editor built to enable efficient text editing.
homepage            http://www.vim.org/
platforms           darwin freebsd

distfiles           ${realname}-${vim_version}.tar.bz2:vim \
                      ${realname}-${vim_version}-extra.tar.gz:extra \
                      ${realname}-${vim_version}-lang.tar.gz:extra \
                      app-bm.tar.gz:app_aqua \
                      doc.tar.gz:doc_aqua

use_bzip2           yes

set serverList {
                    ftp://ftp.vim.org/pub/vim/ \
                      http://ftp.vim.org/pub/vim/ \
                      ftp://ftp.us.vim.org/pub/vim/ \
                      ftp://ftp.ca.vim.org/pub/vim/ \
                      ftp://ftp.nl.vim.org/pub/vim/ \
                      ftp://ftp.uk.vim.org/pub/vim/ \
                      ftp://ftp.ie.vim.org/pub/vim/ \
                      ftp://ftp.is.vim.org/pub/vim/ \
                      ftp://ftp.pl.vim.org/pub/vim/ \
                      ftp://ftp.ro.vim.org/pub/vim/ \
                      ftp://ftp.cz.vim.org/pub/vim/ \
                      ftp://ftp.sk.vim.org/pub/vim/ \
                      ftp://ftp.jp.vim.org/pub/vim/ \
                      ftp://ftp.kr.vim.org/pub/vim/ \
                      ftp://ftp2.us.vim.org/pub/vim/ \
                      ftp://ftp9.us.vim.org/pub/vim/ \
                      ftp://ftp2.nl.vim.org/pub/vim/ \
                      ftp://ftp3.nl.vim.org/pub/vim/ \
                      ftp://ftp3.de.vim.org/pub/vim/ \
                      ftp://ftp2.tw.vim.org/pub/vim/ \
                      ftp://miroir-francais.fr/pub/vim/ \
                      ftp://ftp.tw.vim.org/pub/Unix/Editors/Vim/
}

# create list of locations for source, extras, patches from serverList
foreach server ${serverList} {
    lappend master_sites ${server}unix/:vim
    lappend master_sites ${server}extra/:extra
    lappend patch_sites ${server}patches/${vim_version}
}
master_sites-append \
    http://www.douglas.stebila.ca/files/code/vim/app/:app_aqua \
    http://www.douglas.stebila.ca/files/code/vim/doc/:doc_aqua

patchfiles          patch-if_ruby.c

dist_subdir         ${realname}
distname            ${realname}[strsed ${vim_version} {g/[.]//}]

eval {
    set low 1
    while {$low <= $vim_patchlevel} {
        set high [expr $low + 99];
        if {$high < $vim_patchlevel} {
            patchfiles-append \
              [format "%s.%03d-%03d.gz" $vim_version $low $high]
            incr low 100
        } else {
            patchfiles-append [format "%s.%03d" $vim_version $low]
            incr low 1
        }
    }
}

set appPath "/Applications/MacPorts/"
depends_lib         port:gettext \
                    port:ncurses
configure.pre_args  --prefix=${appPath}/Vim
configure.args      --enable-gui=carbon \
                    --without-x \
                    --disable-gpm \
                    --mandir=${prefix}/share/man \
                    --with-tlib=ncurses
configure.env       CPPFLAGS="-I${prefix}/include" \
                    LDFLAGS="-L${prefix}/lib"
extract.only        ${realname}-${vim_version}${extract.suffix}
post-extract {
    system "gnutar xvfz ${distpath}/${realname}-${vim_version}-extra.tar.gz -C \
      ${workpath}"
    system "gnutar xvfz ${distpath}/${realname}-${vim_version}-lang.tar.gz -C \
      ${workpath}"
    system "gnutar xvfz ${distpath}/app-bm.tar.gz -C ${workpath}"
    system "gnutar xvfz ${distpath}/doc.tar.gz -C ${workpath}"
}

test.run            yes

destroot {
    set appPath "/Applications/MacPorts/"
    # create the required directories
    xinstall -d -m 755 ${destroot}${appPath}Vim
    # copy Vim.app
    file copy ${worksrcpath}/src/Vim.app ${destroot}${appPath}Vim
    xinstall -m 644 ${filespath}/vimrc ${filespath}/gvimrc \
      ${destroot}${appPath}Vim/Vim.app
    xinstall -m 644 ${workpath}/doc-txt.icns \
      ${destroot}${appPath}Vim/Vim.app/Contents/Resources
    xinstall -m 644 ${workpath}/app.icns \
      ${destroot}${appPath}Vim/Vim.app/Contents/Resources/gui_mac.icns
    # remove the broken link to 'runtime', copy the folder instead
    set runtimePath \
      "${destroot}${appPath}Vim/Vim.app/Contents/Resources/vim/runtime"
    file delete ${runtimePath}
    file copy ${worksrcpath}/runtime ${runtimePath}
    # fix permissions
    foreach f [glob ${runtimePath}/autoload/*.vim] {
            file attributes ${f} -permissions 0644
    }
    # install launchscript
    xinstall -m 755 ${filespath}/gvim.sh \
      ${destroot}/${prefix}/bin/gvim
    # allow for Vim.App to open .nfo, .vim, .latex, .tex, .diff files
    cd ${destroot}${appPath}Vim/Vim.app/Contents/
    system "patch -p0 < ${filespath}/patch-Info.plist"
    # copy GVim.app (ppc only)
    if {![variant_isset darwin_i386]} {
        system "gnutar xvfz ${filespath}/GVim_app.tar.gz -C \
          ${destroot}${appPath}"
        xinstall -m 644 ${workpath}/app.icns \
          ${destroot}${appPath}GVim.app/Contents/Resources/appIcon.icns
    }
}

# vim-app specific, experimental variants.
# Since the patches may overlap, only ONE of these 
# can be installed at a time.

# macatsui: better antialising (experimental)
# see http://wiki.macvim.org/wiki/VimPatches/ATSUI
variant macatsui conflicts guitab {
    patch_sites-append macports:.:macatsui
    patchfiles-append  atsui.patch_mod:macatsui
}

# guitab: use a drawer for tabs (experimental)
# see http://wiki.macvim.org/wiki/VimPatches/GuiTab
variant guitab conflicts macatsui {
   patch_sites-append  macports:.:guitab
   patchfiles-append   guitab.v7.diff:guitab
}

# general vim variants

variant big                     { configure.args-append --with-features=big }
variant huge                    { configure.args-append --with-features=huge }
variant multibyte               { configure.args-append --enable-multibyte }
variant xim                     { configure.args-append --with-xim }

variant perl {
    configure.args-append   --enable-perlinterp
    depends_lib-append      bin:perl:perl5.8
}
variant python {
    configure.args-append   --enable-pythoninterp
    depends_lib-append      bin:python:python23
}
variant ruby {
    configure.args-append   --enable-rubyinterp
    depends_lib-append      bin:ruby:ruby
}
variant tcl {
    configure.args-append   --enable-tclinterp
    depends_lib-append      bin:tclsh:tcl
}

variant cscope {
    configure.args-append   --enable-cscope
}

platform darwin i386 {
}

include checksums_dist
include checksums_patch
