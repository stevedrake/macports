# $Id$

PortSystem          1.0

name                vim
set vim_version     7.3
set vim_patchlevel  20
version             ${vim_version}.${vim_patchlevel}
categories          editors
maintainers         raimue
description         Vi \"workalike\" with many additional features
long_description \
    Vim is an advanced text editor that seeks to provide the power of the   \
    de-facto Unix editor 'Vi', with a more complete feature set.

homepage            http://www.vim.org/
platforms           darwin freebsd

master_sites        http://ftp.vim.org/pub/vim/unix/
patch_sites         http://ftp.vim.org/pub/vim/patches/${vim_version}
distname            vim-${vim_version}
use_bzip2           yes
dist_subdir         vim[strsed ${vim_version} {g/\.//}]
worksrcdir          vim[strsed ${vim_version} {g/\.//}]

patchfiles-append   patch-x11.diff

# Generate patchfiles
set low 1
set patchlevel [string trimleft $vim_patchlevel 0]
while {$low <= $patchlevel} {
    set high [expr $low + 99];
    if {$high < $patchlevel} {
        patchfiles-append [format "%s.%03d-%03d.gz" $vim_version $low $high]
        incr low 100
    } else {
        patchfiles-append [format "%s.%03d" $vim_version $low]
        incr low 1
    }
}

checksums \
  vim-${vim_version}${extract.suffix} \
    md5     5b9510a17074e2b37d8bb38ae09edbf2 \
    sha1    46faa96c5fab639899b1c655c23d8755b62f036f \
    rmd160  1846e7f4aa8e0a329d8360a9e05d7e93da23b4b5

checksums-append \
    7.3.001 md5 aa5582d8289b43255f45d4bb6f62e140 \
    7.3.002 md5 2949cbdfe86f533c487fd144c5935c7a \
    7.3.003 md5 9059db41cf3a468935745242cb9c0514 \
    7.3.004 md5 9aaa4490d2fbf9a1e780a151fb41f279 \
    7.3.005 md5 bf5b5fad8c4de23449fa7c7c01969369 \
    7.3.006 md5 f53d95dfb1eee5f5f769594174d0e9d4 \
    7.3.007 md5 a7a4c56110662bc3ba6fbb2fd645d94f \
    7.3.008 md5 be756a231afe754d004b6c8a9d12bb50 \
    7.3.009 md5 f4ed2feff44e2c1898fd5e60f9f97b0d \
    7.3.010 md5 4fffed01d3683b0b8b23df600a0bada2 \
    7.3.011 md5 4ee8f06dce300c0be029bf00b03ef093 \
    7.3.012 md5 89faf7d5eef1d1d50b657fe34ee7c90b \
    7.3.013 md5 6a029d61f7d51c1bea55330732676319 \
    7.3.014 md5 d0109c0c413c405fdb827ec20f3903d8 \
    7.3.015 md5 4db0a869dbe00c360541ad2c1ca87a2d \
    7.3.016 md5 e0c634532a865d7ed47942080e371b3e \
    7.3.017 md5 f52aa5bc3df02c3bb4c75849b2b5f431 \
    7.3.018 md5 02270ecbc1dc2f57de80441ac7cdd0f0 \
    7.3.019 md5 5c1be1a0a107261e0a716c877c82fc97 \
    7.3.020 md5 ef09917435a7cab9382abe3708cf5152

depends_build       bin:grep:grep
depends_lib         port:ncurses \
                    port:libiconv \
                    port:ctags

autoconf.cmd make autoconf
autoconf.dir ${worksrcpath}/src

configure.args      --disable-gui \
                    --without-x \
                    --disable-gpm \
                    --disable-nls \
                    --mandir=${prefix}/share/man \
                    --with-tlib=ncurses \
                    --enable-multibyte \
                    --with-developer-dir=${developer_dir}

post-patch {
    set features [open ${worksrcpath}/src/feature.h a+]
    puts $features "#define SYS_VIMRC_FILE \"${prefix}/etc/vimrc\""
    close $features
}

post-destroot {
    ln -s ${prefix}/bin/vim ${destroot}${prefix}/bin/vi
}

test.run            yes

variant x requires x11 description {Compatibility variant, requires +x11} {}
variant x11 description {Build CLI version with X support} {
    configure.args-delete   --without-x
    configure.args-append   --with-x
    depends_lib-append      port:xorg-libXt
}

variant athena description {Build GUI version using Athena widgets} requires x11 conflicts gtk1 gtk2 motif {
    configure.args-delete   --disable-gui
    configure.args-append   --enable-gui=athena --disable-darwin
    depends_lib-append      port:xorg-libXaw
}
variant gtk1 description {Build GUI version using GTK 1.x widgets} requires x11 conflicts athena gtk2 motif {
    configure.args-delete   --disable-gui
    configure.args-append   --enable-gui=gtk --disable-darwin
    depends_lib-append      port:gtk1
}
variant gtk2 description {Build GUI version using GTK 2.x widgets} requires x11 conflicts athena gtk1 motif {
    configure.args-delete   --disable-gui
    configure.args-append   --enable-gui=gtk2 --disable-darwin
    depends_lib-append      port:gtk2
}
variant motif description {Build GUI version with Motif widgets} requires x11 conflicts athena gtk1 gtk2 {
    configure.args-delete   --disable-gui
    configure.args-append   --enable-gui=motif --disable-darwin
    depends_lib-append      lib:libXm:openmotif
}

variant tiny description {Build tiny feature set} {
    configure.args-append --with-features=tiny
}
variant small description {Build small feature set} conflicts tiny {
    configure.args-append --with-features=small
}
variant big description {Build big feature set} conflicts tiny small	{
    configure.args-append --with-features=big
}
variant huge description {Build huge feature set} conflicts tiny small big {
    configure.args-append --with-features=huge
}
variant xim description {Build with support for X Input Method} {
    configure.args-append --with-xim
}

# FIXME: Does not work with vim 7.3 yet
# variant shell description {Enables shell windows} {
    # # Patch taken from http://www.wana.at/vimshell/
    # patchfiles-append       patch-vimshell.diff
# }

variant perl description {Enable Perl scripting} {
    configure.args-append   --enable-perlinterp
    depends_lib-append      path:bin/perl:perl5
}
variant python requires python25 description {Compatibility variant, requires +python25} {}
variant python25 conflicts python26 python27 python31 description {Enable Python scripting} {
    configure.args-append   --enable-pythoninterp --with-python=${prefix}/bin/python2.5
    patchfiles-append       patch-python.diff
    depends_lib-append      port:python25

    use_autoconf yes
    # Overwriting autoconf.cmd above removes dependency, add it again
    depends_build-append port:autoconf
}
variant python26 conflicts python25 python27 python31 description {Enable Python scripting} {
    configure.args-append   --enable-pythoninterp --with-python=${prefix}/bin/python2.6
    patchfiles-append       patch-python.diff
    depends_lib-append      port:python26

    use_autoconf yes
    # Overwriting autoconf.cmd above removes dependency, add it again
    depends_build-append port:autoconf
}
variant python27 conflicts python25 python26 python31 description {Enable Python scripting} {
    configure.args-append   --enable-pythoninterp --with-python=${prefix}/bin/python2.7
    patchfiles-append       patch-python.diff
    depends_lib-append      port:python27

    use_autoconf yes
    # Overwriting autoconf.cmd above removes dependency, add it again
    depends_build-append port:autoconf
}
variant python31 conflicts python25 python26 python27 description {Enable Python scripting} {
    configure.args-append   --enable-python3interp --with-python=${prefix}/bin/python3.1
    patchfiles-append       patch-python3.diff
    depends_lib-append      port:python31

    use_autoconf yes
    # Overwriting autoconf.cmd above removes dependency, add it again
    depends_build-append port:autoconf
}
variant ruby description {Enable Ruby scripting} {
    configure.args-append   --enable-rubyinterp
    depends_lib-append      port:ruby
}
variant tcl description {Enable Tcl scripting} {
    configure.args-append   --enable-tclinterp
    patchfiles-append       patch-tcl.diff
    depends_lib-append      port:tcl

    use_autoconf yes
    # Overwriting autoconf.cmd above removes dependency, add it again
    depends_build-append port:autoconf
}

variant cscope description {Enable source code browsing with cscope} {
    configure.args-append   --enable-cscope
}

variant nls {
    configure.args-delete   --disable-nls
    depends_lib-append      port:gettext
}

platform puredarwin {
    configure.args-append --disable-darwin
}

livecheck.type  regex
livecheck.url   http://ftp.vim.org/pub/${name}/patches/${vim_version}/?O=D
livecheck.version [format "%s.%03d" $vim_version $vim_patchlevel]
livecheck.regex (${vim_version}\.\\d+)
