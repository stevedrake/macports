# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem                  1.0
PortGroup                   cmake 1.0

name                        PlasmaClient
version                     0.0-233
revision                    2
categories                  games
platforms                   darwin
maintainers                 ryandesign
license                     GPL-3+
homepage                    http://plasmaclient.servegame.org/

description                 open-source Plasma engine

long_description            ${name} is an open-source cross-platform \
                            re-implementation of the Plasma engine, \
                            originally created by HeadSpin Technologies and \
                            Cyan Worlds. The Plasma engine powers Myst \
                            Online: URU Live again.

fetch.type                  hg
hg.url                      http://uru.zrax.net/hg/plasmaclient
hg.tag                      9b0fa8db3071

# Decompress these into MO:ULa data dir
#http://stashbox.org/919902/python.zip
#http://stashbox.org/998132/sdl.zip

depends_lib                 port:bullet \
                            port:python26 \
                            port:boost \
                            port:jpeg \
                            port:zlib \
                            port:openssl \
                            port:libsdl \
                            port:libhsplasma

if {![file exists ${prefix}/lib/libboost_python-mt.dylib]} {
    depends_lib-delete port:boost
    pre-configure {
        ui_error "
****
**** ${name} requires port boost installed with variant +python26.
**** Please do the following then try installing ${name} again:
****
****     sudo port install boost +python26
****

"
        return -code error "incompatible boost installation"
    }
}

post-extract {
    copy ${filespath}/PlasmaClient.in ${workpath}/PlasmaClient
}

configure.args              -DBULLET_INCLUDE_DIR:PATH=${prefix}/include/bullet \
                            -DCMAKE_VERBOSE_MAKEFILE:BOOL=TRUE \
                            -DPYTHON_INCLUDE_DIR:PATH=${frameworks_dir}/Python.framework/Versions/2.6/Headers \
                            -DPYTHON_LIBRARY:FILEPATH=${frameworks_dir}/Python.framework/Versions/2.6/lib/python2.6/config/libpython2.6.dylib \
                            -DSDL_INCLUDE_DIR=${prefix}/include/SDL \
                            -DSDL_LIBRARY="${prefix}/lib/libSDLmain.a\;${prefix}/lib/libSDL.dylib\;-framework Cocoa"

post-build {
    reinplace "s|@PREFIX@|${prefix}|g" ${workpath}/PlasmaClient
}

destroot.keepdirs           ${destroot}${prefix}/var/log/${name}

post-destroot {
    xinstall -d ${destroot}${applications_dir}/PlasmaClient.app/Contents/MacOS
    xinstall ${workpath}/PlasmaClient ${destroot}${applications_dir}/PlasmaClient.app/Contents/MacOS
    
    xinstall -d -m 777 ${destroot}${prefix}/var/log/${name}
}

notes "
To run PlasmaClient, write your Myst Online: URU Live again username and password into the preferences plist like this:

    defaults write org.macports.PlasmaClient username YOURUSERNAME
    defaults write org.macports.PlasmaClient password YOURPASSWORD

(replacing YOURUSERNAME with your username and YOURPASSWORD with your password). Then open PlasmaClient in ${applications_dir}.
"

platform darwin powerpc {
    notes-append "\n\n${name} probably does not work at all on PowerPC Macs at this time; try an Intel Mac."
}

platform darwin 8 {
    notes-append "\n\n${name} probably does not work at all on Mac OS X 10.4 Tiger at this time; try a later version of Mac OS X."
    configure.ldflags-append -lcrypto -ljpeg -lz
}

if {[variant_isset debug]} {
    configure.optflags -O1
    configure.cflags-append -ggdb
    configure.cxxflags-append -ggdb
}

livecheck.type              regex
livecheck.url               ${hg.url}
livecheck.version           [lindex [split ${version} -] 1]
livecheck.regex             {rev (\d+)}
