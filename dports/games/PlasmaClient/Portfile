# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem                  1.0
PortGroup                   cmake 1.0

name                        PlasmaClient
epoch                       1
version                     0.0.1-275
categories                  games
platforms                   darwin
maintainers                 ryandesign
license                     GPL-3+
homepage                    http://plasmaclient.info/

description                 open-source Plasma engine

long_description            ${name} is an open-source cross-platform \
                            re-implementation of the Plasma engine, \
                            originally created by HeadSpin Technologies and \
                            Cyan Worlds. The Plasma engine powers Myst \
                            Online: URU Live again.

fetch.type                  hg
hg.url                      http://uru.zrax.net/hg/plasmaclient
hg.tag                      8e9a3e21306d

depends_lib                 port:bullet \
                            port:python26 \
                            port:boost \
                            port:jpeg \
                            port:zlib \
                            port:openssl \
                            port:libsdl \
                            port:libhsplasma

if {![file exists ${prefix}/lib/libboost_python-mt.dylib]} {
    depends_lib-delete port:boost
    pre-configure {
        ui_error "
****
**** ${name} requires port boost installed with variant +python26.
**** Please do the following then try installing ${name} again:
****
****     sudo port install boost +python26
****

"
        return -code error "incompatible boost installation"
    }
}

post-extract {
    reinplace "s|\r||g" ${worksrcpath}/win32dist/readme.rtf
}

patchfiles                  patch-win32dist-readme.rtf.diff

configure.args              -DBULLET_INCLUDE_DIR:PATH=${prefix}/include/bullet \
                            -DCMAKE_VERBOSE_MAKEFILE:BOOL=TRUE \
                            -DPYTHON_INCLUDE_DIR:PATH=${frameworks_dir}/Python.framework/Versions/2.6/Headers \
                            -DPYTHON_LIBRARY:FILEPATH=${frameworks_dir}/Python.framework/Versions/2.6/lib/python2.6/config/libpython2.6.dylib \
                            -DSDL_INCLUDE_DIR=${prefix}/include/SDL \
                            -DSDL_LIBRARY="${prefix}/lib/libSDLmain.a\;${prefix}/lib/libSDL.dylib\;-framework Cocoa"

destroot.keepdirs           ${destroot}${prefix}/var/log/${name}

set docdir ${prefix}/share/doc/${name}
post-destroot {
    xinstall -d ${destroot}${prefix}/share/mystonline/data
    xinstall -W ${worksrcpath}/win32dist global.wpm ${destroot}${prefix}/share/mystonline/data
    
    xinstall -d ${destroot}${docdir}
    xinstall -W ${worksrcpath}/win32dist readme.rtf gpl.txt ${destroot}${docdir}
    
    xinstall -d -m 777 ${destroot}${prefix}/var/log/${name}
}

notes "
To start ${name}, install the PCLauncher port and run PCLauncher in ${applications_dir}

Instructions for using ${name} are in the file ${docdir}/readme.rtf

For more information, please visit the Guild of Writers' IRC channel at irc://irc.guildofwriters.com/#writers
"

platform darwin powerpc {
    notes-append "\n\n${name} probably does not work at all on PowerPC Macs at this time; try an Intel Mac."
}

platform darwin 8 {
    configure.ldflags-append -lcrypto -ljpeg -lz
}

if {[variant_isset debug]} {
    configure.optflags -O1
    configure.cflags-append -ggdb
    configure.cxxflags-append -ggdb
}

livecheck.type              regex
livecheck.url               ${hg.url}
livecheck.version           [lindex [split ${version} -] 1]
livecheck.regex             {rev (\d+)}
