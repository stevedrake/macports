#!/bin/sh
# $Id$

usage() {
    osascript \
        -e 'tell app "Finder"' \
        -e 'activate' \
        -e 'display dialog (do shell script "@PREFIX@/bin/port -q notes PlasmaClient") buttons "OK" default button 1 with title "PlasmaClient" with icon note' \
        -e 'end'
    exit 1
}

PLIST=org.macports.PlasmaClient

USERNAME="$(defaults read $PLIST username)"
PASSWORD="$(defaults read $PLIST password)"

if [ -z "$USERNAME" -o -z "$PASSWORD" ]; then
    usage
fi

LOGDIR="@PREFIX@/var/log/PlasmaClient"
KEEPLOGS=10
cd "${LOGDIR}"
ls PlasmaClient.*.log 2>/dev/null | sort -n -r | sed "1,$((${KEEPLOGS} - 1))d" | xargs rm -f

LOGFILE="PlasmaClient.$(date '+%s').log"
LOGLINK="PlasmaClient.log"
rm -f "${LOGDIR}/${LOGLINK}"
ln -s "${LOGFILE}" "${LOGDIR}/${LOGLINK}"
echo "Logging to ${LOGDIR}/${LOGFILE}"

cd "@PREFIX@/share/mystonline/data"
"@PREFIX@/bin/PlasmaClient" "${USERNAME}" "${PASSWORD}" > "${LOGDIR}/${LOGFILE}" 2>&1
