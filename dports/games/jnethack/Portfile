# $Id$

PortSystem      1.0

name            jnethack
version         3.4.3-0.9
categories      games japanese
maintainers     rutiler.net:kyut takanori
description     Classic dungeon adventure game, translated in Japanese.
long_description \
                ${description}
platforms       darwin
homepage        http://jnethack.sourceforge.jp/
#master_sites   sourceforge_jp:${name}/9091/:nh \
#		sourceforge_jp:${name}/25190/:jnh
set sfjpid_nh   9091
set sfjpid_jnh  25190
master_sites    http://keihanna.dl.sourceforge.jp/${name}/${sfjpid_nh}/:nh \
                http://osdn.dl.sourceforge.jp/${name}/${sfjpid_nh}/:nh \
                http://globalbase.dl.sourceforge.jp/${name}/${sfjpid_nh}/:nh \
                http://jaist.dl.sourceforge.jp/${name}/${sfjpid_nh}/:nh \
                http://keihanna.dl.sourceforge.jp/${name}/${sfjpid_jnh}/:jnh \
                http://osdn.dl.sourceforge.jp/${name}/${sfjpid_jnh}/:jnh \
                http://globalbase.dl.sourceforge.jp/${name}/${sfjpid_jnh}/:jnh \
                http://jaist.dl.sourceforge.jp/${name}/${sfjpid_jnh}/:jnh
set nethacksrc      "nethack-343-src.tgz"
set jnethackpatch   "${name}-${version}.diff.gz"
distfiles       ${nethacksrc}:nh \
                ${jnethackpatch}:jnh
patchfiles      patch-sys_unix_Makefile.doc.diff \
                patch-sys_unix_Makefile.top.diff \
                patch-sys_unix_nethack.sh.diff \
                patch-win_tty_termcap.c.diff \
                patch-src_options.c.diff
checksums       ${nethacksrc} sha1 c26537093c38152bc0fbcec20468d975b35f59fd \
                ${jnethackpatch}  sha1 547acd967c75a6bc8d464821b41ed026c1c2bb3a

depends_build   port:bison \
                port:flex
depends_run     port:cocot

## extract ##

extract.only    ${nethacksrc}
worksrcdir      nethack-3.4.3
post-extract {
    system "cd ${worksrcpath} && gunzip -dc ${distpath}/${jnethackpatch} | patch -p 1"
}

## patch ##

pre-patch {
    if {[variant_isset x11]} {
        patchfiles-append x11/patch-include_config.h.diff \
                          x11/patch-sys_unix_Makefile.top.diff \
                          x11/patch-sys_unix_Makefile.src.diff \
                          x11/patch-win_X11_JNetHack.ad.diff
    }
}
post-patch {
    reinplace "s|__PREFIX__|${prefix}|" "${worksrcpath}/sys/unix/Makefile.doc" \
                                        "${worksrcpath}/sys/unix/Makefile.top" \
                                        "${worksrcpath}/sys/unix/nethack.sh"
}

## configure ##

configure.dir       ${worksrcpath}/sys/unix
configure.cmd       /bin/sh
configure.pre_args  setup.sh

## destroot ##

pre-destroot {
    addgroup games
    adduser games gid=[existsgroup games]

    xinstall -m 755 -d "${destroot}${prefix}/share/man/man6"
    xinstall -m 755 -d "${destroot}${prefix}/share/jnethackdir/save"
}

destroot.target     install manpages
destroot.keepdirs   "${destroot}${prefix}/share/jnethackdir/save/"

post-destroot {
    reinplace "s|${destroot}||" "${destroot}${prefix}/bin/jnethack"
    if {[variant_isset x11]} {
        copy ${worksrcpath}/win/X11/JNetHack.ad ${destroot}${prefix}/share/jnethackdir/
    }
}

## install ##

pre-install {
    addgroup games
    adduser games gid=[existsgroup games]
}

## variants ##

variant x11 {}

variant universal {
    post-patch {
        reinplace "s|^CFLAGS = -W -g -O -I../include$|CFLAGS = ${configure.cflags} ${configure.universal_cflags} -I../include|" ${worksrcpath}/sys/unix/Makefile.src
        reinplace "s|\$(LINK) \$(LFLAGS)|\$(LINK) \$(CFLAGS) \$(LFLAGS)|" ${worksrcpath}/sys/unix/Makefile.src
        reinplace "s|^CFLAGS = -O -I../include$|CFLAGS = ${configure.cflags} ${configure.universal_cflags} -I../include|" ${worksrcpath}/sys/unix/Makefile.utl
        reinplace "s|\$(CC) \$(LFLAGS)|\$(CC) \$(CFLAGS) \$(LFLAGS)|" ${worksrcpath}/sys/unix/Makefile.utl
    }
}

livecheck.check regex
livecheck.url   ${homepage}
livecheck.regex <li>\\(\[0-9/\]+\\) (\[0-9.-\]+)
