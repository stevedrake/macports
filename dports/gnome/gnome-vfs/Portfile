# $Id$
PortSystem 1.0
name		gnome-vfs
version		2.18.1
revision	1
description	This is the GNOME Virtual File System.
long_description        This is the GNOME Virtual File System. \
			GNOME VFS is currently used as one of the \
			foundations of the Nautilus file manager.
maintainers	rhwood openmaintainer@macports.org
categories	gnome
platforms	darwin 
homepage	http://www.gnome.org/
master_sites    gnome:sources/${name}/2.18/
checksums	md5 bf4a6d95180d05981893e5d021c6695c \
		sha1 e939fe4fe2e75516ae6c4d476f8fb44f59ec8bdc \
		rmd160 ff2fc7a7c47b85a03d65964a8ad1d7d585698f3d

depends_lib	\
		port:gnome-mime-data \
		port:gconf \
		port:howl \
		port:neon \
		port:dbus \
		port:openssl \
		port:libidl \
		port:dbus-glib \
		port:libxml2 \
		port:libiconv \
		port:gettext

use_bzip2 	yes

configure.args  --mandir=${prefix}/share/man \
		--enable-ipv6 \
		--enable-howl \
		--with-openssl-libs=${prefix}/lib \
		--with-openssl-includes=${prefix}/include \
		--disable-gnutls
configure.env   PATH="${prefix}/bin:$env(PATH)"
configure.ldflags-append	"-lresolv"

post-patch {
	reinplace "s|open64||g" ${worksrcpath}/configure
	reinplace "s|posix_fadvise||g" ${worksrcpath}/configure
	reinplace "s|data_dirs = \"/usr|data_dirs = \"${prefix}/share:/usr|g" \
		${worksrcpath}/libgnomevfs/xdgmime.c \
		${worksrcpath}/libgnomevfs/gnome-vfs-mime-info.c 
	reinplace "s|\"/etc/fstab\"|\"/etc/fstab.hd\"|g" \
		${worksrcpath}/libgnomevfs/gnome-vfs-unix-mounts.c

	if {[variant_isset darwin_6]} {
        reinplace "s|#include <arpa/nameser.h>|#include <arpa/nameser.h>\\
		#ifndef T_SRV\\
		#define T_SRV 33\\
		#endif|g" \
			${worksrcpath}/libgnomevfs/gnome-vfs-dns-sd.c 
        reinplace "s|#include <limits.h>|#include <limits.h>\\
		#if \!defined getc_unlocked \\&\\& \!defined HAVE_GETC_UNLOCKED\\
		#define getc_unlocked(fp) getc (fp)\\
		#endif|g" \
			${worksrcpath}/libgnomevfs/xdgmimemagic.c
    	reinplace "s|socklen_t|int|g" ${worksrcpath}/modules/ftp-method.c
	}
	
	if {[variant_isset darwin_7]} {
		reinplace "s|#include <stdio.h>|#include <stdio.h>\\
		#include <stdint.h>|g" ${worksrcpath}/libgnomevfs/xdgmimecache.c
	}

}

pre-build {
	reinplace "s|-lkrb5support||g" \
		${worksrcpath}/Makefile ${worksrcpath}/daemon/Makefile \
		${worksrcpath}/devel-docs/Makefile ${worksrcpath}/doc/Makefile \
		${worksrcpath}/devel-docs/gnome-vfs-tutorial/Makefile \
		${worksrcpath}/imported/Makefile ${worksrcpath}/imported/neon/Makefile \
		${worksrcpath}/libgnomevfs/Makefile ${worksrcpath}/modules/Makefile \
		${worksrcpath}/schemas/Makefile 
}

platform darwin 6 {
        configure.ldflags-delete "-lresolv"
	patchfiles	patch-xdgmimecache.c
}

platform darwin 7 {
	patchfiles	\
		patch-xdgmimecache.c \
		patch-modules_file-method-acl.c.diff
}
