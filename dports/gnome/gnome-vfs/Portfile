# $Id$

PortSystem      1.0

name            gnome-vfs
version         2.20.1
revision        1
maintainers     nomaintainer
categories      gnome
platforms       darwin 
description     This is the GNOME Virtual File System.

long_description \
    This is the GNOME Virtual File System. \
    GNOME VFS is currently used as one of the \
    foundations of the Nautilus file manager.

homepage        http://www.gnome.org/
master_sites    gnome:sources/${name}/[strsed ${version} {/\.[0-9]*$//}]/
use_bzip2       yes

checksums       md5 a350a5a3e201951d7e7867d0900df423 \
                sha1 03afa10e84425f7f38e05f0db0ecf55ae5fb7b15 \
                rmd160 faa5fffb5495d1e161cb6c3b47612cf39cbb1629

depends_lib     port:gconf \
                port:dbus \
                port:openssl \
                port:libidl \
                port:dbus-glib \
                port:libxml2 \
                port:libiconv \
                port:gettext

depends_run     port:gnome-mime-data

configure.args  --enable-ipv6 \
                --disable-howl \
                --disable-avahi \
                --with-openssl-libs=${prefix}/lib \
                --with-openssl-includes=${prefix}/include \
                --disable-gnutls \
                ac_cv_func_open64=no \
                ac_cv_func_posix_fadvise=no \
                ac_cv_path_KRB5_CONFIG=none
                

configure.ldflags-append    -lresolv

post-patch {
    reinplace -E "/xdg_data_dirs =/s|\"\[^\"\]*\"|\"${prefix}/share\"|" \
        ${worksrcpath}/libgnomevfs/xdgmime.c

    reinplace "s|/etc/fstab|/etc/fstab.hd|" \
        ${worksrcpath}/libgnomevfs/gnome-vfs-unix-mounts.c
}

platform darwin 6 {
    post-patch {
        reinplace "s|#include <arpa/nameser.h>|#include <arpa/nameser.h>\\
        #ifndef T_SRV\\
        #define T_SRV 33\\
        #endif|g" \
            ${worksrcpath}/libgnomevfs/gnome-vfs-dns-sd.c 

        reinplace "s|#include <limits.h>|#include <limits.h>\\
        #if \!defined getc_unlocked \\&\\& \!defined HAVE_GETC_UNLOCKED\\
        #define getc_unlocked(fp) getc (fp)\\
        #endif|g" \
            ${worksrcpath}/libgnomevfs/xdgmimemagic.c

        reinplace "s|socklen_t|int|g" ${worksrcpath}/modules/ftp-method.c
    }

    configure.ldflags-delete    -lresolv
}

platform darwin 7 {
    patchfiles-append   patch-modules_file-method-acl.c.diff

    post-patch {
        reinplace "s|#include <stdio.h>|#include <stdio.h>\\
        #include <stdint.h>|g" ${worksrcpath}/libgnomevfs/xdgmimecache.c
    }
}

variant avahi description {Enable Bonjour through avahi} {
    depends_lib-append      port:avahi
    configure.args-delete   --disable-avahi
}
