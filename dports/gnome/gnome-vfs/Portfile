# $Id$

PortSystem      1.0

name            gnome-vfs
version         2.20.1
maintainers     nomaintainer
categories      gnome
platforms       darwin 
description     This is the GNOME Virtual File System.

long_description \
    This is the GNOME Virtual File System. \
    GNOME VFS is currently used as one of the \
    foundations of the Nautilus file manager.

homepage        http://www.gnome.org/
master_sites    gnome:sources/${name}/[strsed ${version} {/\.[0-9]*$//}]/
use_bzip2       yes

checksums       md5 a350a5a3e201951d7e7867d0900df423 \
                sha1 03afa10e84425f7f38e05f0db0ecf55ae5fb7b15 \
                rmd160 faa5fffb5495d1e161cb6c3b47612cf39cbb1629

depends_lib     port:gnome-mime-data \
                port:gconf \
                port:avahi \
                port:neon \
                port:dbus \
                port:openssl \
                port:libidl \
                port:dbus-glib \
                port:libxml2 \
                port:libiconv \
                port:gettext


configure.args  --mandir=${prefix}/share/man \
                --enable-ipv6 \
                --disable-howl \
                --with-openssl-libs=${prefix}/lib \
                --with-openssl-includes=${prefix}/include \
                --disable-gnutls

configure.ldflags-append    -lresolv

post-patch {
    reinplace "s|open64||g" ${worksrcpath}/configure
    reinplace "s|posix_fadvise||g" ${worksrcpath}/configure
    reinplace "s|data_dirs = \"/usr|data_dirs = \"${prefix}/share:/usr|g" \
        ${worksrcpath}/libgnomevfs/xdgmime.c \
        ${worksrcpath}/libgnomevfs/gnome-vfs-mime-info.c 
    reinplace "s|\"/etc/fstab\"|\"/etc/fstab.hd\"|g" \
        ${worksrcpath}/libgnomevfs/gnome-vfs-unix-mounts.c

    if {[variant_isset darwin_6]} {
        reinplace "s|#include <arpa/nameser.h>|#include <arpa/nameser.h>\\
        #ifndef T_SRV\\
        #define T_SRV 33\\
        #endif|g" \
            ${worksrcpath}/libgnomevfs/gnome-vfs-dns-sd.c 
        reinplace "s|#include <limits.h>|#include <limits.h>\\
        #if \!defined getc_unlocked \\&\\& \!defined HAVE_GETC_UNLOCKED\\
        #define getc_unlocked(fp) getc (fp)\\
        #endif|g" \
            ${worksrcpath}/libgnomevfs/xdgmimemagic.c
        reinplace "s|socklen_t|int|g" ${worksrcpath}/modules/ftp-method.c
    }
    
    if {[variant_isset darwin_7]} {
        reinplace "s|#include <stdio.h>|#include <stdio.h>\\
        #include <stdint.h>|g" ${worksrcpath}/libgnomevfs/xdgmimecache.c
    }

}

pre-build {
    reinplace "s|-lkrb5support||g" \
        ${worksrcpath}/Makefile ${worksrcpath}/daemon/Makefile \
        ${worksrcpath}/devel-docs/Makefile ${worksrcpath}/doc/Makefile \
        ${worksrcpath}/devel-docs/gnome-vfs-tutorial/Makefile \
        ${worksrcpath}/imported/Makefile ${worksrcpath}/imported/neon/Makefile \
        ${worksrcpath}/libgnomevfs/Makefile ${worksrcpath}/modules/Makefile \
        ${worksrcpath}/schemas/Makefile 
}

platform darwin 6 {
    patchfiles-append   patch-xdgmimecache.c

    configure.ldflags-delete    -lresolv
}

platform darwin 7 {
    patchfiles-append   patch-xdgmimecache.c \
                        patch-modules_file-method-acl.c.diff
}
