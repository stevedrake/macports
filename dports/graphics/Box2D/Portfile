# $Id$

PortSystem      1.0
PortGroup       xcode 1.0
                  
name            Box2D
version         2.0.2
revision        2
categories      graphics devel
maintainers     nox openmaintainer
license         as-is
description     A C++ 2D physics engine for games

long_description \
    Box2D is a feature rich 2d rigid body physics engine, written in C++ by \
    Erin Catto. It has been used in many games, including Crayon Physics \
    Deluxe, winner of the 2008 Independent Game Festival Grand Prize.

homepage        http://www.box2d.org/
master_sites    http://download.github.com/
distname        nox-${name}-90c3b1e

checksums       md5     769b557ee2a726cc40af21a1c3110433 \
                sha1    e9a594eb51f57790f7b1b35eeddfce3735a16ca3 \
                rmd160  68fc37a7ffe54747a837abed36b4e970d021c0ab

set topsrcpath  ${workpath}/${distname}
worksrcdir      ${distname}/Build/Xcode

patch.dir       ${topsrcpath}
patchfiles      patch-osx-sl.diff

xcode.configuration Release
xcode.target        "TestBed App"

post-destroot {
    set app_path "${applications_dir}/Box2D Test Bed.app"
    set lib_path ${prefix}/lib/libbox2d.dylib

    set offset [expr [string length ${topsrcpath}/Source] + 1]
    fs-traverse header ${topsrcpath}/Source {
        if {[file extension ${header}] eq ".h"} {
            set basename [string range ${header} ${offset} end]
            set dest ${destroot}${prefix}/include/${basename}
            xinstall -d [file dirname ${dest}]
            xinstall -m 644 ${header} ${dest}
        }
    }

    xinstall -m 644 ${topsrcpath}/Include/Box2D.h \
            ${destroot}${prefix}/include
    reinplace s@../Source/@@ ${destroot}${prefix}/include/Box2D.h

    delete ${destroot}${app_path}/Contents/MacOS/libBox2D.dylib
    move ${destroot}${applications_dir}/libBox2D.dylib \
            ${destroot}${lib_path}
    system "install_name_tool -id ${lib_path} ${destroot}${lib_path}"
    system "install_name_tool \
            -change ${applications_dir}/libBox2D.dylib ${lib_path} \
            \"${destroot}${app_path}/Contents/MacOS/Box2D Test Bed\""
}
