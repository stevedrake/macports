# $Id$

PortSystem              1.0
PortGroup               archcheck 1.0

name                    dcraw
version                 9.02-20100614155500
set version_number      [lindex [split ${version} -] 0]
categories              graphics
maintainers             ryandesign
platforms               darwin
homepage                http://www.cybercom.net/~dcoffin/dcraw/
master_sites            ${homepage}archive/
distname                ${name}-${version_number}
worksrcdir              $name
dist_subdir             ${name}/${version}
use_configure           no
use_parallel_build      yes

description             Digital camera raw photo decoding software supporting \
                        hundreds of cameras

long_description        ${name} is a small program for processing raw, \
                        unprocessed CCD data files from any of hundreds of \
                        digital cameras with better quality output than the \
                        tools provided by camera vendors.

checksums               md5     e97bba4a546f266ca6b2faa3f43e441e \
                        sha1    bc7001cfc782af626b5cf06dbe578a6a8a439f00 \
                        rmd160  88fda3eae497bab40dd7e2d89cba379f86e59a0e

depends_lib             port:gettext \
                        port:libiconv \
                        port:jpeg \
                        port:lcms

archcheck.files         lib/libintl.dylib \
                        lib/libiconv.dylib \
                        lib/libjpeg.dylib \
                        lib/liblcms.dylib

post-extract {
    xinstall -W ${filespath} Makefile.in ${worksrcpath}/Makefile
}

variant universal {
    configure.cflags-append ${configure.universal_cflags}
    configure.cppflags-append ${configure.universal_cppflags}
    configure.ldflags-append ${configure.universal_ldflags}
}

pre-configure {
    # ufraw 0.15 and earlier provided its own copy of dcraw, but 0.16 now
    # depends on the dcraw port instead. To prevent activation conflicts
    # when upgrading to ufraw 0.16, ensure an old dcraw-providing ufraw
    # is not active.
    if {[file exists ${prefix}/bin/ufraw]} {
        ui_debug "ufraw is installed; determining version"
        set ufraw_minimum_version 0.16
        set ufraw_installed_version [exec ${prefix}/bin/msgunfmt ${prefix}/share/locale/de/LC_MESSAGES/ufraw.mo | sed -E -n s/^.*Project-Id-Version:\ \(\[0-9.\]+\).*\$/\\1/p]
        if {[rpm-vercomp ${ufraw_installed_version} ${ufraw_minimum_version}] < 0} {
            ui_debug "ufraw ${ufraw_installed_version} is installed; needs to be deactivated first"
            return -code error "Please deactivate your currently-installed ufraw port, then try again"
        } else {
            ui_debug "ufraw ${ufraw_installed_version} is installed; ok"
        }
    } else {
        ui_debug "ufraw is not installed; ok"
    }
}

pre-build {
    build.args          CC=${configure.cc} \
                        CFLAGS="[join ${configure.cflags}]" \
                        CPPFLAGS="[join ${configure.cppflags}]" \
                        LDFLAGS="[join ${configure.ldflags}]" \
                        PREFIX=${prefix}
}

destroot.args           PREFIX=${prefix}

set my_locales          {ca cs da de eo es fr hu it nl pl pt ru sv zh_CN zh_TW}

post-destroot {
    xinstall -m 644 -W ${worksrcpath} dcraw.1 ${destroot}${prefix}/share/man/man1
    foreach locale ${my_locales} {
        if {[file exist ${worksrcpath}/dcraw_${locale}.1]} {
            xinstall -m 755 -d ${destroot}${prefix}/share/man/${locale}/man1
            xinstall -m 644 -W ${worksrcpath} dcraw_${locale}.1 ${destroot}${prefix}/share/man/${locale}/man1/dcraw.1
        }
        if {[file exist ${worksrcpath}/build/dcraw_${locale}.mo]} {
            xinstall -m 755 -d ${destroot}${prefix}/share/locale/${locale}/LC_MESSAGES
            xinstall -m 644 -W ${worksrcpath}/build dcraw_${locale}.mo ${destroot}${prefix}/share/locale/${locale}/LC_MESSAGES/dcraw.mo
        }
    }
}

livecheck.type          regex
livecheck.url           http://www.ryandesign.com/macports/version.php/${name}
livecheck.regex         (.*)
