# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4; truncate-lines: t -*- vim:fenc=utf-8:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

name                qwtplot3d
version             0.2.7
revision            2
categories          graphics science
platforms           darwin
maintainers         michaelld

description         Qt-based 3D-widgets
long_description    Feature-rich Qt / OpenGL-based C++ programming library, \
                    providing 3D-widgets for technical applications

homepage            http://${name}.sourceforge.net
master_sites        sourceforge:${name}
worksrcdir          ${name}
extract.suffix      .tgz

checksums           md5    2f14660152e2e26bfeaaeec479ed9f2b \
                    sha1   4463fafb8420a91825e165da7a296aaabd70abea \
                    rmd160 0f28462cb95ef6091d73642c8b26ece60d50bfb8

variant qt3 conflicts qt4 description {Use qt3-mac} {
    depends_lib-append  port:qt3-mac
}

variant qt4 conflicts qt3 description {Use qt4-mac} {
    depends_lib-append  port:qt4-mac
}

# move setting of 'qt_dir' outside variants, since 'if' statements are
# processed in-order while variants are processed after everything else.
if {[variant_isset qt3]} {
    set qt_dir          ${prefix}/libexec/qt3-mac
} else {
    # when variant 'qt3' is not set, use qt4 whether by default or via
    # the user's variant choice
    if {![variant_isset qt4]} {
        default_variants    +qt4
    }
    set qt_dir          ${prefix}/libexec/qt4-mac
}

configure.cmd       ${qt_dir}/bin/qmake
configure.pre_args  

variant qwt conflicts qwt52 description {Use qwt} {
    depends_lib-append  port:qwt
}

variant qwt52 conflicts qwt description {Use qwt52} {
    depends_lib-append  port:qwt52
}

if {![variant_isset qwt] && ![variant_isset qwt52]} {
    default_variants    +qwt52
}

variant debug description "Build release and debug versions" {}

post-patch {
    # tweak the qwtplot3d.pro file.  add key for later reinplace for
    # archs, no matter the status of the debug or universal variants.
    reinplace "/CONFIG/s/debug/debug @UNIVERSAL_TYPES@/g" \
        ${worksrcpath}/qwtplot3d.pro
    if {![variant_isset debug]} {
        # remove 'debug' from the qwtplot3d.pro file
        reinplace "s@debug@@g" ${worksrcpath}/qwtplot3d.pro
    }
    set qca_arch_types_str ""
    if {[variant_exists universal] && [variant_isset universal]} {
        # set universal arch types, depending on what the
        # user has specified
        array set macports_to_qt_build_arch {
            ppc     ppc
            i386    x86
            ppc64   ppc64
            x86_64  x86_64
        }
        set qca_arch_types ""
        foreach arch ${universal_archs} {
            lappend qca_arch_types $macports_to_qt_build_arch($arch)
        }
        set qca_arch_types_str [join ${qca_arch_types} " "]
    }
    reinplace "s/@UNIVERSAL_TYPES@/${qca_arch_types_str}/g" \
        ${worksrcpath}/qwtplot3d.pro
}

variant universal {
    # remove from universal configure flags
    configure.universal_args-delete --disable-dependency-tracking
}

patch {
    reinplace "s|0.2.6|${version}|g" ${worksrcpath}/qwtplot3d.pro
}

destroot {
    xinstall -m 0644 ${worksrcpath}/lib/lib${name}.${version}.dylib ${destroot}${prefix}/lib
    system "cd ${destroot}${prefix}/lib && ln -s lib${name}.${version}.dylib lib${name}.0.2.dylib"
    system "cd ${destroot}${prefix}/lib && ln -s lib${name}.${version}.dylib lib${name}.0.dylib"
    system "cd ${destroot}${prefix}/lib && ln -s lib${name}.${version}.dylib lib${name}.dylib"
    xinstall -m 755 -d  ${destroot}${prefix}/include/${name}
    eval xinstall -m 0644 [glob ${worksrcpath}/include/*] ${destroot}${prefix}/include/${name}
    system "install_name_tool -id ${prefix}/lib/lib${name}.${version}.dylib ${destroot}${prefix}/lib/lib${name}.${version}.dylib"
}
