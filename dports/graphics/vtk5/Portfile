# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem 1.0

name		vtk5
version		5.2.1
set branch	[join [lrange [split ${version} .] 0 1] .]
categories	graphics devel
maintainers	nomaintainer
description	3D visualization toolkit
long_description	an open source, freely available software system  \
	for 3D computer graphics, image processing, and visualization     \
	used by thousands of researchers and developers around the world. \
	VTK consists of a C++ class library, and several interpreted      \
	interface layers including Tcl/Tk, Java, and Python.

homepage	http://www.vtk.org/
platforms	darwin freebsd
master_sites	http://www.vtk.org/files/release/${branch}/
checksums vtk-${version}.tar.gz md5 d59520d5f6c49c8b4e3b9227e341b19f \
          vtk-${version}.tar.gz sha1 e08ee5c9d738c2fe774fdb3111818b9899a7b751 \
          vtk-${version}.tar.gz rmd160 c6cdee0c76e243d21d802690f138faab1c6eb863\
      vtkdata-${version}.tar.gz md5 3cd99917ab1ec3ef369dd40db74b93b1 \
      vtkdata-${version}.tar.gz sha1 a625f4934d0fbaad2242ae2bc920084775438933 \
      vtkdata-${version}.tar.gz rmd160 5628fec27673d99426922dcd32b8d66a0d86c9ec

depends_build	bin:cmake:cmake \
		port:readline
distfiles	vtk-${version}.tar.gz \
		vtkdata-${version}.tar.gz
distname	VTK

post-extract {
	delete ${worksrcpath}/Utilities/vtktiff/tif_fax3sm.c
#    set fl [open "| grep VTK_BUILD_VERSION ${worksrcpath}/CMakeLists.txt | grep 6"]
#    set data [read $fl]
#    close $fl
#    if {$data != "SET(VTK_BUILD_VERSION 6)\n"} { ui_msg "$data
#================================================================
#Warning : the Latest VTK version is not the same as the Portfile
#The build may still succeed but this should be reported as a bug
#================================================================"
#    }
}

configure	{ system "cd ${worksrcpath} && ${configure.env} cmake ${configure.args} ${worksrcpath}" }
configure.args	-DBUILD_SHARED_LIBS:BOOL=OFF \
		-DCMAKE_LIBRARY_PATH:PATH=${prefix}/lib \
		-DCMAKE_INCLUDE_PATH:PATH=${prefix}/include \
		-DCMAKE_INSTALL_PREFIX:PATH=${prefix} \
		-DCMAKE_INSTALL_NAME_DIR:STRING=${prefix}/lib \
		-DCMAKE_EXE_LINKER_FLAGS:STRING=-rpath ${prefix}/lib \
		-DVTK_INSTALL_PREFIX:PATH=${prefix} \
		-DVTK_USE_HYBRID:BOOL=ON \
		-DVTK_USE_CARBON:BOOL=OFF \
		-DVTK_WRAP_TCL:BOOL=ON \
		-DVTK_USE_COCOA:BOOL=ON \
		-DVTK_DATA_ROOT:PATH=${prefix}/share/VTKData \
		-DVTK_TCL_LIBRARY_DIR:FILEPATH=${prefix}/lib/tcl8.4 \
		-DVTK_WRAP_PYTHON:BOOL=OFF \
		-DVTK_REQUIRED_EXE_LINKER_FLAGS:STRING=-rpath ${prefix}/lib

configure.env	LDFLAGS="-L${prefix}/lib" \
		CPPFLAGS="-I${prefix}/include"

post-configure {
    reinplace "s|c++|c++ -L${prefix}/lib |"	\
    ${worksrcpath}/Infovis/Testing/Cxx/CMakeFiles/InfovisCxxTests.dir/link.txt \
    ${worksrcpath}/IO/Testing/Cxx/CMakeFiles/IOCxxTests.dir/link.txt \
    ${worksrcpath}/Views/Testing/Cxx/CMakeFiles/ViewsCxxTests.dir/link.txt \
    ${worksrcpath}/Wrapping/Tcl/CMakeFiles/vtk.dir/link.txt
}

platform darwin 8 {
	configure.env-append	CC=/usr/bin/gcc-4.0 CPP=/usr/bin/cpp-4.0 MACOSX_DEPLOYMENT_TARGET=10.4
}

platform darwin 9 {
	configure.env-append	MACOSX_DEPLOYMENT_TARGET=10.5
}

variant x11 {
	depends_build-append	port:xorg-libs
	configure.args-delete	"-D VTK_USE_COCOA:BOOL=ON"
	configure.args-append	-DVTK_USE_COCOA:BOOL=OFF \
				-DVTK_USE_X:BOOL=ON \
				-DOPENGL_gl_LIBRARY:FILEPATH=${x11prefix}/lib/libGL.dylib \
				-DOPENGL_glu_LIBRARY:FILEPATH=${x11prefix}/lib/libGLU.dylib
}

variant python description {builds python wrappers} {
	depends_build-append	port:python25
	configure.args-delete	-DVTK_WRAP_PYTHON:BOOL=OFF
	configure.args-append	-DPYTHON_DEBUG_LIBRARY:FILEPATH=${prefix}/lib/libpython2.5.dylib \
				-DPYTHON_EXECUTABLE:FILEPATH=${prefix}/bin/python2.5 \
				-DPYTHON_INCLUDE_PATH:FILEPATH=${prefix}/include/python2.5 \
				-DPYTHON_LIBRARY:FILEPATH=${prefix}/lib/libpython2.5.dylib \
				-DVTK_WRAP_PYTHON:BOOL=ON \
				-DVTK_PYTHON_SETUP_ARGS:STRING="--prefix=${prefix} --root=${destdir"}
}

set vtkdest	${destroot}${prefix}/share/doc/${name}

post-destroot {
	xinstall -d -m 0755 ${vtkdest}
	file copy ${worksrcpath}/README.html ${vtkdest}
	file copy ${worksrcpath}/Copyright.txt ${vtkdest}
	file copy ${worksrcpath}/Testing.txt ${vtkdest}

	# Must set RPATH on executables

	# Provide some examples
	file copy ${worksrcpath}/Examples ${vtkdest}
	foreach x {CommonCxxTests FilteringCxxTests GenericFilteringCxxTests GraphicsCxxTests IOCxxTests} { file copy ${worksrcpath}/bin/$x ${vtkdest}/Examples }
	foreach x {ImagingCxxTests RenderingCxxTests TestCxxFeatures TestInstantiator VTKBenchMark VolumeRenderingCxxTests WidgetsCxxTests} { file copy ${worksrcpath}/bin/$x ${vtkdest}/Examples }

	# Provide data files
	system "tar -C ${destroot}${prefix}/share -xzvf ${distpath}/vtkdata-${version}.tar.gz"
}
