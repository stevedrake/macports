# $Id$

PortSystem          1.0

name                amarok
version             2.0
revision            1
categories          kde kde4
maintainers         illogic-al@macports.org openmaintainer
description         Amarok, the world renown media player/.
long_description    Amarok is a music player and manager with an intuitive \
                    interface. It provides a variety of features which \
                    help you to discover and manage your music.
platforms           darwin
homepage            http://amarok.kde.org
master_sites	    http://ftp.kde.org/stable/${name}/${version}/src/
use_bzip2           yes
distname            ${name}-${version}
distfiles           ${distname}.tar.bz2
checksums           md5 bcecfedd3976df0e8a0bd4a499b89fcb

depends_lib         port:kdelibs4 \
                    path:bin/kde4:kdebase4-runtime \
                    port:taglib port:phonon \
                    path:lib/mysql5/libmysqld.a:mysql5-devel
# need to add embedded_server variant to mysql5 portfiles for this to work
					
depends_build       port:cmake

use_parallel_build  yes
worksrcdir          build
pre-configure 	    { file mkdir ${worksrcpath} }

configure.cmd       cmake
configure.ccache    no
configure.args	../${distname} -DBUILD_SHARED_LIBS=ON \
		-DCMAKE_BUILD_WITH_INSTALL_RPATH=ON \
		-DCMAKE_VERBOSE_MAKEFILE=ON \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_SYSTEM_PREFIX_PATH=\"${prefix}\;/usr\" \
		-DCMAKE_INSTALL_PREFIX=${prefix} \
		-DPHONON_INCLUDE_DIR=${prefix}/include \
		-DPHONON_LIBRARY=${prefix}/lib/libphonon.dylib \
		-DCMAKE_OSX_SYSROOT=${universal_sysroot} \
		-Wno-dev

variant universal {
    configure.universal_args-delete  --disable-dependency-tracking
    configure.args-append	-DCMAKE_OSX_ARCHITECTURES=\"[strsed ${configure.universal_archs} "g| |;|"]\"
}

variant debug description "Enable debug binaries" {
	configure.args-delete		-DCMAKE_BUILD_TYPE=Release
	configure.args-append		-DCMAKE_BUILD_TYPE=debugFull
}

post-destroot {
    # We have to move the collection scanner within the bundle
    # because it doesn't work otherwise
	system "mv ${destroot}/${prefix}/bin/amarokcollectionscanner ${destroot}/Applications/KDE4/Amarok.app/Contents/MacOS/"
    # and this puts the bundle icons where they should go
	system "mv ${destroot}/${prefix}/bin/amarok.app/Contents/Resources ${destroot}/Applications/KDE4/Amarok.app/Contents/"
	system "rm -rf ${destroot}/${prefix}/bin"
}

