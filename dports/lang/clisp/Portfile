# $Id: Portfile,v 1.15 2005/08/04 23:32:43 gwright Exp $

PortSystem 1.0
name		clisp
version		2.34
categories	lang
maintainers	gwright@opendarwin.org
platforms	darwin
description	The Clisp Common Lisp Implementation
long_description	\
		CLISP is a Common Lisp implementation by Bruno Haible, \
		formerly of Karlsruhe University, and Michael Stoll, \
		formerly of Munich University, both in Germany. \
		It mostly supports the Lisp described in the \
		ANSI Common Lisp standard. \
		CLISP includes an interpreter, a compiler, almost all \
		of CLOS, a foreign language interface and a socket interface. \
		An X11 interface is available through CLX and Garnet. \
		Command line editing is provided by readline.

homepage	http://clisp.cons.org/
master_sites	gnu:clisp/release/${version}	\
		sourceforge

depends_lib	port:readline		\
		port:gettext

checksums	md5 20f1b1dce6bd184b8f00653772497eae

build.dir	${workpath}/${worksrcdir}/src

configure.env	CPPFLAGS=-I${prefix}/include	\
		LDFLAGS=-L${prefix}/lib

post-configure	{ cd ${build.dir}
		  system "./makemake --prefix=${prefix}		\
				     --with-unicode		\
				     --with-readline		\
				     --with-dynamic-ffi		\
				     --with-export-syscalls	\
				     --with-gettext  > Makefile && \
				     make config.lisp"

		  reinplace "s|CLFLAGS =|CLFLAGS = -L${prefix}/lib|g" Makefile
		}

#
# The  build procedure is awkward in part because 2.34 shipped with a broken
# test suite (this is the reason for the multiple "make check-*" lines).
# The repetition of the CPPFLAGS and LDFLAGS is necessary because of clisp's
# hand written (and very fragile) configuration process.
#
build		{ system "ulimit -s 8192 && cd ${build.dir}"
		  system "CPPFLAGS=-I${prefix}/include LDFLAGS=-L${prefix}/lib make"
		  system "CPPFLAGS=-I${prefix}/include LDFLAGS=-L${prefix}/lib make check-recompile"
		  system "CPPFLAGS=-I${prefix}/include LDFLAGS=-L${prefix}/lib make check-tests"
		  system "CPPFLAGS=-I${prefix}/include LDFLAGS=-L${prefix}/lib make check-ansi-tests"
		}

pre-destroot	{ cd ${build.dir} }


