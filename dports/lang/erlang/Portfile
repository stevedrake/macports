# $Id$

PortSystem 1.0
name		erlang
version		R12B-4
revision    1
categories	lang erlang
maintainers	bfulgham@macports.org
platforms	darwin
description	The Erlang Programming Language
long_description	\
		Erlang is a programming language designed at the	\
		Ericsson Computer Science Laboratory. Open-source	\
		Erlang is being released to help encourage the spread	\
		of Erlang outside Ericsson.				\
									\
		We are releasing free of charge:			\
			The entire source code of the current Erlang	\
			system.						\
			Extensive libraries of code for building robust	\
			fault-tolerant distributed applications.	\
			All with documentation.				\
									\
		All the above software has been battle tested in a	\
		number of Ericsson products, for example the new	\
		Ericsson ATM switch. 

homepage	http://www.erlang.org/
master_sites	http://www.erlang.org/download/

distfiles	otp_src_${version}${extract.suffix}		\
		otp_doc_man_${version}${extract.suffix}		\
		otp_doc_html_${version}${extract.suffix}

checksums       otp_src_R12B-4.tar.gz \
                    md5     ae81edda4a17506af7a9d73abca033b2 \
                    sha1    4e42454c3f560ce6efd3c917a79a5b288664e329 \
                    rmd160  3c57ae04388c0493d97c76529c57c50de639bdce \
                otp_doc_man_R12B-4.tar.gz \
                    md5     ef8f96d1721a2345cc87b208cde3de06 \
                    sha1    b954711b493e384606ce23d32a6d980017637b10 \
                    rmd160  f14eb1f542ebecceddd6ac70aa4ed325f91b0b24 \
                otp_doc_html_R12B-4.tar.gz \
                    md5     f633cd418d8260af7a11c998aa88072b \
                    sha1    cbe6bc52a5000b21de5cac5f9b2672b935e94ed7 \
                    rmd160  bf05981ddf2e97910141739980cee09572b1c34d

extract.only	otp_src_${version}${extract.suffix}

pre-patch	{ file rename ${workpath}/otp_src_${version} ${workpath}/${name}-${version} }

patchfiles	patch-toolbar.erl \
                patch-erts_emulator_Makefile.in \
                patch-lib_ssl_c_src_esock_openssl.c \
                patch-lib_ssl_c_src_Makefile.dist \
                patch-lib_ssl_c_src_Makefile.in \
                patch-erts_emulator_sys_unix_ddll.c

configure.args  --prefix=${destroot}${prefix}	\
                --enable-kernel-poll            \
		--disable-smp-support

variant smp	{
	configure.args-delete	--disable-smp-support
}

variant ssl	{
	configure.args-append	--with-ssl=${prefix}
	configure.ldflags-append -lz
	depends_build-append	port:openssl
	depends_run-append	port:openssl
}

variant hipe {
	# Currently produces bus errors in 10.5.3 due to changes in
	# signal handling
	configure.args-append	--enable-hipe
}


platform i386 {
   pre-configure {
      file copy ${filespath}/mach_override.h ${workpath}/${name}-${version}/erts/emulator/hipe
      file copy ${filespath}/mach_override.c ${workpath}/${name}-${version}/erts/emulator/hipe
   }
}



depends_build	port:gawk
depends_run	port:tk

post-destroot	{
	system "tar -C ${destroot}${prefix}/lib/erlang -zxvf ${distpath}/otp_doc_html_${version}${extract.suffix}"
	system "tar -C ${destroot}${prefix}/lib/erlang -zxvf ${distpath}/otp_doc_man_${version}${extract.suffix}"
 
        set erts_dir   erts-5.6.4

        reinplace s|${destroot}|| ${destroot}${prefix}/lib/erlang/bin/erl
        reinplace s|${destroot}|| ${destroot}${prefix}/lib/erlang/bin/start
        reinplace s|${destroot}|| ${destroot}${prefix}/lib/erlang/${erts_dir}/bin/erl
        reinplace s|${destroot}|| ${destroot}${prefix}/lib/erlang/${erts_dir}/bin/start

	foreach x {dialyzer ear ecc elink epmd erl erlc escript run_erl start to_erl typer} { file delete -force ${destroot}${prefix}/bin/${x} }
	foreach x {dialyzer erl erlc escript run_erl start to_erl typer} { system "ln -s ../lib/erlang/bin/${x} ${destroot}${prefix}/bin/${x}" }

	file delete -force ${destroot}${prefix}/lib/erlang/bin/epmd
	system "ln -s ../${erts_dir}/bin/epmd ${destroot}${prefix}/lib/erlang/bin/epmd"
}
