# $Id$

PortSystem 1.0
name            erlang
version         R13B03
categories      lang erlang
maintainers     bfulgham
platforms       darwin
description     The Erlang Programming Language
long_description                                                        \
                Erlang is a programming language designed at the        \
                Ericsson Computer Science Laboratory. Open-source       \
                Erlang is being released to help encourage the spread   \
                of Erlang outside Ericsson.                             \
                                                                        \
                We are releasing free of charge:                        \
                    The entire source code of the current Erlang        \
                    system.                                             \
                    Extensive libraries of code for building robust     \
                    fault-tolerant distributed applications.            \
                    All with documentation.                             \
                                                                        \
                All the above software has been battle tested in a      \
                number of Ericsson products, for example the new        \
                Ericsson ATM switch.

homepage        http://www.erlang.org/
master_sites    http://www.erlang.org/download/ \
                http://www.erlang.org/download/patches/:patches

# Parallel build doesn't work as per R13B01
use_parallel_build  no

distfiles       otp_src_${version}${extract.suffix}                    \
                otp_doc_man_${version}${extract.suffix}                \
                otp_doc_html_${version}${extract.suffix}

checksums       otp_src_${version}.tar.gz \
                md5     411fcb29f0819973f71e28f6b56d9948 \
                sha1    161f22d498da244d4b32181a78b04d97523857d1 \
                rmd160  7cf3d1cf6cdf73ff19f5a416396c4024e641ec29 \
                otp_doc_man_${version}.tar.gz \
                md5     1fe80b110061ef73614824fb06d4d6eb \
                sha1    2241651db8c4bce02fc5d34d63c983a3d55d1011 \
                rmd160  8d6af7ea55fe6d8696fd28c563f9c4e5d9aee779 \
                otp_doc_html_${version}.tar.gz \
                md5     ade1a4d5dcfe3732dc953f7cf9664b37 \
                sha1    3a578b3d83fe7bb7abd74823d65548e17cd228e6 \
                rmd160  b2971024e56e3b05ba537c722fca694daade2ffb

pre-patch       { file rename ${workpath}/otp_src_${version} ${workpath}/${name}-${version} }

# http://www.erlang.org/pipermail/erlang-bugs/2009-January/001171.html
patchfiles	patch-toolbar.erl \
                patch-erts_emulator_Makefile.in \
                patch-erts_emulator_hipe_hipe_amd64_asm.m4.diff \
                patch-erts_emulator_hipe_hipe_amd64_bifs.m4.diff \
		patch-erts_emulator_hipe_hipe_amd64_glue.S.diff \
                patch-erts_emulator_hipe_hipe_amd64.c.diff \
                patch-erts_emulator_sys_unix_sys_float.c.diff \
                patch-erts_configure.diff \
		patch-lib_ssl_c_src_esock_openssl.c \
                patch-lib_wx_configure.in \
                patch-lib_wx_configure

configure.args  --prefix=${destroot}${prefix}	\
                --enable-kernel-poll            \
                --enable-threads                \
                --enable-dynamic-ssl-lib        \
                --enable-smp-support            \
                --enable-hipe                   \
                --disable-ssl

platform darwin 10 {
    # 10.6 comes with wxWidgets and since it requires libsdl, which
    # current doesn't compile (bug #20235), we can avoid it here.
    depends_build-delete    port:wxWidgets

    patchfiles-delete	patch-lib_ssl_c_src_esock_openssl.c
    
    # 10.6 (and 10.6.1) has a bad bug related to using dlopen in a thread.
    # rdar://7209349 - http://www.openradar.appspot.com/7209349
    # This is a workaround.
    patchfiles-append   patch-erts_emulator_sys_unix_ddll.c.diff
    configure.ldflags-append -framework CoreFoundation
}

variant ssl description {Build SSL support}	{
        configure.args-delete    --disable-ssl
	configure.args-append    --with-ssl=${prefix}
	configure.ldflags-append -lz
	depends_build-append     port:openssl
	depends_run-append       port:openssl
}

variant nohipe description {Disable HiPE (native-code bytecode compiler)}   {
	configure.args-delete   --enable-hipe
}

depends_build   port:gawk \
                port:wxWidgets
depends_run     port:tk

post-destroot	{
	system "tar -C ${destroot}${prefix}/lib/erlang -zxvf ${distpath}/otp_doc_html_${version}${extract.suffix}"
	system "tar -C ${destroot}${prefix}/lib/erlang -zxvf ${distpath}/otp_doc_man_${version}${extract.suffix}"
 
        set erts_dir   erts-5.7.4

        reinplace s|${destroot}|| ${destroot}${prefix}/lib/erlang/bin/erl
        reinplace s|${destroot}|| ${destroot}${prefix}/lib/erlang/bin/start
        reinplace s|${destroot}|| ${destroot}${prefix}/lib/erlang/${erts_dir}/bin/erl
        reinplace s|${destroot}|| ${destroot}${prefix}/lib/erlang/${erts_dir}/bin/start

	foreach x {dialyzer ear ecc elink epmd erl erlc escript run_erl start to_erl typer} { file delete -force ${destroot}${prefix}/bin/${x} }
	foreach x {dialyzer erl erlc escript run_erl start to_erl typer} { system "ln -s ../lib/erlang/bin/${x} ${destroot}${prefix}/bin/${x}" }

	file delete -force ${destroot}${prefix}/lib/erlang/bin/epmd
	system "ln -s ../${erts_dir}/bin/epmd ${destroot}${prefix}/lib/erlang/bin/epmd"
}

# Livecheck 
livecheck.type     regex
livecheck.version  ${version}
livecheck.url      ${homepage}download/
livecheck.regex    "otp_src_(R\[0-9\]+\[AB\]\[0-9\]*(-\[0-9\])?)\\.tar\\.gz"
