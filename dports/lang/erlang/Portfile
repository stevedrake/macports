# $Id$

PortSystem 1.0
name		erlang
version		R13B
revision    4
categories	lang erlang
maintainers	bfulgham
platforms	darwin
description	The Erlang Programming Language
long_description                                                        \
                Erlang is a programming language designed at the        \
                Ericsson Computer Science Laboratory. Open-source       \
                Erlang is being released to help encourage the spread   \
                of Erlang outside Ericsson.                             \
                                                                        \
                We are releasing free of charge:                        \
                    The entire source code of the current Erlang        \
                    system.                                             \
                    Extensive libraries of code for building robust     \
                    fault-tolerant distributed applications.            \
                    All with documentation.                             \
                                                                        \
                All the above software has been battle tested in a      \
                number of Ericsson products, for example the new        \
                Ericsson ATM switch. 

homepage        http://www.erlang.org/
master_sites    http://www.erlang.org/download/ \
                http://www.erlang.org/download/patches/:patches


distfiles       otp_src_${version}${extract.suffix}                    \
                otp_doc_man_${version}${extract.suffix}                \
                otp_doc_html_${version}${extract.suffix}               \
                eunit-2.1.1.tar.gz:patches

checksums       otp_src_${version}.tar.gz \
                    md5     6d8c256468a198458b9f08ba6aa1a384 \
                    sha1    a69611923c48861aef157e7b4a06689d339571ff \
                    rmd160  625bf1b2c9051218dc6a4f3c89eaea50367fa112 \
                otp_doc_man_${version}.tar.gz \
                    md5     9265ebf3b1041be6ae18e323b0933601 \
                    sha1    9a390f4e670db7b6596200031d4e0dbb6e96578d \
                    rmd160  ea0341750880a30359979d0e6aefcb2a7e1cecb5 \
                otp_doc_html_${version}.tar.gz \
                    md5     a14b1111550ce2bce65090de5cf3b0ff \
                    sha1    d479dc6f865ae0cd59a9085de20698fae9d71b67 \
                    rmd160  632b54c5b4a2261d61377c171a9ca7e71176bd69 \
                eunit-2.1.1.tar.gz \
                    md5     b29d3aa9a03b0be0c55ed729e41931a9 \
                    sha1    339aca80925e560f5e6724d900a9a29cc72810b4 \
                    rmd160  a483fb2dab4cb85558d33fa9a6747729d4730321

extract.only    otp_src_${version}${extract.suffix} eunit-2.1.1.tar.gz
post-extract {
    system "cd ${workpath}/eunit-2.1.1/ && tar cf - . | (cd ${workpath}/otp_src_${version}/lib/eunit ; tar xf -)"
}

pre-patch       { file rename ${workpath}/otp_src_${version} ${workpath}/${name}-${version} }

# http://www.erlang.org/pipermail/erlang-bugs/2008-October/001023.html
# http://www.erlang.org/pipermail/erlang-bugs/2008-October/001024.html
# http://www.erlang.org/pipermail/erlang-bugs/2009-January/001171.html
patchfiles	patch-toolbar.erl \
                patch-erts_emulator_Makefile.in \
                patch-lib_ssl_c_src_esock_openssl.c \
                patch-lib_ssl_c_src_Makefile.dist \
                patch-lib_ssl_c_src_Makefile.in \
                patch-decode_big.c.diff \
                patch-decode_fun.c.diff \
                patch-lib-erl_interface-src-connect-ei_connect.c.diff \
                patch-lib-erl_interface-include-ei.h.diff \
                patch-erts_configure.diff \
                patch-lib_wx_configure.in \
                patch-lib_wx_configure

configure.args  --prefix=${destroot}${prefix}	\
                --enable-kernel-poll            \
                --enable-threads                \
                --enable-dynamic-ssl-lib        \
                --enable-smp-support            \
                --enable-hipe

variant ssl description {Build SSL support}	{
	configure.args-append    --with-ssl=${prefix}
	configure.ldflags-append -lz
	depends_build-append     port:openssl
	depends_run-append       port:openssl
}

variant nohipe description {Disable HiPE (native-code bytecode compiler)}   {
	configure.args-delete   --enable-hipe
}

depends_build   port:gawk \
                port:wxWidgets
depends_run     port:tk

post-destroot	{
	system "tar -C ${destroot}${prefix}/lib/erlang -zxvf ${distpath}/otp_doc_html_${version}${extract.suffix}"
	system "tar -C ${destroot}${prefix}/lib/erlang -zxvf ${distpath}/otp_doc_man_${version}${extract.suffix}"
 
        set erts_dir   erts-5.7.1

        reinplace s|${destroot}|| ${destroot}${prefix}/lib/erlang/bin/erl
        reinplace s|${destroot}|| ${destroot}${prefix}/lib/erlang/bin/start
        reinplace s|${destroot}|| ${destroot}${prefix}/lib/erlang/${erts_dir}/bin/erl
        reinplace s|${destroot}|| ${destroot}${prefix}/lib/erlang/${erts_dir}/bin/start

	foreach x {dialyzer ear ecc elink epmd erl erlc escript run_erl start to_erl typer} { file delete -force ${destroot}${prefix}/bin/${x} }
	foreach x {dialyzer erl erlc escript run_erl start to_erl typer} { system "ln -s ../lib/erlang/bin/${x} ${destroot}${prefix}/bin/${x}" }

	file delete -force ${destroot}${prefix}/lib/erlang/bin/epmd
	system "ln -s ../${erts_dir}/bin/epmd ${destroot}${prefix}/lib/erlang/bin/epmd"
}
