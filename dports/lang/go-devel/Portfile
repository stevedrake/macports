# $Id$

PortSystem          1.0

name                go-devel
set real_name       go
version             0.0.1
revision            1
categories          lang
platforms           darwin freebsd linux
license             BSD
maintainers         singingwolfboy
description         Systems programming language developed by Google (development version)
long_description    \
    A systems programming language developed by Google Inc. Go is similar to C, \
    but with fast builds, clean syntax, garbage collection, methods for any \
    type, and run-time reflection. Go promotes writing systems and servers as \
    sets of lightweight communicating processes, called goroutines, with \
    strong support from the language. It feels like a dynamic language but has \
    the speed and safety of a static language. 

homepage            http://golang.org/
fetch.type          hg
hg.url              https://go.googlecode.com/hg/
#hg.tag              release
hg.tag              9482fde11a02

depends_build       bin:bison:bison \
                    bin:make:gmake \
                    bin:awk:gawk \
                    bin:ed:ed

set GOROOT          ${worksrcpath}
set GOBIN           ${workpath}/bin

# based on minivmac port
# converts normal arch names into Go arch names
proc my_arch_to_target {arch} {
    switch ${arch} {
        i386 {
            return 386
        }
        x86_64 {
            return amd64
        }
        arm {
            return arm
        }
        default {
            return -code error "unsupported architecture ${arch}"
        }
    }
}
set GOARCH          [my_arch_to_target ${build_arch}]

# based on wine port
pre-fetch {
    if {"big" == ${os.endian}} {
        ui_error "${name} can only be used on an Intel Mac or other computer with a little-endian processor."
        return -code error "incompatible processor"
    }
}

use_configure       no

pre-build {
    xinstall -m 755 -d ${GOROOT} ${GOBIN}
}
build.dir           ${worksrcpath}/src
build.cmd           ./make.bash
build.target    
build.env           GOROOT=${GOROOT} GOBIN=${GOBIN} GOARCH=${GOARCH}
use_parallel_build  no

test.run            yes
test.dir            ${worksrcpath}/src
test.cmd            ./run.bash
test.target 
test.env            GOROOT=${GOROOT} GOBIN=${GOBIN} GOARCH=${build_arch}

destroot {
    # bin files
    file delete ${destroot}${prefix}/bin
    file copy ${GOBIN} ${destroot}${prefix}
        
    # lib files
    file delete -force ${destroot}${prefix}/lib
    file copy ${worksrcpath}/lib ${destroot}${prefix}
    
    # include files
    file copy ${worksrcpath}/include ${destroot}${prefix}/include/${real_name}
    
    # documentation
    xinstall -m 755 -d ${destroot}${prefix}/share/doc/
    file copy ${worksrcpath}/doc ${destroot}${prefix}/share/doc/${real_name}
    xinstall -m 644 -W ${worksrcpath} favicon.ico \
        ${destroot}${prefix}/share/doc/${real_name}
}


platform darwin {
    build.env-append GOOS=darwin
    test.env-append GOOS=darwin
}
platform freebsd {
    build.env-append GOOS=freebsd
    test.env-append GOOS=freebsd
}
platform linux {
    build.env-append GOOS=linux
    test.env-append GOOS=linux
}
variant nacl description {Native Client platform} {
    build.env-delete GOOS
    build.env-append GOOS=nacl
    test.env-delete GOOS
    test.env-append GOOS=nacl
}


variant bash_completion description {Install bash completion files for Go} {
    depends_run-append      path:etc/bash_completion.d:bash-completion
    post-destroot {
        xinstall -m 755 -d ${destroot}${prefix}/etc/bash_completion.d
        xinstall -m 644 -W ${worksrcpath}/misc/bash ${real_name} \
            ${destroot}${prefix}/etc/bash_completion.d/${real_name}
    }
}
variant emacs description {Install Go syntax highlighting for emacs} {
    depends_run-append      bin:emacs:emacs
    post-destroot {
        xinstall -m 755 -d ${destroot}${prefix}/share/emacs/site-lisp/
        eval xinstall -m 644 [glob ${worksrcpath}/misc/emacs/*.el] \
            ${destroot}${prefix}/share/emacs/site-lisp/
    }
}
variant vim description {Install Go syntax highlighting for vim} {
    depends_run-append      bin:vim:vim
    post-destroot {
        xinstall -m 755 -d ${destroot}${prefix}/share/vim/vim72/syntax/
        xinstall -m 644 ${worksrcpath}/misc/vim/${real_name}.vim \
            ${destroot}${prefix}/share/vim/vim72/syntax/
    }
}
