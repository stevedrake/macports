# $Id: Portfile 34218 2008-02-18 09:13:42Z erickt@macports.org $

PortSystem 1.0

name                    llvm-devel
version                 53722
set checker-version     62
categories              lang
platforms               darwin
maintainers             erickt@macports.org pguyot@kallisys.net openmaintainer
description             llvm is a next generation compiler infrastructure
long_description        llvm brings tools to work on the llvm intermediate \
                        language incl. a C and C++ frontend.

homepage                http://llvm.org/
master_sites            macports:pguyot

distfiles               llvm-${version}.tar.gz

checksums               llvm-${version}.tar.gz \
                            md5     2572a3e6bc2d2356942dbae1929621c8 \
                            sha1    be776f49fe15c7599631eff0e6a4db575593f480 \
                            rmd160  efa4833664a2ff5b017645b13ce642d3fa1f1167 \
                        checker-${checker-version}.tar.gz \
                            md5     a04f5c35a65556b73e56c28f766e3750 \
                            sha1    85dcdc6a592fa4000b3314c55320dad7065f2522 \
                            rmd160  243bb4e053c2b435ac0af137d49ab5be4011e292

depends_build           bin:flex:flex \
                        bin:bison:bison

worksrcdir              build

variant clang description {Install clang (with checker tools)} {
    distfiles-append    checker-${checker-version}.tar.gz
    post-extract {
        system "mv ${workpath}/checker-${checker-version}/ ${workpath}/llvm-${version}/tools/clang"
    }
    patch.dir           ${workpath}/llvm-${version}
    patchfiles-append   patch-tools-Makefile.diff
    depends_lib-append  port:python25
    post-destroot {
        reinplace "s|/usr/bin/env python|${prefix}/bin/python2.5|g" ${workpath}/llvm-${version}/tools/clang/utils/ccc-analyzer

        file copy ${workpath}/llvm-${version}/tools/clang/utils/ccc ${destroot}${prefix}/bin/
        file copy ${workpath}/llvm-${version}/tools/clang/utils/ccc-analyzer ${destroot}${prefix}/bin/
        file copy ${workpath}/llvm-${version}/tools/clang/utils/scan-build ${destroot}${prefix}/bin/
        file copy ${workpath}/llvm-${version}/tools/clang/utils/sorttable.js  ${destroot}${prefix}/bin/
    }
}

post-extract {
    file mkdir ${workpath}/build
}

configure.cmd           ../llvm-${version}/configure
configure.args          --enable-optimized --enable-jit

post-destroot {
    file mkdir ${destroot}${prefix}/lib/llvm
    file mkdir ${destroot}${prefix}/lib/llvm/src
    file mkdir ${destroot}${prefix}/lib/llvm/obj

    file copy ${workpath}/llvm-${version}/include ${destroot}${prefix}/lib/llvm/src
    file copy ${workpath}/build/include ${destroot}${prefix}/lib/llvm/obj
    file copy ${workpath}/build/Release ${destroot}${prefix}/lib/llvm/obj

    reinplace "s|${workpath}/build/\.\./llvm-${version}|${prefix}/lib/llvm/src|g" ${destroot}${prefix}/bin/llvm-config
    reinplace "s|${workpath}/build|${prefix}/lib/llvm/obj|g"                      ${destroot}${prefix}/bin/llvm-config

    reinplace "s|${workpath}/build/\.\./llvm-${version}|${prefix}/lib/llvm/src|g" ${destroot}${prefix}/lib/llvm/obj/Release/bin/llvm-config
    reinplace "s|${workpath}/build|${prefix}/lib/llvm/obj|g"                      ${destroot}${prefix}/lib/llvm/obj/Release/bin/llvm-config
}
