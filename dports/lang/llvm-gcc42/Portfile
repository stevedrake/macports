# $Id$

PortSystem 1.0

name                    llvm-gcc42
version                 2.7
revision                0
categories              lang
platforms               darwin
license                 GPLv2+
maintainers             erickt mfeiri
description             llvm-gcc42 is a gcc compiler frontend for llvm
long_description        llvm-gcc42 integrates the LLVM optimizers and code \
                        generator with the GCC 4.2 parser. This allows LLVM to \
                        compile languages supported by the GCC compiler \
                        frontends, and provides high-fidelity drop-in \
                        compatibility with version 4.2 of GCC.

homepage                http://llvm.org/
master_sites            ${homepage}releases/${version}/

distname                llvm-gcc-4.2-${version}.source
extract.suffix          .tgz

checksums               md5     c5033005ceac1988b7cdc908445090f0 \
                        sha1    aaf466efa41e95014d51a2f8a60ad3b7771c1829 \
                        rmd160  523edd94ece00caaaa3ff2399f3c0b044b50f432

# gmp and mpfr are not universal
universal_variant       no

depends_lib             port:llvm port:gmp port:mpfr port:libiconv

worksrcdir              build

post-extract {
    file mkdir ${worksrcpath}
}

# the generated compiler doesn't accept -arch
if {[info exists build_arch] && ${os.platform} == "darwin"} {
    configure.cc_archflags
    configure.cxx_archflags
    configure.objc_archflags
    if {${build_arch} == "i386" } {
        configure.pre_args-append --host=i686-apple-darwin${os.major}
    } else {
        configure.pre_args-append --host=${build_arch}-apple-darwin${os.major}
    }
}

configure.cmd           ../llvm-gcc-4.2-${version}.source/configure
configure.args          --enable-llvm=${prefix}/lib/llvm/obj \
                        --enable-languages=c,c++,objc,obj-c++,fortran \
                        --libdir=${prefix}/lib/${name} \
                        --includedir=${prefix}/include/${name} \
                        --infodir=${prefix}/share/info \
                        --mandir=${prefix}/share/man \
                        --with-local-prefix=${prefix} \
                        --with-system-zlib \
                        --disable-nls \
                        --program-prefix=llvm- \
                        --program-suffix=-4.2 \
                        --with-gxx-include-dir=/usr/include/c++/4.2.1 \
                        --with-gmp=${prefix} \
                        --with-mpfr=${prefix} \
                        --with-slibdir=/usr/lib \
                        --with-build-time-tools=/usr/bin

build.target	        bootstrap

destroot.target	        install install-info-host

post-destroot {
        system "cd ${destroot}${prefix}/bin/ && ln -s llvm-gcc-4.2 llvm-gcc"
        system "cd ${destroot}${prefix}/bin/ && ln -s llvm-g++-4.2 llvm-g++"

        # dont install slibs outside of ${prefix}
        foreach f [glob -nocomplain ${destroot}/usr/lib/*] {
            file rename $f ${destroot}${prefix}/lib/${name}/
        }

        file delete -force ${destroot}${prefix}/share/man/man7 \
            ${destroot}${prefix}/share/info

        # install/copy ffitarget.h only if we have it
        if {![catch {set ffitarget.h [glob ${destroot}${prefix}/lib/${name}/gcc/*/${version}/include/ffitarget.h]} result]} {
            file copy ${ffitarget.h} ${destroot}${prefix}/include/${name}/
        }
        xinstall -m 755 -d ${destroot}${prefix}/etc/select/gcc
        xinstall -m 444 ${filespath}/mp-llvm-gcc42 ${destroot}${prefix}/etc/select/gcc/
}

platform darwin 9 {
        configure.args-delete --with-gxx-include-dir=/usr/include/c++/4.2.1
        configure.args-append --with-gxx-include-dir=/usr/include/c++/4.0.0
}

platform darwin {
    depends_run-append  port:ld64
    post-destroot {
        if {${build_arch} == "i386" } {
            file mkdir ${destroot}${prefix}/lib/llvm-gcc42/i686-apple-darwin${os.major}/4.2.1
            ln -s ../../../../bin/ld ${destroot}${prefix}/lib/llvm-gcc42/i686-apple-darwin${os.major}/4.2.1/ld
        } else {
            file mkdir ${destroot}${prefix}/lib/llvm-gcc42/${build_arch}-apple-darwin${os.major}/4.2.1
            ln -s ../../../../bin/ld ${destroot}${prefix}/lib/llvm-gcc42/${build_arch}-apple-darwin${os.major}/4.2.1/ld
        }
    }
}

variant libgcc_s \
        description "Install and use the libgcc_s libraries provided by gcc instead of those provided by the system. \
        This introduces a linker dependency in all binaries built for 10.4 and 10.5 targets using this compiler." {
        configure.args-delete --with-slibdir=/usr/lib
}

livecheck.type	regex
livecheck.url   ${homepage}releases/
livecheck.regex {'(\d+(?:\.\d+)*)'}
