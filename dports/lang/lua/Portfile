# $Id$

PortSystem              1.0

name                    lua
version                 5.1.3
revision                2
categories              lang
platforms               darwin
maintainers             pmq openmaintainer

description             powerful, lightweight programming language
long_description        Lua is a powerful, light-weight programming language \
			designed for extending applications. Lua is also frequently \
			used as a general-purpose, standalone language.

homepage                http://www.lua.org
master_sites		${homepage}/ftp/
checksums               sha1 89bc9f5a351402565b8077e8123327e7cd15f004 \
			rmd160 1c5979dd4986057fef325aa2af0c872bbecab92e

depends_lib		port:readline
build.target		macosx

test.run		yes
test.env		DYLD_LIBRARY_PATH=./lib

patchfiles		patch-lua-5.1.3.diff

post-patch {
	reinplace "s|/usr/local|${prefix}|g" ${worksrcpath}/Makefile
	reinplace "s|/usr/local|${prefix}|g" ${worksrcpath}/src/luaconf.h
	reinplace "s|/man/man1|/share/man/man1|g" ${worksrcpath}/Makefile

	# to complement the use_readline patch
	reinplace "s|MYLDFLAGS=|MYLDFLAGS=-L${prefix}/lib|" ${worksrcpath}/src/Makefile
	# for the pkgconfig file
	reinplace "s|/usr/local|${prefix}|g" ${worksrcpath}/etc/lua.pc
}

# "use_configure no" nullifies the configure.universal_* hooks
configure {
	if {[variant_isset universal]} {
		reinplace "s|MYCFLAGS=|MYCFLAGS=\"${configure.universal_cflags} \"|g" ${worksrcpath}/src/Makefile
		reinplace "s|MYLDFLAGS=|MYLDFLAGS=${configure.universal_ldflags} |g" ${worksrcpath}/src/Makefile
	}
}

destroot.target	install INSTALL_TOP=${destroot}${prefix}
post-destroot {
	xinstall -d -m 0755 ${destroot}${prefix}/share/doc/${name}
	xinstall -m 0644 ${worksrcpath}/README ${destroot}${prefix}/share/doc/${name}
	xinstall -m 0644 ${worksrcpath}/COPYRIGHT ${destroot}${prefix}/share/doc/${name}
	xinstall -m 0644 ${worksrcpath}/HISTORY ${destroot}${prefix}/share/doc/${name}
	xinstall -d -m 0755 ${destroot}${prefix}/share/doc/${name}/html
	foreach html [glob ${worksrcpath}/doc/*.html ${worksrcpath}/doc/*.gif] {
		xinstall -m 0644 ${html} ${destroot}${prefix}/share/doc/${name}/html
	}
	xinstall -d -m 0755 ${destroot}${prefix}/share/doc/${name}/test
	foreach test [glob ${worksrcpath}/test/README ${worksrcpath}/test/*.lua] {
		xinstall -m 0644 ${test} ${destroot}${prefix}/share/doc/${name}/test
	}
	xinstall -d -m 0755 ${destroot}${prefix}/lib/pkgconfig
	xinstall -m 0644 ${worksrcpath}/etc/lua.pc ${destroot}${prefix}/lib/pkgconfig/lua.pc
}

platform darwin 7 {
	depends_lib-delete port:readline
	patchfiles-append  patch-readline_darwin7.diff
}
