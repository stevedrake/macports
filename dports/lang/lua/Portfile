# $Id$

PortSystem          1.0

name                lua
conflicts           lua50
set compat_version  5.1
version             ${compat_version}.4
revision            4
categories          lang
platforms           darwin
maintainers         nomaintainer
description         powerful, lightweight programming language
long_description    \
    Lua is a powerful, light-weight programming language designed for \
    extending applications. Lua is also frequently used as a general-purpose, \
    standalone language.

homepage            http://www.lua.org
master_sites        ${homepage}/ftp/

checksums           ${distfiles} \
                    sha1    2b11c8e60306efb7f0734b747588f57995493db7 \
                    rmd160  c867c8364295d3e4fb4e4d8ebb27fa2b2312cdef \
                    patch-lua-5.1.4-3 \
                    sha1    312d5baf480aa4c61cdc212dcbd10322f020c198 \
                    rmd160  8361d74d2b6d1f7a53eaa9943dd5c4f2f3b892b9

depends_lib         port:readline
build.target        macosx

test.run            yes
test.env            DYLD_LIBRARY_PATH=./lib

patch.dir           ${worksrcpath}/src
patchfiles          patch-lua-5.1.4-3 \
                    patch-Makefile.diff \
                    patch-src_Makefile.diff

post-patch {
    reinplace "s|/usr/local|${prefix}|g" ${worksrcpath}/Makefile ${worksrcpath}/src/luaconf.h
    reinplace "s|/man/man1|/share/man/man1|g" ${worksrcpath}/Makefile

    # reinplace %VERSION% and %COMPAT_VERSION% after applying patch-dlopen.diff
    reinplace "s|%VERSION%|${version}|g" ${worksrcpath}/Makefile ${worksrcpath}/src/Makefile
    reinplace "s|%COMPAT_VERSION%|${compat_version}|g" ${worksrcpath}/Makefile ${worksrcpath}/src/Makefile
    
    # reinplace %PREFIX% to fix @executable_path, cf. ticket no. 28726
    reinplace "s|%PREFIX%|${prefix}|g" ${worksrcpath}/src/Makefile

    # for the pkgconfig file
    reinplace "s|/usr/local|${prefix}|g" ${worksrcpath}/etc/lua.pc
}

configure {
    set myldflags ${configure.ldflags}
    set cflags "${configure.cflags} ${configure.cppflags}"

    if {[variant_isset universal]} {
        set myldflags "${myldflags} ${configure.universal_ldflags}"
        set cflags "${cflags} ${configure.universal_cflags} ${configure.universal_cppflags}"
    } else {
        set myldflags "${myldflags} ${configure.ld_archflags}"
        set cflags "${cflags} ${configure.cc_archflags}"
    }

    reinplace -E "/^MYLDFLAGS=/s|\$| ${myldflags}|" ${worksrcpath}/src/Makefile
    reinplace -E "/^CFLAGS=/s|\$| ${cflags}|" ${worksrcpath}/src/Makefile
    reinplace "s|CC= .*\$|CC= ${configure.cc}|" ${worksrcpath}/src/Makefile
}

use_parallel_build  yes

destroot.target install INSTALL_TOP=${destroot}${prefix}
post-destroot {
    xinstall -d -m 0755 ${destroot}${prefix}/share/doc/${name}
    xinstall -m 0644 -W ${worksrcpath} COPYRIGHT HISTORY README ${destroot}${prefix}/share/doc/${name}
    xinstall -d -m 0755 ${destroot}${prefix}/share/doc/${name}/html
    foreach html [glob ${worksrcpath}/doc/*.html ${worksrcpath}/doc/*.gif] {
        xinstall -m 0644 ${html} ${destroot}${prefix}/share/doc/${name}/html
    }
    xinstall -d -m 0755 ${destroot}${prefix}/share/doc/${name}/test
    foreach test [glob ${worksrcpath}/test/README ${worksrcpath}/test/*.lua] {
        xinstall -m 0644 ${test} ${destroot}${prefix}/share/doc/${name}/test
    }
    xinstall -d -m 0755 ${destroot}${prefix}/lib/pkgconfig
    xinstall -m 0644 ${worksrcpath}/etc/lua.pc ${destroot}${prefix}/lib/pkgconfig/lua.pc
}

livecheck.type  regex
livecheck.url   ${master_sites}
livecheck.regex {lua-(\d+(?:\.\d+)*)}
