# $Id$

PortSystem 1.0

name            python24
version         2.4.4
revision        2
set major_version   2
set minor_version   4
categories      lang
platforms       darwin freebsd linux
maintainers     nomaintainer
description     An interpreted, object-oriented programming language
long_description    Python is an interpreted, interactive, object-oriented \
                    programming language.

homepage        http://www.python.org/
master_sites    ${homepage}/ftp/python/${version}/ \
                ftp://ftp.python.org/pub/python/${version}/
distname        Python-${version}
checksums       md5 0ba90c79175c017101100ebf5978e906
patchfiles      patch-configure \
                patch-Makefile.pre.in \
                patch-Lib-cgi.py \
                patch-Lib-site.py \
                patch-setup.py \
                patch-Include-pyport.h \
                patch-Mac-OSX-Makefile.in \
                patch-Mac-OSX-IDLE-Makefile.in \
                patch-Mac-OSX-PythonLauncher-Makefile.in

use_bzip2       yes

depends_lib     port:gettext

configure.args  --enable-shared \
                --mandir=${prefix}/share/man \
                --bindir=${prefix}/bin \
                --libdir=${prefix}/lib \
                --without-readline \
                --enable-framework=${prefix}/Library/Frameworks \
                --disable-tk \
                --enable-ipv6

post-patch {
    reinplace "s|__PREFIX__|${prefix}|g" ${worksrcpath}/Lib/cgi.py
    reinplace "s|__PREFIX__|${prefix}|g" ${worksrcpath}/Lib/site.py
    reinplace "s|__PREFIX__|${prefix}|g" ${worksrcpath}/Mac/OSX/Makefile.in
    reinplace "s|__PREFIX__|${prefix}|g" ${worksrcpath}/setup.py
}

build.target    all libpython2.4.dylib

# Workaround for case-sensitive file systems
post-build {
    if { ![file exists ${worksrcpath}/python.exe] } {
        ln -s python ${worksrcpath}/python.exe  
    }
}

test.run        yes
test.target     test

destroot.target frameworkinstall maninstall
post-destroot {
    if { [variant_isset macosx]} {
        set framewdir ${prefix}/Library/Frameworks/Python.framework
        xinstall -m 755 -d ${destroot}${framewdir}/Versions/2.4/include
       ln -s Versions/Current/lib ${destroot}${framewdir}/Libraries
       ln -sf ${framewdir}/Versions/2.4/bin/pydoc ${destroot}${prefix}/binpydoc
       ln -sf ${framewdir}/Versions/2.4/bin/pydoc ${destroot}${prefix}/binpydoc24
       ln -s ${prefix}/lib/python2.4/config ${destroot}${framewdir}/Versions/2.4/lib/python2.4/config
       ln -s ${framewdir}/Versions/2.4/lib/libpython${major_version}.${minor_version}.dylib ${destroot}${prefix}/lib/libpython${version}.dylib
       ln -s ${framewdir}/Versions/2.4/lib/libpython${major_version}.${minor_version}.dylib ${destroot}${prefix}/lib/libpython${major_version}.dylib
       ln -s ${framewdir}/Versions/2.4/lib/libpython${major_version}.${minor_version}.dylib ${destroot}${prefix}/lib/libpython.dylib
    } elseif { [variant_isset darwin]} {
       ln -s libpython${major_version}.${minor_version}.dylib ${destroot}${prefix}/lib/libpython${version}.dylib
       ln -s libpython${major_version}.${minor_version}.dylib ${destroot}${prefix}/lib/libpython${major_version}.dylib
       ln -s libpython${major_version}.${minor_version}.dylib ${destroot}${prefix}/lib/libpython.dylib
    } else {
        system "cd ${destroot}${prefix}/lib && \
        ln -s libpython${major_version}.${minor_version}.so \
            libpython${version}.so && \
        ln -s libpython${major_version}.${minor_version}.so \
            libpython${major_version}.so && \
        ln -s libpython${major_version}.${minor_version}.so \
            libpython.so"
    }
}


# delete symlinks without version suffix, use python_select instead to choose version
platform darwin {
    post-destroot {
        file delete ${destroot}${prefix}/bin/python
        file delete ${destroot}${prefix}/bin/pythonw
        file delete ${destroot}${prefix}/bin/idle
        file delete ${destroot}${prefix}/bin/pydoc
        file delete ${destroot}${prefix}/bin/smtpd.py
        file rename ${destroot}${prefix}/share/man/man1/python.1 ${destroot}${prefix}/share/man/man1/python2.4.1

        # install select file for python_select
        xinstall -m 755 -d ${destroot}${prefix}/etc/select/python
        xinstall -m 644 ${filespath}/python24 ${destroot}${prefix}/etc/select/python/
    }
}

platform puredarwin {
    configure.args-delete   --enable-framework=${prefix}/Library/Frameworks
    configure.args-append   --disable-toolbox-glue --disable-framework
    destroot.target     install maninstall
}

platform darwin 8 {
    configure.compiler	gcc-4.0
    configure.args-append --with-cxx=/usr/bin/g++-4.0
}

platform darwin 9 {
    configure.cppflags-append    -D__DARWIN_UNIX03
}

platform freebsd {
    configure.args-delete   --enable-framework=${prefix}/Library/Frameworks
    configure.args-append   --disable-framework
    build.target        all libpython2.4.so
    destroot.target     install maninstall
}

platform linux {
    configure.args-delete   --enable-framework=${prefix}/Library/Frameworks
    configure.args-append   --disable-framework
    build.target        all libpython2.4.so
    destroot.target     install maninstall
}

livecheck.check regex
livecheck.url   http://www.python.org/download/releases/
livecheck.regex Python (2.4.\[0-9\]+)
