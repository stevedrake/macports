# $Id$

PortSystem 1.0

name                    python30
version                 3.0
revision                1
set branch              [join [lrange [split ${version} .] 0 1] .]
categories              lang
platforms               darwin
maintainers             mww

description             An interpreted, object-oriented programming language
long_description        Python is an interpreted, interactive, object-oriented \
                        programming language.

homepage                http://www.python.org/
master_sites            ${homepage}/ftp/python/${branch}/ \
                        ftp://ftp.python.org/pub/python/${branch}/ \
                        ftp://ftp.fastorama.com/mirrors/ftp.python.org/pub/python/${branch}/ \
                        ftp://ftp.python.jp/pub/python/${branch}/

distname                Python-${version}
use_bzip2               yes

checksums               md5     28021e4c542323b7544aace274a03bed \
                        sha1    bf434861cd7bdefb47703ffb6bbc66c6dbd2da3d \
                        rmd160  ae3da661bd387330e93cc5fbcd3f2040bfeff6b6

patchfiles              patch-setup.py.diff \
                        patch-Lib-cgi.py.diff \
                        patch-Lib-distutils-dist.py.diff

depends_lib             port:gettext port:zlib port:openssl port:tk \
                        port:sqlite3 port:ncurses port:gdbm \
                        port:bzip2 port:readline

configure.args          --enable-shared \
                        --enable-framework=${frameworks_dir} \
                        --enable-ipv6

use_parallel_build      no

post-patch {
   reinplace "s|@@PREFIX@@|${prefix}|g" ${worksrcpath}/Lib/cgi.py

   reinplace "s|/setup.py|/setup.py --no-user-cfg|" ${worksrcpath}/Makefile.pre.in

   # replace /Applications/ with ${applications_dir}/
   reinplace "s|\\(\[^a-zA-Z0-9\]\\)/Applications/|\\1${applications_dir}/|" \
      ${worksrcpath}/Mac/Makefile.in \
      ${worksrcpath}/Mac/Tools/Doc/setup.py \
      ${worksrcpath}/Mac/PythonLauncher/Makefile.in \
      ${worksrcpath}/Mac/BuildScript/build-installer.py

   reinplace "s|#!/Library/Frameworks|#!${frameworks_dir}|" \
      ${worksrcpath}/Mac/IDLE/IDLE.app/Contents/MacOS/IDLE
}

build.target            all

# test_cmd_line fails
# see http://bugs.python.org/issue4388 and
#     http://bugs.python.org/issue4474
test.run                yes
test.target             test

destroot.target         frameworkinstall maninstall

# ensure that correct compiler is used
build.args-append       MAKE="${build.cmd} CC=${configure.cc}"
destroot.args-append    MAKE="${destroot.cmd} CC=${configure.cc}"

post-destroot {
   set framewpath ${frameworks_dir}/Python.framework
   set framewdir  ${framewpath}/Versions/${branch}

   foreach dir { Headers Resources Python Versions/Current } {
      file delete ${destroot}${framewpath}/${dir}
   }

   ln -s ${framewdir}/share/man/man1/python${branch}.1 ${destroot}${prefix}/share/man/man1/

   # install select file for python_select
   xinstall -m 755 -d ${destroot}${prefix}/etc/select/python
   xinstall -m 644 ${filespath}/python[string map {. {}} ${branch}] ${destroot}${prefix}/etc/select/python/
}

post-activate {
    ui_msg "\nTo fully complete your installation and make python $branch the default, please run
\n\tsudo port install python_select \
\n\tsudo python_select $name\n"
}

platform darwin 10 {
   configure.compiler   gcc-4.2
}

variant universal {
   post-patch {
      set universal_arch_flags {}
      set arch_run_32bit {}
      foreach arch ${universal_archs} {
         lappend universal_arch_flags -arch ${arch}
         if { ${arch}=="i386" || ${arch}=="ppc" } {
            lappend arch_run_32bit -${arch}
         }
      }
      reinplace \
         "s|UNIVERSAL_ARCH_FLAGS=\".*\"|UNIVERSAL_ARCH_FLAGS=\"${universal_arch_flags}\"|" \
         ${worksrcpath}/configure
      if { ${arch_run_32bit} != "" } {
         reinplace \
            "s|ARCH_RUN_32BIT=\".*\"|ARCH_RUN_32BIT=\"arch ${arch_run_32bit}\"|" \
            ${worksrcpath}/configure
      }
   }
   configure.args-append   --enable-universalsdk=${universal_sysroot}
}

variant ucs4 description {Use 4-byte Unicode characters} {
   configure.args-append   --with-wide-unicode
}

livecheck.check         regex
livecheck.url           ${homepage}download/releases/
livecheck.regex         Python (${branch}(?:\\.\\d+)*)
