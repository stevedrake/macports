# $Id: Portfile,v 1.11 2004/12/25 09:56:09 waqar Exp $

PortSystem	1.0
name		sbcl
version		0.8.17
revision	0
categories	lang
maintainers	gwright@opendarwin.org waqar@opendarwin.org
platforms	darwin
description	The Steel Bank Common Lisp system
long_description	\
		Steel Bank Common Lisp (SBCL) is a Open Source		\
		development system for ANSI Common Lisp. It provides an	\
		interactive environment including an integrated native	\
		compiler, interpreter, and debugger. (And it, and its	\
		generated code, can also play nicely with Unix when	\
		running noninteractively.)

homepage	http://www.sbcl.org
master_sites	sourceforge
use_bzip2	yes

distfiles	${name}-${version}-source${extract.suffix}	\
		${name}-${version}-powerpc-darwin-binary${extract.suffix}

distname	${name}-${version}-source
worksrcdir	${name}-${version}

checksums	${name}-${version}-source${extract.suffix}		\
			md5 684d1a96496b46331dc50840db612909		\
		${name}-${version}-powerpc-darwin-binary${extract.suffix} \
			md5 8e2eadf069bd14be6d8391e67938f192

platform darwin 7 {
 		patchfiles	patch-src-runtime-Config.ppc-darwin
}

use_configure	no

set host_lisp	" \"${workpath}/${name}-${version}-powerpc-darwin/src/runtime/sbcl --core ${workpath}/${name}-${version}-powerpc-darwin/output/sbcl.core --disable-debugger\" "

build		{ cd ${worksrcpath}
		  system "ulimit -s 8192"

		  system "sh make.sh ${host_lisp}"
		}

default_variants	+test

variant test	{ test.run	yes
		  test.dir	${worksrcpath}/tests
		  test.cmd	sh
		  test.target	run-tests.sh
		}

destroot	{ cd ${worksrcpath}
		  system "INSTALL_ROOT=${destroot}/${prefix} sh install.sh"
		}

post-destroot	{ cd ${destroot}${prefix}/bin
		  file rename sbcl sbcl.bin

		  set script [open "${destroot}${prefix}/bin/sbcl" w 755]
                  puts $script "#!/bin/sh"
                  puts $script "${prefix}/bin/sbcl.bin --core ${prefix}/lib/${name}/${name}.core $@"
                  puts $script ""
                  close $script
                  system "chmod 755 ${destroot}${prefix}/bin/sbcl"
                }

