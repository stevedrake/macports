# $Id: Portfile,v 1.6 2005/05/31 10:08:36 toby Exp $

PortSystem 1.0
name             smlnj
version          110.54
categories       lang
maintainers      toby@opendarwin.org
description      Standard ML of New Jersey
long_description \
	Standard ML of New Jersey (abbreviated SML/NJ) is a \
	compiler for the Standard ML '97 programming language \
	with associated libraries, tools, and documentation. \
	SML/NJ is free, open source software.
homepage         http://www.smlnj.org/
platforms        darwin

master_sites     http://smlnj.cs.uchicago.edu/dist/working/${version}/
dist_subdir      ${name}/${version}

distfiles
checksums

# Files needed for basic distribution.
set srcs [list \
	config.tgz 738d5704fab95306eef77ef80ebe62ff \
	runtime.tgz e2e307e84d05d024f94fb6d7f36460b8 \
	system.tgz 1af45e2ceac5072db50dad085447a5aa \
	smlnj-lib.tgz 2501128af31dd3765185f5373ba3fe31 \
	smlnj-c.tgz df27f8316e6fb906eaf0b0d45708a16d \
	cm.tgz b67415228b7c7c32cd4f312d3d054d81 \
	MLRISC.tgz 76b059befa77cf5b17b8a31b0998cf11 \
	ml-yacc.tgz 22d9c3b25ff5b6c460ecb4121284bf11 \
	ml-nlffigen.tgz 10a13239ef4ccc36fbc1c5e60f5c6255 \
	ml-nlffi-lib.tgz 8a181d18daa2e6302cc3f74fdff7f05e \
	ml-lex.tgz 416c039fa775cfd734eaca36028893df \
	ml-burg.tgz 78900547fc70f2a9c0c7b412a526f6b7 \
	eXene.tgz 75c6ca41681854ef602728cb0ad4eed6 \
	compiler.tgz 70c1d9c8f3c3da6b925265a40eb040e6 \
	cml.tgz 270cadf6bd7e2d8982f35aa2b604f609 \
	ckit.tgz f24209a140a4eaeec7cc8610aebe52fc \
	heap2asm.tgz cf3951f0ced6e66ebd1268e72ee7ffa4 \
]

foreach {tarball checksum} $srcs {
	distfiles-append $tarball
	checksums-append $tarball md5 $checksum
}

# Platform-specific boot code (omitted: alpha32, hppa, mipseb, sparc).
platform powerpc {
	distfiles-append boot.ppc-unix.tgz
	checksums-append boot.ppc-unix.tgz md5 e5a79529e29452869a8d33548e0baa70
}
platform i386 {
	distfiles-append boot.x86-unix.tgz
	checksums-append boot.x86-unix.tgz md5 e85a3bc17bfacadeecd655c30297072e
}

### extract ###
pre-extract {
	file mkdir ${worksrcpath}
}
extract.dir          ${worksrcpath}
extract.only         config.tgz

### configure ###
configure {
	reinplace "s|SRCARCHIVEURL=.*|SRCARCHIVEURL=file://${distpath}|" \
		${worksrcpath}/config/srcarchiveurl

	reinplace "s|#request|request|" ${worksrcpath}/config/targets
}

### build ###
build.env            URLGETTER=curl
build.cmd            ${worksrcpath}/config/install.sh
build.target

### destroot ###
destroot {
	set smlnj_home ${prefix}/share/smlnj

	file mkdir ${destroot}${smlnj_home}
	file copy ${worksrcpath}/bin ${destroot}${smlnj_home}
	file copy ${worksrcpath}/lib ${destroot}${smlnj_home}

	xinstall -m 555 ${filespath}/sml.sh ${destroot}${prefix}/bin/sml
	reinplace "s|__SMLNJ_HOME__|${smlnj_home}|g" \
		${destroot}${prefix}/bin/sml

	foreach prog [glob -directory ${worksrcpath}/bin *] {
		set progname [file tail $prog]
		if {![string equal $progname sml]} {
			system "ln -s sml ${destroot}${prefix}/bin/${progname}"
		}
	}
}
