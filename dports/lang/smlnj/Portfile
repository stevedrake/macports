# $Id$

PortSystem 1.0
name             smlnj
version          110.60
categories       lang
maintainers      bfulgham@macports.org
description      Standard ML of New Jersey
long_description \
	Standard ML of New Jersey (abbreviated SML/NJ) is a \
	compiler for the Standard ML '97 programming language \
	with associated libraries, tools, and documentation. \
	SML/NJ is free, open source software.
homepage         http://www.smlnj.org/
platforms        darwin

master_sites     http://smlnj.cs.uchicago.edu/dist/working/${version}/
dist_subdir      ${name}/${version}

distfiles
checksums

# Files needed for basic distribution.
set srcs [list \
	MLRISC.tgz 2e829ffd1c228c45d054f621c47a242e695d5542 \
	ckit.tgz 53428cea54aa1ef50023f7bd3c54609ef59fb636 \
	cm.tgz f7c3b83994f47cedca35019151620fc6783368f6 \
	cml.tgz 11d35224d700d64c63ed9fba9ff8649522760663 \
	compiler.tgz cbbdf667202df972b640e4aa1d1b490cb270e7cf \
	config.tgz 0984aed44fd44b97edd7a7f3b9f1cc9319e21304 \
	eXene.tgz d83829d892aed24677defa325f9a99e891702f82 \
	ml-burg.tgz 8dfb03c9353c81d9a085c201b45a52d153de5c00 \
	lexgen.tgz 151efa7092eab8fe3e9aec5ee77664bac545c3fb \
	ml-lex.tgz f1a3baab99de0947bf1c9cf7ef87340a7d61e486 \
	ml-yacc.tgz c99b9c03e297ebd08e6f9cdb40278bfabc1296d1 \
	ml-nlffi-lib.tgz eb3cbe7ebefd71640601d98165313cdeb6411a72 \
	ml-nlffigen.tgz fc80840efc6882317c5d5ef6b1e3337f5b927705 \
	pgraph.tgz 0e63e7e75a0c0e27d9f81792324d8dc61db2ceb1 \
	runtime.tgz 4807c18d88240c733f8439fed277b035ac5693a8 \
	smlnj-c.tgz 90a5944800925e292b265cb43a826f833fc74ffe \
	smlnj-lib.tgz 46145529dec1883e188e6aeb30afd456b44fb57a \
	system.tgz a3a6b792643979a0843bd4b7c1d09c538aafd646 \
	heap2asm.tgz d9d40c2530c66d6e684f288d5e14b4de6b5635ad \
	trace-debug-profile.tgz f9ec5775a872ae5eee0253c4a7b19cfc0e2b5dd2 \
	ml-lpt.tgz 10bd108e8def7b47506560a48d292751caf15f2b \
	nlffi.tgz 4e4fbcb707ee65f4d2e24c729d347a066ad7a1ce \
]

foreach {tarball checksum} $srcs {
	distfiles-append $tarball
	checksums-append $tarball sha1 $checksum
}

# Platform-specific boot code (omitted: sparc-unix, x86-win32)
platform powerpc {
	distfiles-append boot.ppc-unix.tgz
	checksums-append boot.ppc-unix.tgz sha1 f84b8caa960053e657bc4ebc75a6826429c855c6
}
platform i386 {
	distfiles-append boot.x86-unix.tgz
	checksums-append boot.x86-unix.tgz sha1 78804002167141bad524dd38b09cf75421478e9e
}

### extract ###
pre-extract {
	file mkdir ${worksrcpath}
}
extract.dir          ${worksrcpath}
extract.only         config.tgz

### configure ###
configure {
	reinplace "s|SRCARCHIVEURL=.*|SRCARCHIVEURL=file://${distpath}|" \
		${worksrcpath}/config/srcarchiveurl

	reinplace "s|#request|request|" ${worksrcpath}/config/targets
}

### build ###
build.env            URLGETTER=curl
build.cmd            ${worksrcpath}/config/install.sh
build.target

### destroot ###
destroot {
	set smlnj_home ${prefix}/share/smlnj

	file mkdir ${destroot}${smlnj_home}
	file copy ${worksrcpath}/bin ${destroot}${smlnj_home}
	file copy ${worksrcpath}/lib ${destroot}${smlnj_home}

	xinstall -m 555 ${filespath}/sml.sh ${destroot}${prefix}/bin/sml
	reinplace "s|__SMLNJ_HOME__|${smlnj_home}|g" \
		${destroot}${prefix}/bin/sml

	foreach prog [glob -directory ${worksrcpath}/bin *] {
		set progname [file tail $prog]
		if {![string equal $progname sml]} {
			system "ln -s sml ${destroot}${prefix}/bin/${progname}"
		}
	}
}
