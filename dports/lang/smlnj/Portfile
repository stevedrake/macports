# $Id$

PortSystem 1.0
name             smlnj
version          110.65
categories       lang
maintainers      bfulgham@macports.org
description      Standard ML of New Jersey
long_description \
	Standard ML of New Jersey (abbreviated SML/NJ) is a \
	compiler for the Standard ML '97 programming language \
	with associated libraries, tools, and documentation. \
	SML/NJ is free, open source software.
homepage         http://www.smlnj.org/
platforms        darwin

master_sites     http://smlnj.cs.uchicago.edu/dist/working/${version}/
dist_subdir      ${name}/${version}

distfiles
checksums

# Files needed for basic distribution.
set srcs [list \
	MLRISC.tgz d671e23119930beedfd6a40ea0dabaabcb468d49 \
	ckit.tgz beeb187a248c0aa4ba6a252db51bf84d504d854c \
	cm.tgz 04d90e1a554c6938da7519585962bd67e8a6d5c2 \
	cml.tgz bdbaa0766ce3025ec89b6d75b927ef52958bf73b \
	compiler.tgz 9f725e05870cc6fb7f14d0d1d4910347c180f734 \
	config.tgz 14bc3b971c5c1f177a5230c17ad4f1f9c35af9d4 \
	eXene.tgz ab336a1c4fe2179923874df2f2bd7964c85c0d65 \
	ml-burg.tgz f1a33a3aadc2c5a12536715ffbf4d0b0493bc15f \
	ml-lex.tgz 87551055c8146c77a7534a880a49ead2746b5cce \
	ml-yacc.tgz 7955774095c7cd3de39172793ebfab3300d18e79 \
	pgraph.tgz 097230c43ab5e09a311540cd31783c8dcc4a9f63 \
	runtime.tgz 1a96849a5902f91439da3a1fc7874aefe9f84a51 \
	smlnj-c.tgz 421515765a233f8a45922dc7eafb7f0c3c5b0219 \
	smlnj-lib.tgz 2ffff6a762a3f632667b4685025134495f6764c0 \
	system.tgz 24b83a4d78706f211ad37bd3f16ed36836b404e1 \
	heap2asm.tgz 2ba1bb3e7fa2a0a365757972d95da9f9ce42a0eb \
	trace-debug-profile.tgz fe8fa49492519d1f65bc971b5518f42faa8d0ca6 \
	ml-lpt.tgz 3ea16d8b4a595a3aace38b4c2b61067bef9485de \
	nlffi.tgz daeb08a34aeb6121e2b7125b3c6490c6b5a13c69 \
]

foreach {tarball checksum} $srcs {
	distfiles-append $tarball
	checksums-append $tarball sha1 $checksum
}

# Platform-specific boot code (omitted: sparc-unix, x86-win32)
platform powerpc {
	distfiles-append boot.ppc-unix.tgz
	checksums-append boot.ppc-unix.tgz sha1 063c97e7946057ba2b9548d493376f6349532cf1
}
platform i386 {
	distfiles-append boot.x86-unix.tgz
	checksums-append boot.x86-unix.tgz sha1 82b87c92887bf670cfb12460b3abd5a7f2f183db
}

### extract ###
pre-extract {
	file mkdir ${worksrcpath}
}
extract.dir          ${worksrcpath}
extract.only         config.tgz

### configure ###
configure {
	reinplace "s|SRCARCHIVEURL=.*|SRCARCHIVEURL=file://${distpath}|" \
		${worksrcpath}/config/srcarchiveurl

	reinplace "s|#request|request|" ${worksrcpath}/config/targets
}

### build ###
build.env            URLGETTER=curl
build.cmd            ${worksrcpath}/config/install.sh
build.target

### destroot ###
destroot {
	set smlnj_home ${prefix}/share/smlnj

	file mkdir ${destroot}${smlnj_home}
	file copy ${worksrcpath}/bin ${destroot}${smlnj_home}
	file copy ${worksrcpath}/lib ${destroot}${smlnj_home}

	xinstall -m 555 ${filespath}/sml.sh ${destroot}${prefix}/bin/sml
	reinplace "s|__SMLNJ_HOME__|${smlnj_home}|g" \
		${destroot}${prefix}/bin/sml

	foreach prog [glob -directory ${worksrcpath}/bin *] {
		set progname [file tail $prog]
		if {![string equal $progname sml]} {
			system "ln -s sml ${destroot}${prefix}/bin/${progname}"
		}
	}
}
