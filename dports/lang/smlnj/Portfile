# $Id: Portfile,v 1.5 2005/04/16 20:04:23 toby Exp $

PortSystem 1.0
name             smlnj
version          110.53
categories       lang
maintainers      toby@opendarwin.org
description      Standard ML of New Jersey
long_description \
	Standard ML of New Jersey (abbreviated SML/NJ) is a \
	compiler for the Standard ML '97 programming language \
	with associated libraries, tools, and documentation. \
	SML/NJ is free, open source software.
homepage         http://www.smlnj.org/
platforms        darwin

master_sites     http://smlnj.cs.uchicago.edu/dist/working/${version}/
dist_subdir      ${name}/${version}

distfiles
checksums

# Files needed for basic distribution.
set srcs [list \
	config.tgz bae475ec6e449b2e398b48515ed275b8 \
	runtime.tgz b1bf4dfbd779750fff5deaa58f261dc1 \
	system.tgz f183f4b27b2a45f2a9f94e8e2ae92ac4 \
	smlnj-lib.tgz b2c4e3b180af49b30e3190e26948247b \
	smlnj-c.tgz f6034c725d147a1be5148bd376c547b5 \
	cm.tgz ab1b035b8e83864c8d5a671f5d739b12 \
	MLRISC.tgz f7ea57e954c1a8d1ad8a1a57bba64bb7 \
	ml-yacc.tgz efd735dd0994dae69f7e34bcc1675633 \
	ml-nlffigen.tgz 5a811d439656d84edca29c2978b12753 \
	ml-nlffi-lib.tgz bbf7394d7bd50cd413c3e3e860a2aa9f \
	ml-lex.tgz c9d75150ca36ac9b028013bba0a2d7d2 \
	ml-burg.tgz 9568ab57d8933b8a40f532cf7fb8d6df \
	eXene.tgz 7e0c258cfcc240fcdafbd2191d55c93a \
	compiler.tgz 9454cb647181dd10bbf9d49f093d762d \
	cml.tgz 659e15d344ef307e19aa27ec209c8f0b \
	ckit.tgz 631772d441bff78254c39e396f9f5501 \
	heap2asm.tgz c1d868b00e80d421c64ea8152cb9f252 \
]

foreach {tarball checksum} $srcs {
	distfiles-append $tarball
	checksums-append $tarball md5 $checksum
}

# Platform-specific boot code (omitted: alpha32, hppa, mipseb, sparc).
platform powerpc {
	distfiles-append boot.ppc-unix.tgz
	checksums-append boot.ppc-unix.tgz md5 6934a77b3d31c2ba6f49e7279c89f273
}
platform i386 {
	distfiles-append boot.x86-unix.tgz
	checksums-append boot.x86-unix.tgz md5 bb70e8670afd5891555db777f5ec83e3
}

### extract ###
pre-extract {
	file mkdir ${worksrcpath}
}
extract.dir          ${worksrcpath}
extract.only         config.tgz

### patch ###
patchfiles           patch-config___arch-n-opsys

### configure ###
configure {
	reinplace "s|SRCARCHIVEURL=.*|SRCARCHIVEURL=file://${distpath}|" \
		${worksrcpath}/config/srcarchiveurl

	reinplace "s|#request|request|" ${worksrcpath}/config/targets
}

### build ###
build.env            URLGETTER=curl
build.cmd            ${worksrcpath}/config/install.sh
build.target

### destroot ###
destroot {
	set smlnj_home ${prefix}/share/smlnj

	file mkdir ${destroot}${smlnj_home}
	file copy ${worksrcpath}/bin ${destroot}${smlnj_home}
	file copy ${worksrcpath}/lib ${destroot}${smlnj_home}

	xinstall -m 555 ${filespath}/sml.sh ${destroot}${prefix}/bin/sml
	reinplace "s|__SMLNJ_HOME__|${smlnj_home}|g" \
		${destroot}${prefix}/bin/sml

	foreach prog [glob -directory ${worksrcpath}/bin *] {
		set progname [file tail $prog]
		if {![string equal $progname sml]} {
			system "ln -s sml ${destroot}${prefix}/bin/${progname}"
		}
	}
}
