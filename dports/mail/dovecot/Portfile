# $Id: Portfile,v 1.18 2006/07/23 02:56:53 yeled Exp $

PortSystem			1.0

name				dovecot
version				1.0.rc2
epoch               20060722

categories			mail
maintainers			yeled@opendarwin.org,jberry@opendarwin.org
platforms			darwin

description			Secure, fast imap and pop3 server -- currently in alpha approaching final
long_description	Dovecot is an IMAP and POP3 server for Linux/UNIX-like \
					systems, written with security primarily in mind. Although \
					it's written in C, it uses several coding techniques to \
					avoid most of the common pitfalls.

homepage			http://dovecot.org/

master_sites		${homepage}releases/
distname			dovecot-${version}
checksums			rmd160	cbb1919f30ccc82033ddda5a9a4b2e9695f78eb9 \
					sha1	548d691166c71533cce05f72204d5f728941bab6 \
					md5 	e27a248b2ee224e4618aa2f020150041

default_variants	+ssl
depends_lib			port:libiconv port:pkgconfig port:zlib

configure.args		--sysconfdir=${prefix}/etc/dovecot \
					--localstatedir=${prefix}/var \
					--without-ssl

post-configure {
	# madvise fails on darwin 7 and earlier, but is fixed on darwin 8
	if { ${os.platform} == "darwin" && [rpm-vercomp ${os.version} 8.0] < 0 } {
		reinplace "s|#define HAVE_MADVISE 1|/* #undef HAVE_MADVISE */|" ${worksrcpath}/config.h
	}
}

post-destroot	{
	# Create the dovecot user and group
	addgroup dovecot
	set gid [existsgroup dovecot]
	adduser dovecot gid=${gid} realname=Dovecot
}

platform darwin 7 {
	# Avoid broken poll
	configure.args-append --with-ioloop=select
}

platform darwin 8 {
	# Avoid broken poll
	configure.args-append --with-ioloop=select
}

variant ssl {
		depends_lib-append	port:openssl 
		configure.args-delete	--without-ssl
		configure.args-append	--with-ssl=openssl \
			--with-ssl-dir=${prefix}/etc/ssl
		configure.env-append	CPPFLAGS="-I${prefix}/include/openssl" \
			LDFLAGS="-L${prefix}/lib"
}

variant postgres	{	
	depends_lib-append	port:postgresql8
	configure.args-append	--with-pgsql
	configure.env-append	LDFLAGS="-L${prefix}/lib/pgsql8" \
		CPPFLAGS="-I${prefix}/include/pgsql8" 
}

variant rawlog	{	configure.args-append	--with-rawlog	}

variant ldap	{	configure.args-append	--with-ldap	
				depends_lib-append	port:openldap
}

startupitem.create	yes
startupitem.name	Dovecot
startupitem.start	${prefix}/sbin/dovecot
startupitem.stop	"
	pidfile=${prefix}/var/run/dovecot/master.pid	
	\[ -r \${pidfile} \] && kill \$(cat \${pidfile})
	"
