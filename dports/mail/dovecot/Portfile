# $Id$

PortSystem          1.0

name                dovecot
epoch               20060722
version             1.1.1

categories          mail
maintainers         jberry
platforms           darwin

description         Secure, fast imap and pop3 server -- currently in alpha approaching final
long_description    Dovecot is an IMAP and POP3 server for Linux/UNIX-like \
                    systems, written with security primarily in mind. Although \
                    it's written in C, it uses several coding techniques to \
                    avoid most of the common pitfalls.

homepage            http://dovecot.org/

master_sites        ${homepage}releases/1.1
distname            dovecot-${version}
checksums           md5     239072365e4fc35b8a7162f841cb07c9 \
                    sha1    039993d8769237dd7d1c0c3ef277734f7013c66b \
                    rmd160  be522b080f221dbf655d9afa1f3fb1a786d4c3b2

depends_lib         port:libiconv \
					port:pkgconfig \
					port:zlib \
					port:openssl

configure.args      --sysconfdir=${prefix}/etc/dovecot \
                    --localstatedir=${prefix}/var \
                    --with-ssl=openssl --with-ssl-dir=${prefix}/etc/ssl

configure.cppflags	"-I${prefix}/include/openssl"

post-configure {
    # madvise fails on darwin 7 and earlier, but is fixed on darwin 8
    if { ${os.platform} == "darwin" && [rpm-vercomp ${os.version} 8.0] < 0 } {
        reinplace "s|#define HAVE_MADVISE 1|/* #undef HAVE_MADVISE */|" ${worksrcpath}/config.h
    }
}

post-destroot   {
    # Create the dovecot user and group
    addgroup dovecot
    set gid [existsgroup dovecot]
    adduser dovecot gid=${gid} realname=Dovecot
}

platform darwin 7 {
    # Avoid broken poll
    configure.args-append --with-ioloop=select
}

platform darwin 8 {
    configure.args-append --with-ioloop=kqueue
}

platform darwin 9 {
    configure.args-append --with-ioloop=kqueue
}

variant postgres {
    depends_lib-append  port:postgresql80
    configure.args-append		--with-pgsql
    configure.ldflags-append	"-L${prefix}/lib/pgsql8"
    configure.cppflags-append	"-I${prefix}/include/pgsql8"
}

variant rawlog  {   configure.args-append   --with-rawlog   }

variant ldap    {   configure.args-append   --with-ldap
                	depends_lib-append  port:openldap
}

startupitem.create		yes
startupitem.executable  ${prefix}/sbin/dovecot
startupitem.pidfile		auto ${prefix}/var/run/dovecot/master.pid
