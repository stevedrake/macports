# $Id$
PortSystem 1.0
name            gnudatalanguage
version         0.9pre4
revision        1
categories      math science
maintainers     takeshi@mac.com
platforms       darwin
description     a free IDL combatible incremental compiler
long_description \
                A free IDL (Interactive Data Language) compatible \
                incremental compiler (ie. runs IDL programs).
homepage        http://gnudatalanguage.sourceforge.net/
master_sites    sourceforge
distname        gdl-${version}

checksums       md5 21f03676b44937b9cc855922618a73d2

depends_lib     port:bzip2 \
                port:freetype \
                port:g95 \
                port:gsl \
                port:hdf5 \
                port:ImageMagick \
                port:jpeg \
                port:ncurses \
                port:netcdf \
                port:plplot \
                port:python24 \
                port:py-numarray \
                port:readline \
                port:tiff \
                port:zlib

patch {
   foreach f {configure.in configure} {
       reinplace "s|-L\$with_hdf5/lib/hdf -L\$with_hdf5/lib/hdf5||" \
           ${worksrcpath}/${f}
       reinplace "s|-I\$with_hdf5/include/hdf -I\$with_hdf5/include/hdf5||" \
           ${worksrcpath}/${f}
       reinplace "s|-lproj4|-lproj|g" ${worksrcpath}/${f}
   }
   reinplace "s|AC_CHECK_LIB(proj4|AC_CHECK_LIB(proj|" ${worksrcpath}/configure.in
   foreach d {src src/antlr} {
       reinplace "s|libantlr.a|libantlr_gdl.a|g" ${worksrcpath}/${d}/Makefile.in
   }
   reinplace "s|-L/usr/X11R6/lib64||" ${worksrcpath}/src/Makefile.in
   reinplace "s|lib_proj.h|projects.h|" ${worksrcpath}/src/plotting.hpp
}
post-patch {
   # Avoid using heimdal's broken fnmatch.h
   reinplace "s|<\\(fnmatch\.h\\)>|\"/usr/include/\\1\"|" ${worksrcpath}/src/file.cpp
}

configure.env       F77=${prefix}/bin/g95 FFLAGS=-O2
configure.args      --with-plplotdir=${prefix} \
                    --with-ncursesdir=${prefix} \
                    --with-readlinedir=${prefix} \
                    --with-gsldir=${prefix} \
                    --with-netcdf=${prefix} \
                    --without-hdf --with-hdf5=${prefix} \
                    --with-python=${prefix} --enable-python_version=2.4 \
                    --with-Magick=${prefix}
 
destroot.destdir    prefix=${destroot}${prefix}
destroot.target     install-strip

post-destroot {
    xinstall -m 755 -d ${destroot}${prefix}/share/doc/${name}
    foreach f {AUTHORS COPYING ChangeLog HACKING INSTALL NEWS PYTHON.txt README TODO} {
        eval xinstall -m 644 [glob ${worksrcpath}/${f}] ${destroot}${prefix}/share/doc/${name}
    }
}

# fftw-3-single does not build on i386
#variant fftw {
#    depends_lib-append    port:fftw-3 port:fftw-3-single
#    configure.args-append --with-fftw=/opt/local
#}

variant proj {
    depends_lib-append port:proj
    configure.env-append CPPFLAGS=-DPJ_LIB__
    configure.args-append --with-libproj4=${prefix}
}
