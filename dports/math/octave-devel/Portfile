# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:et:sw=4:ts=4:sts=4
# $Id$

PortSystem 1.0

name                octave-devel
version             3.4.0
conflicts           octave
categories          math science
maintainers         michaelld openmaintainer
platforms           darwin
description         a Matlab-like environment for numerical analysis
long_description    Octave provides a convenient command line interface \
                    for solving linear and nonlinear problems numerically, \
                    using a language that is mostly compatible with Matlab. \
                    It is easily extensible and customizable via \
                    user-defined functions or using dynamically loaded \
                    modules written in e.g. C++, C or Fortran.

homepage            http://www.gnu.org/software/octave/
master_sites        gnu:octave
dist_subdir         octave
distname            octave-${version}
use_bzip2           yes

checksums           md5     c8144cee1d37e645d3368a8e8a5f1856 \
                    sha1    936a8fc962abd96e7568fb5909ec2a4d7997a1a8 \
                    rmd160  8448fc8277e19dab8dbc5c0121e673e9198c74ec

depends_build       port:bison \
                    port:flex \
                    port:gawk \
                    port:gperf \
                    port:gsed \
                    path:bin/perl:perl5 \
                    port:texinfo

depends_lib         port:arpack \
                    port:atlas \
                    port:curl \
                    port:fftw-3 \
                    port:fftw-3-single \
                    port:ftgl \
                    port:ghostscript \
                    port:glpk \
                    port:GraphicsMagick \
                    port:gnuplot \
                    port:hdf5-18 \
                    port:less \
                    port:metis \
                    port:ncurses \
                    port:pcre \
                    port:readline \
                    port:qhull \
                    port:qrupdate \
                    port:SuiteSparse

# allow non-Apple compilers to work with FLTK by removing the -arch
# flag, which means this port cannot easy compile as universal.
patchfiles-append patch-configure.diff

universal_variant   no

configure.args      --without-x \
                    --enable-shared \
                    --enable-dl \
                    --disable-docs \
                    --disable-openmp

# do not build static libraries; just shared
#                    --enable-static

### the following are probably not necessary (except possibly the
### 'cholmod' one), but are included for completion.  Ordering is the
### same as in './configure --help'.
configure.args-append \
                    --enable-readline \
                    --enable-extra-warning-flags \
                    --with-qhull \
                    --with-z \
                    --with-hdf5 \
                    --with-fftw3 \
                    --with-fftw3f \
                    --with-glpk \
                    --with-curl \
                    --with-blas \
                    --with-lapack \
                    --with-qrupdate \
                    --with-amd \
                    --with-camd \
                    --with-colamd \
                    --with-ccolamd \
                    --with-cholmod="-lcholmod -lmetis" \
                    --with-cxsparse \
                    --with-umfpack \
                    --with-arpack

### the following are probably not necessary, but are included for
### completion.
# octave uses a number of other ports to create sources from template:
# perl, gawk, gsed, flex, bison, texinfo.  python is not used if perl
# is available, so clear it out.  FLTK doesn't work as of 1.3.x-r7794,
# so disable it entirely (via "no" here and a configure patch).
configure.perl      ${prefix}/bin/perl
configure.python    ' '
configure.awk       ${prefix}/bin/gawk
configure.env-append SED="${prefix}/bin/gsed" \
                     TEXI2DVI="${prefix}/bin/texi2dvi" \
                     TEXI2PDF="${prefix}/bin/texi2pdf" \
                     FLTK_CONFIG=no
configure.cppflags
configure.ldflags

test.run            yes
test.target         check

variant gcc43 description {build with the macports gcc43 toolchain} conflicts gcc45 gcc44 g95 {}

variant gcc44 description {build with the macports gcc44 toolchain} conflicts gcc45 gcc43 g95 {}

variant gcc45 description {build with the macports gcc45 toolchain} conflicts gcc44 gcc43 g95 {}

variant g95 description {build with g95} conflicts gcc43 gcc44 gcc45 {
    depends_build-append    port:g95
    configure.f77           "${prefix}/bin/g95"
}

# check for default variant
if { ![variant_isset gcc43] && ![variant_isset gcc44] && \
         ![variant_isset gcc45] && ![variant_isset g95] } {
    default_variants +gcc44
}

# check for just -gcc44
if { ![variant_isset gcc43] && ![variant_isset gcc44] && \
         ![variant_isset gcc45] && ![variant_isset g95] } {
    error "You cannot use the variant -gcc44 alone."
}

set gcc_version ""
if {[variant_isset gcc43]} {
    set gcc_version "4.3"
} elseif {[variant_isset gcc44]} {
    set gcc_version "4.4"
} elseif {[variant_isset gcc45]} {
    set gcc_version "4.5"
}

if {${gcc_version} != ""} {
    set gcc_version_join [join [split ${gcc_version} "."] ""]
    configure.ldflags    "${prefix}/lib/gcc${gcc_version_join}/libstdc++.6.dylib"
    depends_build-append port:gcc${gcc_version_join}
    configure.compiler   macports-gcc-${gcc_version}
}

variant docs description {Enable creation and installation of documentation} {
    configure.args-replace s|--disable-docs|--enable-docs|
}

variant x11 description {Enable use of X11} {
    configure.args-replace s|--without-x|--with-x|
    configure.args-append --x-includes=${prefix}
}

variant debug description {Produce debugging information in compiled code} {
    configure.cflags-delete    -O2
    configure.cxxflags-delete  -O2
    configure.fflags-delete    -O2
    configure.fcflags-delete   -O2
    configure.f90flags-delete  -O2
    configure.objcflags-delete -O2
    configure.cflags-append    -g3 -O0
    configure.cxxflags-append  -g3 -O0
    configure.fcflags-append   -g3 -O0
    configure.f90flags-append  -g3 -O0
    configure.fflags-append    -g3 -O0
    configure.objcflags-append -g3 -O0
}

#variant fltk description {Include FLTK option} {
#    depends_lib-append port:fltk-devel
#    post-patch {
#        # fix use of #include Fl -> FL
#        reinplace "/include/s,Fl/,FL/,g"
#            ${worksrcpath}/src/DLD-FUNCTIONS/__init_fltk__.cc
#    }
#}

#if {![variant_isset fltk]} {
#    configure.env-append FLTK_CONFIG=no
#}

livecheck.type      regex
livecheck.url       http://www.gnu.org/software/octave/news.html
livecheck.regex     Version (\\d+(\\.\\d+)*)
