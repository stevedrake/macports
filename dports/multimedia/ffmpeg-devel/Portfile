# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem 1.0

name            ffmpeg-devel
version         15943
categories      multimedia
maintainers     devans openmaintainer

description     Digital VCR and streaming server (new unstable API/ABI libavcodec version 52)

long_description \
                FFmpeg is a complete solution to record, convert and \
                stream audio and video. It includes libavcodec, the \
                leading audio/video codec library. \
                \
                FFmpeg is currently undergoing major changes in its API/ABI in \
                libavcodec version 52. This development release reflects those \
                changes and may break applications coded to libavcodec version 51. \
                \
                For the last valid revision for libavcodec version 51 (r15261) \
                please use port ffmpeg.

homepage        http://www.ffmpeg.org/
master_sites
distfiles
patchfiles      patch-libavfilter-avfilter.h.diff \
                patch-libswscale-Makefile.diff \
                patch-libswscale-swscale.h.diff

use_parallel_build yes
worksrcdir      trunk
depends_build   bin:svn:subversion port:gmake

depends_lib     port:libsdl \
                port:bzip2 \
                port:zlib

build.cmd       gmake
configure.compiler gcc-4.0

set svn_rev ${version}
set libswscale_rev 27970

pre-fetch {
    if {[file isdirectory ${distpath}/${svn_rev}]} {
        if {![file isdirectory ${distpath}/${svn_rev}/trunk/.svn] || ![file exists ${distpath}/${svn_rev}/trunk/.complete]} {
             file delete -force ${distpath}/${svn_rev}
        }
    }
}

fetch {
    if {![file isdirectory ${distpath}/${svn_rev}]} {
        file mkdir ${distpath}/${svn_rev}
        system "svn co -r${svn_rev} --ignore-externals svn://svn.mplayerhq.hu/ffmpeg/trunk ${distpath}/${svn_rev}/trunk"
        system "svn co -r${libswscale_rev} svn://svn.mplayerhq.hu/mplayer/trunk/libswscale ${distpath}/${svn_rev}/trunk/libswscale"
        system "touch ${distpath}/${svn_rev}/trunk/.complete"
    }
}

extract {
    file copy ${distpath}/${svn_rev}/trunk ${worksrcpath}
}

platforms       darwin

configure.cflags-append    -DHAVE_LRINTF ${configure.cppflags}
configure.args \
        --disable-vhook \
        --mandir=${prefix}/share/man \
        --enable-shared --enable-pthreads \
        --disable-mmx \
        --cc=gcc-4.0

test.run        yes

#
# configure isn't autoconf and they do use a dep cache
#

universal_variant no

post-destroot {
    file mkdir ${destroot}${prefix}/share/doc/${name}
    file copy ${worksrcpath}/doc/TODO ${destroot}${prefix}/share/doc/${name}
    foreach f [glob ${worksrcpath}/doc/*.txt ${worksrcpath}/doc/*.html] {
        file copy $f ${destroot}${prefix}/share/doc/${name}
    }
}

platform darwin i386 {
    post-patch {
        reinplace "s|defined\(ARCH_X86\) \&\& defined\(CONFIG_GPL\)|defined\(ARCH_X86\) \\\&\\\& defined\(CONFIG_GPL\) \\\&\\\& \\\!defined\(__APPLE__\)|g" ${worksrcpath}/libswscale/rgb2rgb.c
    }
}

#
# comments concerning mmx problems may be out of date
# needs testing on i386 platform to verify
#

variant mmx description {enable mmx optimizations ; may not build in gcc-4.2 or xcode 3.0 gcc-4.0} {
# make no-mmx default and allow mmx enabling for the brave.
    configure.args-delete --disable-mmx 
# Fix Leopard problems by disabling the cavs decoder for now (is this still required?)
    configure.args-append --disable-decoder=cavs
}

variant gpl description {allow use of GPL code, the resulting libav* and ffmpeg will be under GPL} {
    configure.args-append --enable-gpl
}

variant nonfree description {allow use of nonfree code, the resulting libs and binaries will be unredistributable} {
    configure.args-append --enable-nonfree
}

variant postproc requires gpl description {enable GPLed postprocessing support} {
    configure.args-append --enable-postproc
}

variant faac requires gpl description {enable FAAC support via libfaac} {
    depends_lib-append port:faac
    configure.args-append --enable-libfaac
}

variant faad requires gpl description {enable FAAD support via libfaad} {
    depends_lib-append port:faad2
    configure.args-append --enable-libfaad
}

variant lame description {enable MP3 encoding via libmp3lame} {
    depends_lib-append port:lame
    configure.args-append --enable-libmp3lame
}

variant theora description {enable Theora encoding via libtheora} {
    depends_lib-append port:libtheora port:libogg
    configure.args-append --enable-libtheora
}

variant extvorbis description {enable Vorbis encoding via libvorbis, native implementation exists} {
    depends_lib-append port:libvorbis port:libogg
    configure.args-append --enable-libvorbis
}

#
# depends build until x264 port supports shared libraries
# disabled for now needs x264 > 0.6.5
#

#variant x264 requires gpl description {enable H.264 encoding via x264} {
#    depends_build-append port:x264
#    configure.args-append --enable-libx264
#}

variant xvid requires gpl description {enable Xvid encoding via xvidcore, native MPEG-4/Xvid encoder exists} {
    depends_lib-append port:XviD
    configure.args-append --enable-libxvid
}

variant avfilter requires gpl description {video filter support (replaces vhook)} {
    configure.args-append --enable-swscale --enable-avfilter --enable-avfilter-lavf
}

#
#disable livecheck
#

livecheck.check none
