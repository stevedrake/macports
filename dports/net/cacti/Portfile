# $Id$

PortSystem	1.0

name			cacti
version			0.8.7b
categories		net
maintainers		markd
platforms		darwin

description		Cacti is a complete RRDtool network graphing solution.

long_description	Cacti is a complete network graphing solution designed \
                        to harness the power of RRDtool's data storage and \
                        graphing functions.

homepage		http://www.cacti.net
master_sites		http://www.cacti.net/downloads/:cacti

distfiles		${distname}${extract.suffix}:cacti
checksums		${distname}${extract.suffix} md5 63ffca5735b60bc33c68bc880f0e8042

# Placeholder for Cacti official patches
#patchfiles

depends_lib		port:mysql5 \
			port:rrdtool

use_configure   no
build {}
set cactidir ${prefix}/share/cacti

variant server description {does nothing in this port, but its presence triggers mysql5 server variant} {}
variant_set server

variant plugins description {The Plugin Architecture for Cacti} {
	master_sites-append http://cactiusers.org/downloads/:plugins
	distfiles-append cacti-plugin-arch${extract.suffix}:plugins
	checksums-append cacti-plugin-arch${extract.suffix} md5 f33cb7da6c78bd67fa588e480440cff6
}

destroot {
	if { [variant_isset plugins] } {
		reinplace "s|+++ 0.8.7|+++ cacti-${version}|g" \
			${workpath}/cacti-plugin-arch/cacti-plugin-0.8.7b-PA-v2.0.diff

	system "cd ${worksrcpath} && patch -p1 -N < ${workpath}/cacti-plugin-arch/cacti-plugin-0.8.7b-PA-v2.0.diff"

	file copy ${workpath}/cacti-plugin-arch/pa.sql \
		${destroot}${cactidir}
	}

	xinstall -m 755 -d ${destroot}${cactidir}
	system "cp -R ${worksrcpath}/* ${destroot}${cactidir}"
}

post-activate {

ui_msg "\n **** To complete the Cacti OS X installation ****

To complete the Cacti installation follow the steps below.  Read the documentation
at http://www.cacti.net/documentation.php for operational instructions.


1) Install PHP (not covered) including command line interface (CLI) support.
	After PHP is installed, make sure that your httpd.conf file has these
	lines uncommented for CLI support.

	'LoadModule php5_module ...'	(Apache 1 & 2)
	'AddModule mod_php5.c'		(Apache 1)

   Check to make sure the PHP variable \"mysql.default_socket\" is set to path
   ${prefix}/var/run/mysql5/mysqld.sock by viewing the output of this terminal command:
	php -i

   If not, locate the php.ini file for your version of PHP and type the path there.

2) Set Cacti permissions.
   sudo chown -R <cacti-user>:<cacti-group> ${prefix}/share/${name}/

3) Setup MySQL and prepare it for Cacti.
   Configure MySQL (new MySQL installs)
	sudo -u mysql ${prefix}/lib/mysql5/bin/mysql_install_db

  Start MySQL:
        sudo ${prefix}/share/mysql5/mysql/mysql.server start

   Set MySQL to start at system boot (optional)
	sudo launchctl load -w /Library/LaunchDaemons/org.macports.mysql5.plist

   Set a root MySQL password.
	Follow the instructions that were given after you executed 'mysql_install_db' above.

   Create a cacti MySQL user and cacti database.
	mysql5 -u root -p (login with new root password when prompted)
        mysql> grant CREATE,INSERT,SELECT,DELETE,UPDATE on cacti.* to cacti@localhost;
        mysql> grant CREATE,INSERT,SELECT,DELETE,UPDATE on cacti.* to cacti;
        mysql> SET PASSWORD FOR cacti@localhost = OLD_PASSWORD('<cactidb-pwd>');
	mysql> create database cacti;
	mysql> exit;

   Import the cacti database.
	sudo cat ${cactidir}/cacti.sql | mysql5 -u root -p cacti (cacti is the db name)

   If you used the 'plugins' variant for Cacti Plugin Architecture support, add the PA schema:
	sudo cat ${cactidir}/pa.sql | mysql5 -u root -p cacti

   Verify the Cacti Database.
	mysql5 -u root -p
	mysql> use cacti;
	mysql> show tables;
	mysql> exit;

4) Edit ${cactidir}/include/config.php to match your MySQL information.

	\$database_type = \"mysql\";
	\$database_default = \"cacti\";
	\$database_hostname = \"localhost\";
	\$database_username = \"cacti\";
	\$database_password = \"<my-cacti-password>\";

5) Place a symlink for Cacti inside your Apache document root.

	ln -s ${cactidir}  <Apache-docroot>/cacti

6) Edit the Cacti user's crontab file.
	sudo -u <cactiuser> crontab -e

  Insert the crontab entry below:
	*/5 * * * * ${prefix}/bin/php ${cactidir}/poller.php > /dev/null 2>&1

7) Go to http://localhost/cacti/install/index.php.
	The default user/password is admin/admin.  Select 'New Install', enter
	the paths for SNMP / RRDtool / PHP (see below), and click 'Finish'.
	You may now use Cacti at http://localhost/cacti/index.php.

Paths:
	snmpwalk binary path: /usr/bin/snmpwalk
	snmpget binary path: /usr/bin/snmpget

	RRDtool binary path: ${prefix}/bin/rrdtool
	PHP binary path: ${prefix}/bin/php (if not using MacPorts PHP, use appropriate path)


\n"

}
