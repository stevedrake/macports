# $Id: Portfile,v 1.6 2006/01/31 03:04:46 markd Exp $

PortSystem	1.0

name				nedi
version				1.0.v

categories			net
maintainers			markd@opendarwin.org
platforms			darwin

description			Network Discovery Suite

long_description	        A low noise network discovery, management, and inventory \
				system for Cisco networks with a user friendly web interface.

homepage			http://nedi.web.psi.ch/
					
master_sites		        http://nedi.web.psi.ch/

distname                      ${name}-${version}
extract.suffix			.tgz

checksums			md5 4759ab5f93008f583a42e8354fafcb2d

depends_lib			port:perl5.8 \
				port:p5-net-snmp \
				port:p5-net-telnet \
				port:p5-net-telnet-cisco \
				port:p5-algorithm-diff \
				port:p5-dbi \
				port:p5-dbd-mysql

worksrcdir		${name}-${version}

pre-fetch {
        ui_msg "\n #### It is recommended that you pre-install ####\n"
        ui_msg "\n #### port mysql4 with the +server variant.  ####\n"
        ui_msg "\n #### 'port install mysql4 +server'          ####\n"
}

use_configure			no
build {}

extract {}
patch {}

destroot {
	xinstall -d ${worksrcpath}
	xinstall -d ${destroot}${prefix}/var
	system "cd ${destroot}${prefix}/var  && gzip -dc ${distpath}/${distname}.tgz | \
		/usr/bin/gnutar --no-same-owner -xf -"

# Keep nedi.conf from prying eyes because it has passwords!
	system "chmod 600 ${destroot}${prefix}/var/${name}/nedi.conf"
}

post-destroot {
# Fix paths
       eval reinplace "s|/usr/bin/perl|${prefix}/bin/perl|g" \
                [glob ${destroot}${prefix}/var/${name}/*.pl] \
		[glob ${destroot}${prefix}/var/${name}/inc/*.pl] \
                [glob ${destroot}${prefix}/var/${name}/html/inc/*.pl]

	reinplace "s|netstat|/usr/sbin/netstat|g" \
                ${destroot}${prefix}/var/${name}/inc/libmisc.pl

# Keep these empty directories
        destroot.keepdirs \
                ${destroot}${prefix}/var/${name}/db/cfg \
		${destroot}${prefix}/var/${name}/html/log
}


post-activate {

ui_msg "\n#### To complete the NeDi OS X installation ####

1) Setup MySQL (for new installs)
-----------------------------------------------
-Configure MySQL:
        sudo -u mysql mysql_install_db
        sudo chown -R mysql:mysql ${prefix}/var/db/mysql/
        sudo chown -R mysql:mysql ${prefix}/var/run/mysqld/
        sudo chown -R mysql:mysql ${prefix}/var/log/mysql/

-Set MySQL to run at system boot
	sudo launchctl load -w /Library/LaunchDaemons/org.darwinports.mysql4.plist

   NOTE: MySQL must have been installed with the +server variant in order to
      use launchctl to run MySQL at system boot.

-Start MySQL:
        sudo /opt/local/share/mysql/mysql.server start

-Set the root MySQL password:
        mysqladmin -u root password <new-password>


2) Download Apache 2 and PHP Binaries
------------------------------------------------
-Download Complete Apache 2 and Complete PHP
	http://www.serverlogistics.com/downloads.php

  Notes about Apache and PHP
  ----------------------------------
  NeDi requires PHP with SNMP support enabled, which is a non-default option
  and extremely challenging to compile into PHP.  Complete PHP is a binary
  installed PHP package with SNMP support and it requires Complete Apache 2.


3) Create an OS X NeDi user (or choose an existing one) using the Accounts
   pane in System Preferences


4) Install Complete Apache 2 (version 2.0.52)
------------------------------------------------
-Turn off Personal Web Sharing
-Run Apache2.pkg installer
-Drag Apache2.prefPane to /Library/PreferencePanes
	Create this folder if it does not exist
-Edit httpd.conf: pico /Library/Apache2/conf/httpd.conf

User <nedi-user>
Group <nedi-group>

-Start Apache 2 via System Preferences pane


5) Install Complete PHP 4 (version 4.3.9)
------------------------------------------------
-Run PHP4.pkg installer
-Edit /Library/PHP4/lib/php.ini
	mysql.default_socket = ${prefix}/var/run/mysqld/mysqld.sock
-Drag test.php to /Library/Apache2/htdocs
-Start Apache via the Apache 2 System Preferences pane
-Test PHP with this link: http://localhost/test.php


6) Configure NeDi, initialize database, and Login to NeDi
-----------------------------------------------
-Set NeDi owner: sudo chown -R <nedi-user>:<nedi-group> ${prefix}/var/${name}/
-Apache symlink: ln -s ${prefix}/var/${name}/html/  /Library/Apache2/htdocs/nedi
-Edit nedi.conf Backend/Authen. vars: sudo pico ${prefix}/var/${name}/nedi.conf
	Leave nedi.conf permissions at 600 to protect your network passwords!
backend		MSQ
dbpass		<nedidb-access-pwd>
authuser	mysql

-Initialize the NeDi database: ${prefix}/var/${name}/nedi.pl -i
	Enter 'root' and the MySQL root password when prompted

-Verify the NeDi DB:
        mysql -u root -p
        mysql> use nedi;
        mysql> show tables;
        mysql> exit;

-Login to the NeDi web interface: http://localhost/nedi/index.php
	Initial user/pass is 'admin'/'admin'


7) Discover Your Network with NeDi
-----------------------------------------------
-Edit the seedlist file: pico ${prefix}/var/${name}/seedlist
-Edit nedi.conf Device Acc. variables: sudo pico ${prefix}/var/${name}/nedi.conf

comm <my-community-string>
<usr>  <pass>  <enablepass>

-Make any other desired changes in nedi.conf
-Start NeDi data collection:
	cd ${prefix}/var/${name}/nedi.pl
	sudo -u <nedi-user> nedi.pl -c -d (debug)
-Put a command in the crontab to discover your network at regular intervals.
 	For example, to run NeDi every day at 11:00 and 3:00:
1 11,15 * * * cd ${prefix}/var/${name} ; ./nedi.pl -c >> /dev/null 2>&1
\n"
}
