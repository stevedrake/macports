# $Id: Portfile,v 1.2 2004/12/21 16:47:29 rshaw Exp $
PortSystem		1.0

name			nefu
version			0.9.6
revision		1
categories		net
maintainers		rshaw@opendarwin.org
description		A network monitoring daemon.
long_description	nefu monitors network services and reports outages. \
					Working from a discription of the network \
					topography, nefu's algorithm prevents "false alarms" \
					in the event of a network outage due to a dependency \
					failure.
homepage		http://rsug.itd.umich.edu/software/${name}
master_sites	${homepage}/files/
checksums		md5 430f9a3d2ea52f865c47895c93375ca3
platforms		darwin

depends_build	bin:bison:bison \
				bin:flex:flex
depends_lib		lib:libssl.0.9:openssl

# All patches were obtained from the CVS logs of the nefu author,
# with the exception of the following patches:
#	patch-Makefile.in
#	patch-aclocal.m4
#	patch-configure.ac
# These were modified for DP installation uses. The following
# has been submitted to the author for inclusion in a future
# release:
#	patch-libtest-shell.c
#
patchfiles		patch-README \
				patch-Makefile.in \
				patch-aclocal.m4 \
				patch-config.h.in \
				patch-configure.ac \
				patch-ttable.c \
				patch-libtest-ldap.c \
				patch-libtest-shell.c \
				patch-libtest-tcp.c \
				patch-TDK-README \
				patch-TDK-README.C \
				patch-TDK-README.SH \
				patch-TDK-Makefile.in \
				patch-TDK-tdk.c \
				patch-TDK-tester.c

use_autoconf	yes
configure.args	--mandir='\${prefix}/share/man' \
				--with-htmldir='\${prefix}/share/${name}/public_html' \
				--with-scriptdir='\${prefix}/share/${name}/shelltests'

build.args		DEFS=-DBIND_8_COMPAT
post-build {
	build.dir	${worksrcpath}/TDK
	system "[command build]"
	build.dir	${worksrcpath}
}

pre-destroot {
	if {$env(USER) == "root"} {
		addgroup nefu
		set gid [existsgroup nefu]
		adduser nefu gid=${gid} realname=Nefu\ Monitor home=${prefix}/share/${name}
	}
}
post-destroot {
	# nefu conf file
	xinstall -d -m 0755 ${destroot}${prefix}/etc
	xinstall -m 0644 ${filespath}/nefu.conf.in \
		${destroot}${prefix}/etc/nefu.conf.sample
	set hostname [exec hostname]
	reinplace "s%@hostname@%${hostname}%" \
		${destroot}${prefix}/etc/nefu.conf.sample

	# nefu sample shelltests
	xinstall -m 0755 TDK/shelltests/environ.sh \
		${destroot}${prefix}/share/${name}/shelltests

	# nefu start/stop script
	xinstall -d -m 0755 ${destroot}${prefix}/etc/rc.d
	xinstall -m 0755 ${filespath}/nefu.sh.in \
		${destroot}${prefix}/etc/rc.d/nefu.sh
	reinplace "s%@PREFIX@%${prefix}%" \
		${destroot}${prefix}/etc/rc.d/nefu.sh

	# nefu documentation
	cd ${worksrcpath}
	xinstall -d -m 0755 ${destroot}${prefix}/share/doc/${name}
	xinstall -m 0644 README ${destroot}${prefix}/share/doc/${name}
	xinstall -d -m 0755 ${destroot}${prefix}/share/doc/${name}/TDK
	xinstall -m 0755 TDK/tdk \
		${destroot}${prefix}/share/doc/${name}/TDK
	xinstall -m 0644 TDK/README TDK/README.C TDK/README.SH \
		${destroot}${prefix}/share/doc/${name}/TDK
	reinplace "s%@PREFIX@%${prefix}%" \
		${destroot}${prefix}/share/doc/${name}/TDK/README.SH
	xinstall -d -m 0755 ${destroot}${prefix}/share/doc/${name}/TDK/shelltests
	xinstall -m 0755 TDK/shelltests/environ.sh \
		${destroot}${prefix}/share/doc/${name}/TDK/shelltests

	# fix ownership
	if {$env(USER) == "root"} {
		system "chown -R nefu ${destroot}${prefix}/share/${name}"
		system "chgrp -R nefu ${destroot}${prefix}/share/${name}"
	}
}

pre-install {
	if {$env(USER) == "root"} {
		addgroup nefu
		set gid [existsgroup nefu]
		adduser nefu gid=${gid} realname=Nefu\ Monitor home=${prefix}/share/${name}
	}
}

platform darwin {
	depends_run	path:/Library/StartupItems/DarwinPortsStartup:DarwinPortsStartup

	post-destroot {
		system "ln -s public_html ${destroot}${prefix}/share/${name}/Sites"
	}
}

