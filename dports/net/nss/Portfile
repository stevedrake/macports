# $Id$

PortSystem	1.0

name		nss
version		3.11.7
revision	2
categories	net
maintainers	reiffert@macports.org
description	Network Security Service libraries.
depends_lib	port:nspr

long_description ${description}
use_configure	no
homepage	http://www.mozilla.org/projects/security/pki/nss/
platforms       darwin

set my_release 	NSS_[strsed ${version} {g/\./_/}]_RTM

master_sites	ftp://ftp.mozilla.org/pub/mozilla.org/security/nss/releases/${my_release}/src/ \
		http://ftp.mozilla.org/pub/mozilla.org/security/nss/releases/${my_release}/src/
checksums	md5 82594a0773cedd7bb7aa25009a25f5a3

worksrcdir      ${worksrcpath}
patchfiles	patch-Darwin.mk.diff \
		patch-UNIX.mk.diff \
		patch-config.mk.diff

variant universal {
		patchfiles-delete patch-Darwin.mk.diff \
					patch-config.mk.diff
		patchfiles-append patch-Darwin.mk.universal.diff \
					patch-Makefile.universal.diff \
					patch-config.mk.universal.diff
}

post-patch {
        reinplace "s|@executable_path|${prefix}/lib|g" \
		mozilla/security/coreconf/Darwin.mk \
		mozilla/security/nss/cmd/platlibs.mk \
		mozilla/security/nss/lib/smime/config.mk \
		mozilla/security/nss/lib/ssl/config.mk
        reinplace "s|@@PREFIX@@|${prefix}|g" \
		mozilla/security/coreconf/Darwin.mk \
		mozilla/security/coreconf/UNIX.mk \
		mozilla/security/nss/lib/ckfw/builtins/config.mk
}

build {system "cd ${worksrcdir} && make -C mozilla/security/coreconf/nsinstall && make -C mozilla/security/dbm && make -C mozilla/security/nss"}

destroot {
	xinstall -m 755 -d ${destroot}${prefix}/include/nss
	eval xinstall -m 755 [glob ${worksrcpath}/mozilla/dist/public/nss/*] ${destroot}${prefix}/include/nss
	eval xinstall -m 755 [glob ${worksrcpath}/mozilla/dist/public/dbm/*] ${destroot}${prefix}/include/nss
	xinstall -m 755 -d ${destroot}${prefix}/bin
	eval xinstall -m 755 [glob ${worksrcpath}/mozilla/dist/Darwin*/bin/*] ${destroot}${prefix}/bin
	xinstall -m 755 -d ${destroot}${prefix}/lib
	eval xinstall -m 755 [glob ${worksrcpath}/mozilla/dist/Darwin*/lib/*.dylib] ${destroot}${prefix}/lib
}
