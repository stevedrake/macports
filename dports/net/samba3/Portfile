# $Id$

PortSystem 1.0

name			samba3
version			3.2.2
categories		net
platforms		darwin
maintainers		mww openmaintainer
description		SMB/CIFS implementation
long_description	Samba is an software suite that provides seamless file and \
					print services to SMB/CIFS clients

homepage		http://www.samba.org/
master_sites	http://us1.samba.org/samba/ftp/stable/ \
				ftp://ftp.bit.nl/mirror/samba/stable/ \
				ftp://de.samba.org/samba.org/stable/ \
				ftp://us4.samba.org/pub/samba/stable/ \
				ftp://ru.samba.org/pub/samba/stable/
distname		samba-${version}
checksums		md5 d5c54759e557009e5ec8d870bc735241 \
			sha1 f23a43d770ad62ffeef726d2b301a90448531ed8
depends_lib		port:libiconv port:openssl port:popt

worksrcdir		${worksrcdir}/source

configure.cflags-append	"-fno-common"
configure.cppflags-append "-DHAVE_STRUCT_TIMESPEC"
configure.args	--with-mandir=${prefix}/share/man \
				--with-libdir=${prefix}/lib/${name} \
				--with-privatedir=${prefix}/var/db/smb \
				--with-configdir=${prefix}/etc/samba3/ \
				--with-swatdir=${prefix}/share/${name}/swat \
				--with-readline=${prefix} \
				--with-krb5=/usr \
				--without-included-popt \
				--without-readline \
				--enable-cups

post-patch {
	reinplace "s|-bundle|-dynamiclib|g" ${worksrcpath}/configure

### BAND-AID: libs in subdirectories of ${prefix}/lib/samba3 will
###   still have unresolved symbols since the makefile doesn't contain
###   any information about install location at link time...
	reinplace "s|@\$\(SHLD\) \$\(LDSHFLAGS\)|@\$\(SHLD\) \$\(LDSHFLAGS\) -install_name @libdir@/`basename \$@`|g" \
		${worksrcpath}/Makefile.in
}

platform darwin 9 {
	patchfiles		patch-source_smbd_utmp_c.diff
}

platform darwin 8 {
	depends_build		port:cups-headers
}

post-destroot {
	xinstall -m 755 -d ${destroot}${prefix}/etc/samba3/ \
		${destroot}${prefix}/var/db/smb/
	xinstall -m 644 ${worksrcpath}/../examples/smb.conf.default \
		${destroot}${prefix}/etc/samba3/smb.conf.sample
	system "touch ${destroot}${prefix}/etc/samba3/lmhosts.sample"
	system "touch ${destroot}${prefix}/var/db/smb/secrets.tdb.sample"
}

livecheck.check	regex
livecheck.url	http://us5.samba.org/samba/ftp/?M=D
livecheck.regex	samba-(3\\.2\[0-9a-z.\]+)\\.tar\\.gz

