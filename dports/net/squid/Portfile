# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem 1.0

name			squid
version			2.6.STABLE20
categories		net
platforms		darwin
maintainers		jmr openmaintainer
description		advanced proxy caching server for http, https, ftp, gopher
long_description	Squid is a high-performance proxy caching server for \
				web clients, supporting FTP, gopher, and HTTP data \
				objects. Unlike traditional caching software, Squid \
				handles all requests in a single, non-blocking, \
				I/O-driven process. Squid keeps meta data and \
				especially hot objects cached in RAM, caches DNS \
				lookups, supports non-blocking DNS lookups, and \
				implements negative caching of failed requests.

homepage		http://www.squid-cache.org/
master_sites		ftp://ftp.squid-cache.org/pub/squid-2/STABLE/ \
				http://www.squid-cache.org/Versions/v2/2.6/ \
				ftp://ftp.unimelb.edu.au/pub/cwis/servers/unix/squid/squid-2/STABLE/ \
				ftp://sunsite.auc.dk/pub/infosystems/squid/squid-2/STABLE/ \
				ftp://ftp.mirrorservice.org/sites/ftp.squid-cache.org/pub/squid-2/STABLE/ \
				http://ring.ip-kyoto.ad.jp/archives/net/www/squid/squid-2/STABLE/

checksums		md5 6e1d87e9ae47f825c814a954a6febc36 \
				sha1 a58fd838ff14345f10f2f3f2d1839eb70bb6f394 \
				rmd160 b9005294cb7bd063928a40bfaed68b1fe52b32ea

use_bzip2		yes
patchfiles		patch-cf.data.pre.diff

depends_lib		port:openssl port:zlib

platform darwin 9 {
	patchfiles-append patch-configure.diff
}

configure.args	--with-pthreads \
				--mandir=${prefix}/share/man \
				--sysconfdir=${prefix}/etc/squid \
				--datadir=${prefix}/share/squid \
				--localstatedir=${prefix}/var/squid \
				--with-openssl=${prefix} \
				--enable-removal-policies

build.args		DEFAULT_PID_FILE=${prefix}/var/run/squid/squid.pid
use_parallel_build  yes

startupitem.create		yes
startupitem.name		Squid
startupitem.start \
	"cd ${prefix}/var/squid" \
	"if \[ ! -d \"${prefix}/var/squid/cache/00\" \]; then" \
	"\tsu -fm root -c \"exec ${prefix}/sbin/squid -s -z\"" \
	"fi" \
	"su -fm root -c \"exec ${prefix}/sbin/squid -s\""
startupitem.stop \
	"cd ${prefix}/var/squid" \
	"su -fm root -c \"exec ${prefix}/sbin/squid -k shutdown\""

pre-destroot {
	addgroup squid
	set gid [existsgroup squid]
	adduser squid gid=${gid} realname=Squid\ Proxy home=${prefix}/var/squid
}
post-destroot	{
	reinplace "s|/etc/squid|${prefix}/etc/squid|g" \
		${destroot}${prefix}/share/man/man8/squid.8
	xinstall -o squid -g squid -m 755 -d \
		${destroot}${prefix}/var/run/squid ${destroot}${prefix}/var/squid \
		${destroot}${prefix}/var/squid/cache ${destroot}${prefix}/var/squid/logs
	file delete -force ${destroot}${prefix}/etc/squid/squid.conf \
	                   ${destroot}${prefix}/etc/squid/mime.conf
}
destroot.keepdirs	${destroot}${prefix}/var/run/squid \
				${destroot}${prefix}/var/squid/cache \
				${destroot}${prefix}/var/squid/logs

post-activate {
	# Make sure initial conf files are present and setup correctly
	foreach f { squid.conf mime.conf } {
		if {![file exists ${prefix}/etc/squid/${f}]} {
			file copy ${prefix}/etc/squid/${f}.default \
				${prefix}/etc/squid/${f}
		}
	}
}

livecheck.check	regex
livecheck.url	http://www.squid-cache.org/Versions/v2/2.6/
livecheck.regex	squid-(2.6.STABLE\[0-9\\.\]+)-RELEASENOTES
