#!/bin/sh

prefix=__PREFIX
exec_prefix=${prefix}
statedir=${prefix}/var/squid
cachedir=${statedir}/cache
confdir=${prefix}/etc/squid

squid_user=__UID

PATH=${exec_prefix}/sbin:/bin:/usr/bin
export PATH

cd ${statedir}

checkinstall() 
{
	# test if conf files are present
	if [ ! -f "$confdir/squid.conf" ]; then
		echo "Error: $confdir/squid.conf is missing!"
		echo "Try copying $confdir/squid.conf.sample to $confdir/squid.conf"
		exit 1
	fi
	if [ ! -f "$confdir/mime.conf" ]; then
		echo "Error: $confdir/mime.conf is missing!"
		echo "Try copying $confdir/mime.conf.sample to $confdir/mime.conf"
		exit 1
	fi

	# test if cache is present, if not we create it
	if [ ! -d "$cachedir/00" ]
	then
		su -fm $squid_user -c "exec $exec_prefix/sbin/squid -s -z"
	fi
}

case "$1" in
start)
	checkinstall
	su -fm $squid_user -c "exec $exec_prefix/sbin/squid -s"
	;;
stop)
	su -fm $squid_user -c "exec $exec_prefix/sbin/squid -k shutdown"
	;;
restart)
	$0 stop
	$0 start
	;;
reconf*|rotate|int*|debug|check|kill)
	su -fm $squid_user -c "exec $exec_prefix/sbin/squid -k $1"
	;;
*)
	echo "Usage: `basename $0` {start|stop|reconfigure|rotate|interrupt|debug|check|kill}" >&2
	echo "    start        start squid" >&2
	echo "    stop         clean shutdown" >&2
	echo "    restart      restart squid (stop & start)" >&2
	echo "    reconfigure  reread configuration files" >&2
	echo "    rotate       rotate log files" >&2
	echo "    interrupt    quick clean shutdown " >&2
	echo "    debug        toggle debug logging" >&2
	echo "    check        check for running squid" >&2
	echo "    kill         terminate squid by brute force" >&2
	exit 1
	;;
esac

exit 0

