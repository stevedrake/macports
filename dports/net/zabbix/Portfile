# $Id$

PortSystem	1.0

name			zabbix
version			1.1.6
categories		net
maintainers		markd@macports.org
platforms		darwin

description		An open source application and network monitor
long_description	${description}

homepage		http://www.zabbix.com
master_sites		sourceforge
checksums		md5 baa6896c5f41ed286bca3c40e419e1cf
default_variants	+server

patchfiles		patch-configure
depends_lib		port:mysql5 \
				port:fping

configure.pre_args     --prefix=${prefix}

configure.args		--enable-server \
			--with-mysql=${prefix} \
			--with-net-snmp \
			--bindir=${prefix}/bin/zabbix \
			--sbindir=${prefix}/sbin/zabbix \
			--libexecdir=${prefix}/libexec/zabbix \
			--datadir=${prefix}/share/zabbix \
			--sysconfdir=${prefix}/etc/zabbix \
			--localstatedir=${prefix}/var/zabbix \
			--mandir=${prefix}/man

	startupitem.create      yes
	startupitem.start       "${prefix}/share/zabbix/zabbix_server.init start"
	startupitem.stop        "${prefix}/share/zabbix/zabbix_server.init stop"

variant server  {
# This variant doesn't do anything in this port.  Its only purpose is to trigger the server
# variant in the mysql5 port.
}

build {}
        
post-patch {
        reinplace "s|#DBSocket=/tmp/mysql.sock|DBSocket=${prefix}/var/run/mysql5/mysqld.sock|g" \
                ${worksrcpath}/misc/conf/zabbix_server.conf
                
        reinplace "s|#FpingLocation=/usr/sbin/fping|FpingLocation=${prefix}/sbin/fping|g" \
        		${worksrcpath}/misc/conf/zabbix_server.conf
}

pre-destroot {
        adduser zabbix
        addgroup zabbix
}

post-destroot {
# Copy sample server .conf files
	xinstall -d -m 755 -d ${destroot}${prefix}/etc/zabbix
        xinstall -m 755 ${worksrcpath}/misc/conf/zabbix_server.conf \
                ${destroot}${prefix}/etc/zabbix/zabbix_server.conf.sample
		
# Copy database data and schemas
        xinstall -d -m 755 -d ${destroot}${prefix}/share/zabbix/data
        xinstall -d -m 755 -d ${destroot}${prefix}/share/zabbix/mysql
        xinstall -d -m 755 -d ${destroot}${prefix}/share/zabbix/postgresql

        eval xinstall -m 755 [glob ${worksrcpath}/create/data/*.*] \
                ${destroot}${prefix}/share/zabbix/data
        eval xinstall -m 755 [glob ${worksrcpath}/create/mysql/*] \
                ${destroot}${prefix}/share/zabbix/mysql
        eval xinstall -m 755 [glob ${worksrcpath}/create/postgresql/*] \
                ${destroot}${prefix}/share/zabbix/postgresql

# Copy the front end
        xinstall -d -m 755 -d ${destroot}${prefix}/share/zabbix/frontends/php
        eval xinstall -m 755 [glob ${worksrcpath}/frontends/php/*.*] \
                ${destroot}${prefix}/share/zabbix/frontends/php
        xinstall -d -m 755 -d ${destroot}${prefix}/share/zabbix/frontends/php/audio
        eval xinstall -m 755 [glob ${worksrcpath}/frontends/php/audio/*.*] \
                ${destroot}${prefix}/share/zabbix/frontends/php/audio

        xinstall -d -m 755 -d ${destroot}${prefix}/share/zabbix/frontends/php/images/general
        xinstall -d -m 755 -d ${destroot}${prefix}/share/zabbix/frontends/php/images/gradients
        xinstall -d -m 755 -d ${destroot}${prefix}/share/zabbix/frontends/php/images/sysmaps/old
        eval xinstall -m 755 [glob ${worksrcpath}/frontends/php/images/general/*.*] \
                ${destroot}${prefix}/share/zabbix/frontends/php/images/general
        eval xinstall -m 755 [glob ${worksrcpath}/frontends/php/images/gradients/*.*] \
                ${destroot}${prefix}/share/zabbix/frontends/php/images/gradients
        eval xinstall -m 755 [glob ${worksrcpath}/frontends/php/images/sysmaps/*.*] \
                ${destroot}${prefix}/share/zabbix/frontends/php/images/sysmaps
        eval xinstall -m 755 [glob ${worksrcpath}/frontends/php/images/sysmaps/old/*.*] \
                ${destroot}${prefix}/share/zabbix/frontends/php/images/sysmaps/old

        xinstall -d -m 755 -d ${destroot}${prefix}/share/zabbix/frontends/php/include/classes
        xinstall -d -m 755 -d ${destroot}${prefix}/share/zabbix/frontends/php/include/locales
        eval xinstall -m 755 [glob ${worksrcpath}/frontends/php/include/*.*] \
                ${destroot}${prefix}/share/zabbix/frontends/php/include
        eval xinstall -m 755 [glob ${worksrcpath}/frontends/php/include/classes/*.*] \
                ${destroot}${prefix}/share/zabbix/frontends/php/include/classes
        eval xinstall -m 755 [glob ${worksrcpath}/frontends/php/include/locales/*.*] \
                ${destroot}${prefix}/share/zabbix/frontends/php/include/locales 

# Create a startup script for the server
		xinstall -m 755 ${portpath}/${filesdir}/zabbix_server.init \
			${destroot}${prefix}/share/zabbix
		reinplace "s|__PREFIX__|${prefix}|g" \
           	${destroot}${prefix}/share/zabbix/zabbix_server.init

# Set permissions for etc (protect passwords) and the frontend
		system "chmod 660 ${destroot}${prefix}/etc/zabbix/*"
		system "chown zabbix:zabbix ${destroot}${prefix}/etc/zabbix/*"
		system "chown -R www:www ${destroot}${prefix}/share/zabbix/frontends/*"
}

post-activate {
ui_msg "\n#### To complete the ZABBIX installation ####


1) Setup MySQL (for new MySQL installs)

-Configure MySQL:
        sudo -u mysql ${prefix}/lib/mysql5/bin/mysql_install_db

-Start MySQL:
        sudo ${prefix}/share/mysql5/mysql/mysql.server start

-Set MySQL to run at system boot (optional)
        sudo launchctl load -w /Library/LaunchDaemons/org.macports.mysql5.plist

   NOTE: MySQL must have been installed with the +server variant in order to
      use launchctl to run MySQL at system boot.

-Set a root MySQL password
   Follow the instructions that were given after you executed 'mysql_install_db' above


2) Setup the ZABBIX MySQL database

-Create the ZABBIX database
	mysql5 -u root -p (enter password at prompt)
	mysql> create database zabbix;
	mysql> exit;

-Import the ZABBIX Schema
	cd ${prefix}/share/zabbix/mysql
	cat schema.sql | mysql5 -u root -p zabbix
	cd ${prefix}/share/zabbix/data
	cat data.sql | mysql5 -u root -p zabbix

-Create a MySQL 'zabbix' user and password
	mysql5 -u root -p
	mysql> grant SELECT, INSERT, UPDATE, DELETE, CREATE on zabbix.* to zabbix@localhost;
	mysql> grant SELECT, INSERT, UPDATE, DELETE, CREATE on zabbix.* to zabbix;
	mysql> set PASSWORD FOR zabbix@localhost = OLD_PASSWORD('zabbix-db-password');

NOTE: ZABBIX uses MySQL old-style password hashes so the OLD_PASSWORD keyword is necessary 

3) Edit the sample .conf file ${prefix}/etc/zabbix/zabbix_server.conf (rename & omit .sample)

   Modify these variables at the very least:

	DBName=zabbix
	DBUser=zabbix
	DBPassword=<zabbix-mysql-password>


4) Install PHP 4 or 5 (not covered)

   Set mysql.default_socket path to ${prefix}/var/run/mysql5/mysqld.sock in this PHP file:

	./phpx/lib/php.ini (in /usr/local, ${prefix}, or /Library depending on PHP package)

   Modify the variables below in this Zabbix file:
	${prefix}/share/zabbix/frontends/php/include/db.inc.php

	\$DB_USER        =\"zabbix\";
	\$DB_PASSWORD    =\"mysql-zabbix-password\";


5) Set a symbolic link in your Apache document root pointing to the PHP frontend files

	sudo ln -s ${prefix}/share/zabbix/frontends/php <Apache-docroot>/zabbix


6) Set zabbix_server to run at system boot, then start it

   OS X 10.4 - Run launchctl so ZABBIX will start at system boot
	sudo launchctl load -w /Library/LaunchDaemons/org.macports.zabbix.plist

   OS X 10.3 and previous - A startup item was created in /Library/StartupItems
	Add \"ZABBIX=-YES-\" to the /etc/hostconfig file to run ZABBIX at system boot

   ${prefix}/share/zabbix/zabbix_server.init start (stop|status)


7) Login at http://localhost/zabbix with default user 'admin' with no password, then
   be sure to read the manual: http://www.zabbix.com/manual/v1.1/index.php

\n"
}

