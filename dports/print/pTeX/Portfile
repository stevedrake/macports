# $Id: Portfile,v 1.3 2006/03/11 18:42:20 takanori Exp $

set ptetex_version 20060127

PortSystem		1.0
name			pTeX
version			ptetex3-${ptetex_version}
revision		1
categories		print textproc
maintainers		takanori@opendarwin.org
description		Japanese TeX (pTeX) processing environment
long_description	${description}
homepage		http://www.nn.iij4u.or.jp/~tutimura/tex/ptetex.html
master_sites		http://www.ring.gr.jp/pub/text/CTAN/systems/unix/teTeX/3.0/distrib/:tetex \
			ftp://tug.ctan.org/tex-archive/systems/unix/teTeX/current/distrib/:tetex \
			ftp://cam.ctan.org/tex-archive/systems/unix/teTeX/current/distrib/:tetex \
			ftp://dante.ctan.org/tex-archive/systems/unix/teTeX/current/distrib/:tetex \
			http://tutimura.ath.cx/~nob/tex/ptetex/ptetex3/:ptetex3 \
			ftp://ftp.miko.org/pub/mirror/ptetex3/:ptetex3
distfiles		tetex-src-3.0.tar.gz:tetex \
			tetex-texmf-3.0.tar.gz:tetex \
			ptetex3-${ptetex_version}.tar.gz:ptetex3 \

checksums	tetex-src-3.0.tar.gz md5 944a4641e79e61043fdaf8f38ecbb4b3 \
				     sha1 7637789f7f4929694aed1b89820f5bad4753e8fc \
				     rmd160 15a139f5f36993e4ed3583260e175cfb13ce7bcc \
		tetex-texmf-3.0.tar.gz md5 11aa15c8d3e28ee7815e0d5fcdf43fd4 \
				       sha1 10f7d2fa007c95ca066d899fca0e9a8446108824 \
				       rmd160 67cb6325f1edbea89c4723791116717190ec73c4 \
		ptetex3-${ptetex_version}.tar.gz md5 ffb476842a3d79c1f8dcaef97a6b12ef \
					  sha1 3181fe631a8712bc9580ea1a82eb7dc7f21d0e1a \
					  rmd160 b728fb78ce1a5d3407e161e8a61cb38a0b9122e3

default_variants	+hiragino +otf

depends_lib	lib:libX11.6:XFree86 lib:libgd:gd2 \
		lib:libz:zlib lib:libpng:libpng lib:libncurses:ncurses
depends_run	port:texinfo port:texi2html

extract.only	ptetex3-${ptetex_version}.tar.gz
worksrcdir	ptetex3-${ptetex_version}

patch		{
		#DarwinPorts' iconv cannot recognize UTF-8-MAC encode. use OSX's native iconv instead.
		system "perl -pi -e 's|(\\s+)iconv(\\s+)|\\1/usr/bin/iconv\\2|g' ${worksrcpath}/*.sh"

		system "echo MD5CHECK=md5check  >> ${worksrcpath}/my_option"
		if {[variant_isset euc]} {
		system "echo KANJI_CODE=EUC  >> ${worksrcpath}/my_option"
		}
		if {[variant_isset sjis]} {
		system "echo KANJI_CODE=SJIS  >> ${worksrcpath}/my_option"
		}
		system "echo SRC_DIR=${distpath} >> ${worksrcpath}/my_option"
		system "echo REAL_PREFIX=${prefix} >> ${worksrcpath}/my_option"
		system "echo REAL_DATA=${prefix}/share >> ${worksrcpath}/my_option"
		system "echo CONF_OPTION=\\\"\\\$CONF_OPTION --without-texinfo --without-texi2html\\\" >> ${worksrcpath}/my_option"
		if {[variant_isset nox11]} {
		   system "echo CONF_OPTION=\\\"\\\$CONF_OPTION --without-x --without-xdvik\\\" >> ${worksrcpath}/my_option"
		} else {
		   # gd2 requires X11
		   system "echo CONF_OPTION=\\\"\\\$CONF_OPTION --with-system-gd\\\" >> ${worksrcpath}/my_option"
		}
		if {[variant_isset motif]} {
		   system "echo CONF_OPTION=\\\"\\\$CONF_OPTION --with-xdvi-x-toolkit=motif\\\" >> ${worksrcpath}/my_option"
		}
		if {[variant_isset xaw]} {
		   system "echo CONF_OPTION=\\\"\\\$CONF_OPTION --with-xdvi-x-toolkit=xaw\\\" >> ${worksrcpath}/my_option"
		}
		if {[variant_isset xaw3d]} {
		   system "echo CONF_OPTION=\\\"\\\$CONF_OPTION --with-xdvi-x-toolkit=xaw3d\\\" >> ${worksrcpath}/my_option"
		}
		if {[variant_isset nextaw]} {
		   system "echo CONF_OPTION=\\\"\\\$CONF_OPTION --with-xdvi-x-toolkit=neXtaw\\\" >> ${worksrcpath}/my_option"
		}
		system "echo CONF_OPTION=\\\"\\\$CONF_OPTION --with-system-zlib --with-system-pnglib --with-system-ncurses\\\" >> ${worksrcpath}/my_option"
		system "echo CPPFLAGS=\\\"-I${prefix}/include\\\" >> ${worksrcpath}/my_option"
		system "echo LDFLAGS=\\\"-L${prefix}/lib\\\" >> ${worksrcpath}/my_option"
		system "echo LD_LIBRARY_PATH=\\\"\\\$LD_LIBRARY_PATH:${prefix}/lib\\\" >> ${worksrcpath}/my_option"
		system "echo export CPPFLAGS LDFLAGS LD_LIBRARY_PATH >> ${worksrcpath}/my_option"
}

configure {}

build		{
		file mkdir ${workpath}/temp

		system "cd ${worksrcpath} && make PREFIX=${workpath}/temp"
		if {[variant_isset otf]} {
		   system "cd ${worksrcpath} && make PREFIX=${workpath}/temp otf"
		}
		if {[variant_isset babel]} {
		   system "cd ${worksrcpath} && make PREFIX=${workpath}/temp babel"
		}
		system "cd ${worksrcpath} && make PREFIX=${workpath}/temp fonty"
}

destroot	{
		system "cp -R ${workpath}/temp/teTeX/ ${destroot}${prefix}"

		file delete ${destroot}${prefix}/info/dir
		file delete ${destroot}${prefix}/share/info
		file rename ${destroot}${prefix}/info ${destroot}${prefix}/share/info
		file delete -force ${destroot}${prefix}/share/man
		file rename ${destroot}${prefix}/man ${destroot}${prefix}/share/man

		if {[variant_isset hiragino]} {
		   system "perl -pi -e \"s|^(KanjiMap utf-noEmbeddedFont.map)$|#\\1\\nKanjiMap utf-unicode-x.map|, s|^(KanjiMap otf-noEmbeddedFont.map)$|#\\1\\nKanjiMap otf-hiraginox.map|\" ${destroot}${prefix}/share/texmf-config/web2c/updmap.cfg"
		   system "perl -pi -e \"s|^(rml\\s.+)$|#\\1\\nrml\\tH\\tHiraMinPro-W3.otf|, s|^(rmlv\\s.+)$|#\\1\\nrmlv\\tV\\tHiraMinPro-W3.otf|, s|^(gbm\\s.+)$|#\\1\\ngbm\\tH\\tHiraKakuPro-W3.otf|, s|^(gbmv\\s.+)$|#\\1\\ngbmv\\tV\\tHiraKakuPro-W3.otf|, \" ${destroot}${prefix}/share/texmf/fonts/map/dvipdfm/cid-x.map"
		}

		# Modify mktex.opt to force use of varfonts
		reinplace "s|MT_FEATURES=appendonlydir|MT_FEATURES=appendonlydir:varfonts|g" ${destroot}${prefix}/share/texmf/web2c/mktex.opt

		# Add a directory for local enhancements
		file mkdir ${destroot}${prefix}/share/texmf-local
		system "touch ${destroot}${prefix}/share/texmf-local/.${version}"
}

post-destroot	{
		xinstall -m 755 -d ${destroot}${prefix}/share/doc/ptetex3

		xinstall -m 644 ${worksrcpath}/ChangeLog ${destroot}${prefix}/share/doc/ptetex3
		xinstall -m 644 ${worksrcpath}/LICENSE ${destroot}${prefix}/share/doc/ptetex3
		eval xinstall -m 644 [glob ${worksrcpath}/README*] ${destroot}${prefix}/share/doc/ptetex3
}

post-activate	{
		system "ranlib ${prefix}/lib/libkpathsea.a"

		system "fmtutil-sys --all"
		system "mktexlsr"
		system "updmap-sys"
}

variant hiragino {}
variant euc conflicts sjis {}
variant sjis conflicts euc {}
variant otf {}
variant babel {}

variant nox11 conflicts motif xaw xaw3d nextaw {
	depends_lib-delete lib:libX11.6:XFree86 lib:libgd:gd2
}
variant motif conflicts nox11 xaw xaw3d nextaw {
	depends_lib-append lib:libXm:openmotif lib:libiconv:libiconv lib:libjpeg:jpeg
}
variant xaw conflicts nox11 motif xaw3d nextaw {
	depends_lib-append lib:libXaw:XFree86 lib:libiconv:libiconv lib:libjpeg:jpeg
}
variant xaw3d conflicts nox11 motif xaw nextaw {
	depends_lib-append lib:libXaw3d:Xaw3d lib:libiconv:libiconv lib:libjpeg:jpeg
}
variant nextaw conflicts nox11 motif xaw xaw3d {
	depends_lib-append lib:libneXtaw:neXtaw lib:libiconv:libiconv lib:libjpeg:jpeg
}
