# $Id: Portfile,v 1.5 2006/03/16 17:45:55 takanori Exp $

set ptetex_version 20060315

PortSystem		1.0
name			pTeX
version			ptetex3-${ptetex_version}
epoch			20060315
categories		print textproc
maintainers		takanori@opendarwin.org
description		Japanese TeX (pTeX) processing environment
long_description	${description}
platforms		darwin
homepage		http://www.nn.iij4u.or.jp/~tutimura/tex/ptetex.html
master_sites		http://www.ring.gr.jp/pub/text/CTAN/systems/unix/teTeX/3.0/distrib/:tetex \
			ftp://tug.ctan.org/tex-archive/systems/unix/teTeX/current/distrib/:tetex \
			ftp://cam.ctan.org/tex-archive/systems/unix/teTeX/current/distrib/:tetex \
			ftp://dante.ctan.org/tex-archive/systems/unix/teTeX/current/distrib/:tetex \
			http://tutimura.ath.cx/~nob/tex/ptetex/ptetex3/:ptetex3 \
			ftp://ftp.miko.org/pub/mirror/ptetex3/:ptetex3
distfiles		tetex-src-3.0.tar.gz:tetex \
			tetex-texmf-3.0.tar.gz:tetex \
			ptetex3-${ptetex_version}.tar.gz:ptetex3 \

checksums	tetex-src-3.0.tar.gz md5 944a4641e79e61043fdaf8f38ecbb4b3 \
				     sha1 7637789f7f4929694aed1b89820f5bad4753e8fc \
				     rmd160 15a139f5f36993e4ed3583260e175cfb13ce7bcc \
		tetex-texmf-3.0.tar.gz md5 11aa15c8d3e28ee7815e0d5fcdf43fd4 \
				       sha1 10f7d2fa007c95ca066d899fca0e9a8446108824 \
				       rmd160 67cb6325f1edbea89c4723791116717190ec73c4 \
		ptetex3-${ptetex_version}.tar.gz md5 0be4b7f78eb993f3cb546a18633dd853 \
					  sha1 5b5c4a7bd5d55d1845109a36b7b83f7cfa70d735 \
					  rmd160 f85c397476722dff63214303a4f67394ce1b0100

default_variants	+hiragino +otf

depends_lib	lib:libX11:XFree86 lib:libgd:gd2 lib:libiconv:libiconv lib:libjpeg:jpeg \
		lib:libz:zlib lib:libpng:libpng lib:libncurses:ncurses lib:libXm:openmotif
depends_run	port:texinfo port:texi2html

extract.only	ptetex3-${ptetex_version}.tar.gz
worksrcdir	ptetex3-${ptetex_version}

patch		{
		system "echo MD5CHECK=md5check  >> ${worksrcpath}/my_option"
		system "echo SRC_DIR=${distpath} >> ${worksrcpath}/my_option"
		system "echo REAL_PREFIX=${prefix} >> ${worksrcpath}/my_option"
		system "echo REAL_DATA=${prefix}/share >> ${worksrcpath}/my_option"
		system "echo CONF_OPTION=\\\"\\\$CONF_OPTION ${configure.args}\\\" >> ${worksrcpath}/my_option"

		system "echo CPPFLAGS=\\\"-I${prefix}/include\\\" >> ${worksrcpath}/my_option"
		system "echo LDFLAGS=\\\"-L${prefix}/lib\\\" >> ${worksrcpath}/my_option"
		system "echo LD_LIBRARY_PATH=\\\"\\\$LD_LIBRARY_PATH:${prefix}/lib\\\" >> ${worksrcpath}/my_option"
		system "echo export CPPFLAGS LDFLAGS LD_LIBRARY_PATH >> ${worksrcpath}/my_option"
}

configure.args	--without-texinfo --without-texi2html --with-system-gd --with-system-zlib --with-system-pnglib --with-system-ncurses --with-xdvi-x-toolkit=motif
configure {}

build		{
		file mkdir ${workpath}/temp

		system "cd ${worksrcpath} && make PREFIX=${workpath}/temp"
		if {[variant_isset otf]} {
		   system "cd ${worksrcpath} && make PREFIX=${workpath}/temp otf"
		}
		if {[variant_isset babel]} {
		   system "cd ${worksrcpath} && make PREFIX=${workpath}/temp babel"
		}
		system "cd ${worksrcpath} && make PREFIX=${workpath}/temp fonty"
}

destroot	{
		system "cp -R ${workpath}/temp/teTeX/ ${destroot}${prefix}"

		file delete ${destroot}${prefix}/info/dir
		file delete ${destroot}${prefix}/share/info
		file rename ${destroot}${prefix}/info ${destroot}${prefix}/share/info
		file delete -force ${destroot}${prefix}/share/man
		file rename ${destroot}${prefix}/man ${destroot}${prefix}/share/man

		if {[variant_isset hiragino]} {
		   system "perl -pi -e \"s|^(KanjiMap utf-noEmbeddedFont.map)$|#\\1\\nKanjiMap utf-unicode-x.map|, s|^(KanjiMap otf-noEmbeddedFont.map)$|#\\1\\nKanjiMap otf-hiraginox.map|\" ${destroot}${prefix}/share/texmf-config/web2c/updmap.cfg"
		   system "perl -pi -e \"s|^(rml\\s.+)$|#\\1\\nrml\\tH\\tHiraMinPro-W3.otf|, s|^(rmlv\\s.+)$|#\\1\\nrmlv\\tV\\tHiraMinPro-W3.otf|, s|^(gbm\\s.+)$|#\\1\\ngbm\\tH\\tHiraKakuPro-W3.otf|, s|^(gbmv\\s.+)$|#\\1\\ngbmv\\tV\\tHiraKakuPro-W3.otf|, \" ${destroot}${prefix}/share/texmf/fonts/map/dvipdfm/cid-x.map"
		}

		# Modify mktex.opt to force use of varfonts
		reinplace "s|MT_FEATURES=appendonlydir|MT_FEATURES=appendonlydir:varfonts|g" ${destroot}${prefix}/share/texmf/web2c/mktex.opt

		# Add a directory for local enhancements
		file mkdir ${destroot}${prefix}/share/texmf-local
		system "touch ${destroot}${prefix}/share/texmf-local/.${version}"
}

post-destroot	{
		xinstall -m 755 -d ${destroot}${prefix}/share/doc/ptetex3
		foreach f {ChangeLog LICENSE README*} {
			eval xinstall -m 644 [glob ${worksrcpath}/${f}] ${destroot}${prefix}/share/doc/ptetex3
		}
}

post-activate	{
		system "ranlib ${prefix}/lib/libkpathsea.a"

		system "${prefix}/bin/fmtutil-sys --all"
		system "${prefix}/bin/mktexlsr"
		system "${prefix}/bin/updmap-sys"
}

variant hiragino {}
variant otf {}
variant babel {}

variant euc conflicts sjis {
	pre-patch { system "echo KANJI_CODE=EUC  >> ${worksrcpath}/my_option" }
}
variant sjis conflicts euc {
	pre-patch { system "echo KANJI_CODE=SJIS  >> ${worksrcpath}/my_option" }
}

variant nox11 conflicts motif xaw xaw3d nextaw {
	depends_lib-delete lib:libX11:XFree86 lib:libgd:gd2 lib:libiconv:libiconv lib:libjpeg:jpeg lib:libXm:openmotif
	# gd2 requires X11
	configure.args-delete --with-system-gd --with-xdvi-x-toolkit=motif
	configure.args-append --without-system-gd --without-x --without-xdvik
}
variant motif conflicts nox11 xaw xaw3d nextaw {}
variant xaw conflicts nox11 motif xaw3d nextaw {
	depends_lib-delete lib:libXm:openmotif
	depends_lib-append lib:libXaw:XFree86
	configure.args-delete --with-xdvi-x-toolkit=motif
	configure.args-append --with-xdvi-x-toolkit=xaw
}
variant xaw3d conflicts nox11 motif xaw nextaw {
	depends_lib-delete lib:libXm:openmotif
	depends_lib-append lib:libXaw3d:Xaw3d
	configure.args-delete --with-xdvi-x-toolkit=motif
	configure.args-append --with-xdvi-x-toolkit=xaw3d
}
variant nextaw conflicts nox11 motif xaw xaw3d {
	depends_lib-delete lib:libXm:openmotif
	depends_lib-append lib:libneXtaw:neXtaw
	configure.args-delete --with-xdvi-x-toolkit=motif
	configure.args-append --with-xdvi-x-toolkit=neXtaw
}
