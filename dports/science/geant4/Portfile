# $Id$

PortSystem          1.0

name                geant4
version             4.9.3
categories          science
maintainers         pd.infn.it:cristiano.fontana
license             Geant4
description         Geant4 is a toolkit for the simulation of the passage of particles through matter.
long_description    Geant4 is a toolkit for the simulation of the passage of particles through matter. \
		    Its areas of application include high energy, nuclear and accelerator physics, as well as studies in medical and space science. \
		    The two main reference papers for Geant4 are published in Nuclear Instruments and Methods in Physics Research A 506 (2003) 250-303, \
		    and IEEE Transactions on Nuclear Science 53 No. 1 (2006) 270-278.
homepage            http://geant4.web.cern.ch/
notes               GEANT4 needs some environment variables to run, they can be set using either ${prefix}/share/geant4/env.sh or ${prefix}/share/geant4/env.csh
platforms           darwin

# Data files versions
set G4NDL_v             3.13
set G4EMLOW_v           6.9
set PhotonEvaporation_v 2.0
set RadioactiveDecay_v  3.2
set G4ABLA_v            3.0
set RealSurface_v       1.0

distfiles           geant${version}.tar.gz \
                    G4NDL.${G4NDL_v}.tar.gz \
                    G4EMLOW.${G4EMLOW_v}.tar.gz \
                    PhotonEvaporation.${PhotonEvaporation_v}.tar.gz \
                    G4RadioactiveDecay.${RadioactiveDecay_v}.tar.gz \
                    G4ABLA.${G4ABLA_v}.tar.gz \
                    RealSurface.${RealSurface_v}.tar.gz

master_sites        http://geant4.cern.ch/support/source/

checksums           geant${version}.tar.gz \
                    md5     e2b02bac0bba8fb5a01e1caeefe86a7a \
                    sha1    9c657e90675d64993416b46dfce70710804379d4 \
                    rmd160  33f54c2dbf33a7eda1470db1a6bb44de279ac577 \
                    G4NDL.${G4NDL_v}.tar.gz \
                    md5     3aeb08f8532fc1d445b020ff9985b4e0 \
                    sha1    4acc412a2f29a7a8f84ac50aeb7331c8ed2889ae \
                    rmd160  243b206170d996c7b562a86e388ff4d5f8d11764 \
                    G4EMLOW.${G4EMLOW_v}.tar.gz \
                    md5     90af6d45b5053e9e355df38231e2060c \
                    sha1    d4d026f96990d4ed15a6b550b1990ba335248965 \
                    rmd160  8306a6af7ec41ec16790df2130b4f9b437bb7d9e \
                    PhotonEvaporation.${PhotonEvaporation_v}.tar.gz \
                    md5     097fa94e2ec361cbfe3477ed5886a423 \
                    sha1    df3b4994c7248da7a226c186be747c4b823d34fa \
                    rmd160  24d46b08b2ffeca5b3be186baffb650b99accc97 \
                    G4RadioactiveDecay.${RadioactiveDecay_v}.tar.gz \
                    md5     45e7ab756038e4ebac16f7d65e4227cc \
                    sha1    45e706e46a33e08b1706f069d15e8c2145f3410e \
                    rmd160  1f797977c0c66722f4b032ac546c26eaa8a9f14a \
                    G4ABLA.${G4ABLA_v}.tar.gz \
                    md5     d2d4e99b14f7a5057f4c10d9c2d647dd \
                    sha1    5f38676f1650a508e49d35f9405ac96984388135 \
                    rmd160  5a032ee8e90d00f39b67114fe257ec47001f347b \
                    RealSurface.${RealSurface_v}.tar.gz \
                    md5     0dde95e00fcd3bcd745804f870bb6884 \
                    sha1    9b4bd95c647dc702458eeaf89ebf62c5885e2ece \
                    rmd160  030513fe340e0cccbfe0b9ae9acb3ba6b5291ebb

worksrcdir          geant${version}/source

depends_lib         port:clhep \
                    port:openmotif \
                    port:xercesc3 \
                    port:zlib

post-patch {
    # Propagate user's flags and compiler settings
    reinplace "s/-o/\$(LDFLAGS) -o/g" ${worksrcpath}/GNUmakefile

    # Replaces g++ with standard compiler
    fs-traverse file ${workpath}/geant${version}/config {
        if {".gmk" == [file extension ${file}]} {
            reinplace "s:g++:${configure.cxx}:g" ${file}
            reinplace "s:gfortran:${configure.fc}:g" ${file}
        }
    }

    # Fix an error message in build phase (I hope that it will not cause any problems)
    reinplace "s:LDFLAGS += -bind_at_load -arch_multiple:LDFLAGS += -bind_at_load:g" ${workpath}/geant${version}/config/sys/Darwin-g++.gmk

    # Forces build phase to lookf for Darwin-g++.gmk and not $(G4SYSTEM).gmk
    reinplace "s:\$(G4SYSTEM).gmk:Darwin-g++.gmk:g" ${workpath}/geant${version}/config/architecture.gmk
    reinplace "s:\$(G4SYSTEM).gmk:Darwin-g++.gmk:g" ${workpath}/geant${version}/config/common.gmk
    reinplace "s:\$(G4SYSTEM).gmk:Darwin-g++.gmk:g" ${workpath}/geant${version}/examples/extended/eventgenerator/HepMC/HepMCEx01/external/GNUmakefile

    # Copies some files to fix them
    foreach file [list ${filespath}/env.sh ${filespath}/env.csh] {
        file copy ${file} ${worksrcpath}
    }

    # Fixes some paths
    foreach file [list ${worksrcpath}/env.sh ${worksrcpath}/env.csh] {
        reinplace "s:@PREFIX@:${prefix}:g" ${file}
        reinplace "s:@WORKSRCPATH@:${worksrcpath}:g" ${file}
        reinplace "s:@DESTROOT@:${destroot}:g" ${file}
        reinplace "s:@VERSION@:${version}:g" ${file}

        reinplace "s:@G4NDL_V@:${G4NDL_v}:g" ${file}
        reinplace "s:@G4EMLOW_V@:${G4EMLOW_v}:g" ${file}
        reinplace "s:@PHOTONEVAPORATION_V@:${PhotonEvaporation_v}:g" ${file}
        reinplace "s:@RADIOACTIVEDECAY_V@:${RadioactiveDecay_v}:g" ${file}
        reinplace "s:@G4ABLA_V@:${G4ABLA_v}:g" ${file}
        reinplace "s:@REALSURFACE_V@:${RealSurface_v}:g" ${file}
    }
}

use_configure       no

build.env           G4SYSTEM=${version}
build.env-append    G4INSTALL=${workpath}/geant${version}
#G4INCLUDE=
build.env-append    G4TMP=\$G4INSTALL/tmp
build.env-append    G4LIB=${workpath}/geant${version}/lib
build.env-append    G4BIN=${workpath}/geant${version}/bin

build.env-append    G4LEVELGAMMADATA=${prefix}/share/geant4/data/PhotonEvaporation${PhotonEvaporation_v}
build.env-append    G4RADIOACTIVEDATA=${prefix}/share/geant4/data/RadioactiveDecay${RadioactiveDecay_v}
build.env-append    G4LEDATA=${prefix}/share/geant4/data/G4EMLOW${G4EMLOW_v}
build.env-append    G4NEUTRONHPDATA=${prefix}/share/geant4/data/G4NDL${G4NDL_v}
build.env-append    G4ABLADATA=${prefix}/share/geant4/data/G4ABLA${G4ABLA_v}
#G4ELASTICDATA=

build.env-append    CLHEP_BASE_DIR=${prefix}
build.env-append    CLHEP_INCLUDE_DIR=${prefix}/include
build.env-append    CLHEP_LIB_DIR=${prefix}/lib
build.env-append    CLHEP_LIB=CLHEP

#build.env-append    G4DEBUG=1

#build.env-append    G4UI_NONE=1 # Sets no user interface
#build.env-append    G4UI_BUILD_XAW_SESSION=1 # Uses Xaw
#build.env-append    G4UI_USE_XAW=1
build.env-append    G4UI_BUILD_XM_SESSION=1 #Uses Motif
build.env-append    G4UI_USE_XM=1
#build.env-append    G4UI_BUILD_QT_SESSION=1 #Uses Qt
#build.env-append    G4UI_USE_QT=1
# END OF G4UI_NONE block

#build.env-append    G4VIS_NONE=1 #Sets no viasualizzation driver
#build.env-append    G4VIS_BUILD_DAWN_DRIVER=1 #Uses DAWN
build.env-append    G4VIS_BUILD_OPENGLX_DRIVER=1 #Uses OpenGLX
build.env-append    G4VIS_BUILD_OPENGLXM_DRIVER=1
#build.env-append    G4VIS_BUILD_OIX_DRIVER=1
#build.env-append    G4VIS_BUILD_RAYTRACERX_DRIVER=1
#build.env-append    G4VIS_BUILD_VRML_DRIVER=1
#build.env-append    G4VIS_BUILD_OPENGLQT_DRIVER=1
#build.env-append    G4VIS_USE_DAWN=1
build.env-append    G4VIS_USE_OPENGLX=1
build.env-append    G4VIS_USE_OPENGLXM=1 #Uses OpenGLX with Motif
#build.env-append    G4VIS_USE_OIX=1
#build.env-append    G4VIS_USE_RAYTRACERX=1
#build.env-append    G4VIS_USE_VRML=1
#build.env-append    G4VIS_USE_OPENGLQT=1
# End of G4VIS_NONE block

#build.env-append    OGLHOME=
#build.env-append    OIVHOME=

build.env-append    XMFLAGS= -I${prefix}/include
build.env-append    XMLIBS= -L${prefix}/lib -lXm -lXpm
#build.env-append    XMFLAGS= -I${prefix}/include
#build.env-append    XMLIBS= -L${prefix}/lib -lXm -lXpm
#build.env-append    XAWFLAGS=
#build.env-append    XAWLIBS=
#build.env-append    QTFLAGS=
#build.env-append    QTLIBS=
#build.env-append    QTMOC=

build.env-append    G4LIB_BUILD_GDML=1 # Use GDML for detector construction
build.env-append    XERCESCROOT=${prefix}

#build.env-append    G4LIB_BUILD_G3TOG4=1
#build.env-append    G4LIB_USE_G3TOG4=1

#build.env-append    G4LIB_BUILD_ZLIB=1
#build.env-append    G4LIB_USE_ZLIB=1

build.env-append    G4LIB_BUILD_SHARED=1
#build.env-append    G4LIB_BUILD_STATIC=1
build.env-append    G4LIB_USE_GRANULAR=1

#pre-build {
    #system "/usr/bin/make -n -p -f \$G4INSTALL/config/scripts/GNUmakefile > \$G4LIB/\$G4SYSTEM/GNUmakefile.db"
#}

build.args
build.target

post-build {
    system "cd ${worksrcpath} && make includes"
}

destroot {
    puts "Installing env scripts to ${prefix}/share/geant4/"

    xinstall -d ${destroot}${prefix}/share/geant4/

    xinstall -m 755 -W ${worksrcpath} env.sh ${destroot}${prefix}/share/geant4/
    xinstall -m 755 -W ${worksrcpath} env.csh ${destroot}${prefix}/share/geant4/

    puts "Installing GEANT4 data to ${prefix}/share/geant4/data"

    xinstall -d ${destroot}${prefix}/share/geant4/data

    foreach data [list G4NDL${G4NDL_v} G4EMLOW${G4EMLOW_v} PhotonEvaporation${PhotonEvaporation_v} RadioactiveDecay${RadioactiveDecay_v} G4ABLA${G4ABLA_v} RealSurface${RealSurface_v}] {
        puts "-> Installing ${data} to ${prefix}/share/geant4/data"
        file copy ${workpath}/${data} ${destroot}${prefix}/share/geant4/data
    }

    puts "Installing sources to ${prefix}/src/geant4/${version}"

    xinstall -d ${destroot}${prefix}/src/geant4/${version}

    foreach sources {config source environments examples} {
        puts "-> Installing ${sources} to ${prefix}/src/geant4/${version}"
        file copy ${workpath}/geant${version}/${sources} ${destroot}${prefix}/src/geant4/${version}
    }

    puts "Installing headers to ${prefix}/include/"

    fs-traverse file ${workpath}/geant${version}/include/ {
        file copy ${file} ${destroot}${prefix}/include/
    }

    puts "Installing libs to ${prefix}/lib/geant4/${version}"

    xinstall -d ${destroot}${prefix}/lib/geant4/

    file copy ${workpath}/geant${version}/lib/${version}/ ${destroot}${prefix}/lib/geant4/

    puts "Installing executables to ${prefix}/bin"

    fs-traverse file ${workpath}/geant${version}/bin/ {
        file copy ${file} ${destroot}${prefix}/bin/
    }
}
