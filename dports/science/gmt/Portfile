# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem                  1.0

name                        gmt
version                     4.5.3
categories                  science
maintainers                 takeshi
license                     GPLv2
description                 the generic mapping tools
long_description an open source collection of ~60 tools         \
    for manipulating geographic and Cartesian data sets and     \
    producing Encapsulated PostScript File (EPS) illustrations  \
    ranging from simple x-y plots via contour maps to           \
    artificially illuminated surfaces and 3-D perspective views.
homepage                    http://gmt.soest.hawaii.edu/
platforms                   darwin
master_sites                ftp://ftp.soest.hawaii.edu/gmt          \
                            ftp://ibis.grdl.noaa.gov/pub/gmt        \
                            ftp://ftp.iris.washington.edu/pub/gmt   \
                            ftp://ftp.iag.usp.br/pub/gmt            \
                            ftp://ftp.geologi.uio.no/pub/gmt        \
                            ftp://gd.tuwien.ac.at/pub/gmt           \
                            ftp://ftp.scc.u-tokai.ac.jp/pub/gmt     \
                            ftp://mirror.geosci.usyd.edu.au/pub/gmt \
                            ftp://gmt.mirror.ac.za/pub/gmt
use_bzip2                   yes
set gshhsversion            2.1.0
set gmtsrc                  GMT${version}_src.tar.bz2
set gmtshare                GMT${version}_share.tar.bz2
set gmtsuppl                GMT${version}_suppl.tar.bz2
set gshhslow                GSHHS${gshhsversion}_coast.tar.bz2
distfiles                   ${gmtsrc} ${gmtshare} ${gmtsuppl} ${gshhslow}
checksums           ${gmtsrc} \
                    md5     ad069cfcc8216fdef69e0cb94536c2a6 \
                    sha1    b801316b08339d572905487cdb0d66b8236b7ecf \
                    rmd160  43a015ba87817f7540d3fb34c2cd676d7bfc5ff5 \
                    ${gmtshare} \
                    md5     378ea1b0e46b09455722df81c4c191ab \
                    sha1    a77559af20edea3a79f7a636671539e3040a5aea \
                    rmd160  a664bee612593cfe0488348fd589a69574909756 \
                    ${gmtsuppl} \
                    md5     7d4bcb2ac56ee558cae8446363a74e64 \
                    sha1    c9feaa2f63052ec3ccbf125f5439e8f315d72f37 \
                    rmd160  dc5b1122c8725017af3aba154330a6094d46ccd5 \
                    ${gshhslow} \
                    md5     1f84a99effe96e12fb60f31fa3cf35bb \
                    sha1    507dee527314e003039722e389052d2705f849d9 \
                    rmd160  eba4e7d1795092dc7508309f4e1b0f9c88c26b42

worksrcdir                  GMT${version}

depends_lib                 port:netcdf

configure.args              --mandir=${prefix}/share/man \
                            --datadir=${prefix}/share/${name} \
                            --enable-netcdf=${prefix} \
                            --enable-shared \
                            --disable-xgrid \
                            --disable-rpath
configure.cflags-append     -std=c99
use_parallel_build          no
destroot.target             install-all
destroot.destdir            prefix=${destroot}${prefix}
configure.ldflags-delete    -L${prefix}/lib
pre-configure {
    reinplace "s|-flat_namespace -undefined suppress||" ${worksrcpath}/configure
}

post-destroot {
    xinstall -m 755 -d ${destroot}${prefix}/share/${name}
    eval xinstall -m 644 [glob ${workpath}/share/coast/*] \
    ${destroot}${prefix}/share/${name}
}

if {[variant_isset universal]} {
    configure.universal_args-delete --disable-dependency-tracking
    patch {
        reinplace "s|\$(AR) cvur \$@ \$?|if \[ -f \$@ \]; then \$(RM) \$@; fi;\$(AR) cvur \$@ \$?|" ${worksrcpath}/src/Makefile
        reinplace "s|-dynamiclib|-dynamiclib ${configure.universal_ldflags}|" ${worksrcpath}/configure
    }
} else {
    patch {
        reinplace "s|-dynamiclib|-dynamiclib ${configure.cc_archflags}|" ${worksrcpath}/configure
    }
    configure.ldflags-append    ${configure.cc_archflags}
}

variant gshhs description {installs high and full resolution GSHHS coast line data} {
    set gshhshigh GSHHS${gshhsversion}_high.tar.bz2
    set gshhsfull GSHHS${gshhsversion}_full.tar.bz2
    distfiles-append        ${gshhshigh} ${gshhsfull}
    checksums-append \
                    ${gshhshigh} \
                    md5     51128a3c545fd48364a2da830ebce1b6 \
                    sha1    a1f8ac81195b3dd45a145ec0b3f58398be0659d0 \
                    rmd160  94da01ab434eb9693c5b4a308fe2e29bc3f6d824 \
                    ${gshhsfull} \
                    md5     da679a412056e401bb624a213d4b11d6 \
                    sha1    bda0300d59ef082c19fda0563899adb42113e2bf \
                    rmd160  702a17c7542c075878af8a0b83c03a91afae118d
}

variant doc description {installs documentation, examples and tutorial} {
    set gmtdoc GMT${version}_doc.tar.bz2
    distfiles-append        ${gmtdoc}
    checksums-append        ${gmtdoc} \
                    md5     a2f0243bbbea4c6e1472a1d92a2c6d7c \
                    sha1    b573b26a0f6b46758ba5e84ad7c6274f91c0457c \
                    rmd160  c14aa0092060510b597bff0c277b8c12cdb210bd
}

variant octave description {compiles Octave interface} {
    depends_lib-append port:octave
    configure.args-append --enable-octave
    configure.args-delete --disable-mex
}

variant triangle description {use J. Shewchuk's fast, non-GPL triangulation routine} {
    set gmttri GMT${version}_triangle.tar.bz2
    distfiles-append        ${gmttri}
    checksums-append        ${gmttri} \
                    md5     5bccc9d473fc2a659cb21d3aafd8b228 \
                    sha1    451d8e2d09673dd72dfb249ca3630c5989256475 \
                    rmd160  7359ece268bdd3e48214bda9d840659980e4c1ea

    configure.args-append   --enable-triangle
}

livecheck.type              regex
livecheck.url               http://gmt.soest.hawaii.edu/gmt/gmt_home.html
livecheck.regex             {Current version is ([0-9]+.[0-9]+.[0-9]+.)}
