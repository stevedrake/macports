# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

name                gwyddion
version             2.17
categories          science x11
platforms           darwin
revison             1
maintainers         rowue gwyddion.net:yeti
description         Software for SPM Analysis

long_description \
    Gwyddion is a modular program for SPM (scanning probe microscopy) data \
    visualization and analysis. It uses gtk2 for the user interface.

homepage            http://gwyddion.net
master_sites        sourceforge
use_bzip2           yes
use_parallel_build  yes

checksums           md5     2c60d97c941e415ab193e45e0590cdd0 \
                    sha1    2d957fee47a42b9f6afcb33dd780d4f8fa544130 \
                    rmd160  c9345e38e7f64d9aac93a39c6c09e71e261af8e9

depends_lib         port:gtk2 \
                    port:libxml2 \
                    port:fftw-3 \
                    port:gtkglext

configure.args      --disable-desktop-file-update \
                    --x-include=${prefix}/include \
                    --x-lib=${prefix}/lib

patchfiles          patch-app-Makefile.am.diff \
                    patch-app-mac_integration.c.diff \
                    patch-configure.ac.diff \
                    patch-configure.diff \
                    app-ige-mag-menu.c.diff

variant no_x11 description { Build gwyddion with quartz gl support} {
    patchfiles-delete   patch-app-Makefile.am.diff \
                        patch-app-mac_integration.c.diff \
                        patch-configure.ac.diff \
                        patch-configure.diff \
                        app-ige-mag-menu.c.diff

    patchfiles-append   patch-libgwydgets-gwy3dview.c.diff

}


post-destroot {
    xinstall -m 755 -d ${destroot}${applications_dir}/gwyddion.app/Contents/MacOS
    if {[variant_isset no_x11]} {
        xinstall ${filespath}/gwyddion.quartz ${destroot}${applications_dir}/gwyddion.app/Contents/MacOS/gwyddion
        reinplace "s|@PREFIX@|${prefix}|" ${destroot}${applications_dir}/gwyddion.app/Contents/MacOS/gwyddion
    } else {
        xinstall ${filespath}/gwyddion ${destroot}${applications_dir}/gwyddion.app/Contents/MacOS
        reinplace "s|@APPDIR@|${applications_dir}|" ${destroot}${applications_dir}/gwyddion.app/Contents/MacOS/gwyddion
        reinplace "s|@PREFIX@|${prefix}|" ${destroot}${applications_dir}/gwyddion.app/Contents/MacOS/gwyddion
    }
    xinstall -m 755 -d ${destroot}${applications_dir}/gwyddion.app/Contents/Resources
    xinstall -m 0644 ${filespath}/gwyddion.icns ${destroot}${applications_dir}/gwyddion.app/Contents/Resources
    xinstall -m 0644 ${filespath}/Info.plist ${destroot}${applications_dir}/gwyddion.app/Contents/
    reinplace "s|@VERSION@|${version}|" ${destroot}${applications_dir}/gwyddion.app/Contents/Info.plist
    system "echo 'APPL????' > ${destroot}${applications_dir}/gwyddion.app/Contents/PkgInfo"
}

post-activate {
        system "${prefix}/bin/update-mime-database ${prefix}/share/mime ; true"
}

platform darwin 8 {
	post-activate {
		if {[file exists ${prefix}/lib/pkgconfig/gl.pc]} {
            if {![variant_isset no_x11]} {
			    ui_msg "openGL support currently requires you to use MacPorts' X11 server (xorg-server) rather than Apple's."
            }
		}
	}
}
