# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

name                hdf4
version             4.2.5
platforms           darwin
categories          science
maintainers         takeshi

description         file format for storing scientific data and utilities
long_description    ${description}
homepage            http://www.hdfgroup.org/products/hdf4/index.html
master_sites        ftp://ftp.hdfgroup.org/HDF/HDF_Current/src/:hdf \
                    http://www.hdfgroup.org/ftp/HDF/HDF_Current/src/:hdf \
                    http://www.hdfgroup.org/ftp/lib-external/jpeg/src/:jpeg \
                    ftp://ftp.hdfgroup.org/lib-external/jpeg/src/:jpeg
distname            hdf-$version
set hdfsrc ${distname}${extract.suffix}
set jpgsrc jpegsrc.v6b${extract.suffix}
distfiles           ${hdfsrc}:hdf \
                    ${jpgsrc}:jpeg
checksums           ${hdfsrc} md5     7241a34b722d29d8561da0947c06069f \
                    ${hdfsrc} sha1    7a9bb3f5d28ed889d7bff2f34389d00be8af5d21 \
                    ${hdfsrc} rmd160  e0756ea157c26832b4bd46b083e5cd8e8ea3ba59 \
                    ${jpgsrc} md5     83992a9466af7536da30efe6b51d4064 \
                    ${jpgsrc} sha1    fdca7f17a20ebefec2c7837916fc1daa90e83332 \
                    ${jpgsrc} rmd160  9be6f07bbd052f3de5a80a25584e74dcb6dce6cf

depends_lib         port:zlib port:szip

set jpgdir ${workpath}/jpeg-6b
configure.args       --with-szlib=${prefix} --disable-netcdf --disable-fortran \
                     --with-jpeg=${jpgdir},${jpgdir}
configure.cppflags-delete   -I${prefix}/include
configure.ldflags-delete    -L${prefix}/lib

test.run            yes
test.target         check

if {[variant_isset universal]} {
  set copts "${configure.cflags} ${configure.universal_cflags}"
  set ldopts ${configure.universal_ldflags}
} else {
  set copts "${configure.cflags} ${configure.cc_archflags}"
  set ldopts ${configure.cc_archflags}
}
pre-configure {
    system " \
      export CC=${configure.cc}; \
      export CPPFLAGS=\"\"; \
      export CFLAGS=\"${copts}\"; \
      export LDFLAGS=\"${ldopts}\"; \
      cd ${jpgdir}; \
      ./configure --prefix=${prefix}; \
      make libjpeg.a"
}

post-destroot {
	file mkdir ${destroot}${prefix}/share/doc/${name}
	file copy ${worksrcpath}/hdf/util/testfiles ${destroot}${prefix}/share/doc/${name}/samples
	foreach f {COPYING release_notes/HISTORY.txt release_notes/RELEASE.txt} {
		file copy ${worksrcpath}/$f ${destroot}${prefix}/share/doc/${name}/
	}
	foreach f {bin/ncdump bin/ncgen lib/libudport.a                   \
             include/netcdf.h include/netcdf.inc include/netcdf.f90 \
             share/man/man1/ncgen.1 share/man/man1/ncdump.1} {
		file delete ${destroot}${prefix}/$f
	}
    xinstall -d -m 755 ${destroot}${prefix}/lib/${name}
    xinstall -d -m 755 ${destroot}${prefix}/lib/${name}/include
    xinstall -d -m 755 ${destroot}${prefix}/lib/${name}/lib
    foreach f "${jpgdir}/jconfig.h ${jpgdir}/jerror.h \
               ${jpgdir}/jmorecfg.h ${jpgdir}/jpeglib.h" {
        xinstall -m 644 ${f} ${destroot}${prefix}/lib/${name}/include
    }
    xinstall -m 644 ${jpgdir}/libjpeg.a ${destroot}${prefix}/lib/${name}/lib
    ui_msg "jpeg-6b required by hdf4 is to be installed in ${prefix}/lib/${name}"
}

variant g95 conflicts gcc43 conflicts universal description {build with g95} {
  configure.args-delete	--disable-fortran
  depends_build-append  port:g95
	configure.env-append  F77=${prefix}/bin/g95
}

variant gcc43 conflicts g95 conflicts universal description {build with gfortran} {
  configure.args-delete	--disable-fortran
  depends_build-append port:gcc43
	configure.env-append F77=${prefix}/bin/gfortran-mp-4.3
}

livecheck.type   regex
livecheck.url    ${homepage}
livecheck.regex  {The latest Official Release of HDF is ([0-9]+\.[0-9]+r[0-9]+)}
