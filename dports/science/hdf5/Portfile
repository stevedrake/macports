# -*- coding: utf-8; mode: tcl; c-basic-offset: 4; indent-tabs-mode: nil; tab-width: 4; truncate-lines: t -*- vim:fenc=utf-8:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

# This Portfile still follows 1.6.x, in the spirit of 1.8 not being ready for production.
# We should provide a hdf5-devel port for 1.8 at this time, I guess.
name                hdf5
version             1.6.7
revision            6
categories          science
maintainers         openmaintainer jochen

description         HDF5 general purpose library and file format for storing scientific data
long_description    ${description}
homepage            http://www.hdfgroup.org/HDF5/
platforms           darwin
master_sites        ftp://ftp.hdfgroup.org/HDF5/current16/src/
checksums           md5 79027c67188e2e4131c5573771f477ce \
                    sha1 9c26fe09cdad269c9a6757933f70ca164a47b8e8 \
                    rmd160 2dbbcccd32986dcd66ce804c5e90ac6c949b71f6

depends_lib         port:zlib
patchfiles          patch-gnu-flags.diff \
                    patch-commence.diff patch-c-commence.diff \
                    patch-fortran-commence.diff patch-H5f90i.diff \
                    patch-H5PropList.cpp.diff

use_parallel_build  yes
configure.args      --enable-cxx --with-zlib=yes --with-szlib=no
configure.ldflags   -L${worksrcpath}/src/.libs -L${prefix}/lib
destroot.destdir    prefix=${destroot}${prefix}
test.run            yes
test.target         check


variant fortran description {Include the Fortran interface} {
    if { [variant_isset gcc43] || [variant_isset gcc42] || [variant_isset g95] } {
        configure.args-delete   --disable-fortran
        configure.args-append   --enable-fortran
    } else {
        error "You must specify a compiler variant in order to build the Fortran interface"
    }
}

variant szip description {Enable szip compression support} {
    configure.args-delete       --with-szlib=no
    configure.args-append       --with-szlib=yes
    depends_lib-append          port:szip
}

variant threadsafe description {Enable threadsafety (experimental, fails unit-tests)} {
    configure.args-delete       --disable-threadsafe
    configure.args-append       --enable-threadsafe
}


variant gcc42 conflicts g95 gcc43 description {Compile using GCC 4.2} {
    depends_lib-append          port:gcc42
    configure.compiler          macports-gcc-4.2
}

variant gcc43 conflicts g95 gcc42 description {Compile using GCC 4.3} {
    depends_lib-append          port:gcc43
    configure.compiler          macports-gcc-4.3
}

variant g95 requires fortran conflicts gcc42 gcc43 description {Use g95 Fortran compiler} {
    depends_lib-append          port:g95
    patchfiles-append           patch-powerpc-apple.diff
    configure.fc                ${prefix}/bin/g95
    configure.fflags            -fno-second-underscore
}

variant optimized description {Higher compiler optimization for host machine (esp. for gcc43)} {
    if { [variant_isset gcc43] } {
        configure.cflags-delete     -O2
        configure.cxxflags-delete   -O2
        configure.fflags-delete     -O2
        configure.cflags-append     -ftree-vectorize -march=native -O3
        configure.cxxflags-append   -ftree-vectorize -march=native -O3
        configure.fflags-append     -ftree-vectorize -march=native -O3
    } else {
        configure.cflags-delete     -O2
        configure.cxxflags-delete   -O2
        configure.fflags-delete     -O2
        configure.cflags-append     -ftree-vectorize -O3
        configure.cxxflags-append   -ftree-vectorize -O3
        configure.fflags-append     -ftree-vectorize -O3
    }
}
