# $Id: Portfile 45104 2009-01-08 14:36:55Z narf_tm@macports.org $

PortSystem            1.0
name									backuppc
version								3.1.0
maintainers           jameskyle
description           BackupPC is a high-performance, enterprise-grade system for backing up Linux, WinXX and MacOSX PCs and laptops to a server's disk.
long_description      ${description} BackupPC is highly configurable and easy to install and maintain.

platforms             darwin

master_sites					sourceforge:${name}

depends_lib						port:perl5.8 \
											port:p5-compress-zlib \
											port:p5-archive-zip \
											port:p5-file-rsyncp \
											port:samba3 \
											port:gnutar \
											port:mod_perl2 \
											port:rsync
											
distfiles							BackupPC-${version}.tar.gz
checksums           	md5     84b4471852ef910768eae9963ef932d2 \
                    	sha1    3bd6d637f4f08f2fda44a12668b91d47c4abb0a7 \
                    	rmd160  22d4cb6dd76f846fde489a301852f50e8db1ae1d

configure.args				--batch \
											--backuppc-user=backuppc \
											--cgi-dir ${prefix}/apache2/cgi-bin \
											--data-dir ${prefix}/var/backups \
											--dest-dir ${destroot}${prefix} \
											--html-dir ${prefix}/apache2/htdocs/backuppc \
											--html-dir-url /backuppc \
											--install-dir ${prefix}/BackupPC											

pre-configure {

  set hostname [exec "hostname"]
  ui_debug  "Hostname: ${hostname}"
  configure.args-append --hostname ${hostname}

}

configure {
  if {[existsgroup "backuppc"]} {
    ui_debug "Found backuppc group."
  } else {
    ui_debug "Could not find backuppc group."
    ui_debug "Creating backuppc group."
    set gid [nextgid]
    ui_debug "gid: $gid"
    if {[catch {addgroup "backuppc" gid=${gid}}]} {
      return -code error "Failed to create backuppc group"
    }
  }
  
  ui_debug "Checking for backuppc user"
  if { [existsuser "backuppc"] } {
    ui_debug "Found backuppc user."
  } else {
    ui_debug "Could not find backuppc user."
    ui_debug "Creating backuppc user."
    set uid [nextuid]
    ui_debug "uid: $uid" 
    if {[catch {adduser "backuppc" uid=${uid} gid=[existsgroup backuppc]}]} {
      return -code error "Failed to create backuppc user"
    }
  }
}