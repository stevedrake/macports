# $Id: Portfile 45104 2009-01-08 14:36:55Z narf_tm@macports.org $

PortSystem            1.0
name									backuppc
categories            sysutils
version								3.1.0
maintainers           jameskyle
description           BackupPC is a high-performance, enterprise-grade system for backing up Linux, WinXX and MacOSX PCs and laptops to a server's disk.
long_description      ${description} BackupPC is highly configurable and easy to install and maintain.

platforms             darwin

master_sites					sourceforge:${name}

depends_lib						port:perl5.8 \
											port:p5-compress-zlib \
											port:p5-archive-zip \
											port:p5-file-rsyncp \
											port:samba3 \
											port:gnutar \
											port:mod_perl2 \
											port:rsync \
											port:openssh
											
distfiles							BackupPC-${version}.tar.gz
checksums           	md5     84b4471852ef910768eae9963ef932d2 \
                    	sha1    3bd6d637f4f08f2fda44a12668b91d47c4abb0a7 \
                    	rmd160  22d4cb6dd76f846fde489a301852f50e8db1ae1d

configure.args				--batch \
											--backuppc-user=backuppc \
											--cgi-dir ${prefix}/apache2/cgi-bin \
											--data-dir ${prefix}/var/backups \
											--dest-dir ${destroot} \
											--html-dir ${prefix}/apache2/htdocs/backuppc \
											--html-dir-url /backuppc \
											--install-dir ${prefix}	\
											--config-dir ${prefix}/etc/BackupPC										

worksrcdir            BackupPC-${version}
destroot.violate_mtree yes

pre-configure {

  set hostname [exec "hostname"]
  ui_debug  "Hostname: ${hostname}"
  configure.args-append --hostname ${hostname}

}

configure {
  if {[existsgroup "backuppc"]} {
    ui_debug "Found backuppc group."
  } else {
    ui_debug "Could not find backuppc group."
    ui_debug "Creating backuppc group."
    set gid [nextgid]
    ui_debug "gid: $gid"
    if {[catch {addgroup "backuppc" gid=${gid}}]} {
      return -code error "Failed to create backuppc group"
    }
  }
  
  ui_debug "Checking for backuppc user"
  if { [existsuser "backuppc"] } {
    ui_debug "Found backuppc user."
  } else {
    ui_debug "Could not find backuppc user."
    ui_debug "Creating backuppc user."
    set uid [nextuid]
    ui_debug "uid: $uid" 
    if {[catch {adduser "backuppc" uid=${uid} gid=[existsgroup backuppc]}]} {
      return -code error "Failed to create backuppc user"
    }
  }
}

build {}

destroot {
    system "cd ${worksrcpath} && ${prefix}/bin/perl5.8 configure.pl ${configure.args}"
    xinstall -d -m 755 ${destroot}${prefix}/share/doc/
    move ${destroot}${prefix}/doc ${destroot}${prefix}/share/doc/BackupPC
    
    # install the launch scripts
    xinstall -d -m 755 ${destroot}${prefix}/Library/LaunchDaemons
    
    xinstall ${filespath}/net.sourceforge.backuppc.plist ${destroot}${prefix}/Library/LaunchDaemons/
     reinplace "s|@@PREFIX@@|${prefix}|g" ${destroot}${prefix}/Library/LaunchDaemons/net.sourceforge.backuppc.plist
  
}

# post-activate {
#   set finish_message "There are several more things you
#   will need to do:
# 
#     - Browse through the config file, ${prefix}/etc/BackupPC/config.pl,
#       and make sure all the settings are correct.  In particular,
#       you will need to set \$Conf{CgiAdminUsers} so you have
#       administration privileges in the CGI interface.
# 
#     - Edit the list of hosts to backup in ${prefix}/etc/BackupPC/hosts.
# 
#     - Read the documentation in ${prefix}/share/doc/BackupPC/BackupPC.html.
#       Please pay special attention to the security section.
# 
#     - Verify that the CGI script BackupPC_Admin runs correctly.  You might
#       need to change the permissions or group ownership of BackupPC_Admin.
#       If this is an upgrade and you are using mod_perl, you will need
#       to restart Apache.  Otherwise it will have stale code.
# 
#     - BackupPC should be ready to start.  Don't forget to run it
#       as user backuppc!  The installation also contains an
#       /Library/LaunchDaemons/net.sourceforge.backuppc.plist launchd
#       so that BackupPC can auto-start on boot. To enable this daemon 
#       execute the following command:
#       cd /Library/LaunchDaemons
#       sudo launchctl load net.sourceforge.backuppc.plist
#       
#     - The data directory is set to ${prefix}/var/backups. Please ensure
#       You have enough space for your backups at this location. You may 
#       wish to create a custom mount point point for you backup volume
#       if necessary.
#       
#     - To hide the backuppc user in the login window, you may execute
#       
#       defaults write /Library/Preferences/com.apple.loginwindow
#   "
# 
#   ui_msg ${finish_message}
#   
# }
