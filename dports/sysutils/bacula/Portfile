# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem 1.0

name             bacula
version          2.4.2
revision         1
categories       sysutils
platforms        darwin
maintainers      macsforever2000

description      network based backup program
long_description Bacula is a set of computer programs that permit you to \
                 manage backup, recovery, and verification of computer data across \
                 a network of computers of different kinds.

homepage         http://www.bacula.org/
master_sites     sourceforge
checksums        md5    3ba8700b8274223f803ad49418568c2a \
                 sha1   226c3c77935d2294e0dcd29d2583d93f666cf7b8 \
                 rmd160 6164deafe144b1f4dff9493671e387f8f12f0d70

depends_build    port:gawk
depends_lib      port:zlib port:openssl port:libiconv port:gettext port:ncurses

patchfiles       patch-configure.diff

post-patch {
                 reinplace "s|@@PREFIX@@|${prefix}|g" ${worksrcpath}/configure
}

configure.args   --mandir=${prefix}/share/man \
                 --datarootdir=${prefix}/share \
                 --with-pid-dir=${prefix}/var/run \
                 --with-subsys-dir=${prefix}/var/run/subsys \
                 --sysconfdir=${prefix}/etc/${name} \
                 --with-libintl-prefix=${prefix} \
                 --with-openssl=${prefix} \
                 --with-libiconv-prefix=${prefix} \
                 --with-readline=${prefix} \
                 --with-archivedir=/var/tmp \
                 --with-included-gettext=${prefix} \
                 --enable-smartalloc \
                 --enable-largefile \
                 --without-sqlite \
                 --without-sqlite3 \
                 --without-postgresql \
                 --without-mysql \
                 --disable-gnome \
                 --disable-wx-console \
                 --enable-tray-monitor
configure.cppflags-append   -I${prefix}/ncurses
configure.ldflags           ""

destroot.keepdirs   ${destroot}${prefix}/var/run/subsys \
                    ${destroot}${prefix}/var/bacula/working

startupitem.create  yes
startupitem.init    \
"BIN=${prefix}/sbin/bacula-fd\nPID=${prefix}/var/run/bacula-fd.*.pid"
startupitem.start   \
"\[ -x \${BIN} \] && \${BIN} -c ${prefix}/etc/bacula/bacula-fd.conf"
startupitem.stop    \
"\[ -r \${PID} \] && /bin/kill \$(cat \${PID})"

variant client_only conflicts mysql4 mysql5 postgresql83 sqlite2 sqlite3 description "Install bacula client (bacula-fd) only" {
  configure.args-append --enable-client-only
}

variant mysql4 conflicts client_only mysql5 postgresql83 sqlite2 sqlite3 description "Install bacula client and server with mysql 4 backend" {
  depends_lib-append    port:mysql4
  configure.args-append --with-mysql
  configure.args-delete --without-mysql
}

variant mysql5 conflicts client_only mysql4 postgresql83 sqlite2 sqlite3 description "Install bacula client and server with mysql 5 backend" {
  depends_lib-append    port:mysql5
  configure.args-append --with-mysql
  configure.args-delete --without-mysql
}

variant postgresql83 conflicts mysql4 mysql5 sqlite2 sqlite3 client_only description "Install bacula client and server with postgresql 8.3 backend" {
  depends_lib-append    port:postgresql83
  configure.args-append --with-postgresql
  configure.args-delete --without-postgresql
  configure.env-append PATH=${prefix}/lib/postgresql83/bin:$env(PATH)
}

variant sqlite2 conflicts client_only sqlite3 mysql4 mysql5 postgresql83 description "Install bacula client and server with sqlite 2 backend" {
  depends_lib-append    port:sqlite2
  configure.args-append --with-sqlite=${prefix}
  configure.args-delete --without-sqlite
}

variant sqlite3 conflicts client_only sqlite2 mysql4 mysql5 postgresql83 description "Install bacula client and server with sqlite 3 backend" {
  depends_lib-append    port:sqlite3
  configure.args-append --with-sqlite3=${prefix}
  configure.args-delete --without-sqlite3
}

if {![variant_isset mysql4] && ![variant_isset mysql5] && ![variant_isset postgresql83] && ![variant_isset sqlite2] && ![variant_isset sqlite3]} {
  default_variants +client_only
}
