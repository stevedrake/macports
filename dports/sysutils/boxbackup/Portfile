# $Id: Portfile,v 1.3 2005/01/19 03:20:48 rshaw Exp $
PortSystem		1.0

name			boxbackup
version			0.09
revision		1
categories		sysutils net
maintainers		rshaw@opendarwin.org
description		completely automatic on-line backup system for UNIX.
long_description	The backup daemon, bbackupd, runs on all machines to \
					be backed up. The store server daemon, bbstored runs \
					on a central server. Data is sent to the store \
					server, which stores all data on local filesystems, \
					that is, only on local hard drives. Tape or other \
					archive media is not used. \
					The system is designed to be easy to set up and run, \
					and cheap to use. Once set up, there should be no \
					need for user or administrative intervention, apart \
					from usual system maintenance.
homepage		http://www.fluffy.co.uk/boxbackup/
master_sites	sourceforge
extract.suffix	.tgz
checksums		md5 b4fced539ed72855383f25609de9e6da

depends_lib		bin:perl:perl5.8 \
				lib:libz.1:zlib \
				lib:libssl.0.9:openssl

patchfiles		patch-BoxPlatform.pm \
				patch-makeparcels.pl
post-patch {
	cd ${worksrcpath}
	foreach file [exec find . -type f ( -name *.pl -o -name *-config -o -name *-certs )] {
		reinplace "s%^#!.*perl%#!/usr/bin/env perl%" ${file}
	}
	foreach file { \
			bin/bbstored/BackupConstants.h \
			bin/bbackupd/bbackupd-config \
			bin/bbstored/bbstored-certs \
			bin/bbstored/bbstored-config \
			lib/common/BoxPortsAndFiles.h \
			lib/raidfile/RaidFileController.h \
			lib/raidfile/raidfile-config \
		} {
		reinplace "s%/usr/local%${prefix}%g" ${file}
		reinplace "s%/var/run%${prefix}/var/run%g" ${file}
		reinplace "s%/var/bbackupd%${prefix}/var/bbackupd%g" ${file}
		reinplace "s%/etc/box%${prefix}/etc/box%g" ${file}
	}
}

configure.env	PREFIX='${prefix}'
configure.pre_args

destroot.target		install-backup-client
destroot.keepdirs	${destroot}${prefix}/etc/box \
					${destroot}${prefix}/etc/box/bbackupd \
					${destroot}${prefix}/var/run \
					${destroot}${prefix}/var/bbackupd
post-destroot {
	xinstall -d -m 0700 ${destroot}${prefix}/etc/box/bbackupd
	xinstall -d -m 0700 ${destroot}${prefix}/var/bbackupd

	xinstall -d -m 0755 ${destroot}${prefix}/etc/rc.d
	xinstall -m 0755 ${filespath}/bbackupd.sh.in \
		${destroot}${prefix}/etc/rc.d/bbackupd.sh
	reinplace "s%__PREFIX%${prefix}%" ${destroot}${prefix}/etc/rc.d/bbackupd.sh

	xinstall -d -m 0755 ${destroot}${prefix}/share/doc/${name}
	foreach docname {accounts bbackupctl client license nonroot restore retrieve server serverfix space trouble} {
		xinstall -m 0644 ${filespath}/${docname}.html \
			${destroot}${prefix}/share/doc/${name}/${docname}.html
		reinplace "s%/usr/local%${prefix}%g" \
			${destroot}${prefix}/share/doc/${name}/${docname}.html
		reinplace "s%/var/run%${prefix}/var/run%g" \
			${destroot}${prefix}/share/doc/${name}/${docname}.html
		reinplace "s%/var/bbackupd%${prefix}/var/bbackupd%g" \
			${destroot}${prefix}/share/doc/${name}/${docname}.html
		reinplace "s%/etc/box%${prefix}/etc/box%g" \
			${destroot}${prefix}/share/doc/${name}/${docname}.html
	}
}

variant server {
	pre-destroot {
		addgroup bbstored
		set gid [existsgroup bbstored]
		adduser bbstored gid=${gid} realname=BoxBackup\ Server home=${prefix}/etc/box/bbstored
	}
	destroot.target-append		install-backup-server
	destroot.keepdirs-append	${destroot}${prefix}/etc/box/bbstored
	post-destroot {
		xinstall -o bbstored -g bbstored -d -m 0700 ${destroot}${prefix}/etc/box/bbstored

		xinstall -d -m 0755 ${destroot}${prefix}/etc/rc.d
		xinstall -m 0755 ${filespath}/bbstored.sh.in \
			${destroot}${prefix}/etc/rc.d/bbstored.sh
		reinplace "s%__PREFIX%${prefix}%" ${destroot}${prefix}/etc/rc.d/bbstored.sh
	}

	pre-install {
		addgroup bbstored
		set gid [existsgroup bbstored]
		adduser bbstored gid=${gid} realname=BoxBackup\ Server home=${prefix}/etc/box/bbstored
	}
}

