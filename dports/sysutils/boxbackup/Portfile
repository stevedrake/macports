# $Id: Portfile,v 1.1 2004/12/17 01:36:05 rshaw Exp $
PortSystem		1.0

name			boxbackup
version			0.09
categories		sysutils net
maintainers		rshaw@opendarwin.org
description		completely automatic on-line backup system for UNIX.
long_description	The backup daemon, bbackupd, runs on all machines to \
					be backed up. The store server daemon, bbstored runs \
					on a central server. Data is sent to the store \
					server, which stores all data on local filesystems, \
					that is, only on local hard drives. Tape or other \
					archive media is not used. \
					The system is designed to be easy to set up and run, \
					and cheap to use. Once set up, there should be no \
					need for user or administrative intervention, apart \
					from usual system maintenance.
homepage		http://www.fluffy.co.uk/boxbackup/
master_sites	sourceforge
extract.suffix	.tgz
checksums		md5 b4fced539ed72855383f25609de9e6da

depends_build	bin:perl:perl5.8

depends_lib		lib:libz.1:zlib \
				lib:libssl.0.9:openssl

patchfiles		patch-BoxPlatform.pm \
				patch-makeparcels.pl
post-patch {
	cd ${worksrcpath}
	set perl.bin [binaryInPath perl]
	foreach file [exec find . -type f -name *.pl] {
		reinplace "s%/usr/bin/perl%${perl.bin}%g" ${file}
	}
	foreach file { \
			bin/bbackupd/bbackupd-config \
			bin/bbstored/bbstored-certs \
			bin/bbstored/bbstored-config \
			bin/bbstored/BackupConstants.h \
			lib/common/BoxPortsAndFiles.h \
			lib/raidfile/raidfile-config \
			lib/raidfile/RaidFileController.h \
		} {
		reinplace "s%/usr/bin/perl%${perl.bin}%g" ${file}
		reinplace "s%/usr/local%${prefix}%g" ${file}
		reinplace "s%/var/run%${prefix}/var/run%g" ${file}
		reinplace "s%/var/bbackupd%${prefix}/var/bbackupd%g" ${file}
		reinplace "s%/etc/box%${prefix}/etc/box%g" ${file}
	}
}

configure.env	PREFIX='${prefix}'
configure.pre_args

destroot.target	install-backup-client \
				install-backup-server
destroot.keepdirs	${destroot}${prefix}/etc/box \
					${destroot}${prefix}/var/run \
					${destroot}${prefix}/var/bbackupd
post-destroot {
	xinstall -d -m 0755 ${destroot}${prefix}/share/doc/${name}
	foreach docname {accounts bbackupctl client license nonroot restore retrieve server serverfix space trouble} {
		xinstall -m 0644 ${filespath}/${docname}.html \
			${destroot}${prefix}/share/doc/${name}/${docname}.html
		reinplace "s%/usr/local%${prefix}%g" \
			${destroot}${prefix}/share/doc/${name}/${docname}.html
		reinplace "s%/var/run%${prefix}/var/run%g" \
			${destroot}${prefix}/share/doc/${name}/${docname}.html
		reinplace "s%/var/bbackupd%${prefix}/var/bbackupd%g" \
			${destroot}${prefix}/share/doc/${name}/${docname}.html
		reinplace "s%/etc/box%${prefix}/etc/box%g" \
			${destroot}${prefix}/share/doc/${name}/${docname}.html
	}
}

