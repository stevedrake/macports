#!/bin/sh

BBSTORED_CONF=__PREFIX/etc/box/bbstored.conf
RAIDFILE_CONF=__PREFIX/etc/box/raidfile.conf
BBSTORED_ETCDIR=__PREFIX/etc/box/bbstored

checkinstall() 
{
	# test if conf file is present
	if [ ! -f "${BBSTORED_CONF}" ]; then
		echo "Error: ${BBSTORED_CONF} is missing!"
		echo "You need to run 'bbstored-config' to create it."
		echo "See the documentation on server setup for details:"
		echo "  file://__PREFIX/share/doc/boxbackup/server.html"
		exit 1
	fi
	if [ ! -f "${RAIDFILE_CONF}" ]; then
		echo "Error: ${RAIDFILE_CONF} is missing!"
		echo "You need to run 'raidfile-config' to create it."
		echo "See the documentation on server setup for details:"
		echo "  file://__PREFIX/share/doc/boxbackup/server.html"
		exit 1
	fi

	# test if work directory is present, if not we create it
	if [ ! -d "${BBSTORED_ETCDIR}" ]; then
		/usr/bin/install -d -m 0700 -o bbstored -g bbstored ${BBSTORED_ETCDIR}
	fi
}

case "$1" in
start)
	checkinstall
	__PREFIX/bin/bbstored
	;;
stop)
	/usr/bin/killall -SIGUSR1 bbstored
	;;
reload)
	/usr/bin/killall -SIGHUP bbstored
	;;
restart)
	$0 stop
	$0 start
	;;
*)
	echo "Usage: `basename $0` {start|stop|reload|restart}" >&2
	;;
esac

exit 0

