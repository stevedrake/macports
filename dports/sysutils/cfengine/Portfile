# $Id: Portfile,v 1.9 2004/11/07 00:00:29 jkh Exp $
PortSystem		1.0

name			cfengine
version			2.1.11
categories		sysutils
maintainers		rshaw@opendarwin.org
description		a tool for setting up and maintaining computer systems
long_description	Cfengine, or the configuration engine is an \
					autonomous agent and a middle to high level \
					policy language for building expert systems \
					which administrate and configure large computer \
					networks. 
homepage		http://www.cfengine.org/
master_sites	ftp://ftp.iu.hio.no/pub/cfengine/ \
				ftp://sunsite.uio.no/pub/cfengine/ \
				http://ftp.us.xemacs.org/ftp/pub/cfengine/cfengine-ftp/
checksums		md5 6d6bd644e4e8b4374d4eb9ed5bd154a2
platforms		darwin

depends_lib		lib:libdb-4:db4 \
				lib:libssl.0.9:openssl

patchfiles		patch-configure \
				patch-conf.h.in \
				patch-cf.defs.h
post-patch {
	cd ${worksrcpath}
	foreach manfile [glob doc/*.8] {
		reinplace "s|/usr/local|${prefix}|g" $manfile
		reinplace "s|/var/cfengine|${prefix}&|g" $manfile
	}
}

set cfworkdir	${prefix}/var/cfengine

configure.args	--mandir='\${prefix}/share/man' \
				--infodir='\${prefix}/share/info' \
				--with-workdir="${cfworkdir}" \
				--with-berkeleydb=default \
				--with-openssl=default \
				--with-docs

build.args		ps_DATA=
destroot.args	ps_DATA=

pre-destroot {
	if {$env(USER) != "root"} {
		ui_msg "-----------------------------------------------------------"
		ui_msg "Note that you are not running as root, so files installed"
		ui_msg "by this port will not end up with proper ownership and"
		ui_msg "likely not work correctly with ${name}."
		ui_msg "-----------------------------------------------------------"
	}
}

post-destroot {
	# Create cfengine directories
	xinstall -d -m 0755 ${destroot}${cfworkdir}
	# Create cfengine sub-directories
	foreach subdir {bin inputs modules outputs state} {
		xinstall -d -m 0755 ${destroot}${cfworkdir}/${subdir}
		destroot.keepdirs-append ${destroot}${cfworkdir}/${subdir}
	}
	foreach subdir {ppkeys rpc_in rpc_out} {
		xinstall -d -m 0700 ${destroot}${cfworkdir}/${subdir}
		destroot.keepdirs-append ${destroot}${cfworkdir}/${subdir}
	}
	# Create distribution sample conf files
	set hostname [exec hostname]
	set host [lindex [split ${hostname} {.}] 0]
	set domain [join [lrange [split ${hostname} {.}] 1 end] {.}]
	set timezone [exec date +%Z]
	foreach conf {cfagent.conf cfservd.conf update.conf cfrun.hosts} {
		xinstall -m 0644  ${filespath}/${conf}.in \
			${destroot}${cfworkdir}/inputs/${conf}-dist
		reinplace "s|@PREFIX@|${prefix}|g" \
			${destroot}${cfworkdir}/inputs/${conf}-dist
		reinplace "s|@CFWORKDIR@|${cfworkdir}|g" \
			${destroot}${cfworkdir}/inputs/${conf}-dist
		reinplace "s|@HOST@|${host}|g" \
			${destroot}${cfworkdir}/inputs/${conf}-dist
		reinplace "s|@DOMAIN@|${domain}|g" \
			${destroot}${cfworkdir}/inputs/${conf}-dist
		reinplace "s|@TIMEZONE@|${timezone}|g" \
			${destroot}${cfworkdir}/inputs/${conf}-dist
	}
}

post-install {
	ui_msg "-----------------------------------------------------------"
	ui_msg "To complete ${name} installation, please do the following:"
	ui_msg "1) Generate root server keys:"
	ui_msg "     sudo cfkey"
	ui_msg "2) Copy sample conf files:"
	foreach conf {cfagent.conf cfservd.conf update.conf cfrun.hosts} {
		ui_msg "     sudo cp ${cfworkdir}/inputs/${conf}-dist \\"
		ui_msg "             ${cfworkdir}/inputs/${conf}"
	}
	ui_msg "3) Edit conf files as desired."
	ui_msg "4) Read documentation in ${prefix}/share/${name}/html"
	ui_msg "-----------------------------------------------------------"
}

variant psdocs {
	depends_build			bin:tex:teTeX \
							bin:texinfo:texinfo
	build.args-delete		ps_DATA=
	destroot.args-delete	ps_DATA=
}

platform darwin {
	depends_run	path:/Library/StartupItems/DarwinPortsStartup:DarwinPortsStartup

	post-destroot {
		# Create DarwinPortsStartup script for cfengine
		xinstall -d -m 0755 ${destroot}${prefix}/etc/rc.d
		xinstall -m 0755 ${filespath}/${name}.sh.in \
			${destroot}${prefix}/etc/rc.d/${name}.sh
		reinplace "s|@PREFIX@|${prefix}|" \
			${destroot}${prefix}/etc/rc.d/${name}.sh
		reinplace "s|@CFWORKDIR@|${cfworkdir}|" \
			${destroot}${prefix}/etc/rc.d/${name}.sh
	}
}

