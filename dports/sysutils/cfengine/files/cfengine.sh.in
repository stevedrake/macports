#!/bin/sh

# Run in cron or daemon mode
#CFMODE=cron
CFMODE=daemon

CRONTAB=/etc/crontab
CFWORKDIR=@CFWORKDIR@

checkinstall() 
{
	# Check if cfagent.conf/update.conf are present
	if [ ! -f "${CFWORKDIR}/inputs/cfagent.conf" ] && \
	   [ ! -f "${CFWORKDIR}/inputs/update.conf" ]; then
		echo "Error: Both ${CFWORKDIR}/inputs/cfagent.conf and ${CFWORKDIR}/inputs/update.conf are missing!"
		echo "Try copying ${CFWORKDIR}/inputs/cfagent.conf-dist to ${CFWORKDIR}/inputs/cfagent.conf"
		echo "and/or ${CFWORKDIR}/inputs/update.conf-dist to ${CFWORKDIR}/inputs/update.conf"
		exit 1
	else
		if [ ! -f "${CFWORKDIR}/inputs/cfagent.conf" ]; then
			echo "Warning: ${CFWORKDIR}/inputs/cfagent.conf is missing!"
			echo "Try copying ${CFWORKDIR}/inputs/cfagent.conf-dist to ${CFWORKDIR}/inputs/cfagent.conf"
		fi
		if [ ! -f "${CFWORKDIR}/inputs/update.conf" ]; then
			echo "Warning: ${CFWORKDIR}/inputs/update.conf is missing!"
			echo "Try copying ${CFWORKDIR}/inputs/update.conf-dist to ${CFWORKDIR}/inputs/update.conf"
		fi
	fi

	# Check for root public-private keys, create if missing
	if [ ! -f "${CFWORKDIR}/ppkeys/localhost.priv" ] || [ ! -f "${CFWORKDIR}/ppkeys/localhost.pub" ]; then
		echo "Warning: Root public-private keys missing, re-creating them!"
		/bin/rm -f ${CFWORKDIR}/ppkeys/localhost.priv
		/bin/rm -f ${CFWORKDIR}/ppkeys/localhost.pub
		@PREFIX@/sbin/cfkey
	fi

	# Add cfengine to /etc/crontab if not already done
	if [ "$CFMODE" == "cron" ]; then
		if [ -z "`grep cfexecd $CRONTAB`" ]; then
			echo "0	*	*	*	*	root	@PREFIX@/sbin/cfexecd -F" >>$CRONTAB
		fi
	fi
}

case "$1" in
start)
	checkinstall
	if [ "$CFMODE" == "daemon" ]; then
		@PREFIX@/sbin/cfexecd
	else
		@PREFIX@/sbin/cfagent
	fi
	;;
stop)
	/usr/bin/killall -SIGUSR1 cfexecd
	;;
*)
	echo "Usage: `basename $0` {start|stop}" >&2
	;;
esac

exit 0

