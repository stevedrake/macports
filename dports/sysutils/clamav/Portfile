# $Id$

PortSystem 1.0

name			clamav
version		 	0.94
categories	  	sysutils
maintainers	 	dluke@geeklair.net
description	 	clamav antivirus software

long_description	Clam AntiVirus is a GPL anti-virus toolkit for UNIX. The \
			main purpose of this software is the integration with mail \
			servers (attachment scanning).
			
homepage		http://www.clamav.net
master_sites		sourceforge
checksums	 	md5 d3f6d5fff2db81950491749166ab0ffa \
			sha1 d69a0c462ac3ef55329384f8e136d9b7bc1b8ec5 \
			rmd160 598561b76b1e4ee14120388ba1bbdcac5ac7bfe5
platforms	   	darwin
configure.args  	--disable-clamav \
			--mandir=${prefix}/share/man \
			--with-zlib=${prefix}

use_parallel_build	yes

depends_lib		port:gmp port:libiconv port:zlib port:bzip2

#workaround gcc bug 28045 http://gcc.gnu.org/bugzilla/show_bug.cgi?id=28045
configure.cflags	{-fdefer-pop -fdelayed-branch -fguess-branch-probability \
			 -fcprop-registers -floop-optimize -fif-conversion \
			 -fif-conversion2 -ftree-ccp -ftree-dce -ftree-dominator-opts \
 			 -ftree-dse -ftree-ter -ftree-lrs -ftree-sra -ftree-copyrename \
			 -ftree-fre -ftree-ch -fmerge-constants \
			 -fthread-jumps -fcrossjumping -foptimize-sibling-calls \
			 -fcse-follow-jumps  -fcse-skip-blocks -fgcse  -fgcse-lm \
			 -fexpensive-optimizations -fstrength-reduce -frerun-cse-after-loop \
			 -frerun-loop-opt -fcaller-saves -fforce-mem -fpeephole2 \
			 -fschedule-insns  -fschedule-insns2 -fsched-spec -fregmove \
			 -fdelete-null-pointer-checks -freorder-functions \
           		 -funit-at-a-time -falign-functions  -falign-jumps -falign-loops \
           		 -falign-labels -ftree-pre}

platform darwin i386 {
			#The gcc on intel macs crashes when using the above cflags
			configure.cflags {-O0}
			}

platform darwin 7 {
			#The gcc on 10.3.9 doesn't like the above cflags either
			configure.cflags {-O0}
			}

post-destroot {
			system "cd '${destroot}${prefix}/etc/'
			mv freshclam.conf example-freshclam.conf
			mv clamd.conf example-clamd.conf"
			}

post-install {		ui_msg "\nYou need to add a new clamav user and clamav\
				group to your system if you want to use clamav\
				in superuser mode.\n"
			}

variant clamav_milter description {build with libmilter support} {
			depends_lib-append port:libmilter
			configure.args-append --enable-milter
			}
