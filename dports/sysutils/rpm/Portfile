# $Id: Portfile,v 1.12 2004/11/07 00:00:30 jkh Exp $

PortSystem 1.0
name			rpm
version			4.0.4
platforms		darwin
revision		7
categories		sysutils archivers
maintainers		ssen@opendarwin.org
description		RedHat Package Manager

master_sites		ftp://ftp.rpm.org/pub/rpm/dist/rpm-4.0.x/
checksums		md5 b0c3093d2f0d850760e59ac1db9bf152

depends_lib		lib:libbz2.1.0:bzip2 lib:libiconv.2:libiconv \
			path:${prefix}/bin/python2.3:python23

configure.args		--disable-nls --with-included-gettext \
			--with-glob --with-libiconv-prefix=${prefix} \
			--mandir=${prefix}/share/man

configure.env		__PYTHON="${prefix}/bin/python"


variant darwin {
	patchfiles-append \
		patch-db3-configure.diff        patch-rpmheader.diff \
		patch-dump.diff                 patch-rpmioc.diff \
		patch-dumpdb.diff               patch-rpmioh.diff \
		patch-lib-signature.diff        patch-rpmlead.diff \
		patch-macros-in.diff            patch-rpmqv.diff \
		patch-rpm2cpio.diff             patch-rpmsignature.diff \
		patch-rpmarchive.diff           patch-systemh.diff \
		patch-rpmrc.diff		patch-rpmrc-in.diff \
		patch-autodeps-darwin-prov.diff	patch-autodeps-darwin-req.diff \
		patch-python-rpmmodule.diff	patch-python-makefile-in.diff \
		patch-configure.diff

	pre-configure {
	        system "mkdir -p ${workpath}/librt"
		system "ln -sf /usr/lib/libSystem.B.dylib \
				${workpath}/librt/librt.dylib"
	}

	configure.args-append --disable-optimized --disable-aio \
			      --with-python=auto --without-javaglue \
		              --enable-broken-chown

	configure.env-append   LDFLAGS="-L${prefix}/lib -L${workpath}/librt" \
			CFLAGS="-I${prefix}/include -no-cpp-precomp" \
			CC="gcc -flat_namespace" CPPFLAGS=""

	proc mkdir-and-keep {dir} {
		system "mkdir -p '${dir}'"
		destroot.keepdirs-append "${dir}"
	}

	post-destroot {
		# where the RPM database to lives
		mkdir-and-keep "${destroot}${prefix}/var/lib/rpm"
		mkdir-and-keep "${destroot}${prefix}/src/apple/BUILD"
		mkdir-and-keep "${destroot}${prefix}/src/apple/RPMS"
		mkdir-and-keep "${destroot}${prefix}/src/apple/SOURCES"
		mkdir-and-keep "${destroot}${prefix}/src/apple/SPECS"
		mkdir-and-keep "${destroot}${prefix}/src/apple/SRPMS"
	}
}
