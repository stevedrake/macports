# $Id: Portfile,v 1.8 2004/11/07 00:00:30 jkh Exp $

PortSystem 1.0
name			rpm41
version			4.1.1
platforms		darwin
revision		3
categories		sysutils archivers
maintainers		ssen@opendarwin.org
description		RedHat Package Manager

master_sites		ftp://ftp.rpm.org/pub/rpm/dist/rpm-4.1.x/
checksums		md5 56bc9fab910de30dc00b045b408daa38
distfiles		rpm-4.1.1-1.8x.src.rpm

#master_sites		opendarwin
#distname		rpm-${version}

depends_lib		lib:libbz2.1.0:bzip2 lib:libiconv.2:libiconv \
			path:${prefix}/bin/python2.3:python23 bin:perl:perl5.8


extract		{	cd ${workpath}
			system "perl ${filespath}/rpmextract.pl ${distpath}/${distfiles} | \
				gunzip -c | cpio -iu"
			file delete -force rpm.spec
			system "tar -zxf rpm-4.1.1.tar.gz"
		}

worksrcdir	rpm-${version}

configure.args		--disable-nls --with-included-gettext \
			--with-glob --with-libiconv-prefix=${prefix} \
			--mandir=${prefix}/share/man

configure.env           __PYTHON="${prefix}/bin/python"

variant darwin {
	patchfiles-append \
		patch-db3-configure.diff        patch-rpmheader.diff \
		patch-dump.diff                 patch-rpmioc.diff \
		patch-dumpdb.diff               patch-rpmioh.diff \
		patch-lib-signature.diff        patch-rpmlead.diff \
		patch-macros-in.diff            patch-rpmqv.diff \
		patch-rpm2cpio.diff             patch-rpmsignature.diff \
		patch-rpmarchive.diff           patch-systemh.diff \
		patch-rpmrc.diff		patch-file-systemh.diff \
		patch-file-filec.diff		patch-rpmio-Makefile-in.diff \
		patch-fts.diff			patch-rpmrpc.diff \
		patch-rpmdb-Makefile-in.diff	patch-lib-Makefile-in.diff \
		patch-rpmdb-rpmdbc.diff		patch-build-Makefile-in.diff \
		patch-tools-rpmfile.diff	patch-tools-Makefile-in.diff \
		patch-Makefile-in.diff		patch-ltmain-sh.diff \
		patch-rpmrc-in.diff		\
		patch-autodeps-darwin-prov.diff	patch-autodeps-darwin-req.diff \
		patch-python-makefile-in.diff	patch-configure.ac.diff


	post-patch {
		system "rm -rf \"${worksrcpath}/elfutils\""
	}

	use_autoconf	yes

	pre-configure {
	        system "mkdir -p ${workpath}/librt"
		system "ln -sf /usr/lib/libSystem.B.dylib \
				${workpath}/librt/librt.dylib"
		system "touch ${worksrcpath}/aclocal.m4"
		system "touch ${worksrcpath}/config.h.in"
	}

	post-configure {
		system "find ${worksrcpath} -name Makefile.in | xargs touch"
		system "find ${worksrcpath} -name Makefile | xargs touch"
	}


	configure.args-append --disable-optimized --disable-aio \
			      --with-python=auto --without-javaglue \
		              --enable-broken-chown

	configure.args-append   LDFLAGS="-L${prefix}/lib -L${workpath}/librt" \
			CFLAGS="-I${prefix}/include -no-cpp-precomp"

	proc mkdir-and-keep {dir} {
		system "mkdir -p '${dir}'"
		destroot.keepdirs-append "${dir}"
	}

	post-destroot {
		# where the RPM database to lives
		mkdir-and-keep "${destroot}${prefix}/var/lib/rpm"
		mkdir-and-keep "${destroot}${prefix}/src/apple/BUILD"
		mkdir-and-keep "${destroot}${prefix}/src/apple/RPMS"
		mkdir-and-keep "${destroot}${prefix}/src/apple/SOURCES"
		mkdir-and-keep "${destroot}${prefix}/src/apple/SPECS"
		mkdir-and-keep "${destroot}${prefix}/src/apple/SRPMS"
	}
}
