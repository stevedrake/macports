--- osdep-darwin.c.orig	2009-09-30 20:30:00.000000000 -0700
+++ osdep-darwin.c	2009-09-30 20:30:25.000000000 -0700
@@ -19,6 +19,7 @@
 #include <sys/types.h>
 #include <sys/sysctl.h>
 
+#include <libproc.h>
 #include <stdlib.h>
 #include <string.h>
 #include <unistd.h>
@@ -30,18 +31,15 @@
 char *
 osdep_get_name(int fd, unused char *tty)
 {
-	int	mib[4] = { CTL_KERN, KERN_PROC, KERN_PROC_PID, 0 };
-        size_t	size;
-	struct kinfo_proc kp;
+	int pid;
+	char name[PATH_MAX], *p;
 
-	if ((mib[3] = tcgetpgrp(fd)) == -1)
+	if ((pid = tcgetpgrp(fd)) == -1)
 		return (NULL);
 
-	size = sizeof kp;
-	if (sysctl(mib, 4, &kp, &size, NULL, 0) == -1)
-		return (NULL);
-	if (*kp.kp_proc.p_comm == '\0')
+	if (proc_pidpath(pid, name, sizeof name) <= 0)
 		return (NULL);
 
-	return (strdup(kp.kp_proc.p_comm));
+	p = strrchr(name, '/');
+	return strdup(p ? p + 1 : name);
 }
