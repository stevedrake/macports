# $Id: Portfile,v 1.1 2006/02/27 09:05:40 pguyot Exp $

PortSystem 1.0
name				XeTeX
version				0.99b
categories			tex print textproc
maintainers			pguyot@kallisys.net
description			The XeTeX typesetting system
long_description	The XeTeX typesetting system is based on a merger of TeX \
					with Unicode and MacOS X font technologies.
homepage			http://scripts.sil.org/cms/scripts/page.php?site_id=nrsi&item_id=XeTeX
platforms			darwin
depends_lib			port:teTeX
set version_str		[strsed ${version} {g/[.]//}]
master_sites		http://scripts.sil.org/cms/scripts/render_download.php?site_id=nrsi&format=file&media_id=xetex_${version_str}&filename=
distfiles			XeTeX_${version_str}.dmg
extract.suffix
checksums			md5 0e79c61f79b770485c9b760bebd61e1e \
					rmd160 1ac50fc5e002d8bc263dbbfc6aff886fa3c04dfa \
					sha1 707126a55a1ff38a0c8b7bca1bd71a87d3f87c9b

use_configure		no
extract	{
	file mkdir ${workpath}
	file mkdir ${workpath}/img
	file mkdir ${workpath}/files
	system "\
		hdiutil mount ${distpath}/${distfiles} -mountpoint ${workpath}/img && \
		ditto --rsrc ${workpath}/img ${workpath}/files && \
		hdiutil eject ${workpath}/img"
	file delete ${workpath}/img
}

build {}

set hyphen_files [list \
	dehyphn.tex \
	dehypht.tex \
	dkhyphen.tex \
	gahyph.tex \
	hrhyph.tex \
	huhyph.tex \
	plhyph.tex \
	trhyph.tex]
set hyphen_files_prefix ${prefix}/share/texmf-dist/tex/generic/hyphen/

destroot {
	# http://scripts.sil.org/cms/scripts/page.php?site_id=nrsi&item_id=xetex_faq#fink
	system "cd ${workpath} && pax -rz < files/XeTeX.pkg/Contents/Archive.pax.gz"
	system "mv ${workpath}/share/texmf.local ${destroot}${prefix}/share/texmf-dist"
	system "mv ${workpath}/bin/powerpc-apple-darwin-current/* ${destroot}${prefix}/bin/"
	system "ln -s ${prefix}/bin/xetex ${destroot}${prefix}/bin/xelatex"
	file mkdir ${destroot}${prefix}/share/texmf-config/web2c/
	xinstall -m 644 ${portpath}/${filesdir}/fmtutil.cnf \
			${destroot}${prefix}/share/texmf-config/web2c/

	# hyphen files
	foreach hyphen_file $hyphen_files {
		system "mv ${destroot}${hyphen_files_prefix}${hyphen_file} \
		${destroot}${hyphen_files_prefix}${hyphen_file}.xetex"
	}
	
	file mkdir ${destroot}${prefix}/share/texmf-dist/tex/generic/config/
	xinstall -m 644 ${portpath}/${filesdir}/language.dat \
		${destroot}${prefix}/share/texmf-dist/tex/generic/config/language.dat.xetex
}

post-activate	{
	system "\
		texhash && \
		fmtutil-sys --enablefmt xetex && \
		fmtutil-sys --enablefmt xelatex && \
		fmtutil-sys --missing && \
		fmtutil-sys --all"

	# hyphen files
	foreach hyphen_file $hyphen_files {
		system "cp -p ${hyphen_files_prefix}${hyphen_file}.xetex \
		${hyphen_files_prefix}${hyphen_file}"
	}
	
	# language.dat file
	system "cp -p \
		${prefix}/share/texmf-dist/tex/generic/config/language.dat.xetex \
		${prefix}/share/texmf-dist/tex/generic/config/language.dat"

	# These are required so that local additions are picked
	# up if teTeX is updated:
	system "mktexlsr"
	system "updmap-sys"
}