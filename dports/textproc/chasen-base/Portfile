# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem          1.0

name                chasen-base
version             2.4.4
categories          textproc japanese
platforms           darwin
maintainers         takanori hum openmaintainer
license             BSD

homepage            http://chasen-legacy.sourceforge.jp/
description         Japanese morphological analysis system
long_description    The base analyzer of ChaSen, ${description}.

dist_subdir         chasen
distname            chasen-${version}

master_sites        sourceforge_jp:chasen-legacy/32224

checksums           rmd160  ceb4a7c064ba5bf0d356d6db0e64b644b88dbc54 \
                    sha256  09e41f681097f87ba6c953d3724c34c1826c3cfa590898a2166fb310a006f932

patchfiles          patch-configure.diff

depends_build       port:darts
depends_lib         port:libiconv

variant dartsclone description {Use darts-clone instead of darts} {
    depends_build-replace    s|port:darts|port:darts-clone|
}

post-extract {
    foreach f {tests/test-chasen.sh tests/test-dic.sh} {
        file attributes ${worksrcpath}/${f} -permissions 0755
    }
}

configure.args      --libexecdir=${prefix}/lib \
                    --sysconfdir=${prefix}/etc/chasen \
                    --with-darts=${prefix}/include \
                    --with-libiconv=${prefix}

test.run            yes
test.target         check

post-destroot {
    set docdir ${destroot}${prefix}/share/doc/chasen
    file mkdir ${docdir}
    xinstall -m 644 -W ${worksrcpath} \
        AUTHORS COPYING ChangeLog NEWS README doc/manual-j.pdf \
        ${docdir}

    if {[variant_isset dartsclone]} {
        set dartslib "dartsclone"
    } else {
        set dartslib "darts"
    }
    # this file indicates which version of chasen is installed
    set fh [open [file join ${docdir} chasen_${dartslib}] w 0644]
    puts ${fh} "This version of ChaSen depends on the ${dartslib} library."
    close ${fh}
}

# deactivate any old chasen port.
pre-activate {
    if {[file exists ${prefix}/bin/chasen]
        && ![catch {set vers [lindex [registry_active chasen] 0]}]
        && ([rpm-vercomp [lindex $vers 1] 2.4.4] < 0 ||
            [rpm-vercomp [lindex $vers 1] 2.4.4] == 0
            && [rpm-vercomp [lindex $vers 2] 1] < 1)} {
        registry_deactivate chasen "" [list ports_nodepcheck 1]
    }
}

livecheck.type      regex
livecheck.url       http://sourceforge.jp/projects/chasen-legacy/releases
livecheck.regex     chasen-(\[0-9.a-z\-\]+)\\.tar
