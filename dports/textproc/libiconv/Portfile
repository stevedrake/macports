# $Id$

PortSystem              1.0
PortGroup               muniversal 1.0

name                    libiconv
version                 1.12
revision                2
categories              textproc
maintainers             ryandesign
platforms               darwin freebsd linux
homepage                http://www.gnu.org/software/libiconv/
distfiles               ${distname}${extract.suffix}:gnu
extract.only            ${distname}${extract.suffix}
use_parallel_build      yes

master_sites \
    gnu::gnu \
    http://www2d.biglobe.ne.jp/~msyk/software/libiconv/:cp932fix

description \
    Character set conversion library

long_description \
    A character-set conversion library which implements the \
    iconv() API for dealing with unicode and other types of \
    conversion.

checksums \
    ${distname}${extract.suffix} \
        md5 c2be282595751535a618ae0edeb8f648 \
        sha1 a5738d7dfbbd01c49e8ce026ea4ffa0f01af0179 \
        rmd160 74a63c1a2963ac1729c1ac7adfec8fd397a685bd \
    ${distname}-cp932-devel.patch.gz \
        md5 124d240bff22e20b86e86d8c8e3bae1c \
        sha1 d989b1ce0a829fa3a12c08c3634efd5f169b399a \
        rmd160 2042116888ee28572c1f7bcc2756e4a29edfbad0

depends_build \
    port:gperf

patchfiles \
    patch-utf8mac.diff \
    patch-src-Makefile.in-darwin.diff

configure.cppflags
configure.ldflags
configure.args \
    --enable-static \
    --mandir=${prefix}/share/man \
    --docdir=${prefix}/share/doc/${name}-${version} \
    --without-libiconv-prefix \
    --without-libintl-prefix \
    --disable-nls \
    --enable-extra-encodings

if {![variant_isset disable_utf8mac] || [variant_isset enable_cp932fix]} {
    build.cmd ${build.cmd} CC=${configure.cc} -f Makefile.devel && ${build.cmd}
}

test.run                yes
test.target             check

platform freebsd {
    patchfiles-append patch-Makefile.devel
    pre-fetch { variant_set disable_utf8mac }
}

platform linux {
    pre-fetch { variant_set disable_utf8mac }
}

post-destroot {
    if {[file exists ${destroot}${prefix}/lib/charset.alias]} {
        delete ${destroot}${prefix}/lib/charset.alias
    }
}

# Do not support UTF-8-MAC encoding
variant disable_utf8mac {
    patchfiles-delete patch-utf8mac.diff
}

# Do not support extra encodings
variant disable_extra_encodings {
    configure.args-delete --enable-extra-encodings
}

# Apply a patch to fix the conversion problem between Shift-JIS and Unicode (See Microsoft KB Q170559)
variant enable_cp932fix {
    distfiles-append ${distname}-cp932-devel.patch.gz:cp932fix
    post-patch {
        system "cd ${worksrcpath} && gzip -dc '${distpath}/${distname}-cp932-devel.patch.gz' | patch -p1"
    }
}

if { [variant_isset universal] } {
    # When cross-compiling, can guess wrong endian value.
    if { ${os.arch}=="i386" } {
        if { ${os.major} >= 10 } {
            lappend merger_configure_env(ppc) cl_cv_sys_endian='big endian'
            set cross_archs "ppc ppc64"
        }
        lappend merger_configure_env(ppc64)   cl_cv_sys_endian='big endian'
        set cross_archs "ppc64"
    } else {
        lappend merger_configure_env(i386)    cl_cv_sys_endian='little endian'
        lappend merger_configure_env(x86_64)  cl_cv_sys_endian='little endian'
        set cross_archs "i386 x86_64"
    }

    foreach arch ${cross_archs} {
        lappend merger_configure_env(${arch}) \
            ac_cv_func_malloc_0_nonnull='yes' \
            gl_cv_func_malloc_0_nonnull='1'
    }

    # See http://trac.macports.org/ticket/18440.
    if { ${os.major}=="8" } {
            foreach arch "ppc64 x86_64" {
                lappend merger_configure_env(${arch}) \
                    am_cv_func_iconv='yes' \
                    am_cv_proto_iconv_arg1='const'
        }
    }
}

livecheck.check         freshmeat
