# $Id$

PortSystem 1.0
name            libiconv
version         1.11
revision        4
categories      textproc
platforms       darwin freebsd

maintainers     mij@macports.org
description     Character set conversion library

long_description \
    A character-set conversion library which implements the \
    iconv() API for dealing with unicode and other types of \
    conversion.

homepage        http://www.gnu.org/software/libiconv/
master_sites    gnu::gnu \
                  http://www2d.biglobe.ne.jp/~msyk/software/libiconv/:cp932fix
distfiles       ${distname}${extract.suffix}:gnu
checksums       ${distname}${extract.suffix} \
                  md5 b77a17e4a5a817100ad4b2613935055e \
                  sha1 df09c3ef43443ac15c0c2d49fd791aa73a64bf30 \
                  rmd160 9adbcd61598bee2fbe4eb94ac3f35f83f568d9d0 \
                ${distname}-cp932-devel.patch.gz \
                  md5 71caa7501358d462862ffab0bd49a152 \
                  sha1 f66d156ec559fedee411393dc7223064039ce209 \
                  rmd160 bacc8421a7e57a0d4dd4d3e133581f55bdd0b886
depends_build   bin:gperf:gperf

extract.only    ${distname}${extract.suffix}

pre-fetch {
    if {[variant_isset universal]} {
        if {![llength [info commands registry_active]]} {
            return -code error "+universal variant requires MacPorts 1.4"
        }
        if {![catch {registry_active libiconv}]} {
            return -code error "libiconv needs to be deactivated/uninstalled \
            before +universal variant can be installed"
        }
    }
}

post-patch {
    if {![variant_isset disable_utf8mac]} {
        system "cd ${worksrcpath} && patch -p1 < ${filespath}/utf8mac.diff"
    }
}

configure.args  --enable-static \
                --mandir=${prefix}/share/man \
                --without-libiconv-prefix \
                --without-libintl-prefix \
                --enable-extra-encodings
configure.universal_ldflags-append \
                -isysroot /Developer/SDKs/MacOSX10.4u.sdk

pre-build {
    if {![variant_isset disable_utf8mac] || [variant_isset enable_cp932fix]} {
        system "cd ${worksrcpath} && make -f Makefile.devel"
    }
}

test.run        yes
test.target     check

platform darwin 7 {
    build.env-append        MACOSX_DEPLOYMENT_TARGET=10.3
    configure.env-append    MACOSX_DEPLOYMENT_TARGET=10.3
    depends_build-append    port:gperf
}

platform darwin 8 {
    build.env-append        MACOSX_DEPLOYMENT_TARGET=10.4
    configure.env-append    MACOSX_DEPLOYMENT_TARGET=10.4
}

post-destroot {
    delete ${destroot}${prefix}/lib/charset.alias
}

# Do not support UTF-8-MAC encoding
variant disable_utf8mac {}

# Do not support extra encodings
variant disable_extra_encodings {
    configure.args-delete   --enable-extra-encodings
}

# Apply a patch to fix the conversion problem between Shift-JIS and Unicode (See Microsoft KB Q170559)
variant enable_cp932fix {
    distfiles-append        ${distname}-cp932-devel.patch.gz:cp932fix
    post-patch {
        system "cd ${worksrcpath} && gzip -dc '${distpath}/${distname}-cp932-devel.patch.gz' | patch -p1"
    }
}
