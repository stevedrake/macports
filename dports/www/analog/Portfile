# $Id: Portfile,v 1.1 2004/12/05 14:34:54 jberry Exp $
PortSystem			1.0

name				analog
version				5.32

categories			www
maintainers			blb@opendarwin.org

description			A program which analyses logfiles from WWW servers
long_description	It is designed to be fast and to produce accurate and attractive statistics: \
					and combined with Report Magic, you can generate even prettier reports. \
					It's free software.
homepage			http://www.analog.cx/

master_sites    	http://www.analog.cx/ \
					http://analog.linuxhelp.ca/ \
					http://www.rge.com/pub/infosystems/statistics/analog/ \
					http://sunsite.cnlab-switch.ch/www/mirror/analog/

platforms			darwin
checksums			md5 077a2d43c8f5c2bddf37129ca63ec1f8

# Note, it'd be nice to use an already-installed version of jpeg and libpng
# as well, but analog currently doesn't have a HAVE_ define for them, just
# zlib (as well as gd, which should be here too if possible)
depends_lib			lib:libz.1:zlib

use_configure		no

set shareanalog		${prefix}/share/analog
# Note, we can also set these *DIR variables with the build.args, but
# quoting gets really, really ugly (seven-backslashes-ugly)
post-patch			{
	reinplace "s|#define IMAGEDIR \"images/\"|#define IMAGEDIR \"${shareanalog}/images/\"|" "${worksrcpath}/src/anlghead.h"
	reinplace "s|#define LANGDIR NULL|#define LANGDIR \"${shareanalog}/lang/\"|" "${worksrcpath}/src/anlghead.h"
	reinplace "s|#define CONFIGDIR NULL|#define CONFIGDIR \"\"|" "${worksrcpath}/src/anlghead.h"
	reinplace "s|#define LOGSDIR NULL|#define LOGSDIR \"\"|" "${worksrcpath}/src/anlghead.h"
	reinplace "s|#define CACHEDIR NULL|#define CACHEDIR \"\"|" "${worksrcpath}/src/anlghead.h"
	reinplace "s|#define OUTDIR NULL|#define OUTDIR \"\"|" "${worksrcpath}/src/anlghead.h"
	reinplace "s|#define HEADERDIR NULL|#define HEADERDIR \"\"|" "${worksrcpath}/src/anlghead.h"
	reinplace "s|#define DNSDIR NULL|#define DNSDIR \"\"|" "${worksrcpath}/src/anlghead.h"
	reinplace "s|#define LOCKDIR NULL|#define LOCKDIR \"\"|" "${worksrcpath}/src/anlghead.h"
	reinplace "s|#define ERRDIR NULL|#define ERRDIR \"\"|" "${worksrcpath}/src/anlghead.h"
}

build.args			DEFS="-DHAVE_ZLIB" LIBS="-lz"
build.target		analog
build.cmd			cd ${worksrcpath}/src && make

pre-destroot		{
	system "mkdir -p \"${destroot}/${prefix}/bin\""
	system "mkdir -p \"${destroot}/${prefix}/share/doc/analog\""
	system "mkdir -p \"${destroot}/${prefix}/share/man/man1\""
	system "mkdir -p \"${destroot}/${shareanalog}\""
}

destroot			{
	system "cd \"${worksrcpath}\" && \
	        tar cf - examples how-to images lang | \
            tar xf - -C \"${destroot}/${shareanalog}\""
	system "cd \"${worksrcpath}/docs\" && \
	        tar cf - . | \
	        tar xf - -C \"${destroot}/${prefix}/share/doc/analog\""
	system "install -m 644 \"${worksrcpath}/analog.man\" \"${destroot}/${prefix}/share/man/man1/analog.1\""
	system "install -m 755 \"${worksrcpath}/analog\" \"${destroot}/${prefix}/bin\""
}

variant darwin {
	build.args-append  OS="OSX"
}
