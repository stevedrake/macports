# $Id$

PortSystem          1.0
name                mediawiki
version             1.15.5
set branch          [join [lrange [split ${version} .] 0 1] .]
categories          www php
maintainers         blb openmaintainer
description         The wiki engine used by Wikipedia
long_description \
   MediaWiki is the collaborative editing software that runs Wikipedia, the \
   free encyclopedia, and other projects. It's designed to handle a large \
   number of users and pages without imposing too rigid a structure or \
   workflow.

platforms           darwin freebsd

homepage            http://www.mediawiki.org
master_sites        http://download.wikimedia.org/mediawiki/${branch}/

checksums           md5     01c4c85fb96991d962c8acb3d892ec2d \
                    sha1    b157fe37bb89c78e5ffa0f27b14beb886db3a5f4 \
                    rmd160  5113beb1df46c56275a90d5a1cb85c2b01ca541f

depends_run         port:libiconv port:jpeg port:jasper port:tiff port:lcms \
                    port:libpng port:freetype port:libxml2 port:jbigkit \
                    port:expat port:fontconfig port:ghostscript \
                    port:ImageMagick port:pkgconfig port:aspell \
                    port:php5-web

# Fix an outdated KHTML hack which affects newer WebKit
# https://bugs.webkit.org/show_bug.cgi?id=28350
patchfiles          patch-skins_common_wikibits.js.diff

use_configure       no

build               {}

set docpath ${prefix}/www/data/${name}

destroot {
   xinstall -d -m 0755 ${destroot}${docpath}
   eval file copy [glob ${worksrcpath}/*] ${destroot}${docpath}
}

notes "\
MediaWiki has now been installed into ${docpath}.  Any further information \
on installation and configuration can be found at:

   http://www.mediawiki.org/wiki/Manual:Installation_guide

If you are upgrading, read:

   http://www.mediawiki.org/wiki/Manual:Upgrading

For a new install, make sure ${docpath}/AdminSettings.php has correct \
information.

For an upgrade, ${docpath}/AdminSettings.php will not be modified, so make \
sure it is correct and anything in ${docpath}/AdminSettings.sample which you \
need, has been copied to ${docpath}/AdminSettings.php.
"

post-activate {
   if {![file exists ${docpath}/AdminSettings.php]} {
      xinstall -m 660 ${docpath}/AdminSettings.sample \
         ${docpath}/AdminSettings.php
   }
}

variant mysql4 description "Deprecated variant, use just +mysql" {}
if {[variant_isset mysql4]} {
   variant_set mysql
}

variant postgresql83 description "Deprecated variant, use just +postgresql" {}
variant postgresql84 description "Deprecated variant, use just +postgresql" {}
if {[variant_isset postgresql83] || [variant_isset postgresql84]} {
   variant_set postgresql
}

variant mysql description "Use MySQL as the database backend" {
   depends_run-append   port:php5-mysql
}

variant postgresql description "Use PostGreSQL as the database backend" {
   depends_run-append   port:php5-postgresql
}

# Default to +mysql since that was previously the built-in setting
if {![variant_isset mysql] && ![variant_isset postgresql]} {
   default_variants     +mysql
}

livecheck.type      regex
livecheck.url       http://www.mediawiki.org/wiki/Download
livecheck.regex     ${name}-(\[.\\d]+)\\.tar\\.gz

