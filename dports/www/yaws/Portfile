# -*- coding: utf-8; mode: tcl; tab-width: 4; truncate-lines: t; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:et:sw=4:ts=4:sts=4
# $Id$

PortSystem			1.0

name				yaws
version				1.85
categories			www
maintainers			nomaintainer
platforms			darwin
description			Webserver for dynamic content written in Erlang
long_description	Yaws is a high performance HTTP server for dynamic content \
					written in Erlang. Pages can be dynamic with embedded erlang \
					code. Yaws also features a built-in Wiki.
homepage			http://yaws.hyber.org/
master_sites		http://yaws.hyber.org/download/
checksums			md5 6941ea52638805246973bf94fd6e9a52 \
					sha1 2d6bd52af002f356d6738900a67550c5531a0b4a \
					rmd160 5be8e85019aade9d7e2213b981f27cc59995aecc

depends_build		port:erlang

extract.post_args	| tar -xf - --exclude \
					"${name}-${version}/www/testdir/xx*xx.jpg"

patchfiles			patch-man-yaws.1 \
					patch-man-yaws_api.5 \
					patch-man-yaws.conf.5 \
					patch-scripts-Install \
					patch-scripts-Makefile \
					patch-scripts-yaws.conf.template

post-patch {
	reinplace "s|__PREFIX|${prefix}|g" ${worksrcpath}/man/yaws.1
	reinplace "s|__PREFIX|${prefix}|g" ${worksrcpath}/man/yaws.conf.5
	reinplace "s|__PREFIX|${prefix}|g" ${worksrcpath}/man/yaws_api.5
	reinplace "s|__PREFIX|${prefix}|g" ${worksrcpath}/scripts/yaws.conf.template
	reinplace "s|__PREFIX|${prefix}|g" ${worksrcpath}/src/yaws_config.erl
}

default_variants	+yapp

configure.args		--sysconfdir=${prefix}/etc \
					--localstatedir=${prefix}/var

variant yapp description {Yapp application handler} {
	post-build {
		system "cd ${worksrcpath}/applications/yapp && make && make docs"
	}
	post-destroot {
		system "cd ${worksrcpath}/applications/yapp && make install DESTDIR=${destroot}"
	}
}
					
post-destroot {
	xinstall -d "${destroot}${prefix}/var/log/yaws/"
	system "touch ${destroot}${prefix}/var/log/yaws/.turd"
	file rename "${destroot}${prefix}/etc/yaws/yaws.conf" "${destroot}${prefix}/etc/yaws/yaws.conf.template"
}

post-install {
	ui_msg "Copy and customize ${prefix}/etc/yaws/yaws.conf.template to ${prefix}/etc/yaws/yaws.conf"
}

startupitem.create	yes
startupitem.name	yaws
startupitem.start	"${prefix}/bin/yaws --daemon --heart --conf ${prefix}/etc/yaws/yaws.conf"
startupitem.stop	"${prefix}/bin/yaws --stop"

livecheck.type	regex
livecheck.url	http://yaws.hyber.org/download/
livecheck.regex	{<address> Yaws (.*) Server at yaws.hyber.org </address>}
