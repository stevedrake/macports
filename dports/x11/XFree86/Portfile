# $Id$

PortSystem 1.0
name		XFree86
version		4.6.0
categories	x11
maintainers	nomaintainer@macports.org
homepage    http://www.xfree86.org/

description	X11R6 windowing system
long_description \
    The XFree86 project's X window system implementation

platforms       darwin freebsd
master_sites    xfree:${version}/source/

distfiles \
    ${distname}-src-1.tgz \
    ${distname}-src-2.tgz \
    ${distname}-src-3.tgz \
    ${distname}-src-4.tgz \
    ${distname}-src-5.tgz
checksums \
    ${distname}-src-1.tgz md5 6c05f3486f088d01584f4517540e8d18 \
    ${distname}-src-2.tgz md5 f084d12aa734c9cd83e8d2a3a4eb3e32 \
    ${distname}-src-3.tgz md5 05450997f1876098d791a4cf9db21af8 \
    ${distname}-src-4.tgz md5 102ed22d33bd31a5853cb5addb51d7c9 \
    ${distname}-src-5.tgz md5 f66708c7ff882e4ca232896266fbf92f

patchfiles \
    darwin.cf.diff \
    darwinKeyboard.c.diff \
    detect.mk.diff \
    patch-GL_apple-Imakefile \
    patch-GL_apple-dri_driver.h \
    patch-Xserver-darwin.c \
    patch-Xserver-darwin-Imakefile \
    xterm_Imakefile.diff \
    XTerm.ad.diff \
    xfree86.fink.patch

depends_build   bin:perl:perl5.8
use_configure   no

# No attempt has yet been made to allow XFree86 to build universal. Feel free
# to attempt. The default universal variant is merely being disabled here
# because it does not function with ports that do not use configure, and
# leaving it enabled prevents the universal installation of any other ports
# that depend on XFree86, even if they would otherwise succeed. See #12137.
universal_variant   no

prefix          ${x11prefix}
worksrcdir      xc

build.target    World
destroot.target install install.man

platform darwin {

    post-patch {
        file mkdir "${workpath}/include"
        file link -symbolic "${workpath}/include/security" "/usr/include/pam"
    }

    configure {
        set hostfd [open "${worksrcpath}/config/cf/host.def" a+]
        puts $hostfd "#define ProjectRoot ${prefix}"
        puts $hostfd "#define NothingOutsideProjectRoot YES"
        puts $hostfd "#define EtcX11Directory \"${prefix}/etc/X11\""
        puts $hostfd "#define StandardIncludes      \"-I${workpath}/include\""
        puts $hostfd "#define FontconfigFontsConfDir  \"${prefix}/etc/fonts\""
        close $hostfd
    }
}


platform puredarwin {

    post-configure	{
        set hostfd [open "${worksrcpath}/config/cf/host.def" a+]
        puts $hostfd "#define DarwinQuartzSupport NO"
        puts $hostfd "#define BuildGlxExt YES"
        puts $hostfd "#define BuildGLXLibrary YES"
        close $hostfd
    }
}

platform macosx {

    # Should also check for cookie crumbs in the keyboard
    pre-fetch {
        if { [file exists ${prefix}/bin/quartz-wm] } {
            if { ![file exists ${prefix}/include/X11/X.h] } {
                return -code error "
                
                    You have an Apple X11 installation already.
                        MacPorts will not overwrite it.

                    If you wish to use Apple X11,
                        install the X11SDK included with Xcode tools.

                    If you really want to use XFree86 instead,
                        please move it aside first :

                            sudo mv /usr/X11R6 /usr/X11R6.apple
                "
            } else {
                return -code error "
                
                    You have an Apple X11 installation already.
                        MacPorts will not overwrite it. 

                    If you really want to use XFree86 instead,
                        please move it aside first :

                            sudo mv /usr/X11R6 /usr/X11R6.apple
                "
            }
        } elseif { [file exists ${prefix}/include/X11/X.h] } {
            return -code error "
            
                    You have an Apple X11SDK installation already.
                        MacPorts will not overwrite it. 

                    If you wish to use Apple X11,
                        install it from your MacOSX install disc.

                    If you really want to use XFree86 instead,
                        please move it aside first :

                            sudo mv /usr/X11R6 /usr/X11R6.apple
            "
        }
    }

    # Dirty hack, should be fixed in Imakefile
    pre-destroot {
        reinplace \
            "s|\$\(DESTDIR\)\[\[:space:\]\]\[\[:space:\]\]*\$\(|\$\(DESTDIR\)\$\(|g" \
                ${worksrcpath}/programs/Xserver/Makefile
     }

     post-destroot {
        xinstall -d ${destroot}/Applications/MacPorts
        cd ${destroot}/Applications/MacPorts
        system "ln -s ${prefix}/bin/XDarwin.app"
    }
}
