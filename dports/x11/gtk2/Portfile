# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:filetype=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem      1.0

name            gtk2
version         2.14.7
set branch      [join [lrange [split ${version} .] 0 1] .]
categories      x11
maintainers     nox openmaintainer
platforms       darwin
description     Gimp ToolKit version 2

long_description \
    This is GTK+ version 2.x. GTK+, which stands for Gimp \
    ToolKit, is a library for creating GUIs for the X Windows \
    System.

homepage        http://www.gtk.org/
distname        gtk+-${version}
use_bzip2       yes

master_sites    gnome:sources/gtk+/${branch}/ \
                ftp://ftp.gtk.org/pub/gtk/v${branch}/ \
                http://ftp.gtk.org/pub/gtk/v${branch}/

patchfiles      patch-configure.diff \
                patch-modules-gail.diff \
                patch-modules-printbackends.diff

if {[variant_isset no_x11]} {
    default_variants    +quartz
}

if {![variant_isset quartz]} {
    default_variants    +x11
}

if {[variant_isset universal]} {
    if {[file exists /Developer/SDKs/MacOSX10.5.sdk]} {
        set configure.universal_sysroot "/Developer/SDKs/MacOSX10.5.sdk"
    } else {
        set configure.universal_sysroot "/Developer/SDKs/MacOSX10.4u.sdk"
    }
    configure.env-append    CUPS_CONFIG="${configure.universal_sysroot}/usr/bin/cups-config"
}

pre-fetch {
    if {![variant_isset quartz] && ![variant_isset x11]} {
        error "Either +x11 or +quartz is required"
    }

    if {[rpm-vercomp ${os.version} 8.0] >= 0 && [file exists ${prefix}/bin/cups-config]} {
        ui_error "You are running Darwin 8.0, cups-headers should not be installed on your system. Please uninstall or deactivate it."
        error "Please uninstall or deactivate cups-headers."
    }
}

checksums       md5     fb1614d4b2adba7b078e2e799b5db604 \
                sha1    f4b9c65dbdc78cad6fc9b601640cbad1d3abb57f \
                rmd160  2ed6451d3de050e9b2423f6509d15e39ba69a6ab

depends_build   port:pkgconfig \
                port:gtk-doc

depends_lib     port:cairo \
                port:fontconfig \
                port:freetype \
                path:lib/pkgconfig/glib-2.0.pc:glib2 \
                port:jpeg \
                port:tiff \
                port:libiconv \
                port:libpng \
                port:jasper \
                port:atk \
                path:lib/pkgconfig/pango.pc:pango \
                port:gettext \
                port:zlib

depends_run     port:shared-mime-info

configure.args  --disable-shm \
                --disable-glibtest \
                --with-included-loaders

configure.ccache            no
configure.cppflags-append   -no-cpp-precomp -DX_LOCALE
configure.cflags-append     -funroll-loops -fstrict-aliasing

use_parallel_build  yes

test.run        yes
test.target     check

post-destroot {
    ui_debug "Creating gtk.immodules..."
    system "DYLD_LIBRARY_PATH=${destroot}${prefix}/lib ${destroot}${prefix}/bin/gtk-query-immodules-2.0 \
        ${destroot}${prefix}/lib/gtk-2.0/2.10.0/immodules/*.so >${destroot}${prefix}/etc/gtk-2.0/gtk.immodules"
    reinplace "s|${destroot}||" ${destroot}${prefix}/etc/gtk-2.0/gtk.immodules
}

post-activate {
    ui_debug "Updating gdk-pixbuf.loaders..."
    system "${prefix}/bin/gdk-pixbuf-query-loaders >${prefix}/etc/gtk-2.0/gdk-pixbuf.loaders"
}

platform darwin 7 {
    depends_build-append    port:cups-headers
}

platform darwin 8 {
    if {[variant_isset quartz] || [variant_isset no_x11]} {
        configure.ldflags-append  -framework Cocoa -framework Carbon
    }
}

variant no_x11 {
    pre-fetch {
        if {[file exists ${prefix}/lib/libpangox-1.0.dylib]} {
            ui_error "Please uninstall or deactivate the pango port and reinstall it by running `port install pango +no_x11`."
            error "pango must be installed with the no_x11 variant enabled."
        }
    }
}

variant quartz requires no_x11 conflicts x11 description {Enable Quartz rendering} {
    patchfiles-append       patch-gnome-bug-531599.diff
    configure.args-append   --with-gdktarget=quartz
}

variant x11 conflicts quartz description {Enable rendering in X11 (default)} {
    depends_lib-append \
        lib:libXi.6:xorg-libXi \
        lib:libXrandr.2:xorg-libXrandr \
        lib:libXcursor.1:xorg-libXcursor \
        lib:libXinerama.1:xorg-libXinerama

        # Leaving these out to avoid pulling them in on Tiger and triggering X11 library conflicts between macports and ${x11prefix}
        #lib:libXdamage.1:xorg-libXdamage \
        #lib:libXcomposite.1:xorg-libXcomposite \
        #lib:libXfixes.3:xorg-libXfixes \

    configure.args-append      --with-xinput --enable-xinerama

    # This block helps us link correctly and setup our pc files correctly when we are
    # +system_x11 and x11prefix is somewhere non-standard
    if { ![file exists ${prefix}/lib/pkgconfig/x11.pc] && ![file exists ${x11prefix}/lib/pkgconfig/x11.pc] } {
        # AC_X_PATH blindly asks xmkmf where X11 is, and it always uses /usr/X11R6.
        # These next three lines should cause AC_X_PATH to let us setup our CPPFLAGS
        # and LDFLAGS without interference
        configure.args-append --x-include=${prefix}/include --x-lib=${prefix}/lib
        configure.cppflags-append -I${x11prefix}/include
        configure.ldflags-append  -L${x11prefix}/lib
 
        # And this will similarly get ports that use pkgconfig to find our pkgconfig-less libX11
        post-destroot {
            foreach pc [glob ${destroot}${prefix}/lib/pkgconfig/*.pc] {
                reinplace "s:-lX11:-L${prefix}/lib -L${x11prefix}/lib -lX11:g" ${pc}
            }
        }
    }
}

livecheck.check regex
livecheck.url   ftp://ftp.gnome.org/pub/gnome/sources/gtk+/${branch}/
livecheck.regex {LATEST-IS-(\d+(?:\.\d+)*)}
