# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:filetype=tcl:et:sw=4:ts=4:sts=4
# $Id$

PortSystem 1.0

name		gtk2
version		2.12.2
set branch  [join [lrange [split ${version} .] 0 1] .]
categories	x11
maintainers	nomaintainer
description	Gimp ToolKit version 2
homepage	http://www.gtk.org/
platforms	darwin

long_description \
    This is GTK+ version 2.x.  GTK+, which stands for Gimp \
    ToolKit, is a library for creating GUIs for the X Windows \
    System.

master_sites	\
    gnome:sources/gtk+/${branch}/ \
    ftp://ftp.gtk.org/pub/gtk/v${branch}/ \
    http://ftp.gtk.org/pub/gtk/v${branch}/

distname	gtk+-${version}

checksums	\
    md5 a789a8a333d418f47cda1dba106d9aac \
    sha1 495ff3ef09de44cc23718239967203bd7871b4aa \
    rmd160 b5cd6b7ec6abf557a6f82c707e0eafb67c813f8d

use_bzip2	yes

depends_build	\
    port:gtk-doc \
    port:pkgconfig
depends_lib	\
    port:cairo \
    port:fontconfig \
    port:freetype \
    port:glib2 \
    port:jpeg \
    port:tiff \
    port:libiconv \
    port:libpng \
    port:atk \
    port:pango \
    port:gettext \
    port:render \
    port:zlib

if { ![variant_isset quartz] } {
    default_variants    +x11
}

pre-fetch {
    if { ![variant_isset quartz] && ![variant_isset x11] } {
        return -code 1 "\n\nThe gtk2 port can be built and installed with support for either Quartz\n(Aqua) rendering or X11 rendering, but not both.\n\nPlease install the gtk2 port by running either:\n\t\"port install gtk2 +quartz\" or\n\t\"port install gtk2 +x11\"\n\nIf you are upgrading a port and see this message, use the X11 variant.\n\n"
    }
    if {[variant_isset quartz]} {
        if { ![file exists ${prefix}/include/cairo/cairo-quartz.h] } {
            return -code 1 "\nYou must first build cairo with the quartz variant enabled.  Please\nuninstall (or deactivate) the cairo port and reinstall by running:\n\n\"port install cairo +quartz\"\n"
        }
    }
    if {${os.platform} == "darwin" && [rpm-vercomp ${os.version} 8.0] >= 0 && [file exists ${prefix}/bin/cups-config]} {
        return -code 1 "\nThe cups-headers port may prevent building this port.  Please uninstall\n(or deactivate) cups-headers and restart the build.\n"
    }
}

configure.ldflags-append    -lpango-1.0
configure.cppflags-append   -no-cpp-precomp -DX_LOCALE
configure.cflags-append     -funroll-loops -fstrict-aliasing

configure.args	\
    --disable-shm \
    --disable-gtk-doc \
    --with-included-loaders \
    --mandir=${prefix}/share/man

platform darwin 6 {
    patchfiles-append patch-gtk-xdgmime-xdgmimemagic.c
}

platform darwin 7 {
    depends_build-append \
        port:cups-headers
}

variant quartz description {Enable Quartz rendering} {
    configure.args-append --with-gdktarget=quartz
}

variant x11 description {Enable rendering in X11 (default, if Quartz is not enabled)} {
    depends_lib-append  \
        port:xrender \
        lib:libX11.6:xorg
    build.args  CFLAGS+="-I{x11prefix}/include"
}

post-patch	{
    reinplace "s|xdg_data_dirs = \"/usr|xdg_data_dirs = \"${prefix}/share:/usr|g" ${worksrcpath}/gtk/xdgmime/xdgmime.c
    reinplace "s|g_strdup (\"/usr|g_strdup (\"${prefix}|g" ${worksrcpath}/gtk/gtkicontheme.c }

post-destroot	{
    system "install -d -m 755 ${destroot}${prefix}/etc/gtk-2.0"
    system "cp ${filespath}/gdk-pixbuf.loaders ${destroot}${prefix}/etc/gtk-2.0/gdk-pixbuf.loaders"
    reinplace "s|__PREFIX__|${prefix}|g" "${destroot}/${prefix}/etc/gtk-2.0/gdk-pixbuf.loaders"
    system "env LANG=C DYLD_LIBRARY_PATH=${destroot}${prefix}/lib ${destroot}${prefix}/bin/gtk-query-immodules-2.0 ${destroot}${prefix}/lib/gtk-2.0/2.10.0/immodules/*.so | sed -e 's|${destroot}||g' > ${destroot}${prefix}/etc/gtk-2.0/gtk.immodules"
}

post-activate	{
    system "gdk-pixbuf-query-loaders ${prefix}/lib/gtk-2.0/2.10.0/loaders/*.so > ${prefix}/etc/gtk-2.0/gdk-pixbuf.loaders"
}

livecheck.check regex
livecheck.url   ftp://ftp.gtk.org/pub/gtk/${branch}/
livecheck.regex {LATEST-(\d+(?:\.\d+)*)}

