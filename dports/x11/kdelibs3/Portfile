# $Id: Portfile,v 1.32 2005/08/08 07:04:12 ben Exp $

PortSystem 1.0
name		kdelibs3
version		3.4.1
categories	x11
maintainers	ben@opendarwin.org
description	Essential libraries for KDE applications \
		NB KDE sound does not work. \
		** This port needs testing **
platforms	darwin
master_sites	kde:stable/${version}/src \
		http://ranger.befunk.com/fink/:admin \
		http://ranger.befunk.com/darwin/:darwin
extract.suffix	.tar.bz2
use_bzip2	yes
distname	kdelibs-${version}
distfiles	${distname}.tar.bz2 \
		kde-admindir-3.4.0-6.tar.bz2:admin \
		detect-autoconf.tar.bz2:darwin

depends_lib	lib:libart_lgpl_2:libart_lgpl \
		lib:libaudiofile.0:audiofile lib:libbz2:bzip2 \
		lib:libiconv.2:libiconv \
		lib:libjpeg.62:jpeg lib:libmad:mad lib:libogg:libogg \
		lib:libpcre:pcre \
		lib:libpng.3:libpng lib:libtiff.3:tiff lib:libqt-mt.3.3.4:qt3 \
		lib:libvorbis.0:libvorbis lib:libxml2.2:libxml2 \
		lib:libxslt:libxslt \
		lib:libX11.6:XFree86 lib:libintl.3:gettext \
		lib:libpoll:poll-emulator \
		lib:libIex:OpenEXR \
		lib:libusb:libusb \
		lib:libcrypto:openssl \
		lib:libfl:libflex \
		lib:libaspell:aspell

checksums	kdelibs-${version}.tar.bz2 md5  67224e6b55856c23b0a162cab17dd1b4 \
		kde-admindir-3.4.0-6.tar.bz2 md5 5d0274369eba8c862178ba8e26639cc3 \
		detect-autoconf.tar.bz2 md5 1f511627496be40174169dbab4d6d78a

set env(PATH) "/usr/X11R6/bin:$env(PATH):${prefix}/bin"

set tigerhack  {}

platform darwin 6 {
		depends_lib-append	lib:libdl:dlcompat
}

variant apidox {
depends_lib-append port:doxygen
build.target       all apidox
destroot.target    install-all install-apidox
}

patchfiles	kdelibs3.patch
patch.args	-p1

post-patch      {
		system "cd '${worksrcpath}' && if test -d ../admin; then cp -Rf ../admin/ admin; fi"
		system "cd '${worksrcpath}' && if test -d ../libltdl; then cp -Rf ../libltdl/ libltdl; fi"

		foreach file [glob admin/*] {
		    reinplace "s|-O2|-Os|g" $file
		    reinplace "s|doc/HTML|doc/kde|g" $file
		    reinplace "s|/usr/share/doc/packages/qt3/html|${prefix}/share/doc/qt3/html|g" $file
		    reinplace "s|HAVE_GCC_VISIBILITY=1|HAVE_GCC_VISIBILITY=0|g" $file
		    reinplace "s|-fvisibility=hidden -fvisibility-inlines-hidden||g" $file
		}
		system "cd '${worksrcpath}' && make -f admin/Makefile.common cvs"
}

configure.env	CC=gcc-3.3 CXX=g++-3.3 \
		PREFIX=${prefix} \
		FREETYPE_CONFIG=${prefix}/bin/freetype-config \
		LD_TWOLEVEL_NAMESPACE=true \
		LDFLAGS='-L/usr/X11R6/lib -L${prefix}/lib' \
		ACLOCALFLAGS='-I libltdl' \
		CFLAGS='-Os -fPIC' \
		CXXFLAGS='-Os -fPIC' \
		CPPFLAGS='-I/usr/X11R6/include -I${prefix}/include/freetype2/freetype -I${prefix}/include/fontconfig -I${prefix}/include/X11/Xft -I${prefix}/include/X11/extensions -I${prefix}/include/gssapi -I${prefix}/include -I${prefix}/include/qt3 -no-cpp-precomp -fno-common -DMACOSX -UHAVE_REALTIME_SCHED ${tigerhack}' \
		LIBS='-L/usr/X11R6/lib -L${prefix}/lib' \
		SED="sed" \
		ALL_LIBRARIES='-L/usr/X11R6/lib -L${prefix}/lib' \
		PATH="/usr/X11R6/bin:$env(PATH):${prefix}/bin" \
		HOME=/tmp \
		QTDIR=${prefix} \
		lt_cv_sys_max_cmd_len=65536

configure.cmd   export CC PREFIX FREETYPE_CONFIG LD_TWOLEVEL_NAMESPACE LD_FLAGS ACLOCALFLAGS \
		CFLAGS CXXFLAGS CPPFLAGS LIBS SED ALL_LIBRARIES PATH \
		HOME QTDIR lt_cv_sys_max_cmd_len && \
		./configure

configure.args	--prefix='${prefix}' --includedir='${prefix}/include' --libdir='${prefix}/lib' \
		--with-extra-includes='${prefix}/include:/usr/include/gssapi' \
		--with-extra-libs='${prefix}/lib' \
		--with-qt-dir='${prefix}' --with-qt-includes='${prefix}/include/qt3' \
		--enable-rpath --with-pic --enable-shared=yes --enable-static=no --enable-mt \
		--libexecdir='${prefix}/lib' --with-xinerama --with-pam --disable-final \
		--disable-dependency-tracking --enable-cups --with-ldap \
		--mandir=${prefix}/share/man --with-pam --with-distribution='DarwinPorts/Mac OS X' \
		--with-ssl-dir=/usr --with-ssl --with-gssapi=framework --disable-dependency-tracking --without-arts

build.env	${configure.env}
build.cmd       export CC PREFIX FREETYPE_CONFIG LD_TWOLEVEL_NAMESPACE LD_FLAGS ACLOCALFLAGS \
		CFLAGS CXXFLAGS CPPFLAGS LIBS DYLD_LIBRARY_PATH LD_LIBRARY_PATH SED ALL_LIBRARIES PATH \
		HOME QTDIR lt_cv_sys_max_cmd_len && \
		make
build.target	all

destroot.args   -j1
destroot.target install

post-destroot   {
		system "rm -rf ${destroot}${prefix}/share/icons/hicolor/index.theme"
		eval xinstall -m 644 [glob ${worksrcpath}/darwin/*] ${destroot}${prefix}/share/config
}
