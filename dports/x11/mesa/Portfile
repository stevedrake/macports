# $Id$

PortSystem          1.0

name                mesa
version             7.2
revision            6
set ASGLX_version   53
categories          x11 graphics
maintainers         jeremyhu andrea.damore openmaintainer
description         Mesa 3D Graphics Library
long_description    Mesa is an open-source implementation of the OpenGL specification, a system for rendering interactive 3D graphics.

homepage            http://mesa3d.sourceforge.net/
distfiles           MesaLib-${version}.tar.bz2:mesa \
                    MesaGLUT-${version}.tar.bz2:mesa \
                    MesaDemos-${version}.tar.bz2:mesa \
                    AppleSGLX-${ASGLX_version}.tar.bz2:xq
worksrcdir          Mesa-${version}
platforms           macosx darwin
use_bzip2           yes
master_sites        sourceforge:mesa3d:mesa \
                    http://xquartz.macosforge.org/downloads/src/:xq

checksums           MesaLib-7.2.tar.bz2 \
                    md5     04d379292e023df0b0266825cb0dbde5 \
                    sha1    a6dce814cc56a562890ab79cf4e205f62459a29c \
                    rmd160  1e7c2cc6aa27ebaf7e726ac2086c10a5155d0832 \
                    MesaGLUT-7.2.tar.bz2 \
                    md5     f67daf93e12c4a459703bbf3e4004e31 \
                    sha1    2d969fc8214622b93bcc594c36e56bb573678d05 \
                    rmd160  e60a98f3e8a16b219f7d68231ecbb84f9b3a9963 \
                    MesaDemos-7.2.tar.bz2 \
                    md5     22e03dc4038cd63f32c21eb60994892b \
                    sha1    3d7b9b3ee84ed3637849f7598faf3d60c5a2a9fd \
                    rmd160  123c9ebb2a61581415e9e3757e5bbc29128c3380 \
                    AppleSGLX-53.tar.bz2 \
                    md5     a5e72066c985888bfcd0d94f520d3ee4 \
                    sha1    ece3287ea4889c244a7d1e80ac9e7f22d508d378 \
                    rmd160  0c8d11f4e759e878ca3fcc591d49303df33ab277

patch.pre_args -p1
patchfiles \
	mesa-7.2-36c3e889d0cfbb040f7b860279987cd6ff5951f4.patch \
	mesa-7.2-Os.patch \
	mesa-7.2-drm_headers.patch \
	mesa-7.2-x11dir.patch

# glut port is here to "clean out" the glut port if it's installed to avoid conflict
depends_build \
	port:xorg-glproto \
	bin:makedepend:makedepend \
	port:glut \
	bin:tclsh8.5:tcl

depends_lib \
	port:xorg-libXext

use_configure  no
use_parallel_build yes

build.target default
build.args-append INSTALL_DIR=${prefix}
destroot.args-append INSTALL_DIR=${prefix}

variant universal {
	if {![info exists universal_archs]} {
		set universal_archs {i386 ppc}
	}
	build.args-append RC_ARCHS="${universal_archs}"
	build.args-append RC_CFLAGS="${configure.universal_cflags}"
}

if { ![file exists /usr/include/Xplugin.h] } {
        # Xplugin.h is missing on Tiger
        configure.cppflags-append -I${filespath}/include
}

if {! [variant_isset system_x11]} {
	default_variants +hw_render

	post-extract {
		if {! [file exists "${worksrcpath}/configs/current"]} { 
			ln -s darwin ${worksrcpath}/configs/current
		}
	}

	# This next hunk supports building -system_x11 mesa on a system that is otherwise +system_x11
	pre-build {
		if {! [file exists ${prefix}/lib/libX11.dylib]} {
			build.args-append X11_DIR=${x11prefix}
			destroot.args-append X11_DIR=${x11prefix}	
		}
	}

	post-destroot {
		xinstall -o root -m 755 -d "${destroot}${prefix}/bin"
		xinstall -o root -m 755 "${worksrcpath}/progs/xdemos/glxgears" "${destroot}/${prefix}/bin"
		xinstall -o root -m 755 "${worksrcpath}/progs/xdemos/glxinfo" "${destroot}/${prefix}/bin"
	}

}

variant hw_render conflicts system_x11 description {Install a libGL.dylib that uses OpenGL.framework to allow rendering on your graphics hardware} {
	#post-patch {
	#	system "cd ${worksrcpath}/../AppleSGLX-${ASGLX_version} && cat ${filespath}/asglx-*.patch | patch -p0"
	#}

	post-build {
		system "cd ${worksrcpath}/../AppleSGLX-${ASGLX_version} && ${build.cmd} builds/libGL.1.2.dylib ${build.args} LDFLAGS='${configure.ldflags}' CFLAGS='${configure.cppflags} ${configure.cflags}' INSTALL_DIR='${prefix}'"
#               Use this if we want to install our glxgears and glxinfo instead of the glut version
#		system "cd ${worksrcpath}/../AppleSGLX-${ASGLX_version} && ${build.cmd} programs ${build.args} LDFLAGS='${configure.ldflags}' CFLAGS='${configure.cppflags} ${configure.cflags}' INSTALL_DIR='${prefix}'"
	}

	post-destroot {
		system "cd ${worksrcpath}/../AppleSGLX-${ASGLX_version} && ${destroot.cmd} ${destroot.target} ${destroot.destdir} ${destroot.args} INSTALL_DIR='${prefix}'"
#               Use this if we want to install our glxgears and glxinfo instead of the glut version
#		system "cd ${worksrcpath}/../AppleSGLX-${ASGLX_version} && ${destroot.cmd} install_programs ${destroot.destdir} ${destroot.args} INSTALL_DIR='${prefix}'"
	}
}

variant system_x11 conflicts hw_render description {Install a stub package to use the system X11 libraries rather than MacPorts} {
	if { [file exists ${x11prefix}/lib/libGLU.dylib] && ! [string equal ${prefix} ${x11prefix}] } {
		depends_build
		depends_lib
		depends_run
		distfiles
		fetch           { }
		checksum        { }
		extract         { }
		patch           { }
		build           { }
		destroot        {
			xinstall -d ${destroot}${prefix}/share/doc/${name}
			system "echo ${long_description} > ${destroot}${prefix}/share/doc/${name}/README.txt"
		}
		use_configure no
	}
}
