# $Id$

PortSystem          1.0

name                mesa
version             7.2
revision            3
set ASGLX_version   49
categories          x11 graphics
maintainers         jeremyhu andrea.damore openmaintainer
description         Mesa 3D Graphics Library
long_description    Mesa is an open-source implementation of the OpenGL specification, a system for rendering interactive 3D graphics.

homepage            http://mesa3d.sourceforge.net/
distfiles           MesaLib-${version}.tar.bz2:mesa \
                    AppleSGLX-${ASGLX_version}.tar.bz2:xq
worksrcdir          Mesa-${version}
platforms           macosx darwin
use_bzip2           yes
master_sites        sourceforge:mesa3d:mesa \
                    http://xquartz.macosforge.org/downloads/src/:xq

checksums           MesaLib-7.2.tar.bz2 \
                    md5     04d379292e023df0b0266825cb0dbde5 \
                    sha1    a6dce814cc56a562890ab79cf4e205f62459a29c \
                    rmd160  1e7c2cc6aa27ebaf7e726ac2086c10a5155d0832 \
                    AppleSGLX-49.tar.bz2 \
                    md5     68843df2cf0f2d3e5411b190b04d90db \
                    sha1    56e3a1e0654297993872eec604d575093c6dc5f4 \
                    rmd160  063a6a066c00d069e00c42fbac6962445a4c9845

patch.pre_args -p1
patchfiles \
	mesa-7.2-36c3e889d0cfbb040f7b860279987cd6ff5951f4.patch \
	mesa-7.2-Os.patch \
	mesa-7.2-drm_headers.patch \
	mesa-7.2-x11dir.patch

depends_build \
	port:xorg-glproto \
	bin:makedepend:makedepend

depends_lib \
	port:xorg-libXext

use_configure  no

build.target default
build.args-append INSTALL_DIR=${prefix}
destroot.args-append INSTALL_DIR=${prefix}

variant universal {
	if {![info exists universal_archs]} {
		set universal_archs {i386 ppc}
	}
	build.args-append RC_ARCHS="${universal_archs}"
	build.args-append RC_CFLAGS="${configure.universal_cflags}"
}

if { ![file exists /usr/include/Xplugin.h] } {
        # Xplugin.h is missing on Tiger
        configure.cppflags-append -I${filespath}/include
}

if {! [variant_isset system_x11]} {
	if {${os.major} >= 9} {
		default_variants +hw_render
	}

	post-extract {
		if {! [file exists "${worksrcpath}/configs/current"]} { 
			ln -s darwin ${worksrcpath}/configs/current
		}
	}

	# This next hunk supports building -system_x11 mesa on a system that is otherwise +system_x11
	if {! [file exists ${prefix}/lib/libX11.dylib]} {
		build.args-append X11_DIR=${x11prefix}
		destroot.args-append X11_DIR=${x11prefix}	
	}
}

variant hw_render conflicts system_x11 description {Install a libGL.dylib that uses OpenGL.framework to allow rendering on your graphics hardware} {
	if {${os.major} < 9} {
		ui_error "+hw_render requires Mac OS X 10.5 or greater"
		error "+hw_render requires Mac OS X 10.5 or greater"
	}

	#post-patch {
	#	system "cd ${worksrcpath}/../AppleSGLX-${ASGLX_version} && cat ${filespath}/asglx-*.patch | patch -p0"
	#}

	post-build {
		system "cd ${worksrcpath}/../AppleSGLX-${ASGLX_version} && ${build.cmd} libGL.1.2.dylib ${build.args} LDFLAGS='-L\$(X11_DIR)/lib -Wl,-single_module' INCLUDE='-I. -Iinclude -Iinclude/internal -DGLX_ALIAS_UNSUPPORTED -Igl ${configure.cppflags}'"
	}

	post-destroot {
		system "cd ${worksrcpath}/../AppleSGLX-${ASGLX_version} && ${destroot.cmd} ${destroot.target} ${destroot.destdir} ${destroot.args}"
	}
}

variant system_x11 conflicts hw_render description {Install a stub package to use the system X11 libraries rather than MacPorts} {
	build.args-append X11_DIR=${x11prefix}
	destroot.args-append X11_DIR=${x11prefix}

	if { [file exists ${x11prefix}/lib/libGLU.dylib] && ! [string equal ${prefix} ${x11prefix}] } {
		depends_build
		depends_lib
		depends_run
		distfiles
		fetch           { }
		checksum        { }
		extract         { }
		patch           { }
		build           { }
		destroot        {
			xinstall -d ${destroot}${prefix}/share/doc/${name}
			system "echo ${long_description} > ${destroot}${prefix}/share/doc/${name}/README.txt"
		}
		use_configure no
	}
}
