# $Id$

PortSystem          1.0

name                mesa
version             7.2
revision            2
set ASGLX_version   48
categories          x11 graphics
maintainers         jeremyhu andrea.damore openmaintainer
description         Mesa 3D Graphics Library
long_description    Mesa is an open-source implementation of the OpenGL specification, a system for rendering interactive 3D graphics.

homepage            http://mesa3d.sourceforge.net/
distfiles           MesaLib-${version}.tar.bz2:mesa \
                    AppleSGLX-${ASGLX_version}.tar.bz2:xq
worksrcdir          Mesa-${version}
platforms           macosx darwin
use_bzip2           yes
master_sites        sourceforge:mesa3d:mesa \
                    http://xquartz.macosforge.org/downloads/src/:xq

checksums           MesaLib-7.2.tar.bz2 \
                    md5     04d379292e023df0b0266825cb0dbde5 \
                    sha1    a6dce814cc56a562890ab79cf4e205f62459a29c \
                    rmd160  1e7c2cc6aa27ebaf7e726ac2086c10a5155d0832 \
                    AppleSGLX-48.tar.bz2 \
                    md5     30e172ba7f4afd08131c3d79319297b7 \
                    sha1    5acd07db348a37348022761321616ec2d431553b \
                    rmd160  d629460f877aa0a748f7b60925ee13a9343a93cf

patch.pre_args -p1
patchfiles \
	mesa-7.2-36c3e889d0cfbb040f7b860279987cd6ff5951f4.patch \
	mesa-7.2-Os.patch \
	mesa-7.2-drm_headers.patch \
	mesa-7.2-x11dir.patch

depends_build \
	port:xorg-glproto \
	bin:makedepend:makedepend

depends_lib \
	port:xorg-libXext

use_configure  no

build.target default
build.args-append INSTALL_DIR=${prefix}
destroot.args-append INSTALL_DIR=${prefix}

variant universal {
	if {![info exists universal_archs]} {
		set universal_archs {i386 ppc}
	}
	build.args-append RC_ARCHS="${universal_archs}"
}

if {${os.major} >= 9 && ! [variant_isset system_x11]} {
	default_variants +hw_render
}

if {! [variant_isset system_x11]} {
	post-extract {
		if {! [file exists "${worksrcpath}/configs/current"]} { 
			ln -s darwin ${worksrcpath}/configs/current
		}
	}

	# This next hunk supports building -system_x11 mesa on a system that is otherwise +system_x11
	if {! [file exists ${prefix}/lib/libX11.dylib]} {
		build.args-append X11_DIR=${x11prefix}
		destroot.args-append X11_DIR=${x11prefix}	
	}
}

variant hw_render conflicts system_x11 description {Install a libGL.dylib that} {
	post-build {
		system "cd ${worksrcpath}/../AppleSGLX-${ASGLX_version} && ${build.cmd} ${build.args}"
	}
	post-destroot {
		system "cd ${worksrcpath}/../AppleSGLX-${ASGLX_version} && ${destroot.cmd} ${destroot.target} ${destroot.destdir} ${destroot.args}"
	}
}

variant system_x11 conflicts hw_render description {Install a stub package to use the system X11 libraries rather than MacPorts} {
	build.args-append X11_DIR=${x11prefix}
	destroot.args-append X11_DIR=${x11prefix}

	if { [file exists ${x11prefix}/lib/libGLU.dylib] && ! [string equal ${prefix} ${x11prefix}] } {
		depends_build
		depends_lib
		depends_run
		distfiles
		fetch           { }
		checksum        { }
		extract         { }
		patch           { }
		build           { }
		destroot        {
			xinstall -d ${destroot}${prefix}/share/doc/${name}
			system "echo ${long_description} > ${destroot}${prefix}/share/doc/${name}/README.txt"
		}
		use_configure no
	}
}
