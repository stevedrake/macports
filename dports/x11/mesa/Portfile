# $Id$

PortSystem          1.0

name                mesa
version             7.2
revision            1
categories          x11 graphics
maintainers         jeremyhu andrea.damore
description         Mesa 3D Graphics Library
long_description    Mesa is an open-source implementation of the OpenGL specification, a system for rendering interactive 3D graphics.

homepage            http://mesa3d.sourceforge.net/
distfiles           MesaLib-${version}.tar.bz2
worksrcdir          Mesa-${version}
platforms           darwin
use_bzip2           yes
master_sites        sourceforge:mesa3d

checksums           md5     04d379292e023df0b0266825cb0dbde5 \
                   sha1    a6dce814cc56a562890ab79cf4e205f62459a29c \
                   rmd160  1e7c2cc6aa27ebaf7e726ac2086c10a5155d0832

patch.pre_args -p1
patchfiles \
	mesa-7.2-36c3e889d0cfbb040f7b860279987cd6ff5951f4.patch \
	mesa-7.2-Os.patch \
	mesa-7.2-drm_headers.patch \
	mesa-7.2-x11dir.patch

depends_build \
	port:xorg-glproto \
	bin:makedepend:makedepend

depends_lib \
	port:xorg-libXext

use_configure  no

post-extract {
	if {! [file exists "${worksrcpath}/configs/current"]} { 
		ln -s darwin ${worksrcpath}/configs/current
	}
}

build.target default
build.args-append INSTALL_DIR=${prefix} X11_DIR=${x11prefix}

destroot.args-append INSTALL_DIR=${prefix} X11_DIR=${x11prefix}

variant universal {
	if {![info exists universal_archs]} {
		set universal_archs {i386 ppc}
	}
	build.args-append RC_ARCHS="${universal_archs}"
}

variant system_x11 description {Install a stub package to use the system X11 libraries rather than MacPorts} {
	if { [file exists ${x11prefix}/lib/libGLU.dylib] && ! [string equal ${prefix} ${x11prefix}] } {
		depends_build
		depends_lib
		depends_run
		distfiles
		fetch           { }
		checksum        { }
		extract         { }
		patch           { }
		build           { }
		destroot        {
			xinstall -d ${destroot}${prefix}/share/doc/${name}
			system "echo ${long_description} > ${destroot}${prefix}/share/doc/${name}/README.txt"
		}
		use_configure no
	}
}
