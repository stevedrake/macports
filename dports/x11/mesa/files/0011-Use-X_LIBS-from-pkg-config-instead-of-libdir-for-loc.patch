From ad1586636d23fc7e032de7ce293b74b376348e74 Mon Sep 17 00:00:00 2001
From: Jeff Smith <whydoubt@yahoo.com>
Date: Fri, 12 Mar 2010 18:55:09 -0600
Subject: [PATCH 11/11] Use X_LIBS from pkg-config, instead of libdir, for locating libX11

Signed-off-by: Jeff Smith <whydoubt@yahoo.com>
Signed-off-by: Dan Nicholson <dbn.lists@gmail.com>
(cherry picked from commit 8d86d395dcf6a5f192b6987485bb7aef49f1fefc)
---
 configs/autoconf.in   |    2 ++
 configure.ac          |    4 +++-
 progs/egl/Makefile    |    6 +++---
 progs/xdemos/Makefile |    4 ++--
 4 files changed, 10 insertions(+), 6 deletions(-)

diff --git Mesa-7.8/configs/autoconf.in Mesa-7.8/configs/autoconf.in
index 3063787..f07035a 100644
--- Mesa-7.8/configs/autoconf.in
+++ Mesa-7.8/configs/autoconf.in
@@ -24,6 +24,8 @@ RADEON_CFLAGS = @RADEON_CFLAGS@
 RADEON_LDFLAGS = @RADEON_LDFLAGS@
 INTEL_LIBS = @INTEL_LIBS@
 INTEL_CFLAGS = @INTEL_CFLAGS@
+X_LIBS = @X_LIBS@
+X_CFLAGS = @X_CFLAGS@
 
 # Assembler
 MESA_ASM_SOURCES = @MESA_ASM_SOURCES@
diff --git Mesa-7.8/configure.ac Mesa-7.8/configure.ac
index 61487c3..5f3d02d 100644
--- Mesa-7.8/configure.ac
+++ Mesa-7.8/configure.ac
@@ -547,7 +547,9 @@ else
     x11_pkgconfig=no
 fi
 dnl Use the autoconf macro if no pkg-config files
-if test "$x11_pkgconfig" = no; then
+if test "$x11_pkgconfig" = yes; then
+    PKG_CHECK_MODULES([X], [x11])
+else
     AC_PATH_XTRA
 fi
 
diff --git Mesa-7.8/progs/egl/Makefile Mesa-7.8/progs/egl/Makefile
index 25de6e1..5f51104 100644
--- Mesa-7.8/progs/egl/Makefile
+++ Mesa-7.8/progs/egl/Makefile
@@ -57,13 +57,13 @@ peglgears: peglgears.o $(HEADERS) $(LIB_DEP)
 	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $< $(LIBS) $(LIBDRM_LIB) -lm
 
 xeglgears: xeglgears.o $(HEADERS) $(LIB_DEP)
-	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $< $(LIBS) -lm -L$(libdir) -lX11
+	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $< $(LIBS) -lm $(X_LIBS)
 
 xeglthreads: xeglthreads.o $(HEADERS) $(LIB_DEP)
-	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $< $(LIBS) -lm -L$(libdir) -lX11
+	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $< $(LIBS) -lm $(X_LIBS)
 
 xegl_tri: xegl_tri.o $(HEADERS) $(LIB_DEP)
-	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $< $(LIBS) -lm -L$(libdir) -lX11
+	$(CC) $(CFLAGS) $(LDFLAGS) -o $@ $< $(LIBS) -lm $(X_LIBS)
 
 clean:
 	-rm -f *.o *~
diff --git Mesa-7.8/progs/xdemos/Makefile Mesa-7.8/progs/xdemos/Makefile
index d81caab..038e21c 100644
--- Mesa-7.8/progs/xdemos/Makefile
+++ Mesa-7.8/progs/xdemos/Makefile
@@ -9,9 +9,9 @@ INCDIR = $(TOP)/include
 LIB_DEP = $(TOP)/$(LIB_DIR)/$(GL_LIB_NAME)
 
 # Add X11 and pthread libs to satisfy GNU gold.
-APP_LIB_DEPS += -lX11 -lpthread
+APP_LIB_DEPS += $(X_LIBS) -lpthread
 
-LIBS = -L$(TOP)/$(LIB_DIR) -l$(GL_LIB) -L$(libdir) $(APP_LIB_DEPS)
+LIBS = -L$(TOP)/$(LIB_DIR) -l$(GL_LIB) $(APP_LIB_DEPS)
 
 PROGS = \
 	corender \
-- 
1.7.0.3

