# $Id: Portfile,v 1.45 2006/03/13 09:37:58 takanori Exp $

PortSystem 1.0
name		qt3
version		3.3.5
revision	1
categories	x11
maintainers	ben@opendarwin.org takanori@opendarwin.org
description	Qt Tool Kit
long_description Qt 3 is a multiplatform C++ application development framework.
homepage	http://www.trolltech.com/products/qt/index.html
platforms	darwin
master_sites	ftp://ftp.trolltech.com/qt/source/:qt3 \
		http://ranger.befunk.com/fink/:fink
distname	qt-x11-free-${portversion}
distfiles	${distname}.tar.bz2:qt3 \
		qt-upstream-patches-0002.tar.bz2
use_bzip2	yes

depends_lib	lib:libGL.1:XFree86 \
		port:cups-headers \
		port:freetype \
		port:jpeg \
		port:libpng \
		port:perl5.8 \
		port:Xft2 \
		port:xrender \
		port:zlib

checksums	${distname}.tar.bz2 md5 05d04688c0c0230ed54e89102d689ca4 \
		qt-upstream-patches-0002.tar.bz2 md5 85bd46f2c4b820ae6b64271dae173b4b

platform darwin 8 {
	 	post-patch	{
			reinplace "s|#define QT_AOUT_UNDERSCORE||g" \
			  ${worksrcpath}/mkspecs/darwin-g++/qplatformdefs.h
		}
		configure.args-append -DTIGER_DLSYM_HACK=1
}

platform darwin 7 {
	 	post-patch	{
			reinplace "s|#define QT_AOUT_UNDERSCORE||g" \
			  ${worksrcpath}/mkspecs/darwin-g++/qplatformdefs.h
		}
		patchfiles-delete qt3-tiger.patch
		patchfiles-append qt3-panther.patch
}

#not tested on OSX 10.2.
platform darwin 6 {
		depends_lib-append lib:libdl:dlcompat
		configure.args-delete -lresolv
		patchfiles-delete qt3-tiger.patch
		patchfiles-append qt3-panther.patch
}

variant mysql {
		depends_lib-append lib:libmysqlclient.10:mysql
		configure.args-append -qt-sql-mysql -L${prefix}/lib/mysql \
			-I${prefix}/include/mysql -plugin-sql-mysql
}

variant odbc {
		depends_lib-append lib:libodbc.1:unixODBC
		configure.args-append -qt-sql-odbc -L${prefix}/lib \
			-I${prefix}/include -plugin-sql-odbc
}

variant psql {
		depends_lib-append lib:libpq.2:postgresql
		configure.args-append -qt-sql-psql -plugin-sql-psql
}

patch.pre_args  -p1
patchfiles      qt3-tiger.patch

post-patch	{
		reinplace "s|@PREFIX@|${prefix}|g" \
		${worksrcpath}/mkspecs/darwin-g++/qmake.conf

		foreach p { patches/qt-3.3.4-print-CJK.patch \
			    patches/qt-3.0.5-nodebug.patch \
			    patches/qt-x11-free-3.3.2-quiet.patch \
			    patches/qt-uic-nostdlib.patch \
			    patches/qt-x11-free-3.3.4-qfontdatabase_x11.patch \
			    patches/qt-3.3.3-gtkstyle.patch  \
			    patches/0038-dragobject-dont-prefer-unknown.rr.patch \
			    patches/0047-fix-kmenu-width.rr.diff \
			    patches/0048-qclipboard_hack_80072.rr.patch \
			    patches/0051-qtoolbar_77047.rr.patch \
			    patches/0056-khotkeys_input_84434.rr.patch \
			    patches/qt-x11-free-3.3.4-assistant_de.patch \
			    patches/qt-x11-free-3.3.4-fullscreen.patch \
			    patches/qt-x11-free-3.3.5-warning.patch } {
			    	system "cd ${worksrcpath} && patch -p1 --fuzz=4 < ${workpath}/${p}"
		}
}

configure.env	DYLD_FALLBACK_LIBRARY_PATH='${worksrcpath}/lib:/usr/lib' \
		INSTALL_ROOT='' \
		QMAKESPEC='${worksrcpath}/mkspecs/darwin-g++' \
		QTDIR='${worksrcpath}' \
		PREFIX='${prefix}' \
		NAME=qt3

configure.pre_args  {}

configure.cmd   export DYLD_FALLBACK_LIBRARY_PATH INSTALL_ROOT QMAKESPEC \
		QTDIR PREFIX NAME && cd ${worksrcpath} && \
		echo yes | sh ./configure

configure.args  -L${prefix}/lib -L/usr/X11R6/lib -L${worksrcpath}/lib \
		-I${prefix}/include -I/usr/X11R6/include -I${worksrcpath}/include \
		-buildkey qt3-jaguar \
		-platform darwin-g++ -xplatform darwin-g++ \
		-translationdir ${prefix}/share/qt3/translations \
		-prefix ${prefix} -bindir ${prefix}/bin \
		-libdir ${prefix}/lib -docdir ${prefix}/share/doc/qt3 \
		-datadir ${prefix}/share/qt3 -headerdir ${prefix}/include/qt3 \
		-plugindir ${prefix}/lib/qt3-plugins \
		-release -shared -no-exceptions -thread -stl \
		-qt-gif -plugin-imgfmt-png \
		-plugin-imgfmt-jpeg -plugin-imgfmt-mng \
		-system-libpng -system-libjpeg -system-zlib \
		-largefile -sm -xinerama -xrender -xft -xkb \
		-lresolv -cups

#workaround for upgrade problem.
pre-build   	{if {[file exists ${prefix}/lib/libqassistantclient.a]} { system "ranlib ${prefix}/lib/libqassistantclient.a" }}

build.env       ${configure.env}

build.cmd	export DYLD_FALLBACK_LIBRARY_PATH INSTALL_ROOT QMAKESPEC \
		QTDIR PREFIX NAME && cd ${worksrcpath} && make 

build.target	symlinks src-qmake src-moc sub-src sub-tools

build.args	{}

destroot.env    PREFIX='${destroot}${prefix}' \
		VERSION='${version}' \
		WORKSRCPATH=${worksrcpath}
destroot.cmd	sh ${portpath}/${filesdir}/qt-install.sh
destroot.args	 {}
destroot.destdir {}
destroot.target  {}

post-activate	 {
		 system "ranlib ${prefix}/lib/libqassistantclient.a"
}
