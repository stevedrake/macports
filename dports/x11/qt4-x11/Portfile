# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:et:sw=4:ts=4:sts=4
# $Id:$

PortSystem          1.0

name                qt4-x11
version             4.3.4
categories	        x11
maintainers         mcalhoun
homepage            http://www.trolltech.com/
platforms           darwin
description         Qt Tool Kit
long_description    This is Qt, TrollTech's C++ toolkit for writing cross-platform GUI applications.
master_sites        ftp://ftp.trolltech.com/qt/source/ \
                    http://ftp.iasi.roedu.net/mirrors/ftp.trolltech.com/qt/source/ \
                    http://ftp.ntua.gr/pub/X11/Qt/qt/source/ \
                    http://wftp.tu-chemnitz.de/pub/Qt/qt/source/
distname            qt-x11-opensource-src-${version}
checksums \
    md5 9499101ec54eb7b0de195b3c5e3ffa93 \
    sha1 639f6469d5aa07c51c2aa6795f8e3de3aab8cd25 \
    rmd160 eb081e599e61bcaa126981aecbe2db480be35eca

depends_lib         port:libmng port:libpng port:jpeg port:tiff port:libiconv

# have to build with Apple gcc because of -fconstant-cfstrings
configure.compiler  gcc-4.0
configure.cmd       "echo yes | ./configure"
configure.pre_args

configure.args \
    -v         \
    -prefix         '${prefix}'                            \
    -docdir         '${prefix}/share/doc/${portname}'      \
    -datadir        '${prefix}/share/${portname}'          \
    -headerdir      '${prefix}/include/${portname}'        \
    -plugindir      '${prefix}/lib/${portname}-plugins'    \
    -translationdir '${prefix}/share/${portname}/translations' \
    -optimized-qmake    -release        -shared         -stl                \
    -no-openssl         -largefile                                          \
    -system-libpng      -system-libjpeg -system-libmng  -system-libtiff     \
    -system-zlib        -qt-gif                                             \
    -no-sql-ibase       -no-sql-mysql   -no-sql-odbc    -no-sql-psql        \
    -no-sql-sqlite      -no-nis         -no-cups                            \
    -make libs          -make tools                                         \
    -I${worksrcpath}/include -I${prefix}/include  \
    -L${worksrcpath}/lib -L${prefix}/lib -lresolv \
    -no-rpath

build.target        first

destroot.destdir    INSTALL_ROOT="${destroot}"

patchfiles \
    patch-Makefile.unix.diff patch-qlibrary_unix.cpp.diff patch-q3process_unix.cpp.diff \
    patch-qprocess_unix.cpp.diff patch-qmake.conf.diff

post-patch {
    reinplace "s|ARCH=macosx|ARCH=`uname -p`|g" ${worksrcpath}/configure
    reinplace "s|Q_OS_DARWIN|Q_WS_MAC|g" ${worksrcpath}/qmake/generators/mac/pbuilder_pbx.cpp
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/demos/qtdemo/colors.cpp
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/examples/dialogs/standarddialogs/dialog.cpp
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/examples/tools/plugandpaint/mainwindow.cpp
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/qmake/main.cpp
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/src/corelib/codecs/qiconvcodec.cpp
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/src/corelib/codecs/qiconvcodec_p.h
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/src/corelib/tools/qstring.cpp
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/src/corelib/global/qglobal.cpp
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/src/corelib/io/qfsfileengine_unix.cpp
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/src/corelib/global/qlibraryinfo.cpp
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/src/corelib/tools/qlocale.cpp
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/src/corelib/io/qsettings.cpp
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/qmake/option.cpp
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/src/corelib/io/qsettings_p.h
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/src/corelib/plugin/qlibrary.cpp
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/src/corelib/tools/qpoint.h
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/src/corelib/tools/qrect.h
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/src/gui/dialogs/qprintdialog.h
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/src/gui/kernel/qapplication.h
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/src/gui/kernel/qapplication_p.h
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/src/gui/widgets/qdockwidget.cpp
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/src/corelib/thread/qthread_unix.cpp
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/src/gui/text/qfont.cpp
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/src/gui/text/qfontdatabase.cpp
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/src/plugins/accessible/widgets/simplewidgets.cpp
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/src/qt3support/other/q3accel.cpp
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/src/qt3support/other/q3polygonscanner.cpp
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/src/qt3support/text/q3textedit.cpp
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/src/sql/drivers/odbc/qsql_odbc.h
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/src/tools/uic/cpp/cppwriteinitialization.cpp
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/src/tools/uic/cpp/cppwriteinitialization.h
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/src/tools/uic/cpp/cppwriteinitialization.h
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/tools/assistant/lib/qassistantclient.cpp
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/tools/designer/src/lib/uilib/abstractformbuilder.cpp
    reinplace "s|Q_OS_MAC|Q_WS_MAC|g" ${worksrcpath}/tools/linguist/shared/proparserutils.h
}

post-destroot {
    foreach doc {INSTALL LICENSE.GPL2 LICENSE.GPL3 LICENSE.QPL OPENSOURCE-NOTICE.TXT README \
                     GPL_EXCEPTION_ADDENDUM.TXT GPL_EXCEPTION.TXT} {
        xinstall -c -m 644 ${worksrcpath}/$doc ${destroot}${prefix}/share/doc/${portname}
    }
    system "cd ${destroot}/${prefix}/lib && ln -s libQtAssistantClient.dylib libQtAssistant.dylib"
}

variant dbus description "Include DBus support" {
    depends_lib-append      port:dbus
    configure.args-append   -qdbus
}

variant nis description "Include Network Information Service (NIS) support" {
    configure.args-delete   -no-nis
    configure.args-append   -nis
}

variant cups description "Include Common Unix Printing System (CUPS) support" {
    configure.args-delete   -no-cups
    configure.args-append   -cups
}

variant mysql conflicts mysql5 description "Include support for SQL via mysql driver" {
    depends_lib-append      lib:libmysqlclient.12:mysql4
    configure.args-delete   -no-sql-mysql
    configure.args-append   -qt-sql-mysql -plugin-sql-mysql \
        -I${prefix}/include/mysql -L${prefix}/lib/mysql
}

variant mysql5 conflicts mysql description "Include support for SQL via mysql5 driver" {
    depends_lib-append      port:mysql5
    configure.args-delete   -no-sql-mysql
    configure.args-append   -qt-sql-mysql -plugin-sql-mysql \
        -I${prefix}/include/mysql5/mysql -L${prefix}/lib/mysql5/mysql
}

variant sqlite description "Include support for SQL via sqlite driver" {
	depends_lib-append      port:sqlite3
	configure.args-delete	-no-sql-sqlite
	configure.args-append	-qt-sql-sqlite -plugin-sql-sqlite
    # -system-sqlite
}

variant ssl description "Include OpenSSL support" {
    depends_lib-append      port:openssl
    configure.args-delete   -no-openssl
    configure.args-append   -openssl
}

variant examples description "Build Qt examples" {
    configure.args-append   -make examples -examplesdir ${prefix}/share/${portname}/examples
}

variant demos description "Build Qt demos" {
    configure.args-append   -make demos -demosdir ${prefix}/share/${portname}/demos
}

livecheck.check     regex
livecheck.url       http://trolltech.com/developer/downloads/qt/x11
livecheck.regex     "The current version of Qt/X11 Open Source Edition is (4(?:\\.\\d+)*)"
