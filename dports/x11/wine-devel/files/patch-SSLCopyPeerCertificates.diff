--- configure.ac.orig	2011-09-23 12:46:51.000000000 -0500
+++ configure.ac	2011-10-08 19:42:28.000000000 -0500
@@ -711,6 +711,10 @@
     if test "$ac_cv_header_Security_Security_h" = "yes"
     then
         AC_SUBST(SECURITYLIB,"-framework Security -framework CoreFoundation")
+        ac_save_LIBS="$LIBS"
+        LIBS="$LIBS $SECURITYLIB"
+        AC_CHECK_FUNCS(SSLCopyPeerCertificates)
+        LIBS="$ac_save_LIBS"
         with_gnutls=${with_gnutls:-no}
     fi
     if test "$ac_cv_header_CoreAudio_CoreAudio_h" = "yes" -a "$ac_cv_header_AudioUnit_AudioUnit_h" = "yes"
--- dlls/secur32/schannel.c.orig	2011-09-23 12:46:51.000000000 -0500
+++ dlls/secur32/schannel.c	2011-10-08 19:51:27.000000000 -0500
@@ -33,7 +33,7 @@
 
 WINE_DEFAULT_DEBUG_CHANNEL(secur32);
 
-#if defined(SONAME_LIBGNUTLS) || defined (HAVE_SECURITY_SECURITY_H)
+#if defined(SONAME_LIBGNUTLS) || (defined(HAVE_SECURITY_SECURITY_H) && defined(HAVE_SSLCOPYPEERCERTIFICATES))
 
 #define SCHAN_INVALID_HANDLE ~0UL
 
@@ -1316,7 +1316,7 @@
     schan_imp_deinit();
 }
 
-#else /* SONAME_LIBGNUTLS || HAVE_SECURITY_SECURITY_H */
+#else /* SONAME_LIBGNUTLS || (HAVE_SECURITY_SECURITY_H && HAVE_SSLCOPYPEERCERTIFICATES) */
 
 void SECUR32_initSchannelSP(void)
 {
@@ -1325,4 +1325,4 @@
 
 void SECUR32_deinitSchannelSP(void) {}
 
-#endif /* SONAME_LIBGNUTLS || HAVE_SECURITY_SECURITY_H */
+#endif /* SONAME_LIBGNUTLS || (HAVE_SECURITY_SECURITY_H && HAVE_SSLCOPYPEERCERTIFICATES) */
--- dlls/secur32/schannel_gnutls.c.orig	2011-09-23 12:46:51.000000000 -0500
+++ dlls/secur32/schannel_gnutls.c	2011-10-08 19:50:15.000000000 -0500
@@ -37,7 +37,7 @@
 
 WINE_DEFAULT_DEBUG_CHANNEL(secur32);
 
-#if defined(SONAME_LIBGNUTLS) && !defined(HAVE_SECURITY_SECURITY_H)
+#if defined(SONAME_LIBGNUTLS) && !(defined(HAVE_SECURITY_SECURITY_H) && defined(HAVE_SSLCOPYPEERCERTIFICATES))
 
 static void *libgnutls_handle;
 #define MAKE_FUNCPTR(f) static typeof(f) * p##f
@@ -459,4 +459,4 @@
     libgnutls_handle = NULL;
 }
 
-#endif /* SONAME_LIBGNUTLS && !HAVE_SECURITY_SECURITY_H */
+#endif /* SONAME_LIBGNUTLS && !(HAVE_SECURITY_SECURITY_H && HAVE_SSLCOPYPEERCERTIFICATES) */
--- dlls/secur32/schannel_macosx.c.orig	2011-09-23 12:46:51.000000000 -0500
+++ dlls/secur32/schannel_macosx.c	2011-10-08 19:49:33.000000000 -0500
@@ -23,7 +23,7 @@
 #include "wine/port.h"
 
 #include <stdarg.h>
-#ifdef HAVE_SECURITY_SECURITY_H
+#if defined(HAVE_SECURITY_SECURITY_H) && defined(HAVE_SSLCOPYPEERCERTIFICATES)
 #include <Security/Security.h>
 #define GetCurrentThread GetCurrentThread_Mac
 #define LoadResource LoadResource_Mac
@@ -43,7 +43,7 @@
 
 WINE_DEFAULT_DEBUG_CHANNEL(secur32);
 
-#ifdef HAVE_SECURITY_SECURITY_H
+#if defined(HAVE_SECURITY_SECURITY_H) && defined(HAVE_SSLCOPYPEERCERTIFICATES)
 
 struct mac_session {
     SSLContextRef context;
@@ -786,4 +786,4 @@
     TRACE("()\n");
 }
 
-#endif /* HAVE_SECURITY_SECURITY_H */
+#endif /* HAVE_SECURITY_SECURITY_H && HAVE_SSLCOPYPEERCERTIFICATES */
