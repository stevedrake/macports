# $Id$

PortSystem 1.0

name		xorg-server-devel
set my_name	xorg-server
version		1.8.0
revision        1
categories	x11 devel
maintainers	jeremyhu openmaintainer
description	The X.org / Xquartz X server.
homepage	http://www.x.org
platforms	darwin macosx
long_description The X.org X server allows you to run X11 applications on your computer.

#master_sites	http://xquartz.macosforge.org/downloads/src
master_sites    http://xorg.freedesktop.org/archive/individual/xserver/

dist_subdir     ${my_name}
distname        ${my_name}-${version}

checksums           md5     7cec3a11890bb53f4a07854319360348 \
                    sha1    a5f4fc748fc9841b7c0be6ef7388d26551d0d75b \
                    rmd160  4dedc88bcbbbe545b0e795d541edb3c665d12018

use_bzip2	yes
use_parallel_build yes

# Yes, mesa is a *BUILD* dependency
depends_build \
	port:pkgconfig \
	port:mesa \
	port:xorg-applewmproto \
	port:xorg-damageproto \
	port:xorg-fixesproto \
	port:xorg-fontsproto \
	port:xorg-glproto \
	port:xorg-inputproto \
	port:xorg-randrproto \
	port:xorg-recordproto \
	port:xorg-renderproto \
	port:xorg-resourceproto \
	port:xorg-scrnsaverproto \
	port:xorg-videoproto \
	port:xorg-xcmiscproto \
	port:xorg-xproto \
	port:xorg-xextproto \
	port:xorg-xineramaproto \
	port:xorg-xtrans \
	port:autoconf \
	port:automake \
	port:libtool \
	port:xorg-util-macros \
	port:doxygen

# This xinit dependency needs to be port: not bin: because we specifically run ${prefix}/bin/startx from bundle-main.c
depends_run \
	port:xinit \
	port:xorg-fonts \
	port:xkeyboard-config

depends_lib \
	path:lib/pkgconfig/pixman-1.pc:libpixman \
	port:xorg-libxkbfile \
	port:xorg-libXfont \
	port:xorg-libXt \
	port:xorg-libAppleWM \
	port:xorg-libXfixes

configure.args --with-apple-applications-dir=${applications_dir} \
	--with-launchd-id-prefix=org.macports \
	--without-dtrace \
	--with-sha1=CommonCrypto

# GL/internal/dri_interface.h is missing in prefix (provided by libdrm for the xorg DDX... not helpful for us)
configure.cppflags-append -I/usr/include -I${filespath}/dri

patchfiles \
        0001-Convert-x86emu-fixed-size-int-typedefs-to-use-stdint.patch \
        0002-dix-be-more-verbose-when-we-run-out-of-opcodes.patch \
        0003-doc-specify-1.6.1-as-the-minimum-version-for-doxygen.patch \
        0004-Don-t-keep-a-pointer-to-a-possibly-freed-cursor-when.patch \
        0005-config-only-match-sane-devices-in-10-evdev.conf.patch \
        0006-xfree86-Allow-adding-sysconfdir-and-datadir-to-confi.patch \
        0007-xfree86-Document-how-configdir-affects-the-xorg.conf.patch \
        0008-xfree86-Set-a-saner-search-path-for-xorg.conf.d.patch \
        0009-xfree86-Search-for-a-system-xorg.conf.d.patch \
        0010-Move-10-evdev.conf-to-system-config-dir-datadir-X11-.patch \
        0011-xfree86-remove-dead-input-drivers-from-xorg.conf-man.patch \
        0012-Disable-setuid-configure-test-on-Cygwin.patch \
        0013-Cygwin-X-Disable-unsupported-extensions-in-configure.patch \
        0014-Don-t-enable-ROOTLESS_WORKAROUND-it-breaks-composite.patch \
        0015-Cygwin-X-Add-configure-option-for-WindowsWM.patch \
        0016-XQuartz-Blacklist-some-oddball-legacy-Mac-keycodes-t.patch \
        0017-XQuartz-Add-a-defaults-option-to-toggle-Alt-Mode_swi.patch \
        0018-XQuartz-Customize-the-NSDefaults-id-in-the-man-file.patch \
        0019-XQuartz-Add-a-GUI-preference-for-the-Alt-Mode_switch.patch \
        0020-XGE-don-t-register-an-extension-event.patch \
        0021-xfree86-Fix-priority-ordering-for-ignoring-input-cla.patch \
        0023-XQuartz-Fix-possible-NULL-dereference-in-ListenOnOpe.patch \
        0024-XQuartz-GLX-Don-t-let-garbage-enter-our-pixel-reques.patch \
        0025-fb-Revert-fb-changes-that-broke-XQuartz.patch

patch.args -p1

build.args V=1

post-destroot {
	ln -s Xquartz ${destroot}${prefix}/bin/X
}

platform macosx {
	if { ![file exists /usr/include/Xplugin.h] } {
		# Xplugin.h is missing on Tiger
		configure.cppflags-append -I${filespath}/include
	}
}
