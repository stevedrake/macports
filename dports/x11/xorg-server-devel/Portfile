# $Id$

PortSystem 1.0

name		xorg-server-devel
set my_name	xorg-server
version		1.7.99.902
categories	x11 devel
maintainers	jeremyhu openmaintainer
description	The X.org / Xquartz X server.
homepage	http://www.x.org
platforms	darwin macosx
long_description The X.org X server allows you to run X11 applications on your computer.

#master_sites	http://xquartz.macosforge.org/downloads/src
master_sites    http://xorg.freedesktop.org/archive/individual/xserver/

dist_subdir     ${my_name}
distname        ${my_name}-${version}

checksums           md5     0f4d818bad13bb643caa93964f369249 \
                    sha1    649a77186df9d278d4d31e89dd02e48ca08d41c3 \
                    rmd160  d3826c08fdef112e5212a998dcbd30455255bd05

use_bzip2	yes
use_parallel_build yes

# Yes, mesa is a *BUILD* dependency
depends_build \
	port:pkgconfig \
	port:mesa \
	port:xorg-applewmproto \
	port:xorg-damageproto \
	port:xorg-fixesproto \
	port:xorg-fontsproto \
	port:xorg-glproto \
	port:xorg-inputproto \
	port:xorg-randrproto \
	port:xorg-recordproto \
	port:xorg-renderproto \
	port:xorg-resourceproto \
	port:xorg-scrnsaverproto \
	port:xorg-videoproto \
	port:xorg-xcmiscproto \
	port:xorg-xproto \
	port:xorg-xextproto \
	port:xorg-xineramaproto \
	port:xorg-xtrans \
	port:autoconf \
	port:automake \
	port:libtool \
	port:xorg-util-macros \
	port:doxygen

# This xinit dependency needs to be port: not bin: because we specifically run ${prefix}/bin/startx from bundle-main.c
depends_run \
	port:xinit \
	port:xorg-fonts \
	port:xkeyboard-config

depends_lib \
	path:lib/pkgconfig/pixman-1.pc:libpixman \
	port:xorg-libxkbfile \
	port:xorg-libXfont \
	port:xorg-libXt \
	port:xorg-libAppleWM \
	port:xorg-libXfixes

configure.args --with-apple-applications-dir=${applications_dir} \
	--with-launchd-id-prefix=org.macports \
	--without-dtrace \
	--with-sha1=CommonCrypto

# GL/internal/dri_interface.h is missing in prefix (provided by libdrm for the xorg DDX... not helpful for us)
configure.cppflags-append -I/usr/include -I${filespath}/dri

patchfiles \
        0001-Revert-XQuartz-Explicitly-pass-a-bellProc-to-make-XB.patch \
        0002-XQuartz-GLX-Fix-Availability-for-Tiger-ppc-workaroun.patch \
        0003-XQuartz-Minor-cleanup.patch \
        0004-XQuartz-xpbproxy-Cleanup-xpbproxy-threading.patch \
        0005-XQuartz-pbproxy-Make-standalone-xpbproxy-respect-the.patch \
        0006-XQuartz-Constrain-the-pointer-to-the-updated-display.patch \
        0007-Cygwin-X-Fix-make-dist-after-11252ed82e1f361b99e8652.patch \
        0008-Cygwin-X-Fix-windres-rule-for-automake-silent-rules.patch \
        0009-Rename-xdmx-client-to-dmxinfo.patch \
        0010-Use-libtool-export-dynamic-flag-for-portability.patch \
        0011-kdrive-Use-MAKE-in-relink-rules.patch \
        0012-Use-EXEEXT-in-relink-rules-for-portable-DDXs.patch \
        0013-Fix-relink-targets-for-silent-rules.patch \
        0014-Respect-value-of-SED-from-configure.patch \
        0015-Fix-.man.N-targets-for-AM_SILENT_RULES.patch \
        0016-Catch-errors-in-recursive-relink-targets.patch \
        0017-mi-remove-deprecated-include-X11-extensions-xf86bigf.patch \
        0018-Xext-fix-old-style-function-definitions-in-xf86bigfo.patch \
        0019-New-header-for-XF86Bigfont-server-functions.patch \
        0020-Cygwin-X-Make-X-XWin-symlink-during-install.patch \
        0021-Xext-Fix-cursor-reference-counting-hazard.patch \
        0022-Fix-typos-in-the-swap-functions.patch \
        0023-configure-Always-define-XINPUT.patch \
        0024-xfree86-remove-if-1-from-the-dawn-of-time.patch \
        0025-XKB-Fix-garbage-initialization.patch \
        0026-Fix-crash-when-all-glyphs-of-a-given-depth-are-freed.patch \
        0027-kdrive-Bump-evdev-maxKeycode.patch \
        0028-os-Prevent-backtrace-from-being-stopped-in-noreturn-.patch \
        0029-xfree86-merge-driver-from-the-input-class-into-the-o.patch \
        0030-Cleanup-some-comments-in-SpriteRec.patch \
        0031-config-udev-Prefer-product-name-from-attribute-rathe.patch \
        0032-XQuartz-Workaround-weird-key-data-reported-on-some-l.patch \
        0033-GLX-Remove-a-redundant-initialization.patch \
        0034-darwin-Generate-crash-reports-on-FatalError.patch \
        0035-XQuartz-Re-query-dixScreenOrigins-as-the-value-could.patch \
        0036-fb-Revert-fb-changes-that-broke-XQuartz.patch \
        0037-OS-Add-some-noreturn-and-printflike-compiler-attribu.patch

patch.args -p1

build.args V=1

post-destroot {
	ln -s Xquartz ${destroot}${prefix}/bin/X
}

platform macosx {
	if { ![file exists /usr/include/Xplugin.h] } {
		# Xplugin.h is missing on Tiger
		configure.cppflags-append -I${filespath}/include
	}
}
