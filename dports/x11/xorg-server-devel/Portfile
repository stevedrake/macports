# $Id$

PortSystem 1.0

name		xorg-server-devel
conflicts       xorg-server
set my_name	xorg-server
version		1.8.99.905
revision        1
categories	x11 devel
maintainers	jeremyhu openmaintainer
description	The X.org / Xquartz X server.
homepage	http://www.x.org
platforms	darwin macosx
long_description The X.org X server allows you to run X11 applications on your computer.

#master_sites	http://xquartz.macosforge.org/downloads/src
master_sites    http://xorg.freedesktop.org/archive/individual/xserver/

dist_subdir     ${my_name}
distname        ${my_name}-${version}

checksums           md5     7772d0bdcf6819332fb3a896fa854bd8 \
                    sha1    10500fee2558edf69353932c3219c222d11be52f \
                    rmd160  67a55f934f0e2ab0932c410cc588cbaa1f027023

use_bzip2	yes
use_parallel_build yes

# Yes, mesa is a *BUILD* dependency
depends_build \
	port:pkgconfig \
	port:mesa \
	port:xorg-applewmproto \
	port:xorg-damageproto \
	port:xorg-fixesproto \
	port:xorg-fontsproto \
	port:xorg-glproto \
	port:xorg-inputproto \
	port:xorg-randrproto \
	port:xorg-recordproto \
	port:xorg-renderproto \
	port:xorg-resourceproto \
	port:xorg-scrnsaverproto \
	port:xorg-videoproto \
	port:xorg-xcmiscproto \
	port:xorg-xproto \
	port:xorg-xextproto \
	port:xorg-xineramaproto \
	port:xorg-xtrans \
	port:autoconf \
	port:automake \
	port:libtool \
	port:xorg-util-macros \
	port:doxygen

if {[info exists supported_archs]} {
        depends_skip_archcheck doxygen
}

# This xinit dependency needs to be port: not bin: because we specifically run ${prefix}/bin/startx from bundle-main.c
depends_run \
	port:xinit \
	port:xorg-fonts \
	port:xkeyboard-config

depends_lib \
	path:lib/pkgconfig/pixman-1.pc:libpixman \
	port:xorg-libxkbfile \
	port:xorg-libXfont \
	port:xorg-libXt \
	port:xorg-libAppleWM \
	port:xorg-libXfixes

configure.args --with-apple-applications-dir=${applications_dir} \
	--with-launchd-id-prefix=org.macports \
	--without-dtrace \
	--with-sha1=CommonCrypto

# GL/internal/dri_interface.h is missing in prefix (provided by libdrm for the xorg DDX... not helpful for us)
configure.cppflags-append -I/usr/include -I${filespath}/dri

configure.env-append \
	RAWCPP=${configure.cpp}

patchfiles \
        0001-rootless-Adjust-the-frame-size-of-the-native-root-w.patch \
        0002-dix-hack-around-enter-leave-event-issues-for-grabbe.patch \
        0003-xkb-use-GetMaster-instead-of-dev-u.master.patch \
        0004-Use-DocBook-stylesheets-from-xorg-sgml-doctools-if-t.patch \
        0005-Add-name-argument-to-CreateNewResourceType-documenta.patch \
        0006-Add-documentation-of-the-Xserver-DTrace-probes.patch \
        0007-XQuartz-GLX-Don-t-mangle-__GLXDrawable-s-pDraw.patch \
        0008-XQuartz-xpbproxy-Don-t-take-down-the-whole-server.patch \
        0009-ddc-Fix-memory-leak-in-GetEDID_DDC1.patch \
        0010-XQuartz-Make-application-switching-work-better-for.patch \
        0011-XQuartz-UpdateScreen-at-the-end-of-SetRootless.patch \
        0012-XQuartz-xpr-Bail-on-errors-during-unlock-and-dest.patch \
        0013-XQuartz-RandR-Implement-basic-RandR-functionality.patch \
        0014-XQuartz-RandR-Toggle-rootless-mode-on-XRandR-mode.patch \
        0015-XQuartz-RandR-Remove-FAKE_RANDR-code.patch \
        0016-XQuartz-RandR-use-deprecated-CG-APIs-only-on-Leopa.patch \
        0017-XQuartz-Ignore-kXquartzToggleFullscreen-when-rootle.patch \
        0018-XQuartz-RandR-Respond-better-to-resolution-changes.patch \
        0019-XQuartz-RandR-Better-handle-switching-betwen-RandR.patch \
        0020-XQuartz-Don-t-change-the-rootless-preference-when-c.patch \
        0021-Workaround-the-GC-clipping-problem-in-miPaintWindow.patch \
        0022-fb-Revert-fb-changes-that-broke-XQuartz.patch

patch.pre_args -p1

use_autoreconf yes
autoreconf.args -fvi

build.args V=1

post-destroot {
	ln -s Xquartz ${destroot}${prefix}/bin/X
}

platform macosx {
	if { ![file exists /usr/include/Xplugin.h] } {
		# Xplugin.h is missing on Tiger
		configure.cppflags-append -I${filespath}/include
	}
}
