# $Id$

PortSystem 1.0

name		xorg-server
version		1.4.2-apple26
categories	x11 devel
maintainers	jeremyhu
description	The X.org / Xquartz X server.
homepage	http://www.x.org
platforms	darwin macosx
long_description The X.org X server allows you to run X11 applications on your computer.
master_sites	http://xquartz.macosforge.org/downloads/src/:xq \
		http://downloads.sourceforge.net/mesa3d/:mesa

set mesavers	"7.0.4"

distfiles	xorg-server-$version.tar.bz2:xq \
		MesaLib-${mesavers}.tar.bz2:mesa

checksums	xorg-server-$version.tar.bz2 sha1 30d2cb0a2cc35d14d7931788006dc3d283c10389 \
		MesaLib-$mesavers.tar.bz2 sha1 7e2ecbe89d245510d2681d04e959aee6adc205c5
use_bzip2	yes
use_parallel_build yes

depends_build   port:pkgconfig \
                port:xorg-applewmproto \
                port:xorg-fixesproto \
                port:xorg-glproto \
                port:xorg-inputproto \
                port:xorg-randrproto \
                port:xorg-renderproto \
                port:xorg-xcmiscproto \
                port:xorg-xproto \
                port:xorg-xextproto \
                port:xorg-xtrans

depends_run     port:xinit
depends_lib     port:libpixman \
                port:xorg-libAppleWM \
                port:xorg-libXdmcp \
                port:xorg-libXfixes

configure.env	PKG_CONFIG_PATH=${x11prefix}/lib/pkgconfig

# Otherwise glcore.h will be pulled in from glproto in /opt/local/include/GL/internal
configure.cppflags -I${worksrcpath}/../Mesa-${mesavers}/include -I${prefix}/include

# Can be removed once MacPorts 1.7.0 is released
if {![info exists applications_dir]} {
    set applications_dir /Applications/MacPorts
}

configure.args	--with-mesa-source=${worksrcpath}/../Mesa-${mesavers} --with-apple-applications-dir=${applications_dir}

post-patch {
	reinplace "s|org.x.X11|org.macports.X11|" ${worksrcpath}/hw/xquartz/bundle/Info.plist 
	reinplace "s|org.x.X11|org.macports.X11|" ${worksrcpath}/hw/xquartz/mach-startup/bundle-main.c
	reinplace "s|org.x.X11|org.macports.X11|" ${worksrcpath}/hw/xquartz/mach-startup/stub.c
	reinplace "s|/usr/X11|${prefix}|" ${worksrcpath}/hw/xquartz/mach-startup/bundle-main.c
}
