# $Id: Portfile,v 1.3 2004/03/19 07:28:20 rshaw Exp $
PortSystem          1.0

name			zope-cmf
version			1.4.2
categories		www zope python
maintainers		wbb4@opendarwin.org rshaw@opendarwin.org
description		The Zope Content Management Framework (CMF)
long_description	The Zope Content Management Framework provides a set \
					of services and content objects useful for building \
					highly dynamic, content-oriented portal sites.  As \
					packaged, the CMF generates a site much like the \
					Zope.org site.  The CMF is intended to be easily \
					customizable, in terms of both the types of content \
					used and the policies and services it provides.
platforms		darwin freebsd
set prodname	CMF
set products	{ CMFCore CMFDefault CMFTopic CMFCalendar DCWorkflow }
homepage		http://cmf.zope.org/
master_sites	${homepage}/download/${prodname}-${version}/
dist_subdir		zope
distname		${prodname}-${version}
checksums		md5 345f8f79ce68d5535933ee897782005b

# Use Python 2.3 from DarwinPorts explicitly 
set python		${prefix}/bin/python2.3
set pythonlib	${prefix}/lib/python2.3

# Location to install Zope products and the Zope user                  
set zopehome	${prefix}/libexec/Zope
set zopeinst	${prefix}/www/Zope
set zopeprod	${zopehome}/lib/python/Products
set zopeuser	zope
set zopegroup	www

# Depends on Zope
depends_build	path:${zopehome}:zope

# Depends on these Zope products
# none

platform freebsd {
	extract.post_args	| gtar -xf -
}
post-extract {
	system "find ${worksrcpath} -name '*.py\[co\]' | xargs rm"
	system "find ${worksrcpath} -type d -name CVS | xargs rm -rf"
}

use_configure	no

build {
	file copy -force ${zopehome}/bin/compilezpy.py ${workpath}
	reinplace "s|^.*sys.stdout|#&|" ${workpath}/compilezpy.py
	system "find ${worksrcpath} -name '*.py\[co\]' | xargs rm"
	system "cd ${worksrcpath} && ${python} ${workpath}/compilezpy.py"
}

destroot {
	if {$env(USER) != "root"} {
		ui_msg "------------------------------------------------------------"
		ui_msg "Note that you are not installing as root, so files installed"
		ui_msg "by this port will not end up with proper ownership and"
		ui_msg "likely not work correctly with Zope."
		ui_msg "------------------------------------------------------------"
	}

	# Install products
	xinstall -d -m 0755 ${destroot}${zopeprod}
	foreach product ${products} {
		system "cp -R ${worksrcpath}/${product} ${destroot}${zopeprod}"
	}
	if {$env(USER) == "root"} {
		system "chown -R ${zopeuser} ${destroot}${zopehome}"
		system "chgrp -R ${zopegroup} ${destroot}${zopehome}"
	}

	# Install docs
	set docPath ${destroot}${prefix}/share/doc
	xinstall -d -m 0755 ${docPath}
	system "cp -R ${worksrcpath}/docs ${docPath}/Zope-CMF"
}

variant cvs {
	version		[clock format [clock seconds] -format %Y%m%d]
	distname	${prodname}-${version}

	fetch.type	cvs
	cvs.root	:pserver:anonymous@cvs.zope.org:/cvs-repository
	cvs.module	${prodname}
	cvs.tag		CMF-1_4-branch
	cvs.args	-d ${distname}
}

